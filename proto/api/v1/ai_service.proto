syntax = "proto3";

package memos.api.v1;

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/empty.proto";

option go_package = "gen/api/v1";

// AIService provides AI-powered features for memo management.
service AIService {
  // SemanticSearch performs semantic search on memos.
  rpc SemanticSearch(SemanticSearchRequest) returns (SemanticSearchResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/search"
      body: "*"
    };
  }

  // SuggestTags suggests tags for memo content.
  rpc SuggestTags(SuggestTagsRequest) returns (SuggestTagsResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/suggest-tags"
      body: "*"
    };
  }

  // Chat streams a chat response with AI agents.
  rpc Chat(ChatRequest) returns (stream ChatResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/chat"
      body: "*"
    };
  }

  // GetRelatedMemos finds memos related to a specific memo.
  rpc GetRelatedMemos(GetRelatedMemosRequest) returns (GetRelatedMemosResponse) {
    option (google.api.http) = {get: "/api/v1/{name=memos/*}/related"};
  }

  // GetParrotSelfCognition returns the metacognitive information of a parrot agent.
  rpc GetParrotSelfCognition(GetParrotSelfCognitionRequest) returns (GetParrotSelfCognitionResponse) {
    option (google.api.http) = {get: "/api/v1/ai/parrots/{agent_type}/self-cognition"};
  }

  // ListParrots returns all available parrot agents with their metacognitive information.
  rpc ListParrots(ListParrotsRequest) returns (ListParrotsResponse) {
    option (google.api.http) = {get: "/api/v1/ai/parrots"};
  }

  // DetectDuplicates checks for duplicate or related memos.
  rpc DetectDuplicates(DetectDuplicatesRequest) returns (DetectDuplicatesResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/detect-duplicates"
      body: "*"
    };
  }

  // MergeMemos merges source memo into target memo.
  rpc MergeMemos(MergeMemosRequest) returns (MergeMemosResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/merge-memos"
      body: "*"
    };
  }

  // LinkMemos creates a bidirectional relation between two memos.
  rpc LinkMemos(LinkMemosRequest) returns (LinkMemosResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/link-memos"
      body: "*"
    };
  }

  // GetKnowledgeGraph returns the knowledge graph for the current user.
  rpc GetKnowledgeGraph(GetKnowledgeGraphRequest) returns (GetKnowledgeGraphResponse) {
    option (google.api.http) = {get: "/api/v1/ai/knowledge-graph"};
  }

  // GetDueReviews returns memos that are due for review.
  rpc GetDueReviews(GetDueReviewsRequest) returns (GetDueReviewsResponse) {
    option (google.api.http) = {get: "/api/v1/ai/reviews/due"};
  }

  // RecordReview records a review result and updates spaced repetition state.
  rpc RecordReview(RecordReviewRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/v1/ai/reviews/{memo_uid}/record"
      body: "*"
    };
  }

  // GetReviewStats returns review statistics for the current user.
  rpc GetReviewStats(GetReviewStatsRequest) returns (GetReviewStatsResponse) {
    option (google.api.http) = {get: "/api/v1/ai/reviews/stats"};
  }

  // ListAIConversations returns a list of AI conversations.
  rpc ListAIConversations(ListAIConversationsRequest) returns (ListAIConversationsResponse) {
    option (google.api.http) = {get: "/api/v1/ai/conversations"};
  }

  // GetAIConversation returns a specific AI conversation with its messages.
  rpc GetAIConversation(GetAIConversationRequest) returns (AIConversation) {
    option (google.api.http) = {get: "/api/v1/ai/conversations/{id}"};
  }

  // CreateAIConversation creates a new AI conversation.
  rpc CreateAIConversation(CreateAIConversationRequest) returns (AIConversation) {
    option (google.api.http) = {
      post: "/api/v1/ai/conversations"
      body: "*"
    };
  }

  // UpdateAIConversation updates an AI conversation.
  rpc UpdateAIConversation(UpdateAIConversationRequest) returns (AIConversation) {
    option (google.api.http) = {
      patch: "/api/v1/ai/conversations/{id}"
      body: "*"
    };
  }

  // GenerateConversationTitle generates a meaningful title for a conversation using AI.
  rpc GenerateConversationTitle(GenerateConversationTitleRequest) returns (GenerateConversationTitleResponse) {
    option (google.api.http) = {
      post: "/api/v1/ai/conversations/{id}/generate-title"
      body: "*"
    };
  }

  // DeleteAIConversation deletes an AI conversation.
  rpc DeleteAIConversation(DeleteAIConversationRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/ai/conversations/{id}"};
  }

  // AddContextSeparator adds a context separator marker to a conversation.
  rpc AddContextSeparator(AddContextSeparatorRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/v1/ai/conversations/{conversation_id}/separator"
      body: "*"
    };
  }

  // ClearConversationMessages deletes all messages in a conversation.
  rpc ClearConversationMessages(ClearConversationMessagesRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/ai/conversations/{conversation_id}/messages"};
  }

  // StopChat cancels an ongoing chat stream and terminates the associated session.
  rpc StopChat(StopChatRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/v1/ai/chat/stop"
      body: "*"
    };
  }

  // ========== Session Statistics (Phase 2) ==========

  // GetSessionStats retrieves statistics for a specific session.
  rpc GetSessionStats(GetSessionStatsRequest) returns (SessionStats) {
    option (google.api.http) = {get: "/api/v1/ai/sessions/{session_id}"};
  }

  // ListSessionStats retrieves session statistics with pagination.
  rpc ListSessionStats(ListSessionStatsRequest) returns (ListSessionStatsResponse) {
    option (google.api.http) = {get: "/api/v1/ai/sessions"};
  }

  // GetCostStats retrieves aggregated cost statistics for the user.
  rpc GetCostStats(GetCostStatsRequest) returns (CostStats) {
    option (google.api.http) = {get: "/api/v1/ai/cost-stats"};
  }

  // GetUserCostSettings retrieves user-specific cost control settings.
  rpc GetUserCostSettings(google.protobuf.Empty) returns (UserCostSettings) {
    option (google.api.http) = {get: "/api/v1/ai/cost-settings"};
  }

  // SetUserCostSettings updates user-specific cost control settings.
  rpc SetUserCostSettings(SetUserCostSettingsRequest) returns (UserCostSettings) {
    option (google.api.http) = {
      patch: "/api/v1/ai/cost-settings"
      body: "*"
    };
  }

  // ========== Unified Block Model (Phase 2) ==========

  // ListBlocks retrieves blocks for a conversation.
  rpc ListBlocks(ListBlocksRequest) returns (ListBlocksResponse) {
    option (google.api.http) = {get: "/api/v1/ai/conversations/{conversation_id}/blocks"};
  }

  // GetBlock retrieves a specific block.
  rpc GetBlock(GetBlockRequest) returns (Block) {
    option (google.api.http) = {get: "/api/v1/ai/blocks/{id}"};
  }

  // CreateBlock creates a new conversation block.
  rpc CreateBlock(CreateBlockRequest) returns (Block) {
    option (google.api.http) = {
      post: "/api/v1/ai/conversations/{conversation_id}/blocks"
      body: "*"
    };
  }

  // UpdateBlock updates a block.
  rpc UpdateBlock(UpdateBlockRequest) returns (Block) {
    option (google.api.http) = {
      patch: "/api/v1/ai/blocks/{id}"
      body: "*"
    };
  }

  // DeleteBlock deletes a block.
  rpc DeleteBlock(DeleteBlockRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/ai/blocks/{id}"};
  }

  // AppendUserInput appends a user input to an existing block.
  rpc AppendUserInput(AppendUserInputRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/v1/ai/blocks/{id}/inputs"
      body: "*"
    };
  }

  // AppendEvent appends an event to the block's event stream.
  rpc AppendEvent(AppendEventRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/v1/ai/blocks/{id}/events"
      body: "*"
    };
  }

  // ========== Tree Branching (Phase 3) ==========

  // ForkBlock creates a new block as a branch from an existing block.
  // The new block inherits the parent's conversation and user inputs,
  // allowing the user to regenerate a different AI response.
  rpc ForkBlock(ForkBlockRequest) returns (Block) {
    option (google.api.http) = {
      post: "/api/v1/ai/blocks/{id}/fork"
      body: "*"
    };
  }

  // ListBlockBranches lists all child blocks of a given block.
  // Returns the tree structure showing all branches from this block.
  rpc ListBlockBranches(ListBlockBranchesRequest) returns (ListBlockBranchesResponse) {
    option (google.api.http) = {get: "/api/v1/ai/blocks/{id}/branches"};
  }

  // SwitchBranch switches the active branch for a conversation.
  // Updates the branch_path to make the specified block the active leaf.
  rpc SwitchBranch(SwitchBranchRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/v1/ai/conversations/{conversation_id}/switch-branch"
      body: "*"
    };
  }

  // DeleteBranch deletes a block and all its descendants.
  // Used for pruning unwanted conversation branches.
  rpc DeleteBranch(DeleteBranchRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/ai/blocks/{id}/branch"};
  }
}

// SemanticSearchRequest is the request for SemanticSearch.
message SemanticSearchRequest {
  string query = 1 [(google.api.field_behavior) = REQUIRED];
  int32 limit = 2; // default: 10, max: 50
}

// SemanticSearchResponse is the response for SemanticSearch.
message SemanticSearchResponse {
  repeated SearchResult results = 1;
}

// SearchResult represents a single search result.
message SearchResult {
  string name = 1; // memos/{id}
  string snippet = 2; // content snippet
  float score = 3; // relevance score
}

// SuggestTagsRequest is the request for SuggestTags.
message SuggestTagsRequest {
  string content = 1 [(google.api.field_behavior) = REQUIRED];
  int32 limit = 2; // default: 5
}

// SuggestTagsResponse is the response for SuggestTags.
message SuggestTagsResponse {
  repeated string tags = 1;
}

// ScheduleQueryMode specifies the query mode for schedule filtering.
enum ScheduleQueryMode {
  AUTO = 0; // Auto-select query mode based on query type (relative time â†’ STANDARD, absolute time â†’ STRICT)
  STANDARD = 1; // Standard mode: return schedules that have any part within the query range
  STRICT = 2; // Strict mode: return only schedules completely within the query range
}

// AgentType specifies the type of AI agent to use for the request.
enum AgentType {
  AGENT_TYPE_DEFAULT = 0; // Default behavior (existing logic)
  AGENT_TYPE_MEMO = 1; // ðŸ¦œ Memo Parrot - Note assistant
  AGENT_TYPE_SCHEDULE = 2; // ðŸ¦œ Schedule Parrot - Schedule assistant
  AGENT_TYPE_AMAZING = 3; // ðŸ¦œ Amazing Parrot - Comprehensive assistant (Milestone 2)
  AGENT_TYPE_CREATIVE = 4; // ðŸ¦œ Creative Parrot - Creative assistant (Milestone 4)
}

// ChatRequest is the request for Chat.
message ChatRequest {
  string message = 1 [(google.api.field_behavior) = REQUIRED];
  string user_timezone = 3; // User's timezone in IANA format (e.g., "Asia/Shanghai"). Defaults to UTC if not provided.
  ScheduleQueryMode schedule_query_mode = 4; // Schedule query mode (optional, defaults to AUTO)
  AgentType agent_type = 5; // Agent type (optional, defaults to DEFAULT)
  int32 conversation_id = 6; // Conversation ID to persist message to
  bool is_temp_conversation = 7; // Whether to create a temporary conversation (true) or fixed conversation (false)
  bool geek_mode = 10; // Geek Mode: Enable Claude Code CLI for code-related tasks (optional, defaults to false)
  bool evolution_mode = 12; // Evolution Mode: Self-evolution with admin privileges (optional, defaults to false)
  string device_context = 11; // Detailed client/device context (JSON string containing UA, screen info, location, etc.)
}

// AIConversation represents an AI chat session.
message AIConversation {
  int32 id = 1;
  string uid = 2;
  int32 creator_id = 3;
  string title = 4;
  string title_source = 11; // "default", "auto", or "user"
  AgentType parrot_id = 5;
  bool pinned = 6;
  int64 created_ts = 7;
  int64 updated_ts = 8;
  repeated Block blocks = 9; // ALL IN Block! Blocks replace messages
  int32 block_count = 10; // Total block count (includes all block types)
}

// AIMessage removed: ALL IN Block!
// Use Block message instead for all conversation persistence.

message ListAIConversationsRequest {}

message ListAIConversationsResponse {
  repeated AIConversation conversations = 1;
}

message GetAIConversationRequest {
  int32 id = 1;
}

message CreateAIConversationRequest {
  string title = 1;
  AgentType parrot_id = 2;
}

message UpdateAIConversationRequest {
  int32 id = 1;
  optional string title = 2;
  optional bool pinned = 3;
}

message GenerateConversationTitleRequest {
  int32 id = 1; // Conversation ID
}

message GenerateConversationTitleResponse {
  string title = 1; // Generated title
  string title_source = 2; // "auto" for AI-generated titles
}

message DeleteAIConversationRequest {
  int32 id = 1;
}

// AddContextSeparatorRequest adds a separator marker to a conversation.
// This marks the point where the conversation context is cleared.
// Subsequent chat requests will only include messages after this separator.
message AddContextSeparatorRequest {
  int32 conversation_id = 1 [(google.api.field_behavior) = REQUIRED];
}

// ClearConversationMessagesRequest is the request for ClearConversationMessages.
message ClearConversationMessagesRequest {
  int32 conversation_id = 1 [(google.api.field_behavior) = REQUIRED];
}

// StopChatRequest is the request for stopping an ongoing chat stream.
message StopChatRequest {
  int32 conversation_id = 1 [(google.api.field_behavior) = REQUIRED]; // Conversation ID to stop
  string reason = 2; // Optional reason for stopping (e.g., "user_cancel", "timeout")
}

// DangerBlockEvent represents a dangerous operation that was blocked.
message DangerBlockEvent {
  string operation = 1; // The dangerous operation that was detected
  string reason = 2; // Explanation of why it's dangerous
  string pattern_matched = 3; // The pattern that matched the input
  bool bypass_allowed = 4; // Whether bypass is allowed (admin only)
}

// ChatResponse is the response for Chat.
message ChatResponse {
  string content = 1; // streaming content chunk
  repeated string sources = 2; // citation sources memos/{id}
  bool done = 3; // stream end marker
  ScheduleCreationIntent schedule_creation_intent = 4; // AI-detected schedule creation intent (sent in final chunk)
  ScheduleQueryResult schedule_query_result = 5; // AI-detected schedule query result (sent in final chunk)

  // Agent event signaling (for schedule agent integration)
  string event_type = 6; // Event type: "thinking", "tool_use", "tool_result", "answer", "error", "schedule_updated", "danger_block"
  string event_data = 7; // Event data (JSON or plain text depending on event type)

  // Event metadata for Geek Mode and Evolution Mode observability
  EventMetadata event_meta = 8; // Enhanced metadata for events (timing, tokens, tool info)

  // Block summary sent when done=true (statistics for this single chat round)
  BlockSummary block_summary = 9; // Summary statistics for the completed block

  // Phase 4: Block ID for Unified Block Model
  int64 block_id = 10; // Block ID for this conversation round (allows frontend to update Block state during streaming)
}

// ScheduleCreationIntent represents AI's analysis of user's intent to create a schedule.
message ScheduleCreationIntent {
  bool detected = 1; // Whether user wants to create a schedule
  string schedule_description = 2; // Natural language description of the schedule (e.g., "æ˜Žå¤©ä¸‹åˆ2ç‚¹å¼€ä¼š")
  string reasoning = 3; // AI's reasoning for intent detection (optional, for debugging)
}

// ScheduleQueryResult contains the result of schedule query intent detection and the queried schedules.
message ScheduleQueryResult {
  bool detected = 1; // Whether the user's intent is to query schedules
  repeated ScheduleSummary schedules = 2; // Queried schedules matching the user's intent
  string time_range_description = 3; // Human-readable time range description (e.g., "æœªæ¥7å¤©", "æœ¬å‘¨")
  string query_type = 4; // Type of query (e.g., "upcoming", "range", "filter")
}

// ScheduleSummary represents a simplified schedule for query results.
// This avoids circular dependencies with the full Schedule message in schedule_service.proto.
message ScheduleSummary {
  string uid = 1; // Schedule unique identifier in format "schedules/{uid}"
  string title = 2; // Schedule title
  int64 start_ts = 3; // Start timestamp (Unix timestamp in seconds)
  int64 end_ts = 4; // End timestamp (Unix timestamp in seconds, 0 if not set)
  bool all_day = 5; // Whether this is an all-day event
  string location = 6; // Event location (optional)
  string recurrence_rule = 7; // Recurrence rule in JSON format (empty if not recurring)
  string status = 8; // Schedule status (e.g., "ACTIVE", "CANCELLED")
}

// GetRelatedMemosRequest is the request for GetRelatedMemos.
message GetRelatedMemosRequest {
  string name = 1 [(google.api.field_behavior) = REQUIRED]; // memos/{id}
  int32 limit = 2; // default: 5
}

// GetRelatedMemosResponse is the response for GetRelatedMemos.
message GetRelatedMemosResponse {
  repeated SearchResult memos = 1;
}

// ParrotSelfCognition represents a parrot's metacognitive understanding of itself.
message ParrotSelfCognition {
  string name = 1; // Parrot name (e.g., "schedule", "memo", "creative", "amazing")
  string emoji = 2; // Visual representation (e.g., "ðŸ¦œ")
  string title = 3; // Formal title (e.g., "é‡‘åˆš - æ—¥ç¨‹åŠ©æ‰‹é¹¦é¹‰")
  repeated string personality = 4; // Character traits
  repeated string capabilities = 5; // What the parrot can do
  repeated string limitations = 6; // What the parrot cannot do
  string working_style = 7; // How the parrot approaches tasks
  repeated string favorite_tools = 8; // Tools the parrot frequently uses
  string self_introduction = 9; // First-person introduction
  string fun_fact = 10; // Interesting fact about the parrot
}

// GetParrotSelfCognitionRequest is the request for GetParrotSelfCognition.
message GetParrotSelfCognitionRequest {
  AgentType agent_type = 1 [(google.api.field_behavior) = REQUIRED]; // Agent type
}

// GetParrotSelfCognitionResponse is the response for GetParrotSelfCognition.
message GetParrotSelfCognitionResponse {
  ParrotSelfCognition self_cognition = 1; // Parrot's metacognitive information
}

// ListParrotsRequest is the request for ListParrots.
message ListParrotsRequest {}

// ListParrotsResponse is the response for ListParrots.
message ListParrotsResponse {
  repeated ParrotInfo parrots = 1; // All available parrots
}

// ParrotInfo represents basic information about a parrot.
message ParrotInfo {
  AgentType agent_type = 1; // Agent type enum
  string name = 2; // Parrot name
  ParrotSelfCognition self_cognition = 3; // Full metacognitive information
}

// DetectDuplicatesRequest is the request for DetectDuplicates.
message DetectDuplicatesRequest {
  string title = 1; // Memo title (optional)
  string content = 2 [(google.api.field_behavior) = REQUIRED]; // Memo content
  repeated string tags = 3; // Memo tags (optional)
  int32 top_k = 4; // Max results to return (default: 5)
}

// DetectDuplicatesResponse is the response for DetectDuplicates.
message DetectDuplicatesResponse {
  bool has_duplicate = 1; // Whether duplicates were found (>90% similarity)
  bool has_related = 2; // Whether related memos were found (70-90% similarity)
  repeated SimilarMemo duplicates = 3; // Duplicate memos
  repeated SimilarMemo related = 4; // Related memos
  int64 latency_ms = 5; // Detection latency in milliseconds
}

// SimilarMemo represents a memo similar to the input.
message SimilarMemo {
  string id = 1; // Memo ID
  string name = 2; // Memo resource name (memos/{uid})
  string title = 3; // Memo title
  string snippet = 4; // Content snippet
  double similarity = 5; // Similarity score (0-1)
  repeated string shared_tags = 6; // Tags shared with input
  string level = 7; // "duplicate" or "related"
  SimilarityBreakdown breakdown = 8; // Similarity breakdown
}

// SimilarityBreakdown shows how similarity was calculated.
message SimilarityBreakdown {
  double vector = 1; // Vector similarity score
  double tag_co_occur = 2; // Tag co-occurrence score
  double time_prox = 3; // Time proximity score
}

// MergeMemosRequest is the request for MergeMemos.
message MergeMemosRequest {
  string source_name = 1 [(google.api.field_behavior) = REQUIRED]; // Source memo name (memos/{uid})
  string target_name = 2 [(google.api.field_behavior) = REQUIRED]; // Target memo name (memos/{uid})
}

// MergeMemosResponse is the response for MergeMemos.
message MergeMemosResponse {
  string merged_name = 1; // Merged memo name
}

// LinkMemosRequest is the request for LinkMemos.
message LinkMemosRequest {
  string memo_name_1 = 1 [(google.api.field_behavior) = REQUIRED]; // First memo name (memos/{uid})
  string memo_name_2 = 2 [(google.api.field_behavior) = REQUIRED]; // Second memo name (memos/{uid})
}

// LinkMemosResponse is the response for LinkMemos.
message LinkMemosResponse {
  bool success = 1; // Whether linking was successful
}

// GetKnowledgeGraphRequest is the request for GetKnowledgeGraph.
message GetKnowledgeGraphRequest {
  repeated string tags = 1; // Filter by tags (optional)
  double min_importance = 2; // Minimum importance score (optional, 0-1)
  repeated int32 clusters = 3; // Filter by cluster IDs (optional)
}

// GetKnowledgeGraphResponse is the response for GetKnowledgeGraph.
message GetKnowledgeGraphResponse {
  repeated GraphNode nodes = 1; // Graph nodes
  repeated GraphEdge edges = 2; // Graph edges
  GraphStats stats = 3; // Graph statistics
  int64 build_ms = 4; // Build latency in milliseconds
}

// GraphNode represents a node in the knowledge graph.
message GraphNode {
  string id = 1; // Node ID (memo UID)
  string label = 2; // Node label (memo title)
  string type = 3; // Node type ("memo" or "tag")
  repeated string tags = 4; // Node tags
  double importance = 5; // Importance score (0-1, PageRank)
  int32 cluster = 6; // Community cluster ID
  int64 created_ts = 7; // Creation timestamp
}

// GraphEdge represents an edge in the knowledge graph.
message GraphEdge {
  string source = 1; // Source node ID
  string target = 2; // Target node ID
  string type = 3; // Edge type ("link", "tag_co", "semantic")
  double weight = 4; // Edge weight (0-1)
}

// GraphStats contains graph statistics.
message GraphStats {
  int32 node_count = 1; // Total node count
  int32 edge_count = 2; // Total edge count
  int32 cluster_count = 3; // Number of communities
  int32 link_edges = 4; // Explicit link edge count
  int32 tag_edges = 5; // Tag co-occurrence edge count
  int32 semantic_edges = 6; // Semantic similarity edge count
}

// ========== Review System Messages (P3-C002) ==========

// GetDueReviewsRequest is the request for GetDueReviews.
message GetDueReviewsRequest {
  int32 limit = 1; // Max items to return (default: 20)
}

// GetDueReviewsResponse is the response for GetDueReviews.
message GetDueReviewsResponse {
  repeated ReviewItem items = 1;
  int32 total_due = 2; // Total items due for review
}

// ReviewItem represents a memo in the review queue.
message ReviewItem {
  string memo_uid = 1; // Memo UID
  string memo_name = 2; // memos/{uid} format
  string title = 3; // Memo title
  string snippet = 4; // Content snippet
  repeated string tags = 5; // Memo tags
  int64 last_review_ts = 6; // Last review timestamp
  int32 review_count = 7; // Total review count
  int64 next_review_ts = 8; // Next scheduled review timestamp
  double priority = 9; // Computed priority score
  int64 created_ts = 10; // Memo creation timestamp
}

// RecordReviewRequest is the request for RecordReview.
message RecordReviewRequest {
  string memo_uid = 1 [(google.api.field_behavior) = REQUIRED];
  ReviewQuality quality = 2 [(google.api.field_behavior) = REQUIRED];
}

// ReviewQuality represents the user's assessment of recall difficulty.
enum ReviewQuality {
  REVIEW_QUALITY_UNSPECIFIED = 0;
  REVIEW_QUALITY_AGAIN = 1; // Complete blackout
  REVIEW_QUALITY_HARD = 2; // Correct with difficulty
  REVIEW_QUALITY_GOOD = 3; // Correct with hesitation
  REVIEW_QUALITY_EASY = 4; // Perfect response
}

// GetReviewStatsRequest is the request for GetReviewStats.
message GetReviewStatsRequest {}

// GetReviewStatsResponse is the response for GetReviewStats.
message GetReviewStatsResponse {
  int32 total_memos = 1; // Total memos in review system
  int32 due_today = 2; // Memos due for review today
  int32 reviewed_today = 3; // Memos reviewed today
  int32 new_memos = 4; // Memos never reviewed
  int32 mastered_memos = 5; // Memos with interval > 30 days
  int32 streak_days = 6; // Consecutive days of review
  int32 total_reviews = 7; // Total review count
  int32 average_accuracy = 8; // Average accuracy percentage
}

// ========== Event Observability Messages (Geek Mode & Evolution Mode) ==========

// EventMetadata provides enhanced metadata for streaming events.
// This enables better observability for Geek Mode and Evolution Mode sessions.
message EventMetadata {
  // Timing information
  int64 duration_ms = 1; // Duration of this event in milliseconds
  int64 total_duration_ms = 2; // Total elapsed time since session start (milliseconds)

  // Tool call information (for tool_use and tool_result events)
  string tool_name = 3; // Tool name (e.g., "bash", "editor_write", "grep")
  string tool_id = 4; // Unique tool call ID (UUID for matching use/result)

  // Token usage (when available from Claude Code CLI)
  int32 input_tokens = 5; // Input tokens consumed
  int32 output_tokens = 6; // Output tokens generated
  int32 cache_write_tokens = 7; // Prompt cache write tokens
  int32 cache_read_tokens = 8; // Prompt cache read tokens

  // Event status
  string status = 9; // Status: "running", "success", "error"
  string error_msg = 10; // Error message if status=error

  // Input/Output summaries for UI display (truncated for performance)
  string input_summary = 11; // Human-readable input summary (e.g., "ls -la")
  string output_summary = 12; // Truncated output preview (max 500 chars)

  // File operations (for tools that operate on files)
  string file_path = 13; // Affected file path (if applicable)
  int32 line_count = 14; // Number of lines affected (for edit operations)
}

// BlockSummary provides end-of-block statistics for a single chat round.
// Sent in the final ChatResponse when done=true.
//
// This represents statistics for a SINGLE Block, not the entire conversation.
// For conversation-level aggregation, query across multiple Blocks.
//
// NOTE: Mode is NOT included here - use Block.mode as the single source of truth.
message BlockSummary {
  // Session identification (for Geek/Evolution modes)
  string session_id = 1; // Claude Code CLI session ID (only for geek/evolution blocks)

  // Overall timing
  int64 total_duration_ms = 2; // Total session duration in milliseconds
  int64 thinking_duration_ms = 3; // Time spent in "thinking" state
  int64 tool_duration_ms = 4; // Time spent executing tools
  int64 generation_duration_ms = 5; // Time spent generating responses

  // Token usage
  int32 total_input_tokens = 6; // Total input tokens consumed
  int32 total_output_tokens = 7; // Total output tokens generated
  int32 total_cache_write_tokens = 8; // Total cache write tokens
  int32 total_cache_read_tokens = 9; // Total cache read tokens

  // Tool call statistics
  int32 tool_call_count = 10; // Total number of tool calls
  repeated string tools_used = 11; // List of tools called (e.g., ["bash", "editor_write"])

  // File operations (for Evolution Mode)
  int32 files_modified = 12; // Number of files modified
  repeated string file_paths = 13; // List of affected file paths

  // Cost tracking (from Claude Code CLI)
  double total_cost_usd = 16; // Total cost in USD for this session

  // Status
  string status = 14; // Final session status: "success", "error", "cancelled"
  string error_msg = 15; // Error message if status=error
}

// ========== Session Statistics Messages (Phase 2) ==========

// SessionStats represents detailed statistics for a single session.
message SessionStats {
  int64 id = 1;
  string session_id = 2;
  int64 conversation_id = 3;
  int32 user_id = 4;
  string agent_type = 5;
  int64 started_at = 6; // Unix timestamp in seconds
  int64 ended_at = 7;
  int64 total_duration_ms = 8;
  int64 thinking_duration_ms = 9;
  int64 tool_duration_ms = 10;
  int64 generation_duration_ms = 11;
  int32 input_tokens = 12;
  int32 output_tokens = 13;
  int32 cache_write_tokens = 14;
  int32 cache_read_tokens = 15;
  int32 total_tokens = 16;
  double total_cost_usd = 17;
  int32 tool_call_count = 18;
  repeated string tools_used = 19;
  int32 files_modified = 20;
  repeated string file_paths = 21;
  string model_used = 22;
  bool is_error = 23;
  string error_message = 24;
  int64 created_at = 25;
  int64 updated_at = 26;
}

// GetSessionStatsRequest is the request for GetSessionStats.
message GetSessionStatsRequest {
  string session_id = 1 [(google.api.field_behavior) = REQUIRED];
}

// ListSessionStatsRequest is the request for ListSessionStats.
message ListSessionStatsRequest {
  int32 limit = 1; // Default: 20, Max: 100
  int32 offset = 2; // Default: 0
  int32 days = 3; // Filter to last N days (optional, default: 30)
}

// ListSessionStatsResponse is the response for ListSessionStats.
message ListSessionStatsResponse {
  repeated SessionStats sessions = 1;
  int64 total_count = 2;
  double total_cost_usd = 3; // Total cost across all sessions
}

// GetCostStatsRequest is the request for GetCostStats.
message GetCostStatsRequest {
  int32 days = 1; // Number of days to analyze (default: 7)
}

// CostStats represents aggregated cost statistics.
message CostStats {
  double total_cost_usd = 1;
  double daily_average_usd = 2;
  int64 session_count = 3;
  SessionStats most_expensive_session = 4;
  repeated DailyCostData daily_breakdown = 5;
}

// DailyCostData represents cost data for a single day.
message DailyCostData {
  string date = 1; // YYYY-MM-DD
  double cost_usd = 2;
  int64 session_count = 3;
}

// UserCostSettings represents user-specific cost control settings.
message UserCostSettings {
  double daily_budget_usd = 1; // 0 = unlimited
  double per_session_threshold_usd = 2;
  bool alert_enabled = 3;
  bool alert_email = 4;
  bool alert_in_app = 5;
  int64 budget_reset_at = 6; // Unix timestamp when budget resets
}

// SetUserCostSettingsRequest is the request for SetUserCostSettings.
message SetUserCostSettingsRequest {
  optional double daily_budget_usd = 1; // Null = unchanged, 0 = unlimited
  optional double per_session_threshold_usd = 2;
  optional bool alert_enabled = 3;
  optional bool alert_email = 4;
  optional bool alert_in_app = 5;
}

// ========== Unified Block Model Messages ==========

// Block represents a single conversation block (round).
// A block contains user inputs and the AI's response, along with
// an event stream tracking the AI's thinking process.
message Block {
  int64 id = 1;
  string uid = 2;
  int32 conversation_id = 3;
  int32 round_number = 4;

  // Block type and mode
  BlockType block_type = 5;
  BlockMode mode = 6;

  // User inputs (may be multiple if user adds more during AI response)
  repeated UserInput user_inputs = 7;

  // AI response
  string assistant_content = 8;
  int64 assistant_timestamp = 9;

  // Event stream (chronological order)
  repeated BlockEvent event_stream = 10;

  // Session statistics (for Geek/Evolution modes)
  SessionStats session_stats = 11;

  // CC session mapping (for Geek/Evolution modes)
  string cc_session_id = 12;

  // Block status
  BlockStatus status = 13;

  // Tree branching support (for edit & regenerate functionality)
  int64 parent_block_id = 14; // Parent block ID (null for root blocks)
  string branch_path = 15; // Branch path for ordering (e.g., "0/1/3")

  // Token usage statistics (for all modes)
  TokenUsage token_usage = 19; // Detailed token usage for this block

  // Cost estimation (in milli-cents: 1/1000 of a US cent)
  int64 cost_estimate = 20; // Estimated cost in milli-cents

  // Model information
  string model_version = 21; // LLM model used (e.g., "deepseek-chat", "gpt-4")

  // User feedback and regeneration
  string user_feedback = 22; // User feedback: "thumbs_up", "thumbs_down", or custom feedback
  int32 regeneration_count = 23; // Number of times this block was regenerated

  // Error tracking
  string error_message = 24; // Error message if status = ERROR

  // Archival support
  int64 archived_at = 25; // Timestamp when block was archived (0 if active)

  // Extension metadata
  string metadata = 16; // JSON string

  int64 created_ts = 17;
  int64 updated_ts = 18;
}

// TokenUsage represents detailed token usage for a single block or LLM call.
message TokenUsage {
  int32 prompt_tokens = 1; // Input tokens
  int32 completion_tokens = 2; // Output tokens
  int32 total_tokens = 3; // Total tokens
  int32 cache_read_tokens = 4; // Tokens read from cache
  int32 cache_write_tokens = 5; // Tokens written to cache
}

// UserInput represents a single user input within a block.
message UserInput {
  string content = 1;
  int64 timestamp = 2;
  string metadata = 3; // JSON string
}

// BlockEvent represents an event in the event stream.
// Events are stored chronologically and track the AI's process.
message BlockEvent {
  string type = 1; // "thinking", "tool_use", "tool_result", "answer", "error"
  string content = 2;
  int64 timestamp = 3;
  string meta = 4; // JSON string with event-specific metadata
}

// BlockType represents the type of block.
enum BlockType {
  BLOCK_TYPE_UNSPECIFIED = 0;
  BLOCK_TYPE_MESSAGE = 1; // User-AI conversation round
  BLOCK_TYPE_CONTEXT_SEPARATOR = 2; // Context separator marker
}

// BlockMode represents the AI mode used for this block.
enum BlockMode {
  BLOCK_MODE_UNSPECIFIED = 0;
  BLOCK_MODE_NORMAL = 1; // Normal AI assistant mode
  BLOCK_MODE_GEEK = 2; // Geek mode (Claude Code CLI)
  BLOCK_MODE_EVOLUTION = 3; // Evolution mode (self-improvement)
}

// BlockStatus represents the current status of a block.
enum BlockStatus {
  BLOCK_STATUS_UNSPECIFIED = 0;
  BLOCK_STATUS_PENDING = 1; // Waiting for AI response
  BLOCK_STATUS_STREAMING = 2; // AI is currently responding
  BLOCK_STATUS_COMPLETED = 3; // Response completed
  BLOCK_STATUS_ERROR = 4; // Error occurred
}

// ListBlocksRequest is the request for ListBlocks.
message ListBlocksRequest {
  int32 conversation_id = 1 [(google.api.field_behavior) = REQUIRED];
  BlockStatus status = 2; // Optional filter by status
  BlockMode mode = 3; // Optional filter by mode
  string cc_session_id = 4; // Optional filter by CC session

  // Pagination support (for incremental sync)
  int32 limit = 5; // Max blocks to return (default: 100, max: 100)
  string last_block_uid = 6; // Last block UID from previous page (for incremental sync)
}

// ListBlocksResponse is the response for ListBlocks.
message ListBlocksResponse {
  repeated Block blocks = 1; // Blocks in the conversation

  // Pagination metadata
  bool has_more = 2; // Whether more blocks exist before this page
  int32 total_count = 3; // Total count of MESSAGE type blocks
  string latest_block_uid = 4; // UID of the latest block for sync validation
  bool sync_required = 5; // Whether client should re-sync (UID not found)
}

// GetBlockRequest is the request for GetBlock.
message GetBlockRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED];
}

// CreateBlockRequest is the request for CreateBlock.
message CreateBlockRequest {
  int32 conversation_id = 1 [(google.api.field_behavior) = REQUIRED];
  BlockType block_type = 2; // Default: MESSAGE
  BlockMode mode = 3; // Default: NORMAL
  repeated UserInput user_inputs = 4;
  string metadata = 5; // JSON string
  string cc_session_id = 6; // For Geek/Evolution modes
}

// UpdateBlockRequest is the request for UpdateBlock.
message UpdateBlockRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED];
  optional string assistant_content = 2;
  repeated BlockEvent event_stream = 3; // Replace entire event stream
  SessionStats session_stats = 4;
  optional string cc_session_id = 5;
  optional BlockStatus status = 6;
  string metadata = 7; // Merge into existing metadata (JSON string)
}

// DeleteBlockRequest is the request for DeleteBlock.
message DeleteBlockRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED];
}

// AppendUserInputRequest is the request for AppendUserInput.
message AppendUserInputRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED]; // Block ID
  UserInput input = 2 [(google.api.field_behavior) = REQUIRED];
}

// AppendEventRequest is the request for AppendEvent.
message AppendEventRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED]; // Block ID
  BlockEvent event = 2 [(google.api.field_behavior) = REQUIRED];
}

// ========== Tree Branching Messages ==========

// ForkBlockRequest is the request for ForkBlock.
message ForkBlockRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED]; // Parent block ID
  optional string reason = 2; // Optional reason for forking (e.g., "regenerate", "edit")
  repeated UserInput replace_user_inputs = 3; // Optional: replace inherited user inputs with new ones (for message editing)
}

// ListBlockBranchesRequest is the request for ListBlockBranches.
message ListBlockBranchesRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED]; // Root block ID
}

// ListBlockBranchesResponse is the response for ListBlockBranches.
message ListBlockBranchesResponse {
  repeated BlockBranch branches = 1;
  string active_branch_path = 2; // Currently active branch path
}

// BlockBranch represents a branch in the conversation tree.
message BlockBranch {
  Block block = 1; // The block at this branch position
  string branch_path = 2; // Path from root to this block (e.g., "0/1/3")
  bool is_active = 3; // Whether this is the currently active branch
  repeated BlockBranch children = 4; // Child branches
}

// SwitchBranchRequest is the request for SwitchBranch.
message SwitchBranchRequest {
  int32 conversation_id = 1 [(google.api.field_behavior) = REQUIRED];
  string target_branch_path = 2 [(google.api.field_behavior) = REQUIRED]; // Target branch to activate
}

// DeleteBranchRequest is the request for DeleteBranch.
message DeleteBranchRequest {
  int64 id = 1 [(google.api.field_behavior) = REQUIRED]; // Block ID to delete (and all descendants)
  bool cascade = 2; // If true, delete all descendants; otherwise only delete this block
}
