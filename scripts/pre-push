#!/bin/sh
# Pre-push hook - full CI checks before pushing to remote
set -e

echo "ðŸš€ Running pre-push checks (full CI validation)..."
echo ""

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get pushed branch
REMOTE="$1"
URL="$2"

echo "Pushing to: $URL"
echo ""

# Backend full checks
echo "ðŸ“¦ Backend:"
echo "  â†’ go mod tidy check..."
cp go.mod go.mod.bak 2>/dev/null || true
cp go.sum go.sum.bak 2>/dev/null || true
go mod tidy
if ! git diff --quiet go.mod go.sum; then
    echo "    ${RED}âœ— go.mod/go.sum not tidy${NC}"
    echo "    Run: go mod tidy && git add go.mod go.sum"
    mv go.mod.bak go.mod 2>/dev/null || true
    mv go.sum.bak go.sum 2>/dev/null || true
    exit 1
fi
rm -f go.mod.bak go.sum.bak

echo "  â†’ golangci-lint..."
if ! golangci-lint run --config=.golangci.yaml --timeout=3m --build-tags=noui; then
    echo "    ${RED}âœ— golangci-lint failed${NC}"
    echo "    Run 'make ci-backend' to fix"
    exit 1
fi

echo "  â†’ go test..."
# Run tests with increased timeout; cron tests need more time when run in parallel
if ! go test -short -timeout=60s -tags=noui ./...; then
    echo "    ${RED}âœ— tests failed${NC}"
    exit 1
fi

echo "    ${GREEN}âœ“ Backend checks passed${NC}"
echo ""

# Frontend checks
echo "ðŸŽ¨ Frontend:"
if [ -d "web" ] && [ -f "web/package.json" ]; then
    cd web
    echo "  â†’ pnpm lint..."
    if ! pnpm lint --silent; then
        echo "    ${RED}âœ— Frontend lint failed${NC}"
        exit 1
    fi

    echo "  â†’ pnpm build..."
    if ! pnpm build >/dev/null 2>&1; then
        echo "    ${RED}âœ— Frontend build failed${NC}"
        exit 1
    fi
    cd ..
    echo "    ${GREEN}âœ“ Frontend checks passed${NC}"
fi

echo ""
echo "${GREEN}âœ… All pre-push checks passed! Ready to push.${NC}"
