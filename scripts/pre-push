#!/bin/bash
# Pre-push hook - smart CI checks based on changes being pushed
set -e
set -o pipefail

# Color output - only enable if terminal supports colors
if [ -t 1 ] && [ -z "$NO_COLOR" ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    NC=''
fi

echo "${CYAN}üöÄ Pre-push checks (smart CI)...${NC}"
echo ""

# Get list of files being pushed (compare with origin/main)
REMOTE="$1"
URL="$2"

# Find the local branch's upstream remote branch
LOCAL_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "HEAD")
REMOTE_BRANCH=$(git for-each-ref --format='%(upstream:short)' "refs/heads/$LOCAL_BRANCH" 2>/dev/null || echo "")

# If no upstream branch, compare with origin/main
if [ -z "$REMOTE_BRANCH" ]; then
    REMOTE_BRANCH="origin/main"
fi

# Get changed files compared to remote
CHANGED_FILES=$(git diff --name-only $REMOTE_BRANCH...HEAD 2>/dev/null || git diff --name-only HEAD~5..HEAD)
if [ -z "$CHANGED_FILES" ]; then
    echo "${YELLOW}No changes detected, skipping checks${NC}"
    exit 0
fi

# Categorize changes
HAS_GO_FILES=$(echo "$CHANGED_FILES" | grep -cE '\.go$' || true)
HAS_GO_MOD=$(echo "$CHANGED_FILES" | grep -cE '^(go\.(mod|sum))$' || true)
HAS_FRONTEND=$(echo "$CHANGED_FILES" | grep -cE '^(web/|server/router/frontend/)' || true)
HAS_PROTO=$(echo "$CHANGED_FILES" | grep -cE '^proto/' || true)
HAS_DOCS_ONLY=true

# Check if non-doc files exist
if [ "$HAS_GO_FILES" -gt 0 ] || [ "$HAS_GO_MOD" -gt 0 ] || [ "$HAS_FRONTEND" -gt 0 ] || [ "$HAS_PROTO" -gt 0 ]; then
    HAS_DOCS_ONLY=false
fi

# Show what's being checked
echo "${BLUE}Changes summary:${NC}"
echo "  Go files:        $HAS_GO_FILES"
echo "  Go mod/sum:      $HAS_GO_MOD"
echo "  Frontend:        $HAS_FRONTEND"
echo "  Proto files:     $HAS_PROTO"
echo "  Docs only:       $HAS_DOCS_ONLY"
echo ""

# Track if any checks failed
CHECKS_FAILED=false
TOTAL_START=$(date +%s)

# ==================== Backend Checks ====================

if [ "$HAS_GO_FILES" -gt 0 ] || [ "$HAS_GO_MOD" -gt 0 ]; then
    echo "${BLUE}üì¶ Backend CI checks:${NC}"
    BACKEND_START=$(date +%s)

    # go.mod/go.sum tidy check
    if [ "$HAS_GO_MOD" -gt 0 ]; then
        echo "  ‚Üí go.mod/go.sum tidy..."
        cp go.mod go.mod.bak 2>/dev/null || true
        cp go.sum go.sum.bak 2>/dev/null || true
        go mod tidy
        if ! git diff --quiet go.mod go.sum; then
            echo "    ${RED}‚úó go.mod/go.sum not tidy${NC}"
            mv go.mod.bak go.mod 2>/dev/null || true
            mv go.sum.bak go.sum 2>/dev/null || true
            CHECKS_FAILED=true
        else
            rm -f go.mod.bak go.sum.bak
            echo "    ${GREEN}‚úì${NC} go.mod/go.sum tidy"
        fi
    fi

    # golangci-lint (only if Go files changed)
    if [ "$HAS_GO_FILES" -gt 0 ]; then
        echo "  ‚Üí golangci-lint..."
        if ! golangci-lint run --config=.golangci.yaml --timeout=3m --build-tags=noui 2>&1; then
            echo "    ${RED}‚úó golangci-lint failed${NC}"
            CHECKS_FAILED=true
        else
            echo "    ${GREEN}‚úì${NC} golangci-lint"
        fi
    fi

    # go test (only if Go files changed)
    if [ "$HAS_GO_FILES" -gt 0 ]; then
        echo "  ‚Üí go test..."
        # Skip benchmarks with -run '^Test' for faster execution
        if ! go test -short -run '^Test' -timeout=60s -tags=noui $(go list ./... | grep -v -E '(^github.com/hrygo/divinesense/proto/|^github.com/hrygo/divinesense/plugin/cron$)') 2>&1; then
            echo "    ${RED}‚úó tests failed${NC}"
            CHECKS_FAILED=true
        else
            echo "    ${GREEN}‚úì${NC} tests passed (benchmarks skipped)"
        fi
    fi

    BACKEND_END=$(date +%s)
    BACKEND_TIME=$((BACKEND_END - BACKEND_START))
    echo "    ${BLUE}‚è± Backend: ${BACKEND_TIME}s${NC}"
    echo ""
fi

# ==================== Frontend Checks ====================

if [ "$HAS_FRONTEND" -gt 0 ]; then
    echo "${BLUE}üé® Frontend CI checks:${NC}"
    FRONTEND_START=$(date +%s)

    if [ -d "web" ] && [ -f "web/package.json" ]; then
        cd web

        echo "  ‚Üí pnpm lint..."
        if ! pnpm lint --silent 2>&1; then
            echo "    ${RED}‚úó Frontend lint failed${NC}"
            cd ..
            CHECKS_FAILED=true
        else
            echo "    ${GREEN}‚úì${NC} pnpm lint"
        fi

        echo "  ‚Üí pnpm build..."
        if ! pnpm build >/dev/null 2>&1; then
            echo "    ${RED}‚úó Frontend build failed${NC}"
            cd ..
            CHECKS_FAILED=true
        else
            echo "    ${GREEN}‚úì${NC} pnpm build"
        fi

        cd ..
    fi

    FRONTEND_END=$(date +%s)
    FRONTEND_TIME=$((FRONTEND_END - FRONTEND_START))
    echo "    ${BLUE}‚è± Frontend: ${FRONTEND_TIME}s${NC}"
    echo ""
fi

# ==================== Proto Files Check ====================

if [ "$HAS_PROTO" -gt 0 ]; then
    echo "${BLUE}üî∑ Proto files changed:${NC}"
    echo "    ${YELLOW}‚ö† Make sure to run 'make generate' after push${NC}"
    echo ""
fi

# ==================== Documentation Only ====================

if [ "$HAS_DOCS_ONLY" = true ]; then
    echo "${BLUE}üìö Documentation only changes${NC}"
    echo "    ${GREEN}‚úì Skipping all CI checks${NC}"
    echo ""
fi

# ==================== Final Report ====================

TOTAL_END=$(date +%s)
TOTAL_TIME=$((TOTAL_END - TOTAL_START))

if [ "$CHECKS_FAILED" = true ]; then
    echo ""
    echo "${RED}‚úó Pre-push checks failed${NC}"
    echo ""
    echo "Fix the errors above and try again, or use:"
    echo "  git push --no-verify"
    exit 1
fi

echo "${GREEN}‚úÖ All pre-push checks passed! (Total: ${TOTAL_TIME}s)${NC}"
echo ""
