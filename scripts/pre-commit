#!/bin/sh
# Pre-commit hook - lightweight checks (fast feedback)
set -e

echo "ðŸ” Quick pre-commit checks..."

# Check go.mod/go.sum are tidy
echo "  â†’ go.mod/go.sum tidy check..."
if ! go mod tidy -diff > /dev/null 2>&1; then
    echo ""
    echo "    âœ— go.mod/go.sum not tidy"
    echo "    Run: go mod tidy && git add go.mod go.sum"
    echo ""
    exit 1
fi
echo "    âœ“ go.mod/go.sum tidy"

# Smart embed check: only verify dist/ exists if frontend files were changed
FRONTEND_CHANGED=$(git diff --cached --name-only | grep -cE '^(server/router/frontend/|web/)' || true)
if [ "$FRONTEND_CHANGED" -gt 0 ]; then
    if [ ! -d "server/router/frontend/dist" ] || [ -z "$(ls -A server/router/frontend/dist 2>/dev/null)" ]; then
        echo "  â†’ Frontend files changed but dist/ not built"
        echo "    Auto-building frontend..."
        if cd web && pnpm build >/dev/null 2>&1 && mkdir -p ../server/router/frontend && cp -r dist/* ../server/router/frontend/dist/; then
            echo "    âœ“ Frontend built successfully"
            cd ..
        else
            echo "    âš  Frontend build failed, continuing anyway (embed will fail in production)"
            cd ..
        fi
    fi
fi

echo "  â†’ go fmt..."
go fmt ./...

echo "  â†’ go vet..."
go vet ./...

echo "âœ… Pre-commit checks passed!"
