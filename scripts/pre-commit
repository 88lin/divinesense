#!/bin/bash
# Pre-commit hook - smart checks based on changed files
set -e
set -o pipefail

# Color output - only enable if terminal supports colors
if [ -t 1 ] && [ -z "$NO_COLOR" ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

# Use printf for reliable escape sequence handling across platforms
print_color() {
    printf '%b\n' "$1"
}

print_color "${BLUE}ðŸ” Pre-commit checks...${NC}"
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED_FILES" ]; then
    print_color "${YELLOW}No staged files, skipping checks${NC}"
    exit 0
fi

# Categorize changes
HAS_GO_FILES=$(echo "$STAGED_FILES" | grep -cE '\.go$' || true)
HAS_GO_MOD=$(echo "$STAGED_FILES" | grep -cE '^(go\.(mod|sum))$' || true)
HAS_FRONTEND=$(echo "$STAGED_FILES" | grep -cE '^(web/|server/router/frontend/)' || true)
HAS_DOCS_ONLY=true

# Check if non-doc files exist
if [ "$HAS_GO_FILES" -gt 0 ] || [ "$HAS_GO_MOD" -gt 0 ] || [ "$HAS_FRONTEND" -gt 0 ]; then
    HAS_DOCS_ONLY=false
fi

# Track if any checks failed
CHECKS_FAILED=false

# ==================== Backend Checks ====================

if [ "$HAS_GO_FILES" -gt 0 ] || [ "$HAS_GO_MOD" -gt 0 ]; then
    print_color "${BLUE}ðŸ“¦ Backend changes detected:${NC}"

    # go.mod/go.sum tidy check (only if go.mod or go.sum changed)
    if [ "$HAS_GO_MOD" -gt 0 ]; then
        echo "  â†’ go.mod/go.sum tidy check..."
        cp go.mod go.mod.bak 2>/dev/null || true
        cp go.sum go.sum.bak 2>/dev/null || true
        go mod tidy
        if ! git diff --quiet go.mod go.sum; then
            print_color "    ${RED}âœ— go.mod/go.sum not tidy${NC}"
            echo "    Run: go mod tidy && git add go.mod go.sum"
            mv go.mod.bak go.mod 2>/dev/null || true
            mv go.sum.bak go.sum 2>/dev/null || true
            CHECKS_FAILED=true
        else
            rm -f go.mod.bak go.sum.bak
            print_color "    ${GREEN}âœ“${NC} go.mod/go.sum tidy"
        fi
    fi

    # go fmt
    echo "  â†’ go fmt..."
    FMT_OUTPUT=$(go fmt ./... 2>&1)
    if [ -n "$FMT_OUTPUT" ]; then
        print_color "    ${YELLOW}âš  Formatted files:${NC}"
        echo "$FMT_OUTPUT" | sed 's/^/    /'
        # Stage the formatted files
        git diff --name-only | grep '\.go$' | xargs git add >/dev/null 2>&1 || true
    else
        print_color "    ${GREEN}âœ“${NC} go fmt"
    fi

    # go vet
    echo "  â†’ go vet..."
    if ! go vet ./... 2>&1 | grep -qE '^(#|vendor/)'; then
        print_color "    ${GREEN}âœ“${NC} go vet"
    else
        print_color "    ${RED}âœ— go vet failed${NC}"
        CHECKS_FAILED=true
    fi
    echo ""
fi

# ==================== Frontend Checks ====================

if [ "$HAS_FRONTEND" -gt 0 ]; then
    print_color "${BLUE}ðŸŽ¨ Frontend changes detected:${NC}"

    # Only check/build if web/ directory exists
    if [ -d "web" ] && [ -f "web/package.json" ]; then
        cd web

        # Quick lint check (auto-fix enabled)
        echo "  â†’ pnpm lint:fix..."
        if ! pnpm lint:fix >/dev/null 2>&1; then
            print_color "    ${RED}âœ— Frontend lint failed${NC}"
            cd ..
            CHECKS_FAILED=true
        else
            print_color "    ${GREEN}âœ“${NC} pnpm lint:fix"
        fi

        cd ..
        # Stage any auto-fixed files (must be in git root for correct paths)
        git diff --name-only | grep '^web/' | xargs -r git add 2>/dev/null || true
    fi
    echo ""
fi

# ==================== Documentation Only ====================

if [ "$HAS_DOCS_ONLY" = true ]; then
    print_color "${BLUE}ðŸ“š Documentation only changes${NC}"
    print_color "    ${GREEN}âœ“ Skipping code checks${NC}"
    echo ""
fi

# ==================== Final Report ====================

if [ "$CHECKS_FAILED" = true ]; then
    echo ""
    print_color "${RED}âœ— Pre-commit checks failed${NC}"
    echo ""
    echo "Fix the errors above and try again, or use:"
    echo "  git commit --no-verify -m 'message'"
    exit 1
fi

print_color "${GREEN}âœ… Pre-commit checks passed!${NC}"
