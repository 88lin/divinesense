import{u as e,j as t,bT as r,F as s,n as a,bo as n,c4 as o,r as i,b6 as l,b3 as d,a4 as c,M as m,c5 as u,m as p,c6 as x,s as g,c7 as h,p as b,c8 as f,c9 as j,aq as v,ah as y,ca as N,cb as k,aE as w,bF as C,bJ as M,bb as T,b7 as _,C as S,bR as D,$ as A,bY as I,aG as z,X as E,b8 as K}from"./react-vendor-LyyF-653.js";import{g as U}from"./mermaid-vendor-B1M2OtO5.js";import{n as R,aV as O,aW as L,G as $,af as B,aX as G,aY as P,aZ as F,a_ as Z,a$ as H,b0 as q,b1 as V,b2 as Q,r as W,W as J}from"./index-D99LTaa7.js";import{G as Y}from"./GenerativeUIContainer-BFWocgGj.js";import{t as X,w as ee}from"./markdown-vendor-DtAGkuPo.js";import"./ui-vendor-ByoYm48K.js";import"./leaflet-vendor-Cu4zZue4.js";import"./lodash-vendor-DIRPa7cU.js";import"./polyfills-RlNY0w59.js";import"./i18n-vendor-Cyfgqt0p.js";import"./math-vendor-JUchi9-2.js";function te({memos:i,schedules:l,insight:d,onMemoClick:c,onScheduleClick:m,className:u}){const{t:p}=e(),x=i.slice(0,3),g=l.slice(0,3);return 0===x.length&&0===g.length?null:t.jsxs("div",{className:R("rounded-2xl border border-purple-100 dark:border-purple-800/30","bg-white/80 dark:bg-zinc-800/50 backdrop-blur-sm","shadow-[0_4px_20px_-4px_rgba(139,92,246,0.1)] overflow-hidden",u),children:[t.jsxs("div",{className:"px-4 py-2.5 flex items-center justify-between border-b border-purple-50 dark:border-purple-800/20",children:[t.jsxs("h3",{className:"font-semibold text-sm text-purple-900 dark:text-purple-100 flex items-center gap-2",children:[t.jsx(r,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"}),p("ai.aichat.amazing-insight.title")]}),t.jsx("span",{className:"text-[11px] uppercase tracking-wider text-purple-400 font-medium",children:p("ai.aichat.amazing-insight.auto_generated")})]}),t.jsxs("div",{className:"grid grid-cols-2 divide-x divide-purple-50 dark:divide-purple-800/20",children:[t.jsxs("div",{className:"p-3",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-2 opacity-80",children:[t.jsx(s,{className:"w-3.5 h-3.5 text-purple-600 dark:text-purple-400"}),t.jsx("h4",{className:"font-medium text-[11px] uppercase tracking-wider text-zinc-500 dark:text-zinc-400",children:p("ai.aichat.amazing-insight.key-memos")})]}),0===x.length?t.jsx("p",{className:"text-xs text-zinc-400 dark:text-zinc-500 py-2 italic",children:p("ai.aichat.memo-query.no-results")}):t.jsx("ul",{className:"space-y-1.5",children:x.map(e=>t.jsx("li",{children:t.jsx(a,{to:`/memo/${e.uid}`,onClick:t=>{c&&(t.preventDefault(),c(e.uid))},className:"group block p-1.5 -m-1.5 rounded-lg hover:bg-purple-50/50 dark:hover:bg-purple-900/10 transition-colors",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-purple-300 dark:text-purple-600 mt-1 font-bold text-[10px]",children:"#"}),t.jsx("span",{className:"flex-1 text-xs text-zinc-600 dark:text-zinc-300 leading-relaxed group-hover:text-purple-700 dark:group-hover:text-purple-300 transition-colors break-words",children:e.content})]})})},e.uid))})]}),t.jsxs("div",{className:"p-3",children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-2 opacity-80",children:[t.jsx(n,{className:"w-3.5 h-3.5 text-purple-600 dark:text-purple-400"}),t.jsx("h4",{className:"font-medium text-[11px] uppercase tracking-wider text-zinc-500 dark:text-zinc-400",children:p("ai.aichat.amazing-insight.upcoming-events")})]}),0===g.length?t.jsx("p",{className:"text-xs text-zinc-400 dark:text-zinc-500 py-2 italic border-zinc-100 dark:border-zinc-800",children:p("schedule.no-schedules-this-period")}):t.jsx("ul",{className:"space-y-1.5",children:g.map(e=>t.jsx("li",{children:t.jsx("button",{onClick:()=>m?.(e),className:"group w-full block p-1.5 -m-1.5 rounded-lg text-left hover:bg-purple-50/50 dark:hover:bg-purple-900/10 transition-colors cursor-pointer",children:t.jsxs("div",{className:"flex items-start gap-2 text-wrap",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-purple-400 dark:bg-purple-500 shrink-0 shadow-[0_0_8px_rgba(167,139,250,0.5)] mt-1.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-[11px] font-bold text-purple-600 dark:text-purple-400 uppercase tracking-tighter",children:re(e,p)}),t.jsx("div",{className:"text-xs text-zinc-700 dark:text-zinc-300 group-hover:text-purple-700 dark:group-hover:text-purple-300 transition-colors break-words",children:e.title})]})]})})},e.uid))})]})]}),d&&t.jsx("div",{className:"px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 dark:from-purple-700 dark:to-indigo-700",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(o,{className:"w-4 h-4 text-white/90 mt-0.5 shrink-0"}),t.jsxs("p",{className:"text-sm text-white/95 leading-relaxed",children:[t.jsxs("span",{className:"font-medium",children:[p("ai.aichat.amazing-insight.insight-prefix"),":"]})," ",d]})]})})]})}function re(e,t){const r=U.unix(e.startTimestamp),s=U();let a="";a=r.isSame(s,"day")?"":r.isSame(s.add(1,"day"),"day")?"Tomorrow, ":r.diff(s,"day")<7?`${r.format("ddd")}, `:`${r.format("MM/DD")}, `;return`${a}${e.allDay?t("ai.amazing_insight.all_day"):r.format("h:mm A")}`}const se={sm:"w-9 h-9",md:"w-9 h-9 md:w-10 md:h-10",lg:"w-12 h-12 md:w-14 md:h-14",xl:"w-16 h-16 md:w-20 md:h-20"},ae={sm:"w-8 h-8",md:"w-8 h-8 md:w-9 md:h-9",lg:"w-10 h-10 md:w-12 md:h-12",xl:"w-14 h-14 md:w-16 md:h-16"},ne=i.memo(i.forwardRef(({src:e,alt:r,size:s="md",isThinking:a=!1,isTyping:n=!1,className:o,onClick:l},d)=>{const[c,m]=i.useState(!1),u=a||n||c;return t.jsxs("div",{ref:d,onClick:l,onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),className:R("relative flex items-center justify-center overflow-hidden cursor-pointer rounded-full transition-all duration-300 ease-out","shadow-md",c&&"scale-110 shadow-xl",a&&"animate-avatar-breathe",n&&"animate-avatar-pulse",u&&"will-change-transform",se[s],o),children:[t.jsx("div",{className:R("absolute inset-0 bg-gradient-to-br from-primary/20 to-primary/5 opacity-0 transition-opacity duration-300",(c||a||n)&&"opacity-100")}),n&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"absolute inset-0 rounded-xl border-2 border-primary/30 animate-avatar-wave"}),t.jsx("div",{className:"absolute inset-0 rounded-xl border-2 border-primary/20 animate-avatar-wave delay-100"}),t.jsx("div",{className:"absolute inset-0 rounded-xl border-2 border-primary/10 animate-avatar-wave delay-200"})]}),t.jsx("img",{src:e,alt:r,className:R("relative z-10 object-cover rounded-full transition-transform duration-300",ae[s],c&&"animate-avatar-tilt")}),(a||n)&&t.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-primary rounded-full border-2 border-background animate-pulse"})]})}));function oe({isThinking:r=!1,className:s,currentCapability:a=L.AUTO,capabilityStatus:n="idle",currentMode:o="normal",onModeChange:i,immersiveMode:m=!1,onImmersiveModeToggle:u,isAdmin:p=!0}){const{t:x}=e(),g=x("ai.assistant-name"),h=function(e,t,r){if("idle"===t)return null;if("thinking"===t)return r("ai.states.thinking");if("processing"===t)switch(e){case L.MEMO:return r("ai.parrot.status.searching-memos");case L.SCHEDULE:return r("ai.parrot.status.querying-schedule");case L.AMAZING:return r("ai.parrot.status.analyzing");default:return r("ai.processing")}return null}(a,n,x),b=function(e,t){switch(e){case"geek":return{border:"border-green-500/20",bg:"bg-green-50/50 dark:bg-green-950/20",text:"text-green-600 dark:text-green-400",name:"font-mono",avatarBorder:"border-green-500/30",avatarBg:"bg-green-500/10",statusText:"text-green-600 dark:text-green-400",statusDot:"bg-green-500",statusPrefix:t("ai.mode.geek_status"),thinking:"text-green-600 dark:text-green-400"};case"evolution":return{border:"border-purple-500/30",bg:"bg-purple-50/50 dark:bg-purple-950/20",text:"text-purple-600 dark:text-purple-400",name:"bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent",avatarBorder:"border-purple-500/40",avatarBg:"bg-purple-500/15",statusText:"text-purple-600 dark:text-purple-400",statusDot:"bg-purple-500",statusPrefix:t("ai.mode.evolution_status"),thinking:"text-purple-600 dark:text-purple-400"};default:return{border:"",bg:"",text:"",name:"",avatarBorder:"",avatarBg:"",statusText:"",statusDot:"",statusPrefix:"",thinking:"text-primary"}}}(o,x);return t.jsxs("header",{className:R("flex items-center justify-between px-4 h-14 shrink-0 transition-all","border-b border-border/80","bg-background/80 backdrop-blur-sm",b.border,b.bg,s),children:[t.jsxs("div",{className:"flex items-center gap-2.5",children:[t.jsx(ne,{src:"/assistant-avatar.webp",alt:g,size:"sm",isThinking:r,isTyping:r,className:R("rounded-lg",b.avatarBorder,b.avatarBg)}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("h1",{className:R("font-semibold text-foreground text-sm leading-tight",b.name),children:g}),h?t.jsxs("span",{className:R("text-xs flex items-center gap-1.5",b.statusText),children:["normal"!==o&&t.jsx("span",{className:R("w-1.5 h-1.5 rounded-full animate-pulse",b.statusDot)}),h]}):t.jsx("span",{className:R("text-xs text-muted-foreground",b.name,"normal"!==o&&"font-medium"),children:b.statusPrefix||x("ai.ready")})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[u&&t.jsx("button",{onClick:()=>u(!m),className:R("hidden lg:flex items-center justify-center w-8 h-8 rounded-lg transition-all","text-muted-foreground hover:text-foreground hover:bg-muted",m&&"text-primary bg-primary/10"),title:x(m?"ai.exit-immersive":"ai.enter-immersive"),children:m?t.jsx(l,{className:"w-4 h-4"}):t.jsx(d,{className:"w-4 h-4"})}),t.jsx(O,{currentMode:o,onModeChange:i??(()=>{}),variant:"header",isAdmin:p}),r&&t.jsx("div",{className:"flex items-center gap-1.5 text-sm",children:t.jsx(c,{className:R("w-4 h-4 animate-pulse",b.thinking)})})]})]})}function ie({value:r,onChange:s,onSend:a,onStop:n,onNewChat:o,onClearContext:l,onClearChat:d,onModeChange:c,disabled:b=!1,isTyping:f=!1,placeholder:j,className:v,showQuickActions:y=!1,quickActions:N,currentMode:k="normal"}){const{t:w}=e(),C=i.useRef(null),[M,T]=i.useState(0),_=i.useRef(0),S=i.useRef(null),D=i.useMemo(()=>"undefined"!=typeof window&&/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?"⌘+Enter":"Ctrl+Enter",[]);i.useEffect(()=>{if("undefined"==typeof window||!window.visualViewport)return;let e=null,t=0;const r=()=>{const r=window.visualViewport;if(!r)return;const s=r.height;Math.abs(s-t)<10||(t=s,e&&clearTimeout(e),e=setTimeout(()=>{const e=window.innerHeight;T(s<.85*e?e-s:0)},100))};return window.visualViewport.addEventListener("resize",r),()=>{e&&clearTimeout(e),window.visualViewport?.removeEventListener("resize",r)}},[]);const A=i.useCallback(e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),a())},[a]),I=i.useCallback(e=>{const t=e.target;S.current&&cancelAnimationFrame(S.current),S.current=requestAnimationFrame(()=>{if(!t||!C.current)return;const e=t.scrollHeight,r=Math.min(e,120);r!==_.current&&(_.current=r,t.style.height=`${r}px`),S.current=null})},[]);i.useEffect(()=>{C.current&&!r&&(C.current.style.height="auto")},[r]);const z=i.useMemo(()=>"geek"===k?w("ai.parrot.geek-chat-placeholder"):"evolution"===k?w("ai.parrot.evolution-chat-placeholder"):j||w("ai.parrot.chat-default-placeholder"),[k,j,w]),E=i.useMemo(()=>{switch(k){case"geek":return{border:"geek-border geek-terminal",input:"geek-mono placeholder:text-green-500/50",button:"geek-btn"};case"evolution":return{border:"evolution-border evolution-gradient",input:"evolution-mono placeholder:text-purple-500/50",button:"evolution-btn"};default:return{border:"",input:"",button:""}}},[k]);return t.jsx("div",{className:R("shrink-0 p-3 md:p-4 border-t border-border bg-background",v),style:{paddingBottom:M>0?`${M+16}px`:"max(16px, env(safe-area-inset-bottom))"},children:t.jsxs("div",{className:"max-w-3xl lg:max-w-4xl xl:max-w-5xl 2xl:max-w-6xl mx-auto",children:[y&&N,(o||l||d||c)&&t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[o&&t.jsxs($,{variant:"ghost",size:"sm",onClick:()=>o&&o(),"aria-label":w("ai.aichat.sidebar.new-chat"),className:"group/btn h-9 w-9 md:h-8 md:w-8 hover:w-auto px-0 hover:px-2 text-xs text-primary hover:text-primary hover:bg-accent transition-all overflow-hidden",title:"⌘N",children:[t.jsx(m,{className:"w-4 h-4 shrink-0"}),t.jsxs("span",{className:"hidden group-hover/btn:inline ml-1 whitespace-nowrap",children:[w("ai.aichat.sidebar.new-chat"),t.jsx("kbd",{className:"ml-1.5 px-1 py-0.5 text-[10px] bg-accent rounded",children:"⌘N"})]})]}),l&&t.jsxs($,{variant:"ghost",size:"sm",onClick:()=>l&&l(),"aria-label":w("ai.clear-context"),className:"group/btn h-9 w-9 md:h-8 md:w-8 hover:w-auto px-0 hover:px-2 text-xs text-muted-foreground hover:text-foreground hover:bg-muted transition-all overflow-hidden",title:"⌘K",children:[t.jsx(u,{className:"w-4 h-4 shrink-0"}),t.jsxs("span",{className:"hidden group-hover/btn:inline ml-1 whitespace-nowrap",children:[w("ai.clear-context"),t.jsx("kbd",{className:"ml-1.5 px-1 py-0.5 text-[10px] bg-muted rounded",children:"⌘K"})]})]}),d&&t.jsxs($,{variant:"ghost",size:"sm",onClick:()=>d&&d(),"aria-label":w("ai.clear-chat"),className:"group/btn h-9 w-9 md:h-8 md:w-8 hover:w-auto px-0 hover:px-2 text-xs text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-all overflow-hidden",title:"⌘L",children:[t.jsx(p,{className:"w-4 h-4 shrink-0"}),t.jsxs("span",{className:"hidden group-hover/btn:inline ml-1 whitespace-nowrap",children:[w("ai.clear-chat"),t.jsx("kbd",{className:"ml-1.5 px-1 py-0.5 text-[10px] bg-destructive/20 rounded",children:"⌘L"})]})]}),t.jsx("div",{className:"flex-1"}),t.jsxs("span",{className:"hidden sm:inline text-xs text-muted-foreground",children:[t.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded",children:"Enter"})," ",w("ai.input-hint-newline",{key:"Enter"})," ·",t.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded ml-1",children:D})," ",w("ai.input-hint-send",{key:D})]}),c&&"normal"!==k&&t.jsx("div",{className:"hidden md:block"})]}),!o&&!l&&!d&&!c&&t.jsx("div",{className:"flex items-center justify-end mb-2",children:t.jsxs("span",{className:"hidden sm:inline text-xs text-muted-foreground",children:[t.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded",children:"Enter"})," 换行 ·",t.jsx("kbd",{className:"px-1 py-0.5 bg-muted rounded ml-1",children:D})," 发送"]})}),t.jsxs("div",{className:R("flex items-end gap-2 md:gap-3 p-2.5 md:p-3 rounded-xl border","focus-within:ring-2 focus-within:ring-offset-2 shadow-sm","bg-card border-border focus-within:ring-ring",E.border),style:{contain:"layout"},children:[t.jsx(B,{ref:C,value:r,onChange:e=>{s(e.target.value),I(e)},onKeyDown:A,placeholder:z,disabled:b,className:R("flex-1 min-h-[44px] max-h-[120px] bg-transparent border-0 outline-none resize-none text-sm leading-relaxed","text-foreground placeholder:text-muted-foreground",E.input),rows:1}),t.jsx($,{size:"icon",className:R("shrink-0 h-11 min-w-[44px] rounded-xl transition-all","hover:scale-105 active:scale-95",f?"bg-destructive text-destructive-foreground hover:bg-destructive/90":r.trim()?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground","disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100",E.button),onClick:()=>{f&&n?n():a()},disabled:b||!f&&!r.trim(),"aria-label":f?"Stop generating":`${D} Send`,children:f?t.jsx(x,{className:"w-5 h-5 fill-current"}):"geek"===k&&r.trim()?t.jsx(g,{className:"w-5 h-5"}):"evolution"===k&&r.trim()?t.jsx(g,{className:"w-5 h-5 text-purple-500"}):t.jsx(h,{className:"w-5 h-5"})})]})]})})}ne.displayName="AnimatedAvatar";const le={[P.MEMO]:"memoFloat",[P.SCHEDULE]:"scheduleTick",[P.AMAZING]:"amazingSpin"},de=({active:e=!0,parrotId:r,variant:s="dots"})=>{const a=r&&G[r]||G.AMAZING;if(!e)return null;if("cursor"===s)return t.jsx("span",{className:"inline-flex items-center ml-1",children:t.jsx("span",{className:R("inline-block w-0.5 h-4 rounded-full animate-pulse",a.iconText.replace("text-","bg-")),style:{animationDuration:"800ms"}})});if("wave"===s)return t.jsx("span",{className:"inline-flex items-center gap-0.5 ml-2",children:[0,1,2].map(e=>t.jsx("span",{className:R("w-1 h-3 rounded-full",a.iconBg),style:{animation:"wave 1.2s ease-in-out infinite",animationDelay:.15*e+"s"}},e))});if("parrot"===s){const e=le[r||P.AMAZING];return t.jsx("span",{className:"inline-flex items-center gap-1 ml-2",children:[0,1,2].map(r=>t.jsx("span",{className:R("w-2 h-2 rounded-full inline-block",a.iconBg),style:{animation:`${e} 1.2s ease-in-out infinite`,animationDelay:.2*r+"s"}},r))})}return t.jsx("span",{className:"inline-flex items-center gap-1 ml-2",children:[0,1,2].map(e=>t.jsx("span",{className:R("w-2 h-2 rounded-full",a.iconBg,"animate-pulse"),style:{animationDuration:"1s",animationDelay:.2*e+"s"}},e))})},ce=i.memo(function({summary:r,className:s}){const{t:a}=e(),[n,o]=i.useState(!1),l=e=>e<1e3?`${e}ms`:e<6e4?`${(e/1e3).toFixed(2)}s`:`${(e/6e4).toFixed(1)}m`,d=e=>e>=1e6?`${(e/1e6).toFixed(2)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString(),c=(r.totalInputTokens||0)+(r.totalOutputTokens||0),m=(r.totalCacheReadTokens||0)+(r.totalCacheWriteTokens||0)+(r.totalInputTokens||0)+(r.totalOutputTokens||0),u=r.totalDurationMs||0,p=u>0&&r.thinkingDurationMs?Math.round(r.thinkingDurationMs/u*100):0,x=u>0&&r.toolDurationMs?Math.round(r.toolDurationMs/u*100):0,g=u>0&&r.generationDurationMs?Math.round(r.generationDurationMs/u*100):0,h="error"===r.status?.toLowerCase()?"text-red-600 dark:text-red-400":"cancelled"===r.status?.toLowerCase()?"text-amber-600 dark:text-amber-400":"text-emerald-600 dark:text-emerald-400";return t.jsxs("div",{className:R("rounded-xl border overflow-hidden","bg-gradient-to-br from-slate-50 to-slate-100/50 dark:from-slate-900/50 dark:to-slate-950/50","border-slate-200 dark:border-slate-700",s),children:[t.jsxs("div",{className:R("flex items-center justify-between px-4 py-3","lg:cursor-pointer lg:hover:bg-slate-100/50 dark:lg:hover:bg-slate-800/50","transition-colors"),onClick:()=>o(!n),children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:R("flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-semibold",h,"bg-current/10"),children:["error"===r.status?.toLowerCase()?t.jsx("span",{children:"✗"}):"cancelled"===r.status?.toLowerCase()?t.jsx("span",{children:"⚠"}):t.jsx("span",{children:"✓"}),t.jsx("span",{className:"capitalize",children:r.status||a("ai.session_stats.status-success")})]}),t.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[u>0&&t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(b,{className:"w-3.5 h-3.5"}),t.jsx("span",{className:"font-mono font-medium",children:l(u)})]}),c>0&&t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(f,{className:"w-3.5 h-3.5 text-amber-500"}),t.jsx("span",{className:"font-mono font-medium",children:d(c)})]}),r.totalCostUSD&&r.totalCostUSD>0&&t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(j,{className:"w-3.5 h-3.5 text-green-500"}),t.jsxs("span",{className:"font-mono font-medium",children:[a("ai.session_stats.currency_symbol"),r.totalCostUSD.toFixed(4)]})]})]})]}),t.jsx("button",{type:"button",className:"hidden lg:block p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors",onClick:e=>{e.stopPropagation(),o(!n)},"aria-label":a(n?"ai.session_stats.collapse":"ai.session_stats.expand"),children:n?t.jsx(v,{className:"w-4 h-4 text-muted-foreground"}):t.jsx(y,{className:"w-4 h-4 text-muted-foreground"})})]}),n&&t.jsx("div",{className:"hidden lg:block",children:t.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[r.sessionId&&t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-muted-foreground",children:a("ai.session_stats.session_id")}),t.jsx("span",{className:"font-mono text-muted-foreground/70 select-all break-all",children:r.sessionId})]}),u>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-muted-foreground font-medium",children:a("ai.session_stats.duration_breakdown")}),t.jsxs("span",{className:"font-mono text-muted-foreground",children:[l(u)," ",a("ai.session_stats.total")]})]}),t.jsxs("div",{className:"h-6 rounded-full overflow-hidden flex bg-slate-200 dark:bg-slate-700",children:[r.thinkingDurationMs&&r.thinkingDurationMs>0&&t.jsx("div",{className:"bg-blue-500/80 flex items-center justify-center text-[10px] text-white font-medium",style:{width:`${p}%`},title:`${a("ai.session_stats.thinking")}: ${l(r.thinkingDurationMs)}`,children:p>=10&&t.jsx(N,{className:"w-3 h-3"})}),r.toolDurationMs&&r.toolDurationMs>0&&t.jsx("div",{className:"bg-purple-500/80 flex items-center justify-center text-[10px] text-white font-medium",style:{width:`${x}%`},title:`${a("ai.session_stats.tool_execution")}: ${l(r.toolDurationMs)}`,children:x>=10&&t.jsx(k,{className:"w-3 h-3"})}),r.generationDurationMs&&r.generationDurationMs>0&&t.jsx("div",{className:"bg-emerald-500/80 flex items-center justify-center text-[10px] text-white font-medium",style:{width:`${g}%`},title:`${a("ai.session_stats.generation")}: ${l(r.generationDurationMs)}`,children:g>=10&&t.jsx(w,{className:"w-3 h-3"})})]}),t.jsxs("div",{className:"flex flex-wrap gap-3 text-xs",children:[r.thinkingDurationMs&&r.thinkingDurationMs>0&&t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500/80"}),t.jsxs("span",{className:"text-muted-foreground",children:[a("ai.session_stats.thinking"),": ",l(r.thinkingDurationMs)]})]}),r.toolDurationMs&&r.toolDurationMs>0&&t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-purple-500/80"}),t.jsxs("span",{className:"text-muted-foreground",children:[a("ai.session_stats.tools"),": ",l(r.toolDurationMs)]})]}),r.generationDurationMs&&r.generationDurationMs>0&&t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500/80"}),t.jsxs("span",{className:"text-muted-foreground",children:[a("ai.session_stats.generation"),": ",l(r.generationDurationMs)]})]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[(void 0!==r.totalInputTokens||void 0!==r.totalOutputTokens)&&t.jsxs("div",{className:"p-3 rounded-lg bg-amber-50/50 dark:bg-amber-900/10 border border-amber-200/50 dark:border-amber-700/30",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(f,{className:"w-4 h-4 text-amber-500"}),t.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:a("ai.session_stats.tokens")})]}),t.jsxs("div",{className:"space-y-1",children:[(r.totalCacheReadTokens||0)>0&&t.jsxs("div",{className:"flex justify-between text-xs items-center",children:[t.jsxs("span",{className:"text-green-600 dark:text-green-400 flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-500"}),a("ai.session_stats.cache_read_discount")]}),t.jsx("span",{className:"font-mono text-green-600 dark:text-green-400",children:d(r.totalCacheReadTokens||0)})]}),(r.totalCacheWriteTokens||0)>0&&t.jsxs("div",{className:"flex justify-between text-xs items-center",children:[t.jsxs("span",{className:"text-amber-600 dark:text-amber-400 flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-amber-500"}),a("ai.session_stats.cache_write_premium")]}),t.jsx("span",{className:"font-mono text-amber-600 dark:text-amber-400",children:d(r.totalCacheWriteTokens||0)})]}),(r.totalInputTokens||0)>0&&t.jsxs("div",{className:"flex justify-between text-xs items-center",children:[t.jsxs("span",{className:"text-muted-foreground/70 flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-amber-500"}),a("ai.session_stats.new_input")]}),t.jsx("span",{className:"font-mono",children:d(r.totalInputTokens||0)})]}),(r.totalOutputTokens||0)>0&&t.jsxs("div",{className:"flex justify-between text-xs items-center",children:[t.jsxs("span",{className:"text-muted-foreground/70 flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-amber-500"}),a("ai.session_stats.output")]}),t.jsx("span",{className:"font-mono",children:d(r.totalOutputTokens||0)})]}),t.jsxs("div",{className:"pt-1 border-t border-amber-200/30 dark:border-amber-700/30 flex justify-between text-xs font-medium",children:[t.jsx("span",{className:"text-muted-foreground",children:a("ai.session_stats.total_processed")}),t.jsx("span",{className:"font-mono text-amber-600 dark:text-amber-400",children:d(m)})]})]})]}),void 0!==r.totalCostUSD&&r.totalCostUSD>=0&&t.jsxs("div",{className:"p-3 rounded-lg bg-green-50/50 dark:bg-green-900/10 border border-green-200/50 dark:border-green-700/30",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(j,{className:"w-4 h-4 text-green-500"}),t.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:a("ai.session_stats.total_cost")})]}),t.jsxs("span",{className:"text-2xl font-mono font-bold text-green-600 dark:text-green-400",children:[a("ai.session_stats.currency_symbol"),r.totalCostUSD.toFixed(4)]})]}),c>0&&t.jsxs("div",{className:"text-[10px] text-muted-foreground text-center",children:[a("ai.session_stats.currency_symbol"),(r.totalCostUSD/c*1e3).toFixed(4)," ",a("ai.session_stats.per_1k_tokens")]}),m>0&&(r.totalCacheReadTokens||0)>0&&t.jsx("div",{className:"mt-2 pt-2 border-t border-green-200/30 dark:border-green-700/30",children:t.jsxs("div",{className:"flex items-center justify-between text-[11px]",children:[t.jsx("span",{className:"text-muted-foreground",children:a("ai.session_stats.cache_hit_rate")}),t.jsxs("span",{className:"font-mono text-green-600 dark:text-green-400",children:[Math.round((r.totalCacheReadTokens||0)/m*100),a("ai.session_stats.percent")]})]})})]}),void 0!==r.toolCallCount&&r.toolCallCount>0&&t.jsxs("div",{className:"p-3 rounded-lg bg-purple-50/50 dark:bg-purple-900/10 border border-purple-200/50 dark:border-purple-700/30",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(k,{className:"w-4 h-4 text-purple-500"}),t.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:a("ai.session_stats.tool_calls")})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("span",{className:"text-2xl font-mono font-bold text-purple-600 dark:text-purple-400",children:r.toolCallCount}),r.toolDurationMs&&t.jsxs("div",{className:"text-[11px] text-muted-foreground mt-1",children:[a("ai.session_stats.avg"),": ",l(r.toolDurationMs/r.toolCallCount)," ",a("ai.session_stats.per_call")]})]}),r.toolsUsed&&r.toolsUsed.length>0&&t.jsx("div",{className:"mt-2 pt-2 border-t border-purple-200/30 dark:border-purple-700/30",children:t.jsx("div",{className:"flex flex-wrap gap-1",children:r.toolsUsed.map(e=>t.jsx("span",{className:"px-2 py-0.5 rounded-full text-[11px] font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300",children:e},e))})})]}),void 0!==r.filesModified&&r.filesModified>0&&t.jsxs("div",{className:"p-3 rounded-lg bg-emerald-50/50 dark:bg-emerald-900/10 border border-emerald-200/50 dark:border-emerald-700/30",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(C,{className:"w-4 h-4 text-emerald-500"}),t.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:a("ai.session_stats.files_modified")})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("span",{className:"text-2xl font-mono font-bold text-emerald-600 dark:text-emerald-400",children:r.filesModified}),r.filePaths&&r.filePaths.length>0&&t.jsx("div",{className:"mt-2 text-[10px] text-muted-foreground",children:t.jsx("div",{className:"max-h-16 overflow-y-auto space-y-0.5",children:r.filePaths.map((e,r)=>t.jsx("div",{className:"truncate font-mono",title:e,children:e},r))})})]})]})]})]})})]})}),me={default:{border:"border-zinc-200 dark:border-zinc-700",headerBg:"bg-zinc-50 dark:bg-zinc-900/50",footerBg:"bg-zinc-200/80 dark:bg-zinc-800/60",badgeBg:"bg-zinc-100 dark:bg-zinc-800",badgeText:"text-zinc-600 dark:text-zinc-400",ringColor:"ring-primary/20"},MEMO:{border:"border-slate-200 dark:border-slate-700",headerBg:"bg-slate-50 dark:bg-slate-900/50",footerBg:"bg-slate-200/80 dark:bg-slate-800/60",badgeBg:"bg-slate-100 dark:bg-slate-800",badgeText:"text-slate-600 dark:text-slate-400",ringColor:"ring-slate-500/20"},SCHEDULE:{border:"border-cyan-200 dark:border-cyan-700",headerBg:"bg-cyan-50 dark:bg-cyan-900/20",footerBg:"bg-cyan-200/80 dark:bg-cyan-800/50",badgeBg:"bg-cyan-100 dark:bg-cyan-900/30",badgeText:"text-cyan-600 dark:text-cyan-400",ringColor:"ring-cyan-500/20"},AMAZING:{border:"border-emerald-200 dark:border-emerald-700",headerBg:"bg-emerald-50 dark:bg-emerald-900/20",footerBg:"bg-emerald-200/80 dark:bg-emerald-800/50",badgeBg:"bg-emerald-100 dark:bg-emerald-900/30",badgeText:"text-emerald-600 dark:text-emerald-400",ringColor:"ring-emerald-500/20"},GEEK:{border:"border-violet-200 dark:border-violet-700",headerBg:"bg-violet-50 dark:bg-violet-900/20",footerBg:"bg-violet-200/80 dark:bg-violet-800/50",badgeBg:"bg-violet-100 dark:bg-violet-900/30",badgeText:"text-violet-600 dark:text-violet-400",ringColor:"ring-violet-500/20"},EVOLUTION:{border:"border-rose-200 dark:border-rose-700",headerBg:"bg-rose-50 dark:bg-rose-900/20",footerBg:"bg-rose-200/80 dark:bg-rose-800/50",badgeBg:"bg-rose-100 dark:bg-rose-900/30",badgeText:"text-rose-600 dark:text-rose-400",ringColor:"ring-rose-500/20"}};function ue(e,t){const r=new Date(e),s=(new Date).getTime()-r.getTime(),a=Math.floor(s/6e4);return a<1?t("ai.aichat.sidebar.time-just-now"):a<60?t("ai.aichat.sidebar.time-minutes-ago",{count:a}):a<1440?t("ai.aichat.sidebar.time-hours-ago",{count:Math.floor(a/60)}):r.toLocaleDateString(void 0,{month:"short",day:"numeric"})}function pe(e,t){let r=0,s="";for(const a of e){const e=(a.codePointAt(0)||0)<128?1:2;if(r+e>t)return s+"...";s+=a,r+=e}return s}function xe(e,t){return!t&&!e}function ge({userMessage:r,assistantMessage:s,sessionSummary:a,parrotId:n,theme:o,onToggle:l,isCollapsed:d,isStreaming:c,additionalUserInputs:m=[]}){const{t:u}=e(),p=function(e){const t=e.trim();if(0===t.length)return"U";const r=t.match(/[a-zA-Z\u4e00-\u9fa5]/);return r?r[0].toUpperCase():"U"}(r.content),x=i.useMemo(()=>{const e=[r.content,...m.map(e=>e.content)],t=e[0].split("\n")[0];if(1===e.length){return function(e){let t=0;const r=[...e];for(let s=0;s<r.length;s++){const e=r[s].codePointAt(0)||0;8203===e||65038===e||65039===e||e>=127995&&e<=127999||(t+=e<128?1:2)}return t}(t)>24?pe(t,24):t}const s=pe(t,20);return 2===e.length?`${s} +1`:`${s} +${e.length-1}`},[r.content,m]),g=i.useMemo(()=>1+m.length,[m.length]),h=i.useMemo(()=>c?"border-l-4 border-l-blue-500/50 dark:border-l-blue-400":s?.error?"border-l-4 border-l-red-500 dark:border-l-red-400":"border-l-4 border-l-transparent",[c,s]),f=i.useMemo(()=>{if(!a||"GEEK"!==n&&"EVOLUTION"!==n)return null;return{cost:a.totalCostUSD?`$${a.totalCostUSD.toFixed(4)}`:"",tokens:a.totalInputTokens&&a.totalOutputTokens?`${((a.totalInputTokens+a.totalOutputTokens)/1e3).toFixed(1)}k token`:"",time:a.totalDurationMs?`${(a.totalDurationMs/1e3).toFixed(1)}s`:""}},[a,n]);return t.jsxs("div",{className:R("flex items-center justify-between px-4 py-2.5 select-none cursor-pointer transition-colors duration-200",o.headerBg,h),onClick:l,children:[t.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"w-7 h-7 rounded-full bg-slate-800 dark:bg-slate-300 flex items-center justify-center text-white dark:text-slate-800 text-xs font-medium shrink-0 shadow-sm",children:p}),g>1&&t.jsx("div",{className:"absolute -top-1 -right-1 min-w-[16px] h-4 px-0.5 rounded-full bg-blue-500 flex items-center justify-center text-[10px] font-bold text-white border-2 border-background shadow-sm",children:g})]}),t.jsx("div",{className:"min-w-0 flex-1",children:t.jsx("p",{className:"text-sm font-medium text-foreground truncate",title:r.content,children:x})})]}),t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 shrink-0 ml-1 sm:ml-2",children:[f&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"hidden lg:flex items-center gap-3 text-[11px] font-mono opacity-70 mr-1 bg-muted/50 px-2 py-1 rounded border border-border/50",children:[t.jsx("span",{className:"font-semibold text-muted-foreground/80 uppercase tracking-wider text-[11px]",children:u("ai.unified_block.session")}),f.time&&t.jsxs("span",{className:"flex items-center gap-1",title:u("ai.unified_block.session_duration"),children:[t.jsx(b,{className:"w-3 h-3"})," ",f.time]}),f.tokens&&t.jsxs("span",{className:"flex items-center gap-1",title:u("ai.unified_block.session_tokens"),children:[t.jsx(N,{className:"w-3 h-3"})," ",f.tokens]}),f.cost&&t.jsxs("span",{className:"flex items-center gap-1 text-green-600 dark:text-green-400",title:u("ai.unified_block.session_cost"),children:[t.jsx("span",{className:"font-bold",children:"$"})," ",f.cost]})]}),t.jsxs("div",{className:"lg:hidden flex items-center gap-1 text-[10px] font-mono opacity-80",children:[f.cost&&t.jsxs("span",{className:"flex items-center gap-0.5 text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 px-1.5 py-0.5 rounded",children:[t.jsx("span",{className:"font-bold",children:"$"}),f.cost]}),!f.cost&&f.tokens&&t.jsx("span",{className:"text-muted-foreground",children:f.tokens})]})]}),t.jsxs("div",{className:R("flex items-center gap-1 text-xs",o.badgeText),children:[t.jsx(b,{className:"w-3 h-3"}),t.jsx("span",{children:ue(r.timestamp,u)})]}),("GEEK"===n||"EVOLUTION"===n||"AMAZING"===n)&&t.jsx("span",{className:R("inline-flex px-2 py-0.5 rounded-full text-xs font-medium",o.badgeBg,o.badgeText),children:u("GEEK"===n?"ai.mode.geek":"EVOLUTION"===n?"ai.mode.evolution":"ai.mode.normal")}),t.jsx("button",{type:"button",className:R("p-1 rounded transition-colors","hover:bg-black/10 dark:hover:bg-white/10","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",o.badgeText),onClick:e=>{e.stopPropagation(),l()},"aria-label":u(d?"common.expand":"common.collapse"),"aria-expanded":!d,children:d?t.jsx(y,{className:"w-4 h-4"}):t.jsx(v,{className:"w-4 h-4"})})]})]})}function he({userMessage:r,additionalUserInputs:s=[],isCollapsed:a}){const{t:n}=e(),[o,l]=i.useState(!1),d=i.useMemo(()=>[r,...s],[r,s]),c=d.length>1,m=d.reduce((e,t)=>e+t.content.length,0)>300,u=!m||o;return a?null:t.jsxs("div",{className:"relative group",children:[t.jsx("div",{className:"absolute -left-8 top-1 w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/40 border border-blue-500 flex items-center justify-center shrink-0 z-10 transition-colors group-hover:bg-blue-200 dark:group-hover:bg-blue-900/60",children:t.jsx(I,{className:"w-3.5 h-3.5 text-blue-600 dark:text-blue-400"})}),t.jsx("div",{className:"flex items-center justify-end mb-3",children:(m||c)&&t.jsx("button",{type:"button",onClick:()=>l(!o),className:"text-xs text-muted-foreground hover:text-foreground transition-colors flex items-center gap-1 px-2 py-1 rounded hover:bg-muted/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:o?t.jsxs(t.Fragment,{children:[t.jsx(v,{className:"w-3.5 h-3.5"}),n("common.collapse")||"收起"]}):t.jsxs(t.Fragment,{children:[t.jsx(y,{className:"w-3.5 h-3.5"}),n("common.expand")||"展开"]})})}),t.jsx("div",{className:"space-y-3",children:u?d.map((e,r)=>t.jsx("div",{className:R("rounded-lg border p-3 transition-colors","bg-muted/20 border-border/50 hover:border-border"),children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"flex-shrink-0 w-5 h-5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-xs font-medium",children:r+1}),t.jsx("div",{className:"flex-1 min-w-0",children:t.jsx("div",{className:"text-sm text-foreground whitespace-pre-wrap break-words",children:e.content})})]})},e.id)):t.jsxs("button",{type:"button",onClick:()=>l(!0),className:"w-full text-left rounded-lg border p-3 bg-muted/20 border-border/50 cursor-pointer hover:bg-muted/30 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[t.jsxs("div",{className:"text-sm text-muted-foreground line-clamp-3 italic",children:[d.map(e=>e.content.split("\n")[0]).join(" "),"..."]}),t.jsxs("div",{className:"text-xs text-muted-foreground/60 mt-2 flex items-center gap-1",children:[t.jsx(y,{className:"w-3 h-3"}),n("ai.unified_block.expand_to_read_all")||"点击展开查看全部内容"]})]})})]})}function be({userMessage:r,additionalUserInputs:s=[],assistantMessage:a,sessionSummary:n,isCollapsed:o,themeColors:l,streamingPhase:d=null,isLatest:c=!1,children:m}){const{t:u}=e(),p=i.useRef(null),x=a?.error,h=a?.metadata?.thinkingSteps||[],b=a?.metadata?.toolCalls||[],j=a?.metadata?.toolResults||[],w=a?.content,C=i.useMemo(()=>{const e=["处理中...","Thinking...","...","AI is thinking","思考中"];return h.map(e=>e.content?.trim()||"").filter(t=>t&&!e.some(e=>t===e||t.startsWith(e))).join("\n\n")},[h]),[A,I]=i.useState(()=>c&&C.length>0);i.useEffect(()=>{c&&C.length>0&&"thinking"===d&&I(!0)},[C.length,c,d]);const z=[];C.length>0&&z.push({type:"thinking",id:"thinking-group",timestamp:h[0]?.timestamp||0,data:{content:C},isFirst:!0}),b.forEach((e,t)=>{const r=("object"==typeof e?e.round:0)||0,s=1e6*r+1e3*t;z.push({type:"tool_call",id:`toolcall-${r}-${t}`,timestamp:s,data:e})}),z.sort((e,t)=>e.timestamp-t.timestamp);const E=z.map((e,t)=>"tool_call"===e.type?t:-1).filter(e=>e>=0).pop();return o?t.jsx("div",{className:"px-4 py-2 text-sm text-muted-foreground italic",children:u("ai.unified_block.collapsed")}):t.jsx("div",{className:"px-4 py-4",children:t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"absolute left-[11px] top-2 bottom-4 w-px bg-border/60"}),t.jsxs("div",{className:"relative pl-8 space-y-6",children:[(r||s.length>0)&&t.jsx(he,{userMessage:r||{id:"",role:"user",content:"",timestamp:Date.now()},additionalUserInputs:s,isCollapsed:o}),C.length>0&&t.jsxs("div",{className:"relative group",children:[t.jsx("div",{className:R("absolute -left-8 top-0.5 w-6 h-6 rounded-full flex items-center justify-center shrink-0 z-10 transition-colors","thinking"===d?"bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 ring-4 ring-blue-50 dark:ring-blue-900/10":"bg-muted text-muted-foreground group-hover:bg-blue-50 dark:group-hover:bg-blue-900/20 group-hover:text-blue-500"),children:"thinking"===d?t.jsx(M,{className:"w-3.5 h-3.5 animate-spin"}):t.jsx(N,{className:"w-3.5 h-3.5"})}),t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("button",{onClick:()=>I(!A),className:"flex items-center gap-2 text-sm font-medium text-foreground hover:text-blue-600 dark:hover:text-blue-400 transition-colors text-left w-full focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded",children:[t.jsx("span",{className:"flex items-center gap-2",children:"thinking"===d?t.jsxs(t.Fragment,{children:[t.jsx(M,{className:"w-3.5 h-3.5 animate-spin text-blue-500"}),t.jsx("span",{className:"text-blue-600 dark:text-blue-400",children:u("ai.states.thinking")||"思考中..."})]}):t.jsxs(t.Fragment,{children:[t.jsx(N,{className:"w-3.5 h-3.5 text-muted-foreground"}),t.jsx("span",{className:"text-muted-foreground",children:u("ai.unified_block.thinking_process")||"思考过程"})]})}),t.jsx("span",{className:"ml-auto",children:A?t.jsx(v,{className:"w-4 h-4 text-muted-foreground"}):t.jsx(y,{className:"w-4 h-4 text-muted-foreground"})})]}),A&&t.jsx("div",{className:"mt-2 text-sm text-muted-foreground bg-muted/30 p-3 rounded-lg border border-border/50 animate-in fade-in slide-in-from-top-1 duration-200 prose prose-xs dark:prose-invert max-w-none",children:t.jsx(T,{children:C})})]})]}),z.map((e,r)=>{if("tool_call"!==e.type)return null;const s="tools"===d&&r===E,n=e.data,o="string"==typeof n?n:n.name,i=j.find(e=>e.name===o||"object"==typeof n&&n.toolId&&e.toolId===n.toolId),l="object"==typeof n?n.isError:a?.error,c=["write","edit","bash","run_command"].some(e=>o.toLowerCase().includes(e));return t.jsxs("div",{className:"relative group",children:[t.jsx("div",{className:R("absolute -left-8 top-0 w-6 h-6 rounded-full flex items-center justify-center shrink-0 z-10 border transition-all",s?"bg-purple-100 dark:bg-purple-900/40 border-purple-500 animate-pulse":"bg-card border-border group-hover:border-purple-400/50",l&&"bg-red-50 border-red-200"),children:s?t.jsx(M,{className:"w-3 h-3 text-purple-600 animate-spin"}):t.jsx(k,{className:R("w-3 h-3",l?"text-red-500":"text-muted-foreground group-hover:text-purple-500")})}),t.jsxs("div",{className:R("rounded-lg border overflow-hidden transition-all duration-200","bg-card hover:shadow-sm",c?"border-purple-200/50 dark:border-purple-800/30 bg-purple-50/10":"border-border/50"),children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-muted/20 text-xs",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:R("font-semibold",c?"text-purple-700 dark:text-purple-300":"text-foreground"),children:o}),"object"==typeof n&&n.duration&&t.jsx("span",{className:"text-[11px] text-muted-foreground bg-background/50 px-1.5 py-0.5 rounded",children:n.duration>1e3?`${(n.duration/1e3).toFixed(1)}s`:`${n.duration}ms`})]}),"object"==typeof n&&n.filePath&&t.jsx("span",{className:"font-mono text-[11px] text-muted-foreground truncate max-w-[150px]",title:n.filePath,children:n.filePath})]}),"object"==typeof n&&n.inputSummary&&t.jsxs("div",{className:"px-3 py-2 border-t border-border/30 bg-background/50",children:[t.jsx("div",{className:"text-[11px] uppercase text-muted-foreground font-semibold mb-0.5",children:u("ai.unified_block.input")}),t.jsx("code",{className:"text-xs text-muted-foreground/80 font-mono break-all line-clamp-2 hover:line-clamp-none transition-all",children:n.inputSummary})]}),i&&i.outputSummary&&t.jsxs("div",{className:"px-3 py-2 border-t border-border/30 bg-muted/10",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsxs("div",{className:"text-[11px] uppercase text-muted-foreground font-semibold flex items-center gap-1",children:[t.jsx(g,{className:"w-3 h-3"})," ",u("ai.unified_block.output")]}),i.isError&&t.jsx("span",{className:"text-[11px] bg-red-100 text-red-600 px-1.5 rounded font-medium",children:u("ai.events.error")})]}),t.jsx("pre",{className:R("text-xs font-mono overflow-x-auto whitespace-pre-wrap break-words max-h-32 overflow-y-auto p-1.5 rounded bg-black/5 dark:bg-black/20 text-muted-foreground",i.isError&&"text-red-600/90 bg-red-50/50"),children:i.outputSummary})]})]})]},e.id)}),w?t.jsxs("div",{className:"relative pt-2",children:[t.jsx("div",{className:R("absolute -left-8 top-3.5 w-6 h-6 rounded-full flex items-center justify-center shrink-0 z-10 transition-colors","answer"===d?"bg-amber-100 dark:bg-amber-900/40 border border-amber-500 animate-pulse text-amber-600":"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700/50 text-amber-500"),children:"answer"===d?t.jsx(M,{className:"w-3.5 h-3.5 animate-spin"}):t.jsx(f,{className:"w-3.5 h-3.5"})}),t.jsxs("div",{className:R("relative rounded-xl shadow-sm transition-colors",l.bubbleBg,l.bubbleBorder,l.text),children:[t.jsx("div",{className:"absolute top-2 right-2 z-30 opacity-0 group-hover:opacity-100 transition-opacity",children:t.jsx("button",{onClick:()=>{a&&navigator.clipboard.writeText(a.content)},className:"p-1.5 rounded-md bg-background/50 hover:bg-background border border-border/50 text-muted-foreground shadow-sm transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",title:u("common.copy"),children:t.jsx(_,{className:"w-3.5 h-3.5"})})}),t.jsx("div",{ref:p,className:"px-5 py-4",children:t.jsxs("div",{className:"prose prose-sm dark:prose-invert max-w-none break-words leading-normal font-sans text-[15px]",children:[t.jsx(T,{remarkPlugins:[X,ee],components:{a:({node:e,...r})=>t.jsx("a",{...r,className:"text-blue-500 hover:underline",target:"_blank",rel:"noopener noreferrer"}),p:({node:e,...r})=>t.jsx("p",{...r,className:"mb-1 last:mb-0 text-sm leading-relaxed"}),ul:({node:e,...r})=>t.jsx("ul",{...r,className:"list-disc pl-5 mb-2 space-y-1"}),ol:({node:e,...r})=>t.jsx("ol",{...r,className:"list-decimal pl-5 mb-2 space-y-1"}),li:({node:e,...r})=>t.jsx("li",{...r,className:"pl-1"}),h1:({node:e,...r})=>t.jsx("h1",{...r,className:"text-xl font-bold mb-2 mt-4 first:mt-0"}),h2:({node:e,...r})=>t.jsx("h2",{...r,className:"text-lg font-bold mb-2 mt-3"}),h3:({node:e,...r})=>t.jsx("h3",{...r,className:"text-base font-bold mb-1 mt-2"}),blockquote:({node:e,...r})=>t.jsx("blockquote",{...r,className:"border-l-4 border-primary/30 pl-4 py-1 my-2 bg-muted/30 italic rounded-r-lg"}),table:({node:e,...r})=>t.jsx("div",{className:"my-4 w-full overflow-x-auto rounded-lg border border-border shadow-sm",children:t.jsx("table",{className:"w-full text-sm",...r})}),thead:({node:e,...r})=>t.jsx("thead",{className:"bg-muted/50 text-xs uppercase",...r}),tbody:({node:e,...r})=>t.jsx("tbody",{className:"divide-y divide-border",...r}),tr:({node:e,...r})=>t.jsx("tr",{className:"hover:bg-muted/50 transition-colors",...r}),th:({node:e,...r})=>t.jsx("th",{className:"px-4 py-2.5 text-left font-medium text-muted-foreground tracking-wider",...r}),td:({node:e,...r})=>t.jsx("td",{className:"px-4 py-2.5 whitespace-pre-wrap",...r}),pre:({node:e,...r})=>t.jsx(F,{...r,hideCopy:!0}),code:({className:e,children:r,inline:s,...a})=>s?t.jsx("code",{className:R("px-1.5 py-0.5 rounded-md bg-muted/80 font-mono text-xs text-secondary-foreground",e),...a,children:r}):t.jsx("code",{className:e,...a,children:r})},children:a.content||u("ai.states.thinking")}),m]})})]})]}):(c||m)&&t.jsx("div",{className:"relative pt-2 px-1 animate-in fade-in duration-300",children:t.jsx("div",{className:"flex items-center gap-3 text-muted-foreground",children:m?t.jsx("div",{className:"scale-90 origin-left",children:m}):t.jsxs(t.Fragment,{children:[t.jsx(M,{className:"w-4 h-4 animate-spin text-muted-foreground/50"}),t.jsx("span",{className:"text-sm italic opacity-70",children:u("ai.states.initializing")})]})})}),x&&t.jsxs("div",{className:"relative group",children:[t.jsx("div",{className:"absolute -left-8 top-1 w-6 h-6 rounded-full bg-red-100 dark:bg-red-900/30 border border-red-500 flex items-center justify-center shrink-0 z-10 transition-colors group-hover:bg-red-200 dark:group-hover:bg-red-900/50",children:t.jsx(S,{className:"w-3.5 h-3.5 text-red-600 dark:text-red-400"})}),t.jsxs("div",{className:"p-3 rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800/30 text-sm",children:[t.jsx("p",{className:"font-semibold text-red-700 dark:text-red-300 flex items-center gap-2",children:u("ai.unified_block.error_occurred")}),t.jsx("p",{className:"mt-1 text-red-600/80 dark:text-red-400/80 font-mono text-xs break-all",children:a.error})]})]}),n&&t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"absolute -left-8 top-1 w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 border border-green-500 flex items-center justify-center shrink-0 z-10 transition-colors",children:t.jsx(D,{className:"w-3.5 h-3.5 text-green-600 dark:text-green-400"})}),t.jsx("div",{className:"pl-0",children:t.jsx(ce,{summary:n})})]})]})]})})}function fe({isCollapsed:r,onToggle:s,onCopy:a,onRegenerate:n,onDelete:o,theme:l}){const{t:d}=e(),[c,m]=i.useState(!1),u=i.useRef(null),p=i.useCallback(()=>{a(),m(!0),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{m(!1),u.current=null},2e3)},[a]);return i.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]),t.jsxs("div",{className:R("flex items-center justify-between px-4 py-2 border-t",l.border,l.footerBg),children:[t.jsxs("button",{type:"button",onClick:s,className:R("flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors","hover:bg-black/10 dark:hover:bg-white/10","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",l.badgeText),children:[r?t.jsx(y,{className:"w-3.5 h-3.5"}):t.jsx(v,{className:"w-3.5 h-3.5"}),d(r?"common.expand":"common.collapse")]}),t.jsxs("div",{className:"flex items-center gap-2",children:[n&&t.jsx("button",{type:"button",onClick:n,className:R("px-3 py-1.5 rounded-lg text-xs font-medium transition-colors","hover:bg-black/10 dark:hover:bg-white/10","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",l.badgeText),children:d("ai.regenerate")}),t.jsxs("button",{type:"button",className:R("flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors opacity-60 hover:opacity-100","hover:bg-black/10 dark:hover:bg-white/10","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:opacity-100",l.badgeText),title:d("ai.unified_block.forget_tooltip"),children:[t.jsx(N,{className:"w-3.5 h-3.5"}),t.jsx("span",{className:"hidden lg:inline",children:d("ai.unified_block.forget")})]}),t.jsxs("button",{type:"button",onClick:p,className:R("flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors","hover:bg-black/10 dark:hover:bg-white/10","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",c&&"bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400",!c&&l.badgeText),children:[c?t.jsx(A,{className:"w-3.5 h-3.5"}):t.jsx(_,{className:"w-3.5 h-3.5"}),d(c?"common.copied":"common.copy")]}),o&&t.jsx("button",{type:"button",onClick:o,className:R("flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors","hover:bg-red-100 dark:hover:bg-red-900/30","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-red-500","text-red-600 dark:text-red-400"),children:d("common.delete")})]})]})}const je=i.memo(function({userMessage:e,additionalUserInputs:r=[],assistantMessage:s,sessionSummary:a,parrotId:n,isLatest:o=!1,isStreaming:l=!1,streamingPhase:d=null,onCopy:c,onRegenerate:m,onDelete:u,children:p,className:x}){const g=n&&me[n]||me.default,h=G[n||"AMAZING"]||G.AMAZING,b=i.useRef(o),f=i.useRef(l);i.useEffect(()=>{b.current=o,f.current=l},[o,l]);const[j,v]=i.useState(()=>xe(o,l));i.useEffect(()=>{v(xe(b.current,f.current))},[o,l]);const y=i.useCallback(()=>{v(e=>!e)},[]),N=i.useMemo(()=>[`User: ${[e.content,...r.map(e=>e.content)].join("\n> ")}`,s?.content?`Assistant: ${s.content}`:"",s?.metadata?.toolResults?`\n\nTools:\n${s.metadata.toolResults.map(e=>`- ${e.name}: ${e.duration}ms`).join("\n")}`:""].filter(Boolean).join("\n\n"),[e.content,r,s?.content,s?.metadata?.toolResults]),k=i.useCallback(()=>{c?.(N)},[N,c]);return t.jsxs("div",{className:R("rounded-lg border overflow-hidden shadow-sm transition-all duration-300",g.border,o&&l&&`ring-2 ${g.ringColor} animate-block-pulse`,o&&!l&&`ring-1 ${g.ringColor}`,x),children:[t.jsx("div",{className:R("border-b",g.border),children:t.jsx(ge,{userMessage:e,assistantMessage:s,sessionSummary:a,parrotId:n,theme:g,onToggle:y,isCollapsed:j,isStreaming:l,additionalUserInputs:r})}),t.jsx(be,{userMessage:e,additionalUserInputs:r,assistantMessage:s,sessionSummary:a,isCollapsed:j,themeColors:h,streamingPhase:d,isLatest:o,children:p}),t.jsx("div",{className:R("border-t",g.border),children:t.jsx(fe,{isCollapsed:j,onToggle:y,onCopy:k,onRegenerate:m,onDelete:u,theme:g})})]})});je.displayName="UnifiedMessageBlock";const ve=i.memo(function({items:e,isTyping:r=!1,currentParrotId:s,onCopyMessage:a,onRegenerate:n,onDeleteMessage:o,children:l,className:d,amazingInsightCard:c,uiTools:m,onUIAction:u,onUIDismiss:p,isStreaming:x=!1,streamingContent:g="",sessionSummary:h}){const b=i.useRef(null),f=i.useRef(null),j=i.useRef(null),v=i.useRef(0),y=i.useRef(!1),N=i.useRef(0),k=i.useCallback(()=>{j.current||(j.current=requestAnimationFrame(()=>{if(j.current=null,b.current&&!y.current){const{scrollTop:e,scrollHeight:t,clientHeight:r}=b.current;t-e-r<150&&(b.current.scrollTop=t)}}))},[]),w=i.useCallback(()=>{if(!b.current)return;const{scrollTop:e,scrollHeight:t,clientHeight:r}=b.current,s=t-e-r>150;y.current!==s&&(y.current=s)},[]),C=i.useCallback(()=>{const e=Date.now();e-v.current<50||(v.current=e,w())},[w]);i.useEffect(()=>{if(!b.current)return;const e=new MutationObserver(e=>{e.some(e=>"childList"===e.type&&e.addedNodes.length>0)&&!y.current&&k()}),t=b.current.firstElementChild;return t&&e.observe(t,{childList:!0,subtree:!0}),()=>e.disconnect()},[k]);const M=i.useRef(e.length);i.useEffect(()=>{const t=e.length,r=t>M.current;M.current=t,r&&!y.current&&k()},[e.length,k]),i.useEffect(()=>{if(!x)return;const e=g.length,t=e-N.current;N.current=e,t>50&&!y.current&&k()},[g,x,k]),i.useEffect(()=>{r&&!y.current&&k()},[r,k]);const T=i.useRef(e.length);i.useEffect(()=>{const t=e.length!==T.current;if(T.current=e.length,t&&b.current){const{scrollTop:e,scrollHeight:t,clientHeight:r}=b.current;t-e-r<=150&&y.current&&(y.current=!1)}},[e.length]),i.useEffect(()=>()=>{j.current&&cancelAnimationFrame(j.current)},[]);const _=i.useMemo(()=>function(e,t){const r=[];let s=null;for(const a of e){if(Z(a)){s&&(r.push({id:s.id,userMessage:s,isLatest:!1}),s=null);continue}const e=a;"user"===e.role?(s&&r.push({id:s.id,userMessage:s,isLatest:!1}),s=e):"assistant"===e.role&&(s?(r.push({id:s.id,userMessage:s,assistantMessage:e,isLatest:!1}),s=null):r.push({id:e.id,userMessage:{id:`system-${e.id}`,role:"user",content:"",timestamp:e.timestamp},assistantMessage:e,isLatest:!1}))}if(s&&r.push({id:s.id,userMessage:s,isLatest:!0}),r.length>0){const e=r[r.length-1];e.isLatest=!0,t&&e.assistantMessage&&(e.attachSessionSummary=!0)}return r}(e,!!h),[e.length,e[e.length-1]?.id,h]),S=_[_.length-1],D=!!S?.assistantMessage&&x,A=i.useMemo(()=>{if(!D||!S?.assistantMessage)return null;const e=S.assistantMessage.metadata;if(!e)return null;const t=e.toolCalls?.some(e=>"object"==typeof e&&!e.outputSummary);return t?"tools":S.assistantMessage.content?"answer":(e.thinkingSteps?.length??0)>0||e.thinking?"thinking":null},[D,S,x]),I=i.useMemo(()=>"geek"===h?.mode?P.GEEK:"evolution"===h?.mode?P.EVOLUTION:s,[s,h?.mode]);return t.jsxs("div",{ref:b,onScroll:C,className:R("flex-1 overflow-y-auto px-3 md:px-6 py-4 overscroll-contain",d),style:{overflowAnchor:"auto",scrollbarGutter:"stable",contain:"layout style paint"},children:[l,_.length>0&&t.jsx("div",{className:"max-w-3xl lg:max-w-4xl xl:max-w-5xl 2xl:max-w-6xl mx-auto space-y-3",children:_.map((e,s)=>{const i=s===_.length-1,l=e.assistantMessage?.metadata?.mode||e.userMessage?.metadata?.mode;let d=I;return"geek"===l?d=P.GEEK:"evolution"===l?d=P.EVOLUTION:"normal"===l&&(d=P.AMAZING),t.jsx(je,{userMessage:e.userMessage,assistantMessage:e.assistantMessage,sessionSummary:e.attachSessionSummary?h:void 0,parrotId:d,isLatest:e.isLatest,isStreaming:D&&e.isLatest,streamingPhase:i?A:null,onCopy:a,onRegenerate:e.isLatest?n:void 0,onDelete:e.isLatest&&o?()=>o(0):void 0,children:e.isLatest&&r&&!e.assistantMessage?.error&&t.jsx(de,{active:!0,parrotId:I||P.AMAZING,variant:"dots"})},e.id)})}),c&&!r&&_.length>0&&t.jsx("div",{className:"max-w-3xl lg:max-w-4xl xl:max-w-5xl 2xl:max-w-6xl mx-auto mt-3",children:c}),m&&m.length>0&&u&&p&&t.jsx("div",{className:"max-w-3xl lg:max-w-4xl xl:max-w-5xl 2xl:max-w-6xl mx-auto mt-3",children:t.jsx(Y,{tools:m,onAction:u,onDismiss:p})}),r&&0===_.length&&t.jsxs("div",{className:"flex gap-3 md:gap-4 animate-in fade-in duration-300",children:[t.jsx("div",{className:"w-9 h-9 md:w-10 md:h-10 rounded-full flex items-center justify-center shadow-sm bg-muted",children:t.jsx("span",{className:"text-lg md:text-xl",children:"🤖"})}),t.jsx("div",{className:R("px-4 py-3 rounded-2xl border shadow-sm",G.AMAZING.bubbleBg,G.AMAZING.bubbleBorder),children:t.jsx(de,{active:!0,parrotId:I||P.AMAZING,variant:"dots"})})]}),t.jsx("div",{ref:f,className:"h-px"})]})}),ye=[{id:L.MEMO,parrotId:P.MEMO,icon:"🦜",iconAlt:"/images/parrots/icons/memo_icon.webp",nameKey:"ai.capability.memo.name",nameAltKey:"ai.capability.memo.nameAlt",descriptionKey:"ai.capability.memo.description",theme:G.MEMO,nameAlt:"Memo"},{id:L.SCHEDULE,parrotId:P.SCHEDULE,icon:"⏰",iconAlt:"/images/parrots/icons/schedule_icon.webp",nameKey:"ai.capability.schedule.name",nameAltKey:"ai.capability.schedule.nameAlt",descriptionKey:"ai.capability.schedule.description",theme:G.SCHEDULE,nameAlt:"Schedule"},{id:L.AMAZING,parrotId:P.AMAZING,icon:"🌟",iconAlt:"/images/parrots/icons/amazing_icon.webp",nameKey:"ai.capability.amazing.name",nameAltKey:"ai.capability.amazing.nameAlt",descriptionKey:"ai.capability.amazing.description",theme:G.AMAZING,nameAlt:"Amazing"}];function Ne({currentCapability:r=L.AUTO,capabilityStatus:s="idle",onCapabilitySelect:a,className:n}){const{t:o}=e();return t.jsx("div",{className:R("w-full h-full overflow-y-auto bg-sidebar p-4 md:p-8",n),children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"text-center mb-8",children:[t.jsxs("div",{className:"flex items-center justify-center gap-2 mb-3",children:[t.jsx(c,{className:"w-5 h-5 text-primary"}),t.jsx("h2",{className:"text-lg md:text-xl font-semibold text-foreground",children:o("ai.capability.title")||"我的能力"}),t.jsx(c,{className:"w-5 h-5 text-primary"})]}),t.jsx("p",{className:"text-sm text-muted-foreground",children:o("ai.capability.subtitle")||"我可以帮你搜索笔记、管理日程、综合分析"})]}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-6",children:ye.map(e=>{const n=e.id===r,i=e.theme,l=e.icon;return t.jsxs("button",{onClick:()=>a?.(e.id),className:R("flex flex-col text-left p-5 md:p-6 rounded-2xl border-2 transition-all duration-300 group relative overflow-hidden","bg-card",n?i.cardBorder+" ring-2 ring-offset-2 ring-foreground shadow-lg scale-[1.02]":"border-border hover:border-border hover:shadow-md","focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-foreground"),children:[t.jsx("div",{className:R("absolute top-0 right-0 w-32 h-32 rounded-full blur-3xl opacity-0 group-hover:opacity-10 transition-opacity duration-500",i.accent)}),n&&t.jsxs("div",{className:"absolute top-3 right-3 flex items-center gap-1.5 px-2 py-1 rounded-full bg-foreground text-background text-xs font-medium",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-primary animate-pulse"}),o("ai.capability.active")||"使用中"]}),t.jsx("div",{className:R("w-12 h-12 rounded-xl flex items-center justify-center text-2xl md:text-3xl mb-4 transition-transform group-hover:scale-110 duration-300",i.iconBg),children:l}),t.jsxs("h3",{className:R("text-base md:text-lg font-bold mb-1 transition-colors",i.text),children:[o(e.nameKey)||e.nameAlt,t.jsx("span",{className:"text-xs font-medium text-muted-foreground ml-2",children:o(e.nameAltKey)})]}),t.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed mb-4 flex-grow",children:o(e.descriptionKey)}),t.jsx("div",{className:R("flex items-center text-sm font-medium",i.iconText),children:n?t.jsxs(t.Fragment,{children:[t.jsx("span",{children:o("ai.capability.in-use")||"正在使用"}),t.jsx(c,{className:"w-4 h-4 ml-1.5 animate-pulse"})]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{children:o("ai.capability.tap-to-activate")||"点击激活"}),t.jsx(m,{className:"w-4 h-4 ml-1.5 transition-transform group-hover:translate-x-1"})]})}),n&&"thinking"===s&&t.jsx("div",{className:"absolute inset-0 bg-card/50 flex items-center justify-center",children:t.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[t.jsx("div",{className:"w-5 h-5 border-2 border-muted-foreground border-t-transparent rounded-full animate-spin"}),t.jsx("span",{children:o("ai.capability.thinking")||"思考中..."})]})})]},e.id)})}),t.jsx("div",{className:"mt-8 p-4 rounded-xl bg-accent border border-border",children:t.jsxs("p",{className:"text-sm text-center text-foreground flex items-center justify-center gap-2",children:[t.jsx(c,{className:"w-4 h-4"}),t.jsx("span",{children:o("ai.capability.auto-hint")||"💡 提示：你也可以直接开始聊天，我会自动理解你的意图并调用相应能力"})]})})]})})}function ke(){const e=(new Date).getHours();return e>=5&&e<9?{timeOfDay:"morning",greetingKey:"ai.parrot.partner.greeting-early-morning",hintKey:"ai.parrot.partner.hint-early-morning"}:e>=9&&e<12?{timeOfDay:"morning",greetingKey:"ai.parrot.partner.greeting-morning",hintKey:"ai.parrot.partner.hint-morning"}:e>=12&&e<14?{timeOfDay:"afternoon",greetingKey:"ai.parrot.partner.greeting-noon",hintKey:"ai.parrot.partner.hint-noon"}:e>=14&&e<18?{timeOfDay:"afternoon",greetingKey:"ai.parrot.partner.greeting-afternoon",hintKey:"ai.parrot.partner.hint-afternoon"}:e>=18&&e<21?{timeOfDay:"evening",greetingKey:"ai.parrot.partner.greeting-evening",hintKey:"ai.parrot.partner.hint-evening"}:{timeOfDay:"night",greetingKey:"ai.parrot.partner.greeting-night",hintKey:"ai.parrot.partner.hint-night"}}const we=i.memo(function({onSendMessage:r,onSendComplete:s,recentMemoCount:a,upcomingScheduleCount:n,className:o,currentMode:l="normal"}){const{t:d}=e(),[c,m]=i.useState(!1),u=i.useRef(null),{greetingText:p,timeHint:x}=i.useMemo(()=>{if("geek"===l)return{greetingText:d("ai.parrot.geek.greeting"),timeHint:d("ai.parrot.geek.hint")};if("evolution"===l)return{greetingText:d("ai.parrot.evolution.greeting"),timeHint:d("ai.parrot.evolution.hint")};const e=ke();return{greetingText:d(e.greetingKey),timeHint:d(e.hintKey)}},[l,d]),g=i.useMemo(()=>{if("geek"===l)return function(e){return[{icon:"⚡",category:"amazing",promptKey:"ai.parrot.geek.prompt-refactor",prompt:e("ai.parrot.geek.prompt-refactor")},{icon:"🧪",category:"create",promptKey:"ai.parrot.geek.prompt-test",prompt:e("ai.parrot.geek.prompt-test")},{icon:"🐛",category:"memo",promptKey:"ai.parrot.geek.prompt-fix",prompt:e("ai.parrot.geek.prompt-fix")},{icon:"📊",category:"amazing",promptKey:"ai.parrot.geek.prompt-analyze",prompt:e("ai.parrot.geek.prompt-analyze")}]}(d);if("evolution"===l)return function(e){return[{icon:"🚀",category:"create",promptKey:"ai.parrot.evolution.prompt-feature",prompt:e("ai.parrot.evolution.prompt-feature")},{icon:"⚡",category:"amazing",promptKey:"ai.parrot.evolution.prompt-optimize",prompt:e("ai.parrot.evolution.prompt-optimize")},{icon:"🐛",category:"memo",promptKey:"ai.parrot.evolution.prompt-fix",prompt:e("ai.parrot.evolution.prompt-fix")},{icon:"🔧",category:"schedule",promptKey:"ai.parrot.evolution.prompt-refactor",prompt:e("ai.parrot.evolution.prompt-refactor")}]}(d);const e=ke(),t=function(e,t){return"morning"===t?[{icon:"📋",category:"schedule",promptKey:"ai.parrot.partner.prompt-today-schedule",prompt:e("ai.parrot.partner.prompt-today-schedule")},{icon:"📝",category:"memo",promptKey:"ai.parrot.partner.prompt-recent-memos",prompt:e("ai.parrot.partner.prompt-recent-memos")},{icon:"➕",category:"create",promptKey:"ai.parrot.partner.prompt-create-meeting",prompt:e("ai.parrot.partner.prompt-create-meeting")},{icon:"📊",category:"amazing",promptKey:"ai.parrot.partner.prompt-today-overview",prompt:e("ai.parrot.partner.prompt-today-overview")}]:"afternoon"===t?[{icon:"🔍",category:"memo",promptKey:"ai.parrot.partner.prompt-search-memo",prompt:e("ai.parrot.partner.prompt-search-memo")},{icon:"⏰",category:"schedule",promptKey:"ai.parrot.partner.prompt-afternoon-free",prompt:e("ai.parrot.partner.prompt-afternoon-free")},{icon:"📅",category:"create",promptKey:"ai.parrot.partner.prompt-create-tomorrow",prompt:e("ai.parrot.partner.prompt-create-tomorrow")},{icon:"🔗",category:"amazing",promptKey:"ai.parrot.partner.prompt-connect-info",prompt:e("ai.parrot.partner.prompt-connect-info")}]:"evening"===t?[{icon:"📝",category:"memo",promptKey:"ai.parrot.partner.prompt-today-learned",prompt:e("ai.parrot.partner.prompt-today-learned")},{icon:"📅",category:"schedule",promptKey:"ai.parrot.partner.prompt-tomorrow-plan",prompt:e("ai.parrot.partner.prompt-tomorrow-plan")},{icon:"✅",category:"create",promptKey:"ai.parrot.partner.prompt-create-reminder",prompt:e("ai.parrot.partner.prompt-create-reminder")},{icon:"📊",category:"amazing",promptKey:"ai.parrot.partner.prompt-day-summary",prompt:e("ai.parrot.partner.prompt-day-summary")}]:[{icon:"🔍",category:"memo",promptKey:"ai.parrot.partner.prompt-quick-search",prompt:e("ai.parrot.partner.prompt-quick-search")},{icon:"📅",category:"schedule",promptKey:"ai.parrot.partner.prompt-tomorrow-check",prompt:e("ai.parrot.partner.prompt-tomorrow-check")},{icon:"💡",category:"memo",promptKey:"ai.parrot.partner.prompt-find-idea",prompt:e("ai.parrot.partner.prompt-find-idea")},{icon:"🌟",category:"amazing",promptKey:"ai.parrot.partner.prompt-week-summary",prompt:e("ai.parrot.partner.prompt-week-summary")}]}(d,e.timeOfDay);return t.some(e=>e.prompt===e.promptKey)?function(e){return[{icon:"🔍",category:"memo",promptKey:"ai.parrot.partner.prompt-search-memo",prompt:e("ai.parrot.partner.prompt-search-memo")},{icon:"📅",category:"schedule",promptKey:"ai.parrot.partner.prompt-today-schedule",prompt:e("ai.parrot.partner.prompt-today-schedule")},{icon:"➕",category:"create",promptKey:"ai.parrot.partner.prompt-create-meeting",prompt:e("ai.parrot.partner.prompt-create-meeting")},{icon:"📊",category:"amazing",promptKey:"ai.parrot.partner.prompt-day-summary",prompt:e("ai.parrot.partner.prompt-day-summary")}]}(d):t},[l,d]),h=i.useMemo(()=>{const e=[];return void 0!==a&&a>0&&e.push(d("ai.parrot.partner.memo-count",{count:a})),void 0!==n&&n>0&&e.push(d("ai.parrot.partner.schedule-count",{count:n})),e.join(" · ")},[a,n,d]);return i.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]),t.jsxs("div",{className:R("flex flex-col items-center justify-center h-full w-full px-6 py-8",o),children:[t.jsx("div",{className:"mb-8 animate-in fade-in zoom-in duration-500",children:t.jsx(ne,{src:"/assistant-avatar.webp",alt:d("ai.assistant_name"),size:"xl",isThinking:!c})}),t.jsxs("div",{className:"text-center mb-8",children:[t.jsx("h2",{className:"text-xl font-semibold text-foreground mb-2",children:p}),t.jsx("p",{className:"text-sm text-muted-foreground",children:x}),h&&t.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:h})]}),t.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4 w-full max-w-3xl lg:max-w-4xl xl:max-w-5xl 2xl:max-w-6xl mb-8",children:g.map(e=>t.jsxs("button",{disabled:c,onClick:()=>(e=>{if(c)return;m(!0),r?.(e.prompt),u.current&&clearTimeout(u.current);const t=s?3e3:500;u.current=setTimeout(()=>m(!1),t)})(e),className:R("flex flex-row items-center gap-3 p-3 rounded-xl","bg-card","border border-border","hover:border-primary/50","hover:bg-accent","transition-all duration-200","active:scale-95","min-h-[56px]",c&&"opacity-50 cursor-not-allowed active:scale-100"),title:e.prompt,children:[t.jsx("span",{className:"text-2xl shrink-0",children:e.icon}),t.jsx("span",{className:"text-sm font-medium text-foreground text-left leading-tight line-clamp-2",children:e.prompt})]},e.promptKey))})]})});function Ce(){const{t:t}=e();return{availableCapabilities:i.useMemo(()=>Object.values(L).filter(e=>e!==L.AUTO),[]),route:(e,t)=>function(e,t=L.AUTO){return{capability:t!==L.AUTO?t:L.AUTO,confidence:.5,reasoning:"backend-routing"}}(0,t),getCapabilityInfo:e=>{switch(e){case L.MEMO:return{name:t("ai.capability.memo.name")||"笔记",nameAlt:"Memo",description:t("ai.capability.memo.description")||"搜索与问答",icon:"🦜"};case L.SCHEDULE:return{name:t("ai.capability.schedule.name")||"日程",nameAlt:"Schedule",description:t("ai.capability.schedule.description")||"规划与管理",icon:"⏰"};case L.AMAZING:return{name:t("ai.capability.amazing.name")||"综合",nameAlt:"Amazing",description:t("ai.capability.amazing.description")||"笔记 + 日程",icon:"🌟"};case L.AUTO:default:return{name:t("ai.capability.auto.name")||"自动",nameAlt:"Auto",description:t("ai.capability.auto.description")||"智能识别",icon:"🤖"}}},toParrotAgent:e=>q(e),fromParrotAgent:e=>H(e)}}i.memo(function({message:r,className:s}){const{t:a}=e(),n=a(ke().greetingKey);return t.jsxs("div",{className:R("flex items-start gap-3 p-4",s),children:[t.jsx("div",{className:"w-9 h-9 md:w-10 md:h-10 rounded-xl bg-primary flex items-center justify-center text-lg shrink-0 shadow-sm",children:t.jsx("span",{children:"🦜"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-foreground mb-1",children:n}),t.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:r||a("ai.parrot.partner.default-hint")})]})]})});function Me({input:r,setInput:s,onSend:a,onStop:n,onNewChat:o,isTyping:l,isThinking:d,clearDialogOpen:c,setClearDialogOpen:m,onClearChat:u,onClearContext:p,memoQueryResults:x,scheduleQueryResults:g,sessionSummary:h,items:b,currentCapability:f,capabilityStatus:j,recentMemoCount:v,upcomingScheduleCount:y,uiTools:N,currentMode:k,onModeChange:w,immersiveMode:C,onImmersiveModeToggle:M,isAdmin:T=!0}){const{t:_}=e(),S=W("md"),D=i.useDeferredValue(x),A=i.useDeferredValue(g);return t.jsxs("div",{className:R("w-full h-full flex flex-col relative bg-background",(e=>{switch(e){case"geek":return"geek-matrix-grid";case"evolution":return"evo-flow-bg";default:return""}})(k)),children:[S&&t.jsx(oe,{currentCapability:f,capabilityStatus:j,isThinking:d,currentMode:k,onModeChange:w,immersiveMode:C,onImmersiveModeToggle:M,isAdmin:T}),t.jsx(ve,{items:b,isTyping:l,currentParrotId:P.AMAZING,onCopyMessage:e=>{K(e)},onDeleteMessage:()=>{},amazingInsightCard:f===L.AMAZING&&(D.length>0||A.length>0)?t.jsx(te,{memos:D[0]?.memos??[],schedules:A[0]?.schedules??[]}):void 0,uiTools:N.tools,onUIAction:N.handleAction,onUIDismiss:N.dismissTool,sessionSummary:h,children:0===b.length&&t.jsx(we,{recentMemoCount:v,upcomingScheduleCount:y,onSendMessage:a,currentMode:k})}),t.jsx(ie,{value:r,onChange:e=>{s(e)},onSend:a,onStop:n,onNewChat:o,onClearContext:p,onClearChat:()=>m(!0),onModeChange:w,isTyping:l,currentMode:k}),t.jsx(J,{open:c,onOpenChange:m,title:_("ai.clear-chat"),confirmLabel:_("common.confirm"),description:_("ai.clear-chat-confirm"),cancelLabel:_("common.cancel"),onConfirm:u,confirmVariant:"destructive"})]})}function Te({currentCapability:r,capabilityStatus:s,onCapabilitySelect:a,onBack:n}){const o=W("md"),{t:i}=e();return t.jsxs("div",{className:"w-full h-full flex flex-col relative bg-background",children:[!o&&t.jsxs("header",{className:"flex items-center justify-between px-3 py-2 border-b border-border bg-background/80 backdrop-blur-md sticky top-0 z-20",children:[t.jsxs("button",{onClick:n,className:"flex items-center gap-1.5 px-2 py-1.5 rounded-lg text-muted-foreground hover:text-foreground hover:bg-muted transition-all",children:[t.jsx(E,{className:"w-4 h-4"}),t.jsx("span",{className:"text-xs font-medium",children:i("common.close")||"Close"})]}),t.jsx("span",{className:"text-sm font-medium text-foreground",children:i("ai.capability.title")}),t.jsx("div",{className:"w-16"})]}),t.jsx(Ne,{currentCapability:r,capabilityStatus:s,onCapabilitySelect:a})]})}const _e=()=>{const r=V(),s=Q(),a=Ce(),n=function(){const[e,t]=i.useState([]),r=i.useRef(0);return{tools:e,processEvent:i.useCallback(e=>{if(!e.uiType||!e.uiData)return;const s="uitool-"+ ++r.current;let a,n;switch(e.uiType){case"ui_schedule_suggestion":a="schedule_suggestion",n=e.uiData;break;case"ui_time_slot_picker":a="time_slot_picker",n=e.uiData;break;case"ui_conflict_resolution":a="conflict_resolution",n=e.uiData;break;case"ui_quick_actions":a="quick_actions",n=e.uiData;break;case"ui_memo_preview":a="memo_preview",n=e.uiData;break;case"ui_progress_tracker":a="progress_tracker",n=e.uiData;break;case"ui_schedule_list":a="schedule_list",n=e.uiData;break;default:return}const o={id:s,type:a,data:n,timestamp:Date.now()};t(e=>[...e,o])},[]),handleAction:i.useCallback(e=>(t(t=>t.filter(t=>t.id!==e.toolId)),e),[]),dismissTool:i.useCallback(e=>{t(t=>t.filter(t=>t.id!==e))},[]),clearTools:i.useCallback(()=>{t([])},[]),hasTools:e.length>0}}(),[o,l]=i.useState(""),[d,c]=i.useState(!1),[m,u]=i.useState(!1),[p,x]=i.useState(!1),[g,h]=i.useState([]),[b,f]=i.useState([]),[j,v]=i.useState(),[y,N]=i.useState(!1),k=i.useRef(null),w=i.useRef(0),C=i.useRef(null),M=i.useRef(""),T=i.useRef(!1),_=i.useRef(0),S=i.useRef([]),D=i.useRef([]),{currentConversation:A,conversations:I,createConversation:E,selectConversation:K,addMessage:U,updateMessage:R,addReferencedMemos:O,addContextSeparator:$,clearMessages:B,state:G,setCurrentCapability:F,setCapabilityStatus:Z,setMode:H,toggleImmersiveMode:W}=s,J=G.currentCapability||L.AUTO,Y=G.capabilityStatus||"idle",X=G.currentMode||"normal",ee=G.immersiveMode||!1,te=i.useMemo(()=>A?.messages||[],[A?.messages]),{t:re}=e();i.useEffect(()=>()=>{k.current&&clearTimeout(k.current)},[]);const se=i.useCallback(()=>{k.current&&(clearTimeout(k.current),k.current=null),c(!1)},[]),ae=i.useCallback(async(e,t,s,a)=>{c(!0),u(!0),Z("thinking"),h([]),f([]),D.current=[],S.current=[],_.current=0;const o=++w.current,i={message:s,agentType:t,userTimezone:Intl.DateTimeFormat().resolvedOptions().timeZone,conversationId:a,geekMode:"geek"===X,evolutionMode:"evolution"===X};try{await r.stream(i,{onThinking:t=>{if(C.current){const r=t.startsWith("ai.")?re(t):t,s=_.current++,a={content:r,timestamp:Date.now(),round:s};S.current.push(a),R(e,C.current,{metadata:{thinkingSteps:[...S.current],thinking:r}})}},onToolUse:(t,r)=>{Z("processing"),D.current.push({name:t,toolId:r?.toolId,inputSummary:r?.inputSummary,outputSummary:r?.outputSummary,filePath:r?.filePath,round:_.current}),C.current&&R(e,C.current,{metadata:{toolCalls:[...D.current]}})},onToolResult:(t,r)=>{if(C.current&&D.current.length>0){const s=D.current[D.current.length-1];s.outputSummary=r?.outputSummary||t.slice(0,200)+(t.length>200?"...":""),s.duration=r?.durationMs,s.exitCode=r?.errorMsg?-1:0,s.isError=!!r?.errorMsg,R(e,C.current,{metadata:{toolCalls:[...D.current],toolResults:D.current.map(e=>({name:e.name,toolId:e.toolId,inputSummary:e.inputSummary,outputSummary:e.outputSummary,duration:e.duration,isError:e.isError||!1,round:e.round}))}})}},onSessionSummary:e=>{v(e)},onMemoQueryResult:t=>{o===w.current&&(h(e=>[...e,t]),O(e,t.memos))},onScheduleQueryResult:e=>{if(o===w.current){const t={schedules:e.schedules.map(e=>({uid:e.uid,title:e.title,startTimestamp:Number(e.startTs),endTimestamp:Number(e.endTs),allDay:e.allDay,location:e.location||void 0,status:e.status})),query:"",count:e.schedules.length,timeRangeDescription:e.timeRangeDescription,queryType:e.queryType};f(e=>[...e,t])}},onUIMemoPreview:e=>{o===w.current&&n.processEvent({type:"ui_memo_preview",data:JSON.stringify(e),uiType:"ui_memo_preview",uiData:e})},onContent:t=>{C.current&&(M.current+=t,R(e,C.current,{content:M.current}))},onDone:()=>{c(!1),u(!1),Z("idle")},onError:t=>{c(!1),u(!1),Z("idle"),C.current&&R(e,C.current,{content:M.current||re("ai.error-generic")||"Sorry, something went wrong. Please try again.",error:!0})}})}catch(l){c(!1),u(!1),Z("idle")}},[r,R,O,Z,re,n]),ne=i.useCallback(async e=>{const t=(e||o).trim();if(!t)return;if(d)return;const r=a.route(t,J).capability;r!==J&&r!==L.AUTO&&F(r);const s=q(r);let n=A?.id,i=null;if(!n){if(T.current)return;const e=I.find(e=>!e.parrotId||e.parrotId===P.AMAZING);if(e)n=e.id,K(e.id);else{T.current=!0;const{id:e,completed:t}=E(P.AMAZING);n=e,i=t.finally(()=>{T.current=!1})}}if(!n)return;if(U(n,{role:"user",content:t}),"---"===t){l("");const e=i?await i:n,r=parseInt(e,10);return void(await ae(e,s,t,r))}const c=U(n,{role:"assistant",content:""});C.current=c,M.current="",l("");let m=n;if(i)try{m=await i}catch(x){}const u=parseInt(m,10),p=isNaN(u)?0:u;await ae(m,s,t,p)},[o,d,A,J,a,F,I,K,E,U,ae,se]),oe=i.useCallback(()=>{r.stop(),se()},[r,se]),ie=i.useCallback(()=>{A&&B(A.id),x(!1)},[A,B]),le=i.useCallback(()=>{E(P.AMAZING)},[E]),de=i.useCallback((e="manual")=>{A&&($(A.id,e),z.success(re("ai.context-cleared-toast"),{duration:2e3,icon:"✂️",className:"dark:bg-zinc-800 dark:border-zinc-700"}))},[A,$,re]);return i.useEffect(()=>{const e=e=>{l(e.detail),setTimeout(()=>{l(""),ne(e.detail)},100)};return window.addEventListener("aichat-send-message",e),()=>{window.removeEventListener("aichat-send-message",e)}},[ne]),i.useEffect(()=>{const e=e=>{if(e.metaKey||e.ctrlKey)switch(e.key.toLowerCase()){case"k":e.preventDefault(),A&&de("shortcut");break;case"n":e.preventDefault(),le();break;case"l":e.preventDefault(),A&&x(!0)}};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[A,de,le]),y?t.jsx(Te,{currentCapability:J,capabilityStatus:Y,onCapabilitySelect:e=>{F(e),N(!1)},onBack:()=>N(!1)}):t.jsx(Me,{input:o,setInput:l,onSend:ne,onStop:oe,onNewChat:le,isTyping:d,isThinking:m,clearDialogOpen:p,setClearDialogOpen:x,onClearChat:ie,onClearContext:de,memoQueryResults:g,scheduleQueryResults:b,sessionSummary:j,items:te,currentCapability:J,capabilityStatus:Y,uiTools:n,currentMode:X,onModeChange:H,immersiveMode:ee,onImmersiveModeToggle:W,isAdmin:!0})};export{_e as default};
