import{j as e,r as s,$ as t,aC as a,bJ as n,bK as i,m as l,aB as r,bL as c,bM as o,bN as d,bO as m,bP as h,bQ as x,aD as u,aG as p,X as g,bR as j,bS as f,bT as v,p as b,bU as N,aF as y,b8 as w,aE as k,n as C,a$ as S,N as A,ac as T,bV as U,bW as E,a3 as L,ax as P,b5 as O,t as I,bX as F,bY as M}from"./react-vendor-LyyF-653.js";import{n as R,i as _,X as z,G as D,Y as K,Z as G,_ as H,$ as V,a0 as W,a1 as $,a2 as B,a3 as q,a4 as J,a5 as Y,a6 as Q,T as Z,a7 as X,a8 as ee,a9 as se,aa as te,ab as ae,ac as ne,ad as ie,u as le,q as re,ae as ce,af as oe,ag as de,ah as me,ai as he,h as xe,aj as ue,ak as pe,al as ge,am as je,an as fe,ao as ve,ap as be,aq as Ne,Q as ye,ar as we,p as ke,F as Ce,a as Se,as as Ae,at as Te,S as Ue,au as Ee,av as Le,aw as Pe,ax as Oe,W as Ie,ay as Fe,az as Me,aA as Re,o as _e,t as ze,e as De,aB as Ke,aC as Ge,aD as He,aE as Ve,aF as We,V as $e,aG as Be,aH as qe,aI as Je,aJ as Ye,aK as Qe,aL as Ze,aM as Xe,aN as es,aO as ss,aP as ts,aQ as as,r as ns}from"./index-D99LTaa7.js";import{u as is}from"./useDialog-BOQkoYHr.js";import{S as ls}from"./separator-Jvca_ZrM.js";import{a2 as rs,w as cs,O as os}from"./lodash-vendor-DIRPa7cU.js";import{c as ds,a as ms}from"./utils-B5ZcaJe4.js";import{L as hs,T as xs}from"./ThemeSelect-Cq9CVVNd.js";import"./ui-vendor-ByoYm48K.js";import"./leaflet-vendor-Cu4zZue4.js";import"./markdown-vendor-DtAGkuPo.js";import"./math-vendor-JUchi9-2.js";import"./mermaid-vendor-B1M2OtO5.js";import"./polyfills-RlNY0w59.js";import"./i18n-vendor-Cyfgqt0p.js";var us=(e=>(e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.TELEGRAM=1]="TELEGRAM",e[e.WHATSAPP=2]="WHATSAPP",e[e.DINGTALK=3]="DINGTALK",e))(us||{});function ps({title:s,subtitle:t,columns:a,data:n,emptyMessage:i="暂无数据",className:l,getRowKey:r,renderActions:c}){return 0===n.length?e.jsx("div",{className:R("px-4 py-8 text-center text-sm text-muted-foreground",l),children:i}):e.jsxs("div",{className:R("flex flex-col",l),children:[s&&e.jsxs("div",{className:"px-4 pt-4 pb-2",children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:s}),t&&e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:t})]}),n.map((s,t)=>{const n=r?r(s,t):t.toString();return e.jsxs("div",{className:"mx-4 my-2 p-4 bg-background border border-border rounded-lg",children:[a.map(t=>{const a=s[t.key],n=t.render?t.render(a,s):a;return null==n?null:e.jsxs("div",{className:"flex items-start justify-between py-2 border-b border-border last:border-0 last:pb-0",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:t.label||t.key}),e.jsx("div",{className:"text-sm text-foreground text-right ml-4 flex-1",children:n})]},t.key)}),c&&e.jsx("div",{className:"flex items-center justify-end gap-2 mt-3 pt-3 border-t border-border",children:c(s)})]},n)})]})}const gs={[us.UNSPECIFIED]:"Unknown",[us.TELEGRAM]:"Telegram",[us.WHATSAPP]:"WhatsApp",[us.DINGTALK]:"DingTalk"},js=({className:r})=>{const c=_(),o=z(),[d,m]=s.useState([]),[h,x]=s.useState(!1),[u,p]=s.useState(!1),[g,j]=s.useState(!1),[f,v]=s.useState(null),[b,N]=s.useState(null),[y,w]=s.useState(us.TELEGRAM),[k,C]=s.useState(""),[S,A]=s.useState(""),[T,U]=s.useState(""),E=[{key:"platform",label:c("setting.chat-apps.platform"),render:(s,a)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:gs[a.platform]||a.platform}),a.enabled?e.jsxs("span",{className:"text-xs text-green-600 dark:text-green-400 flex items-center gap-1",children:[e.jsx(t,{className:"w-3 h-3"}),c("setting.chat-apps.enabled")]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:c("setting.chat-apps.disabled")})]})},{key:"platformUserId",label:c("setting.chat-apps.platform-user-id"),render:(s,t)=>e.jsx("span",{className:"font-mono text-xs",children:t.platformUserId})},{key:"createdTs",label:c("setting.chat-apps.created-at"),render:(e,s)=>new Date(1e3*s.createdTs).toLocaleString()}];s.useEffect(()=>{L()},[]);const L=async()=>{x(!0),v(null);try{const e=await fetch("/api/v1/chat-apps/credentials",{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(!e.ok)throw new Error("Failed to fetch credentials");const s=await e.json();m(s.credentials||[])}catch(e){v(c("setting.chat-apps.fetch-failed"))}finally{x(!1)}},P=async()=>{if(k&&(S||y===us.WHATSAPP)){j(!0),v(null);try{if(!(await fetch("/api/v1/chat-apps/credentials",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({platform:y,platform_user_id:k,platform_chat_id:k,access_token:S,webhook_url:T})})).ok)throw new Error("Failed to register credential");C(""),A(""),U(""),p(!1),await L()}catch(e){v(c("setting.chat-apps.register-failed"))}finally{j(!1)}}else v(c("setting.chat-apps.validation-error"))},O=async e=>{j(!0),v(null);try{if(!(await fetch(`/api/v1/chat-apps/credentials/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}})).ok)throw new Error("Failed to delete credential");await L()}catch(s){v(c("setting.chat-apps.delete-failed"))}finally{j(!1)}},I=async(e,s)=>{v(null);try{if(!(await fetch(`/api/v1/chat-apps/credentials/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({platform:e,enabled:s})})).ok)throw new Error("Failed to update credential");await L()}catch(t){v(c("setting.chat-apps.update-failed"))}},F=async e=>{try{const s=await fetch(`/api/v1/chat-apps/webhook-info/${us[e].toLowerCase()}`,{headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(!s.ok)throw new Error("Failed to get webhook info");const t=await s.json();N({webhook_url:t.webhook_url,setup_instructions:t.setup_instructions})}catch(s){}};return e.jsxs("div",{className:r,children:[e.jsxs("div",{className:"flex flex-row justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:c("setting.chat-apps.title")}),e.jsxs(D,{variant:"outline",size:"sm",onClick:()=>p(!0),children:[e.jsx(a,{className:"w-4 h-4 mr-2"}),c("setting.chat-apps.add")]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:c("setting.chat-apps.description")}),f&&e.jsx("div",{className:"mb-4 p-3 bg-destructive/10 border border-destructive/20 rounded-md text-sm text-destructive",children:f}),h?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(n,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):0===d.length?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsx("p",{children:c("setting.chat-apps.no-credentials")})}):o?e.jsx(ps,{columns:E,data:d,emptyMessage:c("setting.chat-apps.no-credentials"),getRowKey:e=>String(e.id),renderActions:s=>e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>F(s.platform),className:"h-9 px-3",children:e.jsx(i,{className:"w-4 h-4"})}),e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>I(s.platform,!s.enabled),className:"h-9 px-3",children:s.enabled?c("setting.chat-apps.disable"):c("setting.chat-apps.enable")}),e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>O(s.platform),className:"h-9 px-3",children:e.jsx(l,{className:"w-4 h-4 text-destructive"})})]})}):e.jsx("div",{className:"space-y-3",children:d.map(s=>(s=>e.jsx("div",{className:"border border-border rounded-lg p-4 bg-background",children:e.jsxs("div",{className:"flex flex-row justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex flex-row items-center gap-2 mb-2",children:[e.jsx("h3",{className:"font-medium",children:gs[s.platform]||s.platform}),e.jsx("span",{className:"text-xs text-muted-foreground px-2 py-0.5 bg-muted rounded",children:s.platformUserId}),s.enabled?e.jsxs("span",{className:"text-xs text-green-600 dark:text-green-400 flex items-center gap-1",children:[e.jsx(t,{className:"w-3 h-3"}),c("setting.chat-apps.enabled")]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:c("setting.chat-apps.disabled")})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[c("setting.chat-apps.created-at"),": ",new Date(1e3*s.createdTs).toLocaleString()]})]}),e.jsxs("div",{className:"flex flex-row gap-2 items-center",children:[e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>F(s.platform),children:e.jsx(i,{className:"w-4 h-4"})}),e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>I(s.platform,!s.enabled),children:s.enabled?c("setting.chat-apps.disable"):c("setting.chat-apps.enable")}),e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>O(s.platform),children:e.jsx(l,{className:"w-4 h-4 text-destructive"})})]})]})},s.id))(s))}),o?e.jsx(K,{open:u,onOpenChange:p,children:e.jsxs(G,{side:"bottom",className:"h-[85vh]",children:[e.jsxs(H,{children:[e.jsx(V,{children:c("setting.chat-apps.add-credential")}),e.jsx(W,{children:c("setting.chat-apps.add-description")})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"platform",children:c("setting.chat-apps.platform")}),e.jsxs(B,{value:String(y),onValueChange:e=>w(Number(e)),children:[e.jsx(q,{id:"platform",children:e.jsx(J,{})}),e.jsxs(Y,{children:[e.jsx(Q,{value:String(us.TELEGRAM),children:"Telegram"}),e.jsx(Q,{value:String(us.WHATSAPP),children:"WhatsApp"}),e.jsx(Q,{value:String(us.DINGTALK),children:"DingTalk"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"platformUserId",children:c("setting.chat-apps.platform-user-id")}),e.jsx(Z,{id:"platformUserId",value:k,onChange:e=>C(e.target.value),placeholder:y===us.TELEGRAM?"123456789":y===us.DINGTALK?"manager1234":"user_id"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y===us.TELEGRAM&&c("setting.chat-apps.telegram-user-id-hint"),y===us.DINGTALK&&c("setting.chat-apps.dingtalk-user-id-hint")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"accessToken",children:y===us.WHATSAPP?"Bridge API Key (Optional)":c("setting.chat-apps.access-token")}),e.jsx(Z,{id:"accessToken",type:"password",value:S,onChange:e=>A(e.target.value),placeholder:y===us.TELEGRAM?"123456789:ABCDefGhIJKlMnOPqrstUVwxYZ":"your_token_here"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y===us.TELEGRAM&&c("setting.chat-apps.telegram-token-hint"),y===us.DINGTALK&&c("setting.chat-apps.dingtalk-token-hint"),y===us.WHATSAPP&&"Leave empty if bridge does not require API key"]})]}),(y===us.DINGTALK||y===us.WHATSAPP)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"webhookUrl",children:y===us.WHATSAPP?"Bridge URL":c("setting.chat-apps.webhook-url")}),e.jsx(Z,{id:"webhookUrl",value:T,onChange:e=>U(e.target.value),placeholder:y===us.WHATSAPP?"http://localhost:3001":"https://oapi.dingtalk.com/robot/send?access_token=..."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y===us.WHATSAPP?"URL of the Baileys Bridge service":c("setting.chat-apps.dingtalk-webhook-hint")})]})]}),e.jsxs(X,{children:[e.jsx(D,{variant:"outline",onClick:()=>p(!1),children:c("common.cancel")}),e.jsxs(D,{onClick:P,disabled:g,children:[g&&e.jsx(n,{className:"w-4 h-4 mr-2 animate-spin"}),c("common.confirm")]})]})]})}):e.jsx(ee,{open:u,onOpenChange:p,children:e.jsxs(se,{className:"max-w-[28rem]",children:[e.jsxs(te,{children:[e.jsx(ae,{children:c("setting.chat-apps.add-credential")}),e.jsx(ne,{children:c("setting.chat-apps.add-description")})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"platform",children:c("setting.chat-apps.platform")}),e.jsxs(B,{value:String(y),onValueChange:e=>w(Number(e)),children:[e.jsx(q,{id:"platform",children:e.jsx(J,{})}),e.jsxs(Y,{children:[e.jsx(Q,{value:String(us.TELEGRAM),children:"Telegram"}),e.jsx(Q,{value:String(us.WHATSAPP),children:"WhatsApp"}),e.jsx(Q,{value:String(us.DINGTALK),children:"DingTalk"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"platformUserId",children:c("setting.chat-apps.platform-user-id")}),e.jsx(Z,{id:"platformUserId",value:k,onChange:e=>C(e.target.value),placeholder:y===us.TELEGRAM?"123456789":y===us.DINGTALK?"manager1234":"user_id"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y===us.TELEGRAM&&c("setting.chat-apps.telegram-user-id-hint"),y===us.DINGTALK&&c("setting.chat-apps.dingtalk-user-id-hint")]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"accessToken",children:y===us.WHATSAPP?"Bridge API Key (Optional)":c("setting.chat-apps.access-token")}),e.jsx(Z,{id:"accessToken",type:"password",value:S,onChange:e=>A(e.target.value),placeholder:y===us.TELEGRAM?"123456789:ABCDefGhIJKlMnOPqrstUVwxYZ":"your_token_here"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y===us.TELEGRAM&&c("setting.chat-apps.telegram-token-hint"),y===us.DINGTALK&&c("setting.chat-apps.dingtalk-token-hint"),y===us.WHATSAPP&&"Leave empty if bridge does not require API key"]})]}),(y===us.DINGTALK||y===us.WHATSAPP)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"webhookUrl",children:y===us.WHATSAPP?"Bridge URL":c("setting.chat-apps.webhook-url")}),e.jsx(Z,{id:"webhookUrl",value:T,onChange:e=>U(e.target.value),placeholder:y===us.WHATSAPP?"http://localhost:3001":"https://oapi.dingtalk.com/robot/send?access_token=..."}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y===us.WHATSAPP?"URL of the Baileys Bridge service":c("setting.chat-apps.dingtalk-webhook-hint")})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"outline",onClick:()=>p(!1),children:c("common.cancel")}),e.jsxs(D,{onClick:P,disabled:g,children:[g&&e.jsx(n,{className:"w-4 h-4 mr-2 animate-spin"}),c("common.confirm")]})]})]})}),o?e.jsx(K,{open:!!b,onOpenChange:e=>!e&&N(null),children:e.jsxs(G,{side:"bottom",children:[e.jsx(H,{children:e.jsx(V,{children:c("setting.chat-apps.webhook-info")})}),e.jsx("div",{className:"space-y-4 py-4",children:b&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Webhook URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{readOnly:!0,value:b.webhook_url}),e.jsx(D,{variant:"outline",size:"icon",onClick:()=>{navigator.clipboard.writeText(b.webhook_url)},children:e.jsx(t,{className:"w-4 h-4"})})]})]}),b.setup_instructions&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Instructions"}),e.jsx("pre",{className:"text-xs bg-muted p-2 rounded whitespace-pre-wrap",children:b.setup_instructions})]})]})}),e.jsx(X,{children:e.jsx(D,{onClick:()=>N(null),children:c("common.close")})})]})}):e.jsx(ee,{open:!!b,onOpenChange:e=>!e&&N(null),children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:c("setting.chat-apps.webhook-info")})}),e.jsx("div",{className:"space-y-4 py-4",children:b&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Webhook URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Z,{readOnly:!0,value:b.webhook_url}),e.jsx(D,{variant:"outline",size:"icon",onClick:()=>{navigator.clipboard.writeText(b.webhook_url)},children:e.jsx(t,{className:"w-4 h-4"})})]})]}),b.setup_instructions&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Instructions"}),e.jsx("pre",{className:"text-xs bg-muted p-2 rounded whitespace-pre-wrap",children:b.setup_instructions})]})]})}),e.jsx(ie,{children:e.jsx(D,{onClick:()=>N(null),children:c("common.close")})})]})})]})};function fs({open:t,onOpenChange:a,onSuccess:n}){const i=_(),{generalSetting:l,updateSetting:c}=le(),[o,d]=s.useState(re(ce,l.customProfile||{})),[m,h]=s.useState(!1),x=e=>{d(s=>({...s,...e}))};return e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{size:"2xl",children:[e.jsxs(te,{children:[e.jsx(ae,{children:i("setting.system-section.customize-server.title")}),e.jsx(ne,{children:"Customize your instance appearance and settings."})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"server-name",children:i("setting.system-section.server-name")}),e.jsx(Z,{id:"server-name",type:"text",value:o.title,onChange:e=>{x({title:e.target.value})},placeholder:"Enter server name"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"icon-url",children:i("setting.system-section.customize-server.icon-url")}),e.jsx(Z,{id:"icon-url",type:"text",value:o.logoUrl,onChange:e=>{x({logoUrl:e.target.value})},placeholder:"Enter icon URL"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"description",children:i("setting.system-section.customize-server.description")}),e.jsx(oe,{id:"description",rows:3,value:o.description,onChange:e=>{x({description:e.target.value})},placeholder:"Enter description"})]})]}),e.jsxs(ie,{className:"flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsx(D,{variant:"outline",onClick:()=>{x({title:"Memos",logoUrl:"/logo.webp",description:""})},disabled:m,className:"sm:mr-auto",children:i("common.restore")}),e.jsxs("div",{className:"flex gap-2 w-full sm:w-auto",children:[e.jsx(D,{variant:"ghost",onClick:()=>{a(!1)},disabled:m,className:"flex-1 sm:flex-initial",children:i("common.cancel")}),e.jsx(D,{onClick:async()=>{if(""!==o.title){h(!0);try{await c(re(de,{name:me(he.GENERAL),value:{case:"generalSetting",value:{...l,customProfile:o}}})),r.success(i("message.update-succeed")),n?.(),a(!1)}catch(e){xe(e,r.error,{context:"Update customized profile",fallbackMessage:"Failed to update profile"})}finally{h(!1)}}else r.error("Title cannot be empty.")},disabled:m,className:"flex-1 sm:flex-initial",children:m?"Saving...":i("common.save")})]})]})]})})}const vs=({messageKey:s,description:t,title:a})=>{const n=_();return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4",children:e.jsx(c,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:a||n("setting.mobile.desktop-required-title")}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-[28rem]",children:s?n(`setting.mobile.${s}`):t||n("setting.mobile.desktop-required-description")})]})},bs=({title:s,description:t,children:a,className:n,showSeparator:i=!1})=>e.jsxs(e.Fragment,{children:[i&&e.jsx(ls,{className:"my-2"}),e.jsxs("div",{className:R("flex flex-col gap-3",n),children:[(s||t)&&e.jsxs("div",{className:"flex flex-col gap-1",children:[s&&e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:s}),t&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t})]}),e.jsx("div",{className:"flex flex-col gap-3",children:a})]})]}),Ns=({label:s,description:t,tooltip:a,children:n,className:i,vertical:l=!1})=>e.jsxs("div",{className:R("w-full flex gap-3",l?"flex-col":"flex-row justify-between items-center",i),children:[e.jsxs("div",{className:R("flex flex-col gap-1",l?"w-full":"flex-1 min-w-0"),children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:R("text-sm",l?"font-medium":""),children:s}),a&&e.jsx(ue,{children:e.jsxs(pe,{children:[e.jsx(ge,{asChild:!0,children:e.jsx(o,{className:"w-4 h-4 text-muted-foreground cursor-help"})}),e.jsx(je,{children:e.jsx("p",{className:"max-w-xs",children:a})})]})})]}),t&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t})]}),e.jsx("div",{className:R("flex items-center",l?"w-full":"shrink-0"),children:n})]}),ys=({title:s,description:t,children:a,className:n,actions:i})=>e.jsxs("div",{className:R("w-full flex flex-col gap-4 pt-2 pb-4",n),children:[(s||t||i)&&e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[s&&e.jsx("div",{className:"text-base font-semibold text-foreground mb-1",children:"string"==typeof s?e.jsx("h3",{children:s}):s}),t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:t})]}),i&&e.jsx("div",{className:"flex items-center gap-2",children:i})]}),e.jsx("div",{className:"flex flex-col gap-4",children:a})]}),ws=()=>{const t=z(),a=_(),n=is(),{generalSetting:i,profile:l,updateSetting:c,fetchSetting:o}=le(),[d,m]=s.useState(i),[h,x]=s.useState([]);s.useEffect(()=>{m({...d,customProfile:i.customProfile})},[i]);const u=e=>{m(re(be,{...d,...e}))};s.useEffect(()=>{p()},[]);const p=async()=>{const{identityProviders:e}=await fe.listIdentityProviders({});x(e)};return e.jsx(ys,{children:t?e.jsx(vs,{messageKey:"system-desktop-only"}):e.jsxs(e.Fragment,{children:[e.jsx(bs,{title:a("common.basic"),children:e.jsx(Ns,{label:a("setting.system-section.server-name"),description:d.customProfile?.title||"Memos",children:e.jsx(D,{variant:"outline",onClick:()=>{n.open()},children:a("common.edit")})})}),e.jsxs(bs,{title:a("setting.system-section.title"),showSeparator:!0,children:[e.jsx(Ns,{label:a("setting.system-section.additional-style"),vertical:!0,children:e.jsx(oe,{className:"font-mono w-full",rows:3,placeholder:a("setting.system-section.additional-style-placeholder"),value:d.additionalStyle,onChange:e=>u({additionalStyle:e.target.value})})}),e.jsx(Ns,{label:a("setting.system-section.additional-script"),vertical:!0,children:e.jsx(oe,{className:"font-mono w-full",rows:3,placeholder:a("setting.system-section.additional-script-placeholder"),value:d.additionalScript,onChange:e=>u({additionalScript:e.target.value})})})]}),e.jsxs(bs,{children:[e.jsx(Ns,{label:a("setting.instance-section.disallow-user-registration"),children:e.jsx(ve,{disabled:"demo"===l.mode,checked:d.disallowUserRegistration,onCheckedChange:e=>u({disallowUserRegistration:e})})}),e.jsx(Ns,{label:a("setting.instance-section.disallow-password-auth"),children:e.jsx(ve,{disabled:"demo"===l.mode||0===h.length&&!d.disallowPasswordAuth,checked:d.disallowPasswordAuth,onCheckedChange:e=>u({disallowPasswordAuth:e})})}),e.jsx(Ns,{label:a("setting.instance-section.disallow-change-username"),children:e.jsx(ve,{checked:d.disallowChangeUsername,onCheckedChange:e=>u({disallowChangeUsername:e})})}),e.jsx(Ns,{label:a("setting.instance-section.disallow-change-nickname"),children:e.jsx(ve,{checked:d.disallowChangeNickname,onCheckedChange:e=>u({disallowChangeNickname:e})})}),e.jsx(Ns,{label:a("setting.instance-section.week-start-day"),children:e.jsxs(B,{value:d.weekStartDayOffset.toString(),onValueChange:e=>{u({weekStartDayOffset:parseInt(e)||0})},children:[e.jsx(q,{className:"min-w-fit",children:e.jsx(J,{})}),e.jsxs(Y,{children:[e.jsx(Q,{value:"-1",children:a("setting.instance-section.saturday")}),e.jsx(Q,{value:"0",children:a("setting.instance-section.sunday")}),e.jsx(Q,{value:"1",children:a("setting.instance-section.monday")})]})]})})]}),e.jsx("div",{className:"w-full flex justify-end",children:e.jsx(D,{disabled:rs(d,i),onClick:async()=>{try{await c(re(de,{name:`instance/settings/${he[he.GENERAL]}`,value:{case:"generalSetting",value:d}})),await o(he.GENERAL)}catch(e){return void(await xe(e,r.error,{context:"Update general settings"}))}r.success(a("message.update-succeed"))},children:a("common.save")})}),!t&&e.jsx(fs,{open:n.isOpen,onOpenChange:n.setOpen,onSuccess:()=>{r.success("Profile updated successfully!")}})]})})};function ks({className:s,...t}){return e.jsx(d,{"data-slot":"radio-group",className:R("grid gap-3",s),...t})}function Cs({className:s,...t}){return e.jsx(m,{"data-slot":"radio-group-item",className:R("border-border text-primary aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(h,{"data-slot":"radio-group-indicator",className:"relative flex items-center justify-center",children:e.jsx(x,{className:"fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2"})})})}function Ss({open:t,onOpenChange:a,user:n,onSuccess:i}){const l=_(),[c,o]=s.useState(re(Ne,n?{username:n.username,role:n.role}:{})),d=ye(!1),m=!n;s.useEffect(()=>{o(re(Ne,n?{username:n.username,role:n.role}:{}))},[n]);const h=e=>{o({...c,...e})};return e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:`${l(m?"common.create":"common.edit")} ${l("common.user")}`})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"username",children:l("common.username")}),e.jsx(Z,{id:"username",type:"text",placeholder:l("common.username"),value:c.username,onChange:e=>h({username:e.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"password",children:l("common.password")}),e.jsx(Z,{id:"password",type:"password",placeholder:l("common.password"),autoComplete:"off",value:c.password,onChange:e=>h({password:e.target.value})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{children:l("common.role")}),e.jsxs(ks,{value:String(c.role),onValueChange:e=>h({role:Number(e)}),className:"flex flex-row gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:String(we.USER),id:"user"}),e.jsx($,{htmlFor:"user",children:l("setting.member-section.user")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:String(we.ADMIN),id:"admin"}),e.jsx($,{htmlFor:"admin",children:l("setting.member-section.admin")})]})]})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"ghost",disabled:d.isLoading,onClick:()=>a(!1),children:l("common.cancel")}),e.jsx(D,{disabled:d.isLoading,onClick:async()=>{if(!m||c.username&&c.password)try{if(d.setLoading(),m)await ke.createUser({user:c}),r.success("Create user successfully");else{const e=[];c.username!==n?.username&&e.push("username"),c.password&&e.push("password"),c.role!==n?.role&&e.push("role"),await ke.updateUser({user:c,updateMask:re(Ce,{paths:e})}),r.success("Update user successfully")}d.setFinish(),i?.(),a(!1)}catch(e){xe(e,r.error,{context:c?"Update user":"Create user",onError:()=>d.setError()})}else r.error("Username and password cannot be empty")},children:l("common.confirm")})]})]})})}function As({columns:s,data:t,emptyMessage:a="No data",className:n,getRowKey:i}){return e.jsx("div",{className:R("w-full overflow-x-auto",n),children:e.jsx("div",{className:"inline-block min-w-full align-middle border border-border rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-border",children:[e.jsx("thead",{children:e.jsx("tr",{className:"text-sm font-semibold text-left text-foreground",children:s.map(s=>e.jsx("th",{scope:"col",className:R("px-3 py-2",s.className),children:s.header},s.key))})}),e.jsx("tbody",{className:"divide-y divide-border",children:0===t.length?e.jsx("tr",{children:e.jsx("td",{colSpan:s.length,className:"px-3 py-4 text-center text-sm text-muted-foreground",children:a})}):t.map((t,a)=>{const n=i?i(t,a):a.toString();return e.jsx("tr",{children:s.map(s=>{const a=t[s.key],n=s.render?s.render(a,t):a;return e.jsx("td",{className:R("whitespace-nowrap px-3 py-2 text-sm text-muted-foreground",s.className),children:n},s.key)})},n)})})]})})})}const Ts=()=>{const t=z(),n=_(),i=Se(),{data:l=[],refetch:r}=Ae(),c=Te(),o=is(),d=is(),[m,h]=s.useState(),x=cs(l,"id"),[g,j]=s.useState(void 0),[f,v]=s.useState(void 0);return e.jsx(ys,{title:n("setting.member-list"),actions:!t&&e.jsxs(D,{onClick:()=>{h(void 0),o.open()},children:[e.jsx(a,{className:"w-4 h-4 mr-2"}),n("common.create")]}),children:t?e.jsx(vs,{messageKey:"member-desktop-only"}):e.jsxs(e.Fragment,{children:[e.jsx(As,{columns:[{key:"username",header:n("common.username"),render:(s,t)=>e.jsxs("span",{className:"text-foreground",children:[t.username,t.state===Ue.ARCHIVED&&e.jsx("span",{className:"ml-2 italic text-muted-foreground",children:"(Archived)"})]})},{key:"role",header:n("common.role"),render:(e,s)=>{return(t=s.role)===we.HOST?"Host":t===we.ADMIN?n("setting.member-section.admin"):n("setting.member-section.user");var t}},{key:"displayName",header:n("common.nickname"),render:(e,s)=>s.displayName},{key:"email",header:n("common.email"),render:(e,s)=>s.email},{key:"actions",header:"",className:"text-right",render:(s,t)=>i?.name===t.name?e.jsx("span",{className:"text-muted-foreground",children:n("common.yourself")}):e.jsxs(Ee,{children:[e.jsx(Le,{asChild:!0,children:e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(u,{className:"w-4 h-auto"})})}),e.jsxs(Pe,{align:"end",sideOffset:2,children:[e.jsx(Oe,{onClick:()=>(e=>{h(e),d.open()})(t),children:n("common.update")}),t.state===Ue.NORMAL?e.jsx(Oe,{onClick:()=>(async e=>{j(e)})(t),children:n("setting.member-section.archive-member")}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{onClick:()=>(async e=>{const{username:s}=e;await ke.updateUser({user:{name:e.name,state:Ue.NORMAL},updateMask:re(Ce,{paths:["state"]})}),p.success(n("setting.member-section.restore-success",{username:s})),await r()})(t),children:n("common.restore")}),e.jsx(Oe,{onClick:()=>(async e=>{v(e)})(t),className:"text-destructive focus:text-destructive",children:n("setting.member-section.delete-member")})]})]})]})}],data:x,emptyMessage:"No members found",getRowKey:e=>e.name}),!t&&e.jsx(Ss,{open:o.isOpen,onOpenChange:o.setOpen,onSuccess:r}),!t&&e.jsx(Ss,{open:d.isOpen,onOpenChange:d.setOpen,user:m,onSuccess:r}),!t&&e.jsxs(e.Fragment,{children:[e.jsx(Ie,{open:!!g,onOpenChange:e=>!e&&j(void 0),title:g?n("setting.member-section.archive-warning",{username:g.username}):"",description:g?n("setting.member-section.archive-warning-description"):"",confirmLabel:n("common.confirm"),cancelLabel:n("common.cancel"),onConfirm:async()=>{if(!g)return;const e=g.username;await ke.updateUser({user:{name:g.name,state:Ue.ARCHIVED},updateMask:re(Ce,{paths:["state"]})}),j(void 0),p.success(n("setting.member-section.archive-success",{username:e})),await r()},confirmVariant:"default"}),e.jsx(Ie,{open:!!f,onOpenChange:e=>!e&&v(void 0),title:f?n("setting.member-section.delete-warning",{username:f.username}):"",description:f?n("setting.member-section.delete-warning-description"):"",confirmLabel:n("common.delete"),cancelLabel:n("common.cancel"),onConfirm:async()=>{if(!f)return;const{username:e,name:s}=f;c.mutate(s),v(void 0),p.success(n("setting.member-section.delete-success",{username:e}))},confirmVariant:"destructive"})]})]})})},Us=()=>{const a=z(),n=_(),{memoRelatedSetting:i,updateSetting:l,fetchSetting:c}=le(),[o,d]=s.useState(i),[m,h]=s.useState(""),x=e=>{const s=re(Me,{...o,...e});d(s)},u=()=>{m&&(x({reactions:os([...o.reactions,m.trim()])}),h(""))};return e.jsx(ys,{children:a?e.jsx(vs,{messageKey:"memo-desktop-only"}):e.jsxs(e.Fragment,{children:[e.jsxs(bs,{title:n("setting.memo-related-settings.title"),children:[e.jsx(Ns,{label:n("setting.system-section.disable-public-memos"),children:e.jsx(ve,{checked:o.disallowPublicVisibility,onCheckedChange:e=>x({disallowPublicVisibility:e})})}),e.jsx(Ns,{label:n("setting.system-section.display-with-updated-time"),children:e.jsx(ve,{checked:o.displayWithUpdateTime,onCheckedChange:e=>x({displayWithUpdateTime:e})})}),e.jsx(Ns,{label:n("setting.system-section.enable-double-click-to-edit"),children:e.jsx(ve,{checked:o.enableDoubleClickEdit,onCheckedChange:e=>x({enableDoubleClickEdit:e})})}),e.jsx(Ns,{label:n("setting.memo-related-settings.content-length-limit"),children:e.jsx(Z,{className:"w-24",type:"number",defaultValue:o.contentLengthLimit,onBlur:e=>x({contentLengthLimit:Number(e.target.value)})})})]}),e.jsx(bs,{title:n("setting.memo-related-settings.reactions"),showSeparator:!0,children:e.jsxs("div",{className:"w-full flex flex-row flex-wrap gap-2",children:[o.reactions.map(s=>e.jsxs(Fe,{variant:"outline",className:"flex items-center gap-1.5 h-8 px-3",children:[s,e.jsx("span",{className:"cursor-pointer text-muted-foreground hover:text-destructive",onClick:()=>x({reactions:o.reactions.filter(e=>e!==s)}),children:e.jsx(g,{className:"w-3.5 h-3.5"})})]},s)),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Z,{className:"w-32 h-8",placeholder:n("common.input"),value:m,onChange:e=>h(e.target.value.trim()),onKeyDown:e=>"Enter"===e.key&&u()}),e.jsx(D,{variant:"ghost",size:"sm",onClick:u,className:"h-8 w-8 p-0",children:e.jsx(t,{className:"w-4 h-4"})})]})]})}),e.jsx("div",{className:"w-full flex justify-end",children:e.jsx(D,{disabled:rs(o,i),onClick:async()=>{if(0!==o.reactions.length)try{await l(re(de,{name:`instance/settings/${he[he.MEMO_RELATED]}`,value:{case:"memoRelatedSetting",value:o}})),await c(he.MEMO_RELATED),r.success(n("message.update-succeed"))}catch(e){await xe(e,r.error,{context:"Update memo-related settings"})}else r.error("Reactions must not be empty.")},children:n("common.save")})})]})})},Es=async(e="24h")=>{const s=await fetch(`/api/v1/system/metrics/overview?range=${e}`);if(!s.ok)throw new Error(`Failed to fetch metrics: ${s.statusText}`);return s.json()};function Ls(){const t=_(),a=z(),[n,i]=s.useState("24h"),[l,r]=s.useState(null),[c,o]=s.useState(!0),[d,m]=s.useState(null);s.useEffect(()=>{o(!0),m(null),Es(n).then(r).catch(e=>{m(e instanceof Error?e.message:"Failed to load metrics")}).finally(()=>o(!1))},[n]);const h=[{value:"1h",label:"1H"},{value:"24h",label:"24H"},{value:"7d",label:"7D"},{value:"30d",label:"30D"}],x=t("setting.metrics-section.overview"),u=t("setting.metrics-section.requests"),p=t("setting.metrics-section.success-rate"),g=t("setting.metrics-section.latency"),y=t("setting.metrics-section.p95"),w=t("setting.metrics-section.errors");return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"w-5 h-5 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold",children:x})]}),!a&&e.jsx("div",{className:"flex gap-1 bg-muted rounded-lg p-1",children:h.map(s=>e.jsx("button",{onClick:()=>i(s.value),className:R("px-3 py-1 text-xs font-medium rounded-md transition-colors",n===s.value?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:s.label},s.value))})]}),a&&e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:h.map(s=>e.jsx("button",{onClick:()=>i(s.value),className:R("px-4 py-2 text-sm font-medium rounded-full whitespace-nowrap transition-colors",n===s.value?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"),children:s.label},s.value))}),d&&e.jsx("div",{className:"p-4 bg-destructive/10 border border-destructive/20 rounded-xl",children:e.jsx("p",{className:"text-sm text-destructive",children:d})}),c?e.jsx("div",{className:R("grid gap-4",a?"grid-cols-2":"grid-cols-1 md:grid-cols-4"),children:[...Array(4)].map((s,t)=>e.jsx("div",{className:R("bg-muted/30 rounded-xl animate-pulse",a?"h-24":"h-28")},t))}):e.jsxs("div",{className:R("grid gap-4",a?"grid-cols-2":"grid-cols-1 md:grid-cols-4"),children:[e.jsx(Ps,{title:u,value:l?.total_requests??0,icon:e.jsx(f,{className:"w-4 h-4"}),color:"text-blue-600",bgColor:"bg-blue-500/10"}),e.jsx(Ps,{title:p,value:`${(100*(l?.success_rate??0)).toFixed(1)}%`,icon:e.jsx(v,{className:"w-4 h-4"}),color:"text-green-600",bgColor:"bg-green-500/10"}),e.jsx(Ps,{title:g,value:`${l?.p50_latency_ms??0}ms`,icon:e.jsx(b,{className:"w-4 h-4"}),color:"text-amber-600",bgColor:"bg-amber-500/10"}),e.jsx(Ps,{title:y,value:`${l?.p95_latency_ms??0}ms`,icon:e.jsx(b,{className:"w-4 h-4"}),color:"text-purple-600",bgColor:"bg-purple-500/10"})]}),l&&l.error_count>0&&e.jsxs("div",{className:R("flex items-start gap-3 rounded-xl border","bg-destructive/10 border-destructive/20"),children:[e.jsx(N,{className:"w-5 h-5 text-destructive shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:w}),e.jsxs("p",{className:"text-xs text-destructive/80 mt-1",children:[l.error_count," ",t("setting.metrics-section.errors")]})]})]}),l&&l.is_mock&&e.jsxs("div",{className:R("flex items-start gap-3 rounded-xl border p-3","bg-amber-500/10 border-amber-500/20"),children:[e.jsx(N,{className:"w-4 h-4 text-amber-600 dark:text-amber-400 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400",children:t("setting.metrics-section.mock-data")})]})]})}function Ps({title:s,value:t,icon:a,color:n,bgColor:i}){const l=z();return e.jsxs("div",{className:R("bg-card border border-border rounded-xl transition-shadow",l?"p-3":"p-4 hover:shadow-md"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:R("text-muted-foreground",l?"text-xs":"text-sm"),children:s}),e.jsx("div",{className:R("p-1.5 rounded-lg",i,l&&"p-1"),children:e.jsx("div",{className:R(n,l&&"w-3.5 h-3.5"),children:a})})]}),e.jsx("p",{className:R("font-semibold text-foreground",l?"text-lg":"text-2xl"),children:t})]})}function Os({open:t,onOpenChange:a,user:n,onSuccess:i}){const l=_(),{mutateAsync:c}=Re(),[o,d]=s.useState(""),[m,h]=s.useState("");return n?e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(ae,{children:[l("setting.account-section.change-password")," (",n.displayName,")"]})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"newPassword",children:l("auth.new-password")}),e.jsx(Z,{id:"newPassword",type:"password",placeholder:l("auth.new-password"),value:o,onChange:e=>{const s=e.target.value;d(s)}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"newPasswordAgain",children:l("auth.repeat-new-password")}),e.jsx(Z,{id:"newPasswordAgain",type:"password",placeholder:l("auth.repeat-new-password"),value:m,onChange:e=>{const s=e.target.value;h(s)}})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"ghost",onClick:()=>{a(!1)},children:l("common.cancel")}),e.jsx(D,{onClick:async()=>{if(n)if(""!==o&&""!==m){if(o!==m)return r.error(l("message.new-password-not-match")),void h("");try{await c({user:{name:n.name,password:o},updateMask:["password"]}),r(l("message.password-changed")),i?.(),a(!1)}catch(e){await xe(e,r.error,{context:"Change member password"})}}else r.error(l("message.fill-all"))},children:l("common.save")})]})]})}):null}function Is({open:t,onOpenChange:a,onSuccess:n}){const i=_(),l=Se(),{generalSetting:c}=le(),{mutateAsync:o}=Re(),[d,m]=s.useState({avatarUrl:l?.avatarUrl??"",username:l?.username??"",displayName:l?.displayName??"",email:l?.email??"",description:l?.description??""}),h=e=>{m(s=>({...s,...e}))};return e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:i("setting.account-section.update-information")})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-row items-center gap-2",children:[e.jsx($,{children:i("common.avatar")}),e.jsxs("label",{className:"relative cursor-pointer hover:opacity-80",children:[e.jsx(_e,{className:"w-10 h-10",avatarUrl:d.avatarUrl}),e.jsx("input",{type:"file",accept:"image/*",className:"absolute invisible w-full h-full inset-0",onChange:async e=>{const s=e.target.files;if(s&&s.length>0){const e=s[0];if(e.size>2097152)return void r.error("Max file size is 2MB");try{const s=await ds(e);h({avatarUrl:s})}catch(t){r.error("Failed to convert image to base64")}}}})]}),d.avatarUrl&&e.jsx(g,{className:"w-4 h-auto cursor-pointer opacity-60 hover:opacity-80",onClick:()=>h({avatarUrl:""})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{htmlFor:"username",children:[i("common.username"),e.jsxs("span",{className:"text-sm text-muted-foreground ml-1",children:["(",i("setting.account-section.username-note"),")"]})]}),e.jsx(Z,{id:"username",value:d.username,onChange:e=>{h({username:e.target.value})},disabled:c.disallowChangeUsername})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{htmlFor:"displayName",children:[i("common.nickname"),e.jsxs("span",{className:"text-sm text-muted-foreground ml-1",children:["(",i("setting.account-section.nickname-note"),")"]})]}),e.jsx(Z,{id:"displayName",value:d.displayName,onChange:e=>{h({displayName:e.target.value})},disabled:c.disallowChangeNickname})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{htmlFor:"email",children:[i("common.email"),e.jsxs("span",{className:"text-sm text-muted-foreground ml-1",children:["(",i("setting.account-section.email-note"),")"]})]}),e.jsx(Z,{id:"email",type:"email",value:d.email,onChange:e=>{m(s=>({...s,email:e.target.value}))}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx($,{htmlFor:"description",children:i("common.description")}),e.jsx(oe,{id:"description",rows:2,value:d.description,onChange:e=>{m(s=>({...s,description:e.target.value}))}})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"ghost",onClick:()=>{a(!1)},children:i("common.cancel")}),e.jsx(D,{onClick:async()=>{if(""!==d.username)try{const e=[];rs(l?.username,d.username)||e.push("username"),rs(l?.displayName,d.displayName)||e.push("display_name"),rs(l?.email,d.email)||e.push("email"),rs(l?.avatarUrl,d.avatarUrl)||e.push("avatar_url"),rs(l?.description,d.description)||e.push("description"),await o({user:{name:l?.name,username:d.username,displayName:d.displayName,email:d.email,avatarUrl:d.avatarUrl,description:d.description},updateMask:e}),r.success(i("message.update-succeed")),n?.(),a(!1)}catch(e){await xe(e,r.error,{context:"Update account"})}else r.error(i("message.fill-all"))},children:i("common.save")})]})]})})}function Fs({open:t,onOpenChange:a,onSuccess:n}){const i=_(),l=Se(),[c,o]=s.useState({description:"",expiration:30}),d=ye(!1),m=[{label:i("setting.access-token-section.create-dialog.duration-1m"),value:30},{label:"90 Days",value:90},{label:i("setting.access-token-section.create-dialog.duration-never"),value:0}],h=e=>{o({...c,...e})};return e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:i("setting.access-token-section.create-dialog.create-access-token")})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{htmlFor:"description",children:[i("setting.access-token-section.create-dialog.description")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{id:"description",type:"text",placeholder:i("setting.access-token-section.create-dialog.some-description"),value:c.description,onChange:e=>{h({description:e.target.value})}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{children:[i("setting.access-token-section.create-dialog.expiration")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(ks,{value:c.expiration.toString(),onValueChange:e=>{h({expiration:Number(e)})},className:"flex flex-row gap-4",children:m.map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:s.value.toString(),id:`expiration-${s.value}`}),e.jsx($,{htmlFor:`expiration-${s.value}`,children:s.label})]},s.value))})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"ghost",disabled:d.isLoading,onClick:()=>a(!1),children:i("common.cancel")}),e.jsx(D,{disabled:d.isLoading,onClick:async()=>{if(c.description)try{d.setLoading();const e=await ke.createPersonalAccessToken({parent:l?.name,description:c.description,expiresInDays:c.expiration});d.setFinish(),n(e),a(!1)}catch(e){xe(e,r.error,{context:"Create access token",onError:()=>d.setError()})}else r.error(i("message.description-is-required"))},children:i("common.create")})]})]})})}const Ms=async e=>{const{personalAccessTokens:s}=await ke.listPersonalAccessTokens({parent:e});return s.sort((e,s)=>((s.createdAt?ze(s.createdAt):void 0)?.getTime()??0)-((e.createdAt?ze(e.createdAt):void 0)?.getTime()??0))},Rs=()=>{const t=_(),n=Se(),i=z(),[l,c]=s.useState([]),o=is(),[d,m]=s.useState(void 0);s.useEffect(()=>{Ms(n?.name??"").then(e=>{c(e)})},[]);const h=async e=>{m(e)},x=[{key:"description",label:t("common.description"),render:(s,t)=>e.jsx("span",{className:"text-foreground",children:t.description})},{key:"createdAt",label:t("setting.access-token-section.create-dialog.created-at"),render:(e,s)=>(s.createdAt?ze(s.createdAt):void 0)?.toLocaleString()},{key:"expiresAt",label:t("setting.access-token-section.create-dialog.expires-at"),render:(e,s)=>(s.expiresAt?ze(s.expiresAt):void 0)?.toLocaleString()??t("setting.access-token-section.create-dialog.duration-never")}],u=[{key:"description",header:t("common.description"),render:(s,t)=>e.jsx("span",{className:"text-foreground",children:t.description})},{key:"createdAt",header:t("setting.access-token-section.create-dialog.created-at"),render:(e,s)=>(s.createdAt?ze(s.createdAt):void 0)?.toLocaleString()},{key:"expiresAt",header:t("setting.access-token-section.create-dialog.expires-at"),render:(e,s)=>(s.expiresAt?ze(s.expiresAt):void 0)?.toLocaleString()??t("setting.access-token-section.create-dialog.duration-never")},{key:"actions",header:"",className:"text-right",render:(s,t)=>e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>h(t),children:e.jsx(y,{className:"text-destructive w-4 h-auto"})})}];return e.jsxs("div",{className:"w-full flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:t("setting.access-token-section.title")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("setting.access-token-section.description")})]}),!i&&e.jsxs(D,{onClick:()=>{o.open()},size:"sm",children:[e.jsx(a,{className:"w-4 h-4 mr-1.5"}),t("common.create")]})]}),i?e.jsx(ps,{columns:x,data:l,emptyMessage:"No access tokens",getRowKey:e=>e.name,renderActions:s=>e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>h(s),className:"h-9 px-3",children:e.jsx(y,{className:"text-destructive w-4 h-auto"})})}):e.jsx(As,{columns:u,data:l,emptyMessage:"No access tokens found",getRowKey:e=>e.name}),e.jsx(Fs,{open:o.isOpen,onOpenChange:o.setOpen,onSuccess:async e=>{const s=await Ms(n?.name??"");c(s),e.token&&(w(e.token),r.success(t("setting.access-token-section.access-token-copied-to-clipboard"))),r.success(t("setting.access-token-section.create-dialog.access-token-created",{description:e.personalAccessToken?.description??""}))}}),e.jsx(Ie,{open:!!d,onOpenChange:e=>!e&&m(void 0),title:d?t("setting.access-token-section.access-token-deletion",{description:d.description}):"",description:t("setting.access-token-section.access-token-deletion-description"),confirmLabel:t("common.delete"),cancelLabel:t("common.cancel"),onConfirm:async()=>{if(!d)return;const{name:e,description:s}=d;await ke.deletePersonalAccessToken({name:e}),c(s=>s.filter(s=>s.name!==e)),m(void 0),r.success(t("setting.access-token-section.access-token-deleted",{description:s}))},confirmVariant:"destructive"})]})},_s=()=>{const s=_(),t=Se(),a=z(),n=is(),i=is();return e.jsxs(ys,{children:[e.jsx(bs,{title:s("setting.account-section.title"),children:e.jsxs("div",{className:"w-full flex flex-row justify-start items-center gap-3",children:[e.jsx(_e,{className:"shrink-0 w-12 h-12",avatarUrl:t?.avatarUrl}),e.jsxs("div",{className:"flex-1 min-w-0 flex flex-col justify-center items-start gap-1",children:[e.jsxs("div",{className:"w-full",children:[e.jsx("span",{className:"text-lg font-semibold",children:t?.displayName}),e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["@",t?.username]})]}),t?.description&&e.jsx("p",{className:"w-full text-sm text-muted-foreground truncate",children:t?.description})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs(D,{variant:"outline",size:"sm",onClick:()=>{n.open()},children:[e.jsx(k,{className:"w-4 h-4 mr-1.5"}),s("common.edit")]}),e.jsxs(Ee,{children:[e.jsx(Le,{asChild:!0,children:e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(u,{className:"w-4 h-4"})})}),e.jsx(Pe,{align:"end",children:e.jsx(Oe,{onClick:()=>{i.open()},children:s("setting.account-section.change-password")})})]})]})]})}),a?e.jsx(bs,{showSeparator:!0,children:e.jsxs("div",{className:"flex flex-col gap-3 px-4 py-6 bg-muted/30 rounded-lg border border-border text-center",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:s("setting.access-token-section.title")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s("setting.mobile.api-management-desktop-only")||"API access token management is only available on desktop"})]})}):e.jsx(bs,{showSeparator:!0,children:e.jsx(Rs,{})}),e.jsx(Is,{open:n.isOpen,onOpenChange:n.setOpen}),e.jsx(Os,{open:i.isOpen,onOpenChange:i.setOpen,user:t})]})};function zs({open:t,onOpenChange:a,webhookName:n,onSuccess:i}){const l=_(),c=Se(),[o,d]=s.useState({displayName:"",url:""}),m=ye(!1),h=void 0===n;s.useEffect(()=>{n&&c&&ke.listUserWebhooks({parent:c.name}).then(e=>{const s=e.webhooks.find(e=>e.name===n);s&&d({displayName:s.displayName,url:s.url})})},[n,c]);const x=e=>{d({...o,...e})};return e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsx(ae,{children:l(h?"setting.webhook-section.create-dialog.create-webhook":"setting.webhook-section.create-dialog.edit-webhook")})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{htmlFor:"displayName",children:[l("setting.webhook-section.create-dialog.title")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{id:"displayName",type:"text",placeholder:l("setting.webhook-section.create-dialog.an-easy-to-remember-name"),value:o.displayName,onChange:e=>{x({displayName:e.target.value})}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs($,{htmlFor:"url",children:[l("setting.webhook-section.create-dialog.payload-url")," ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{id:"url",type:"text",placeholder:l("setting.webhook-section.create-dialog.url-example-post-receive"),value:o.url,onChange:e=>{x({url:e.target.value})}})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"ghost",disabled:m.isLoading,onClick:()=>a(!1),children:l("common.cancel")}),e.jsx(D,{disabled:m.isLoading,onClick:async()=>{if(o.displayName&&o.url)if(c)try{m.setLoading(),h?await ke.createUserWebhook({parent:c.name,webhook:{displayName:o.displayName,url:o.url}}):await ke.updateUserWebhook({webhook:{name:n,displayName:o.displayName,url:o.url},updateMask:re(Ce,{paths:["display_name","url"]})}),i?.(),a(!1),m.setFinish()}catch(e){xe(e,r.error,{context:n?"Update webhook":"Create webhook",onError:()=>m.setError()})}else r.error("User not authenticated");else r.error(l("message.fill-all-required-fields"))},children:l("common.create")})]})]})})}const Ds=()=>{const t=_(),n=Se(),[i,l]=s.useState([]),[r,c]=s.useState(!1),[o,d]=s.useState(void 0),m=async()=>{if(!n)return[];const{webhooks:e}=await ke.listUserWebhooks({parent:n.name});return e};s.useEffect(()=>{m().then(e=>{l(e)})},[n]);return e.jsxs("div",{className:"w-full flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:t("setting.webhook-section.title")}),e.jsxs(D,{onClick:()=>c(!0),size:"sm",children:[e.jsx(a,{className:"w-4 h-4 mr-1.5"}),t("common.create")]})]}),e.jsx(As,{columns:[{key:"displayName",header:t("common.name"),render:(s,t)=>e.jsx("span",{className:"text-foreground",children:t.displayName})},{key:"url",header:t("setting.webhook-section.url"),render:(s,t)=>e.jsx("span",{className:"max-w-[300px] inline-block truncate text-foreground",title:t.url,children:t.url})},{key:"actions",header:"",className:"text-right",render:(s,t)=>e.jsx(D,{variant:"ghost",size:"sm",onClick:()=>(async e=>{d(e)})(t),children:e.jsx(y,{className:"text-destructive w-4 h-auto"})})}],data:i,emptyMessage:t("setting.webhook-section.no-webhooks-found"),getRowKey:e=>e.name}),e.jsx("div",{className:"w-full",children:e.jsxs(C,{className:"text-muted-foreground text-sm inline-flex items-center hover:underline hover:text-primary",to:"https://divinesense.com/docs/integrations/webhooks",target:"_blank",children:[t("common.learn-more"),e.jsx(S,{className:"w-4 h-4 ml-1"})]})}),e.jsx(zs,{open:r,onOpenChange:c,onSuccess:async()=>{const e=await m(),s=e[e.length-1]?.displayName||"";l(e),c(!1),p.success(t("setting.webhook-section.create-dialog.create-webhook-success",{name:s}))}}),e.jsx(Ie,{open:!!o,onOpenChange:e=>!e&&d(void 0),title:t("setting.webhook-section.delete-dialog.delete-webhook-title",{name:o?.displayName||""}),description:t("setting.webhook-section.delete-dialog.delete-webhook-description"),confirmLabel:t("common.delete"),cancelLabel:t("common.cancel"),onConfirm:async()=>{o&&(await ke.deleteUserWebhook({name:o.name}),l(i.filter(e=>e.name!==o.name)),d(void 0),p.success(t("setting.webhook-section.delete-dialog.delete-webhook-success",{name:o.displayName})))},confirmVariant:"destructive"})]})},Ks=["en","zh-Hans","zh-Hant"],Gs=[{value:$e.PRIVATE,labelKey:"memo.visibility.private"},{value:$e.PROTECTED,labelKey:"memo.visibility.protected"},{value:$e.PUBLIC,labelKey:"memo.visibility.public"}],Hs=()=>{const a=_(),{currentUser:n,userGeneralSetting:i,refetchSettings:l}=De(),{mutate:r}=Ke(n?.name),c=z(),[o,d]=s.useState(!1),[m,h]=s.useState(!1),[x,u]=s.useState(!1),p=async e=>{qe(e),r({generalSetting:{locale:e},updateMask:["locale"]},{onSuccess:()=>{l()}}),d(!1)},g=e=>{r({generalSetting:{memoVisibility:e},updateMask:["memo_visibility"]},{onSuccess:()=>{l()}}),u(!1)},j=async e=>{Je(e),r({generalSetting:{theme:e},updateMask:["theme"]},{onSuccess:()=>{l()}}),h(!1)},f=i||re(Ge,{locale:"en",memoVisibility:"PRIVATE",theme:"system"}),v=()=>e.jsx(K,{open:o,onOpenChange:d,children:e.jsxs(G,{side:"bottom",className:"px-4 pb-6",children:[e.jsx(H,{children:e.jsx(V,{children:a("common.language")})}),e.jsx("div",{className:"mt-4",children:Ks.map(s=>e.jsxs("button",{onClick:()=>p(s),className:R("w-full flex items-center justify-between px-4 py-3 border-b border-border last:border-0","active:bg-muted/50",f.locale===s&&"bg-muted/30"),children:[e.jsx("span",{className:"text-sm",children:"en"===s?"English":"zh-Hans"===s?"简体中文":"繁體中文"}),f.locale===s&&e.jsx(t,{className:"w-5 h-5 text-green-600"})]},s))})]})}),b=()=>e.jsx(K,{open:m,onOpenChange:h,children:e.jsxs(G,{side:"bottom",className:"px-4 pb-6",children:[e.jsx(H,{children:e.jsx(V,{children:a("setting.preference-section.theme")})}),e.jsx("div",{className:"mt-4",children:He.filter(e=>["system","light","dark"].includes(e.value)).map(s=>e.jsxs("button",{onClick:()=>j(s.value),className:R("w-full flex items-center justify-between px-4 py-3 border-b border-border last:border-0","active:bg-muted/50",f.theme===s.value&&"bg-muted/30"),children:[e.jsx("span",{className:"text-sm",children:s.label}),f.theme===s.value&&e.jsx(t,{className:"w-5 h-5 text-green-600"})]},s.value))})]})}),N=()=>e.jsx(K,{open:x,onOpenChange:u,children:e.jsxs(G,{side:"bottom",className:"px-4 pb-6",children:[e.jsx(H,{children:e.jsx(V,{children:a("setting.preference-section.default-memo-visibility")})}),e.jsx("div",{className:"mt-4",children:Gs.map(s=>e.jsxs("button",{onClick:()=>g(Be(s.value)),className:R("w-full flex items-center justify-between px-4 py-3 border-b border-border last:border-0","active:bg-muted/50",f.memoVisibility===Be(s.value)&&"bg-muted/30"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ve,{visibility:s.value}),e.jsx("span",{className:"text-sm",children:a(s.labelKey)})]}),f.memoVisibility===Be(s.value)&&e.jsx(t,{className:"w-5 h-5 text-green-600"})]},s.value))})]})});return e.jsxs(ys,{children:[e.jsxs(bs,{title:a("common.basic"),children:[c?e.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-3 border-b border-border last:border-0 active:bg-muted/50",onClick:()=>d(!0),children:[e.jsx("span",{className:"text-sm",children:a("common.language")}),e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[f.locale,e.jsx(A,{className:"w-4 h-4"})]})]}):e.jsx(Ns,{label:a("common.language"),children:e.jsx(hs,{value:f.locale,onChange:p})}),c?e.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-3 border-b border-border last:border-0 active:bg-muted/50",onClick:()=>h(!0),children:[e.jsx("span",{className:"text-sm",children:a("setting.preference-section.theme")}),e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[He.find(e=>e.value===f.theme)?.label||f.theme,e.jsx(A,{className:"w-4 h-4"})]})]}):e.jsx(Ns,{label:a("setting.preference-section.theme"),children:e.jsx(xs,{value:f.theme,onValueChange:j})})]}),e.jsx(bs,{title:a("setting.preference"),showSeparator:!0,children:c?e.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-3 border-b border-border last:border-0 active:bg-muted/50",onClick:()=>u(!0),children:[e.jsx("span",{className:"text-sm",children:a("setting.preference-section.default-memo-visibility")}),e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[e.jsx(Ve,{visibility:We(f.memoVisibility)}),e.jsx(A,{className:"w-4 h-4"})]})]}):e.jsx(Ns,{label:a("setting.preference-section.default-memo-visibility"),children:e.jsxs(B,{value:f.memoVisibility||"PRIVATE",onValueChange:g,children:[e.jsx(q,{className:"min-w-fit",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ve,{visibility:We(f.memoVisibility)}),e.jsx(J,{})]})}),e.jsx(Y,{children:[$e.PRIVATE,$e.PROTECTED,$e.PUBLIC].map(e=>Be(e)).map(s=>e.jsx(Q,{value:s,className:"whitespace-nowrap",children:a(`memo.visibility.${s.toLowerCase()}`)},s))})]})})}),!c&&e.jsx(bs,{showSeparator:!0,children:e.jsx(Ds,{})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(v,{}),e.jsx(b,{}),e.jsx(N,{})]})]})},Vs=[re(es,{name:"",title:"GitHub",type:Ye.OAUTH2,identifierFilter:"",config:re(Xe,{config:{case:"oauth2Config",value:re(Ze,{clientId:"",clientSecret:"",authUrl:"https://github.com/login/oauth/authorize",tokenUrl:"https://github.com/login/oauth/access_token",userInfoUrl:"https://api.github.com/user",scopes:["read:user"],fieldMapping:re(Qe,{identifier:"login",displayName:"name",email:"email"})})}})}),re(es,{name:"",title:"GitLab",type:Ye.OAUTH2,identifierFilter:"",config:re(Xe,{config:{case:"oauth2Config",value:re(Ze,{clientId:"",clientSecret:"",authUrl:"https://gitlab.com/oauth/authorize",tokenUrl:"https://gitlab.com/oauth/token",userInfoUrl:"https://gitlab.com/oauth/userinfo",scopes:["openid"],fieldMapping:re(Qe,{identifier:"name",displayName:"name",email:"email"})})}})}),re(es,{name:"",title:"Google",type:Ye.OAUTH2,identifierFilter:"",config:re(Xe,{config:{case:"oauth2Config",value:re(Ze,{clientId:"",clientSecret:"",authUrl:"https://accounts.google.com/o/oauth2/v2/auth",tokenUrl:"https://oauth2.googleapis.com/token",userInfoUrl:"https://www.googleapis.com/oauth2/v2/userinfo",scopes:["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile"],fieldMapping:re(Qe,{identifier:"email",displayName:"name",email:"email"})})}})}),re(es,{name:"",title:"Custom",type:Ye.OAUTH2,identifierFilter:"",config:re(Xe,{config:{case:"oauth2Config",value:re(Ze,{clientId:"",clientSecret:"",authUrl:"",tokenUrl:"",userInfoUrl:"",scopes:[],fieldMapping:re(Qe,{identifier:"",displayName:"",email:""})})}})})];function Ws({open:t,onOpenChange:a,identityProvider:n,onSuccess:i}){const l=_(),c=[...new Set(Vs.map(e=>e.type))],[o,d]=s.useState({title:"",identifierFilter:""}),[m,h]=s.useState(Ye.OAUTH2),[x,u]=s.useState(re(Ze,{clientId:"",clientSecret:"",authUrl:"",tokenUrl:"",userInfoUrl:"",scopes:[],fieldMapping:re(Qe,{identifier:"",displayName:"",email:""})})),[p,g]=s.useState(""),[j,f]=s.useState("GitHub"),v=void 0===n;s.useEffect(()=>{t||(d({title:"",identifierFilter:""}),h(Ye.OAUTH2),u(re(Ze,{clientId:"",clientSecret:"",authUrl:"",tokenUrl:"",userInfoUrl:"",scopes:[],fieldMapping:re(Qe,{identifier:"",displayName:"",email:""})})),g(""),f("GitHub"))},[t]),s.useEffect(()=>{if(t&&n&&(d({title:n.title,identifierFilter:n.identifierFilter}),h(n.type),n.type===Ye.OAUTH2&&"oauth2Config"===n.config?.config?.case)){const e=re(Ze,n.config.config.value||{});u(e),g(e.scopes.join(" "))}},[t,n]),s.useEffect(()=>{if(!v||!t)return;const e=Vs.find(e=>e.title===j);if(e&&(d({title:e.title,identifierFilter:e.identifierFilter}),h(e.type),e.type===Ye.OAUTH2&&"oauth2Config"===e.config?.config?.case)){const s=re(Ze,e.config.config.value||{});u(s),g(s.scopes.join(" "))}},[j,v,t]);const b=e=>{u({...x,...e})};return e.jsx(ee,{open:t,onOpenChange:a,children:e.jsxs(se,{size:"2xl",className:"max-h-[80vh] overflow-y-auto",children:[e.jsx(te,{children:e.jsx(ae,{children:l(v?"setting.sso-section.create-sso":"setting.sso-section.update-sso")})}),e.jsxs("div",{className:"flex flex-col justify-start items-start w-full space-y-4",children:[v&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"mb-1!",children:l("common.type")}),e.jsxs(B,{value:String(m),onValueChange:e=>h(parseInt(e)),children:[e.jsx(q,{className:"w-full mb-4",children:e.jsx(J,{})}),e.jsx(Y,{children:c.map(s=>e.jsx(Q,{value:String(s),children:Ye[s]||s},s))})]}),e.jsx("p",{className:"mb-2 text-sm font-medium",children:l("setting.sso-section.template")}),e.jsxs(B,{value:j,onValueChange:e=>f(e),children:[e.jsx(q,{className:"mb-1 h-auto w-full",children:e.jsx(J,{})}),e.jsx(Y,{children:Vs.map(s=>e.jsx(Q,{value:s.title,children:s.title},s.title))})]}),e.jsx(ls,{className:"my-2"})]}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("common.name"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("common.name"),value:o.title,onChange:e=>d({...o,title:e.target.value})}),e.jsx("p",{className:"mb-1 text-sm font-medium",children:l("setting.sso-section.identifier-filter")}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.identifier-filter"),value:o.identifierFilter,onChange:e=>d({...o,identifierFilter:e.target.value})}),e.jsx(ls,{className:"my-2"}),m===Ye.OAUTH2&&e.jsxs(e.Fragment,{children:[v&&e.jsxs("p",{className:"border border-border rounded-md p-2 text-sm w-full mb-2 break-all",children:[l("setting.sso-section.redirect-url"),": ",ms("/auth/callback")]}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.client-id"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.client-id"),value:x.clientId,onChange:e=>b({clientId:e.target.value})}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.client-secret"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.client-secret"),value:x.clientSecret,onChange:e=>b({clientSecret:e.target.value})}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.authorization-endpoint"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.authorization-endpoint"),value:x.authUrl,onChange:e=>b({authUrl:e.target.value})}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.token-endpoint"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.token-endpoint"),value:x.tokenUrl,onChange:e=>b({tokenUrl:e.target.value})}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.user-endpoint"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.user-endpoint"),value:x.userInfoUrl,onChange:e=>b({userInfoUrl:e.target.value})}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.scopes"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.scopes"),value:p,onChange:e=>g(e.target.value)}),e.jsx(ls,{className:"my-2"}),e.jsxs("p",{className:"mb-1 text-sm font-medium",children:[l("setting.sso-section.identifier"),e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.identifier"),value:x.fieldMapping.identifier,onChange:e=>b({fieldMapping:{...x.fieldMapping,identifier:e.target.value}})}),e.jsx("p",{className:"mb-1 text-sm font-medium",children:l("setting.sso-section.display-name")}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("setting.sso-section.display-name"),value:x.fieldMapping.displayName,onChange:e=>b({fieldMapping:{...x.fieldMapping,displayName:e.target.value}})}),e.jsx("p",{className:"mb-1 text-sm font-medium",children:l("common.email")}),e.jsx(Z,{className:"mb-2 w-full",placeholder:l("common.email"),value:x.fieldMapping.email,onChange:e=>b({fieldMapping:{...x.fieldMapping,email:e.target.value}})}),e.jsx("p",{className:"mb-1 text-sm font-medium",children:"Avatar URL"}),e.jsx(Z,{className:"mb-2 w-full",placeholder:"Avatar URL",value:x.fieldMapping.avatarUrl,onChange:e=>b({fieldMapping:{...x.fieldMapping,avatarUrl:e.target.value}})})]})]}),e.jsxs(ie,{children:[e.jsx(D,{variant:"ghost",onClick:()=>{a(!1)},children:l("common.cancel")}),e.jsx(D,{onClick:async()=>{try{v?(await fe.createIdentityProvider({identityProvider:re(es,{...o,type:m,config:re(Xe,{config:{case:"oauth2Config",value:{...x,scopes:p.split(" ")}}})})}),r.success(l("setting.sso-section.sso-created",{name:o.title}))):(await fe.updateIdentityProvider({identityProvider:re(es,{...o,name:n.name,type:m,config:re(Xe,{config:{case:"oauth2Config",value:{...x,scopes:p.split(" ")}}})}),updateMask:re(Ce,{paths:["title","identifier_filter","config"]})}),r.success(l("setting.sso-section.sso-updated",{name:o.title})))}catch(e){await xe(e,r.error,{context:v?"Create identity provider":"Update identity provider"})}i?.(),a(!1)},disabled:!(()=>{if(""===o.title)return!1;if(m===Ye.OAUTH2){if(""===x.clientId||""===x.authUrl||""===x.tokenUrl||""===x.userInfoUrl||""===p||""===x.fieldMapping?.identifier)return!1;if(v&&""===x.clientSecret)return!1}return!0})(),children:l(v?"common.create":"common.update")})]})]})})}const $s=s=>{const{className:t,url:a,title:n}=s,i=_();return e.jsx(ue,{children:e.jsxs(pe,{children:[e.jsx(ge,{asChild:!0,children:e.jsx("a",{className:`text-muted-foreground hover:text-primary ${t}`,href:a,target:"_blank",children:e.jsx(S,{className:"w-4 h-auto"})})}),e.jsx(je,{children:e.jsx("p",{children:n??i("common.learn-more")})})]})})},Bs=()=>{const t=z(),n=_(),[i,l]=s.useState([]),[c,o]=s.useState(!1),[d,m]=s.useState(),[h,x]=s.useState(void 0);s.useEffect(()=>{p()},[]);const p=async()=>{const{identityProviders:e}=await fe.listIdentityProviders({});l(e)};return e.jsx(ys,{title:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:n("setting.sso-section.sso-list")}),!t&&e.jsx($s,{url:"https://divinesense.com/docs/configuration/authentication"})]}),actions:!t&&e.jsxs(D,{onClick:()=>{m(void 0),o(!0)},children:[e.jsx(a,{className:"w-4 h-4 mr-2"}),n("common.create")]}),children:t?e.jsx(vs,{messageKey:"sso-desktop-only"}):e.jsxs(e.Fragment,{children:[e.jsx(As,{columns:[{key:"title",header:n("common.name"),render:(s,t)=>e.jsxs("span",{className:"text-foreground",children:[t.title,e.jsxs("span",{className:"ml-2 text-sm text-muted-foreground",children:["(",t.type,")"]})]})},{key:"actions",header:"",className:"text-right",render:(s,t)=>e.jsxs(Ee,{children:[e.jsx(Le,{asChild:!0,children:e.jsx(D,{variant:"outline",size:"sm",children:e.jsx(u,{className:"w-4 h-auto"})})}),e.jsxs(Pe,{align:"end",sideOffset:2,children:[e.jsx(Oe,{onClick:()=>(m(t),void o(!0)),children:n("common.edit")}),e.jsx(Oe,{onClick:()=>(async e=>{x(e)})(t),className:"text-destructive focus:text-destructive",children:n("common.delete")})]})]})}],data:i,emptyMessage:n("setting.sso-section.no-sso-found"),getRowKey:e=>e.name}),e.jsx(Ws,{open:c,onOpenChange:e=>{o(e),e||m(void 0)},identityProvider:d,onSuccess:async()=>{await p(),o(!1),m(void 0)}}),e.jsx(Ie,{open:!!h,onOpenChange:e=>!e&&x(void 0),title:h?n("setting.sso-section.confirm-delete",{name:h.title}):"",confirmLabel:n("common.delete"),cancelLabel:n("common.cancel"),onConfirm:async()=>{if(h){try{await fe.deleteIdentityProvider({name:h.name})}catch(e){xe(e,r.error,{context:"Delete identity provider"})}await p(),x(void 0)}},confirmVariant:"destructive"})]})})},qs=()=>{const t=z(),a=_(),{storageSetting:n,updateSetting:i,fetchSetting:l}=le(),[c,o]=s.useState(n);s.useEffect(()=>{o(n)},[n]);const d=s.useMemo(()=>{if(c.uploadSizeLimitMb<=0)return!1;if(c.storageType===ss.LOCAL){if(0===c.filepathTemplate.length)return!1}else if(c.storageType===ss.S3&&(0===c.s3Config?.accessKeyId.length||0===c.s3Config?.accessKeySecret.length||0===c.s3Config?.endpoint.length||0===c.s3Config?.region.length||0===c.s3Config?.bucket.length))return!1;return!rs(n,c)},[c,n]),m=async e=>{const s=c.s3Config,t={accessKeyId:s?.accessKeyId??"",accessKeySecret:s?.accessKeySecret??"",endpoint:s?.endpoint??"",region:s?.region??"",bucket:s?.bucket??"",usePathStyle:s?.usePathStyle??!1,...e},a=re(ts,{storageType:c.storageType,filepathTemplate:c.filepathTemplate,uploadSizeLimitMb:c.uploadSizeLimitMb,s3Config:re(as,t)});o(a)};return e.jsx(ys,{children:t?e.jsx(vs,{messageKey:"storage-desktop-only"}):e.jsxs(e.Fragment,{children:[e.jsxs(bs,{title:a("setting.storage-section.current-storage"),children:[e.jsx("div",{className:"w-full",children:e.jsxs(ks,{value:String(c.storageType),onValueChange:e=>{(async e=>{const s=re(ts,{...c,storageType:e});o(s)})(Number(e))},className:"flex flex-row gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:String(ss.DATABASE),id:"database"}),e.jsx($,{htmlFor:"database",children:a("setting.storage-section.type-database")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:String(ss.LOCAL),id:"local"}),e.jsx($,{htmlFor:"local",children:a("setting.storage-section.type-local")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:String(ss.S3),id:"s3"}),e.jsx($,{htmlFor:"s3",children:"S3"})]})]})}),e.jsx(Ns,{label:a("setting.system-section.max-upload-size"),tooltip:a("setting.system-section.max-upload-size-hint"),children:e.jsx(Z,{className:"w-24 font-mono",value:String(c.uploadSizeLimitMb),onChange:async e=>{let s=parseInt(e.target.value);Number.isNaN(s)&&(s=0);const t=re(ts,{...c,uploadSizeLimitMb:BigInt(s)});o(t)}})}),c.storageType!==ss.DATABASE&&e.jsx(Ns,{label:a("setting.storage-section.filepath-template"),children:e.jsx(Z,{className:"w-64",value:c.filepathTemplate,placeholder:"assets/{timestamp}_{filename}",onChange:async e=>{const s=re(ts,{...c,filepathTemplate:e.target.value});o(s)}})})]}),c.storageType===ss.S3&&e.jsxs(bs,{title:"S3 Configuration",showSeparator:!0,children:[e.jsx(Ns,{label:"Access key id",children:e.jsx(Z,{className:"w-64",value:c.s3Config?.accessKeyId,onChange:async e=>{m({accessKeyId:e.target.value})}})}),e.jsx(Ns,{label:"Access key secret",children:e.jsx(Z,{className:"w-64",type:"password",value:c.s3Config?.accessKeySecret,onChange:async e=>{m({accessKeySecret:e.target.value})}})}),e.jsx(Ns,{label:"Endpoint",children:e.jsx(Z,{className:"w-64",value:c.s3Config?.endpoint,onChange:async e=>{m({endpoint:e.target.value})}})}),e.jsx(Ns,{label:"Region",children:e.jsx(Z,{className:"w-64",value:c.s3Config?.region,onChange:async e=>{m({region:e.target.value})}})}),e.jsx(Ns,{label:"Bucket",children:e.jsx(Z,{className:"w-64",value:c.s3Config?.bucket,onChange:async e=>{m({bucket:e.target.value})}})}),e.jsx(Ns,{label:"Use Path Style",children:e.jsx(ve,{checked:c.s3Config?.usePathStyle,onCheckedChange:e=>{m({usePathStyle:{target:{checked:e}}.target.checked})}})})]}),e.jsx("div",{className:"w-full flex justify-end",children:e.jsx(D,{disabled:!d,onClick:async()=>{try{await i(re(de,{name:`instance/settings/${he[he.STORAGE]}`,value:{case:"storageSetting",value:c}})),await l(he.STORAGE),r.success("Updated")}catch(e){xe(e,r.error,{context:"Update storage settings"})}},children:a("common.save")})})]})})},Js=["my-account","preference","chat-apps"],Ys=["member","system","memo-related","storage","sso","metrics"],Qs={"my-account":M,preference:F,"chat-apps":I,member:O,system:P,"memo-related":L,storage:E,sso:U,metrics:j},Zs={"my-account":"setting.my-account",preference:"setting.preference","chat-apps":"setting.chat-apps.title",member:"setting.member-list",system:"setting.system-section.title","memo-related":"setting.memo-related-title",storage:"setting.storage-section.title",sso:"setting.sso-section.title",metrics:"setting.metrics-title"},Xs=()=>{const t=_(),a=ns("sm"),n=T(),i=Se(),{profile:l,fetchSetting:r}=le(),[c,o]=s.useState({selectedSection:"my-account"}),d=i?.role===we.HOST;s.useEffect(()=>{let e=n.hash.slice(1);[...Js,...Ys].includes(e)||(e="my-account"),o({selectedSection:e})},[n.hash]),s.useEffect(()=>{d&&(async()=>{[he.MEMO_RELATED,he.STORAGE].forEach(async e=>{await r(e)})})()},[d,r]);const m=s.useCallback(e=>{window.location.hash=e,o({selectedSection:e})},[]),h=()=>{switch(c.selectedSection){case"my-account":return e.jsx(_s,{});case"preference":return e.jsx(Hs,{});case"chat-apps":return e.jsx(js,{});case"member":return e.jsx(Ts,{});case"system":return e.jsx(ws,{});case"memo-related":return e.jsx(Us,{});case"storage":return e.jsx(qs,{});case"sso":return e.jsx(Bs,{});case"metrics":return e.jsx(Ls,{});default:return null}},x=(s,a)=>e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground mb-3 px-4",children:t(s)}),e.jsx("div",{className:"bg-background border border-border rounded-xl overflow-hidden",children:a.map(s=>{const a=Qs[s],n=Zs[s];return e.jsxs("button",{onClick:()=>m(s),className:R("w-full flex items-center gap-3 px-4 py-3 border-b border-border last:border-0","active:bg-muted/50",c.selectedSection===s&&"bg-muted/30"),children:[e.jsx(a,{className:"w-5 h-5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"text-sm text-foreground flex-1 text-left",children:t("chat-apps"===s?`setting.${s}.title`:n)}),e.jsx(A,{className:"w-5 h-5 text-muted-foreground shrink-0"})]},s)})})]});return e.jsx("section",{className:"@container w-full max-w-[100rem] min-h-full flex flex-col justify-start items-start pb-8",children:e.jsxs("div",{className:"w-full",children:[a&&e.jsxs("div",{className:"w-full border border-border flex flex-row justify-start items-start px-4 py-3 rounded-xl bg-background text-muted-foreground",children:[e.jsxs("div",{className:"flex flex-col justify-start items-start w-40 h-auto shrink-0 py-2",children:[e.jsx("span",{className:"text-sm mt-0.5 pl-3 font-mono select-none text-muted-foreground",children:t("common.basic")}),e.jsx("div",{className:"w-full flex flex-col justify-start items-start mt-1",children:Js.map(s=>e.jsx("button",{onClick:()=>m(s),className:R("w-full text-left px-3 py-1.5 rounded-md text-sm hover:bg-muted/50 transition-colors",c.selectedSection===s&&"bg-muted/30"),children:t("chat-apps"===s?`setting.${s}.title`:`setting.${s}`)},s))}),d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-sm mt-4 pl-3 font-mono select-none text-muted-foreground",children:t("common.admin")}),e.jsxs("div",{className:"w-full flex flex-col justify-start items-start mt-1",children:[Ys.map(s=>e.jsx("button",{onClick:()=>m(s),className:R("w-full text-left px-3 py-1.5 rounded-md text-sm hover:bg-muted/50 transition-colors",c.selectedSection===s&&"bg-muted/30"),children:t(`setting.${s}`)},s)),e.jsxs("span",{className:"px-3 mt-2 opacity-70 text-sm",children:[t("setting.version"),": v",l.version]})]})]}):null]}),e.jsx("div",{className:"w-full grow sm:pl-4 overflow-x-auto",children:h()})]}),!a&&e.jsxs(e.Fragment,{children:[x("setting.personal",Js),d&&x("setting.admin",Ys),e.jsx("div",{className:"mt-4",children:h()})]})]})})};export{Xs as default};
