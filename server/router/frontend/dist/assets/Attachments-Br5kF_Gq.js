import{r as e,j as s,bB as t,aQ as a,bC as l,bD as r,bE as i,bF as n,bG as c,F as o,bH as m,bI as d,b as u,c as x,aB as f,a9 as h,o as p,aF as j,n as w,a$ as g}from"./react-vendor-LyyF-653.js";import{g as y}from"./mermaid-vendor-B1M2OtO5.js";import{J as v,K as N,n as b,L as k,N as F,O as C,i as S,r as T,Q as W,h as z,T as M,E,G as L,W as P,t as A}from"./index-D99LTaa7.js";import{S as O}from"./separator-Jvca_ZrM.js";import{u as Q}from"./useDialog-BOQkoYHr.js";import{i as Y}from"./i18n-vendor-Cyfgqt0p.js";import"./ui-vendor-ByoYm48K.js";import"./leaflet-vendor-Cu4zZue4.js";import"./markdown-vendor-DtAGkuPo.js";import"./math-vendor-JUchi9-2.js";import"./lodash-vendor-DIRPa7cU.js";import"./polyfills-RlNY0w59.js";const D=t=>{const{children:a,className:l}=t,r=t.baseSide||"width",i=e.useRef(null);return e.useEffect(()=>{const e=()=>{if(i.current)if("width"===r){const e=i.current.clientWidth;i.current.style.height=e+"px"}else{const e=i.current.clientHeight;i.current.style.width=e+"px"}};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[]),s.jsx("div",{ref:i,className:`${["width"===r?"w-full":"h-full",l??""].join(" ")}`,children:a})},K=t.memo(t=>{const{attachment:u}=t,[x,f]=e.useState({open:!1,urls:[],index:0}),h=v(u),p=N(u),j=b("w-full h-auto",t.className),w=t.strokeWidth,g=()=>{window.open(p)},y=()=>{f({open:!0,urls:[p],index:0})};if("image/*"===h)return s.jsxs(s.Fragment,{children:[s.jsx(D,{className:b(j,"flex items-center justify-center overflow-clip"),children:s.jsx("img",{className:"min-w-full min-h-full object-cover",src:k(u),onClick:y,onError:e=>{const s=e.target;s.src.includes("?thumbnail=true")&&(s.src=p)},decoding:"async",loading:"lazy"})}),s.jsx(F,{open:x.open,onOpenChange:e=>f(s=>({...s,open:e})),imgUrls:x.urls,initialIndex:x.index})]});return s.jsx("div",{onClick:g,className:b(j,"max-w-16 opacity-50 cursor-pointer"),children:(()=>{switch(h){case"video/*":return s.jsx(d,{strokeWidth:w,className:"w-full h-auto"});case"audio/*":return s.jsx(m,{strokeWidth:w,className:"w-full h-auto"});case"text/*":return s.jsx(o,{strokeWidth:w,className:"w-full h-auto"});case"application/epub+zip":case"application/pdf":return s.jsx(c,{strokeWidth:w,className:"w-full h-auto"});case"application/msword":return s.jsx(n,{strokeWidth:w,className:"w-full h-auto"});case"application/msexcel":return s.jsx(i,{strokeWidth:w,className:"w-full h-auto"});case"application/zip":return s.jsx(r,{onClick:g,strokeWidth:w,className:"w-full h-auto"});case"application/x-java-archive":return s.jsx(l,{strokeWidth:w,className:"w-full h-auto"});default:return s.jsx(a,{strokeWidth:w,className:"w-full h-auto"})}})()})}),$={all:["attachments"],lists:()=>[...$.all,"list"],list:e=>[...$.lists(),e],details:()=>[...$.all,"detail"],detail:e=>[...$.details(),e]};const q=({attachment:e})=>s.jsxs("div",{className:"w-24 sm:w-32 h-auto flex flex-col justify-start items-start",children:[s.jsx("div",{className:"w-24 h-24 flex justify-center items-center sm:w-32 sm:h-32 border border-border overflow-clip rounded-xl cursor-pointer hover:shadow hover:opacity-80",children:s.jsx(K,{attachment:e,strokeWidth:.5})}),s.jsxs("div",{className:"w-full max-w-full flex flex-row justify-between items-center mt-1 px-1",children:[s.jsx("p",{className:"text-xs shrink text-muted-foreground truncate",children:e.filename}),e.memo&&s.jsx(w,{to:`/${e.memo}`,className:"text-primary hover:opacity-80 transition-opacity shrink-0 ml-1","aria-label":"View memo",children:s.jsx(g,{className:"w-3 h-3"})})]})]}),B=()=>{const t=S(),a=T("sm"),l=W(),r=Q(),{mutateAsync:i}=function(){const e=u();return x({mutationFn:async e=>(await C.deleteAttachment({name:e}),e),onSuccess:s=>{e.removeQueries({queryKey:$.detail(s)}),e.invalidateQueries({queryKey:$.lists()})}})}(),[n,c]=e.useState(""),[o,m]=e.useState([]),[d,w]=e.useState(""),[g,v]=e.useState(!1),N=e.useMemo(()=>((e,s)=>{if(!s.trim())return e;const t=s.toLowerCase();return e.filter(e=>e.filename.toLowerCase().includes(t))})(o,n),[o,n]),b=e.useMemo(()=>N.filter(e=>e.memo),[N]),k=e.useMemo(()=>N.filter(e=>!e.memo),[N]),F=e.useMemo(()=>(e=>{const s=new Map,t=[...e].sort((e,s)=>{const t=e.createTime?A(e.createTime):void 0,a=s.createTime?A(s.createTime):void 0;return y(a).unix()-y(t).unix()});for(const a of t){const e=a.createTime?A(a.createTime):void 0,t=y(e).format("YYYY-MM"),l=s.get(t)??[];l.push(a),s.set(t,l)}return s})(b),[b]);e.useEffect(()=>{(async()=>{try{const{attachments:e,nextPageToken:s}=await C.listAttachments({pageSize:50});m(e),w(s??"")}catch(e){z(e,f.error,{context:"Failed to fetch attachments",fallbackMessage:"Failed to load attachments. Please try again."})}finally{l.setFinish()}})()},[]);const D=e.useCallback(async()=>{if(d&&!g){v(!0);try{const{attachments:e,nextPageToken:s}=await C.listAttachments({pageSize:50,pageToken:d});m(s=>[...s,...e]),w(s??"")}catch(e){z(e,f.error,{context:"Failed to load more attachments",fallbackMessage:"Failed to load more attachments. Please try again."})}finally{v(!1)}}},[d,g]),K=e.useCallback(async()=>{try{l.setLoading();const{attachments:e,nextPageToken:s}=await C.listAttachments({pageSize:50});m(e),w(s??""),l.setFinish()}catch(e){z(e,f.error,{context:"Failed to refetch attachments",fallbackMessage:"Failed to refresh attachments. Please try again.",onError:()=>l.setError()})}},[l]),B=e.useCallback(async()=>{try{let e=[],s="";do{const t=await C.listAttachments({pageSize:1e3,pageToken:s,filter:"memo_id == null"});e=[...e,...t.attachments],s=t.nextPageToken}while(s);await Promise.all(e.map(e=>i(e.name))),f.success(t("resource.delete-all-unused-success"))}catch(e){z(e,f.error,{context:"Failed to delete unused attachments",fallbackMessage:t("resource.delete-all-unused-error")})}finally{await K()}},[t,K,i]),G=e.useCallback(e=>{c(e.target.value)},[]);return s.jsxs("section",{className:"@container w-full max-w-[100rem] min-h-full flex flex-col justify-start items-center sm:pt-3 md:pt-6 pb-8",children:[s.jsx("div",{className:"w-full px-4 sm:px-6",children:s.jsxs("div",{className:"w-full border border-border flex flex-col justify-start items-start px-4 py-3 rounded-xl bg-background text-foreground",children:[a&&s.jsxs("div",{className:"relative w-full flex flex-row justify-between items-center",children:[s.jsxs("p",{className:"py-1 flex flex-row justify-start items-center select-none opacity-80",children:[s.jsx(h,{className:"w-6 h-auto mr-1 opacity-80"}),s.jsx("span",{className:"text-lg",children:t("common.attachments")})]}),s.jsx("div",{children:s.jsxs("div",{className:"relative max-w-32",children:[s.jsx(p,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),s.jsx(M,{className:"pl-9",placeholder:t("common.search"),value:n,onChange:G})]})})]}),s.jsx("div",{className:"w-full flex flex-col justify-start items-start mt-4 mb-6",children:l.isLoading?s.jsx("div",{className:"w-full h-32 flex flex-col justify-center items-center",children:s.jsx("p",{className:"w-full text-center text-base my-6 mt-8",children:t("resource.fetching-data")})}):s.jsx(s.Fragment,{children:0===N.length?s.jsxs("div",{className:"w-full mt-8 mb-8 flex flex-col justify-center items-center italic",children:[s.jsx(E,{}),s.jsx("p",{className:"mt-4 text-muted-foreground",children:t("message.no-data")})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"w-full h-auto px-2 flex flex-col justify-start items-start gap-y-8",children:[Array.from(F.entries()).map(([e,t])=>s.jsxs("div",{className:"w-full flex flex-row justify-start items-start",children:[s.jsxs("div",{className:"w-16 sm:w-24 pt-4 sm:pl-4 flex flex-col justify-start items-start",children:[s.jsx("span",{className:"text-sm opacity-60",children:y(e).year()}),s.jsx("span",{className:"font-medium text-xl",children:y(e).toDate().toLocaleString(Y.language,{month:"short"})})]}),s.jsx("div",{className:"w-full max-w-[calc(100%-4rem)] sm:max-w-[calc(100%-6rem)] flex flex-row justify-start items-start gap-4 flex-wrap",children:t.map(e=>s.jsx(q,{attachment:e},e.name))})]},e)),k.length>0&&s.jsxs(s.Fragment,{children:[s.jsx(O,{}),s.jsxs("div",{className:"w-full flex flex-row justify-start items-start",children:[s.jsx("div",{className:"w-16 sm:w-24 sm:pl-4 flex flex-col justify-start items-start"}),s.jsxs("div",{className:"w-full max-w-[calc(100%-4rem)] sm:max-w-[calc(100%-6rem)] flex flex-row justify-start items-start gap-4 flex-wrap",children:[s.jsxs("div",{className:"w-full flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2",children:[s.jsxs("div",{className:"flex flex-row items-center gap-2",children:[s.jsx("span",{className:"text-muted-foreground",children:t("resource.unused-resources")}),s.jsxs("span",{className:"text-muted-foreground opacity-80",children:["(",k.length,")"]})]}),s.jsx("div",{children:s.jsxs(L,{variant:"destructive",onClick:()=>r.open(),size:"sm",children:[s.jsx(j,{}),t("resource.delete-all-unused")]})})]}),k.map(e=>s.jsx(q,{attachment:e},e.name))]})]})]})]}),d&&s.jsx("div",{className:"w-full flex flex-row justify-center items-center mt-4",children:s.jsx(L,{variant:"outline",size:"sm",onClick:D,disabled:g,children:t(g?"resource.fetching-data":"memo.load-more")})})]})})})]})}),s.jsx(P,{open:r.isOpen,onOpenChange:r.setOpen,title:t("resource.delete-all-unused-confirm"),confirmLabel:t("common.delete"),cancelLabel:t("common.cancel"),onConfirm:B,confirmVariant:"destructive"})]})};export{B as default};
