# ğŸš€ Upstream Sync & Architecture Upgrade: Focus Mode, Plugins, & Markdown++

**Sync Target**: [`cf0a285e`](https://github.com/usememos/memos/commit/cf0a285ef1090282371035a05be1f1ce6814048c) (2026-02-02)
**Analysis Date**: 2026-02-03
**Status**: Ready for Implementation

---

## ğŸ“– Executive Summary
æœ¬æ¬¡åŒæ­¥ä¸ä»…æ˜¯åŠŸèƒ½è¿½é½ï¼Œæ›´æ˜¯**åç«¯æ¶æ„æ¼”è¿›**çš„é‡è¦ä¸€æ­¥ã€‚ä¸Šæ¸¸å¼•å…¥äº† **Plugin System (æ’ä»¶ç³»ç»Ÿ)**ï¼Œå°† Scheduler å’Œ Email æ¨¡å—åŒ–ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦é‡ç‚¹è·Ÿè¿›çš„æ¶æ„å˜æ›´ã€‚åŒæ—¶ï¼Œå‰ç«¯è¿æ¥äº†å¤§å¹…åº¦çš„**å†™ä½œä½“éªŒå‡çº§**ï¼ŒåŒ…æ‹¬ä¸“æ³¨æ¨¡å¼å’Œæ›´å¼ºå¤§çš„ Markdown æ¸²æŸ“èƒ½åŠ›ã€‚

---

## ğŸ“¦ Module 1: Writing Experience (Front-end)

### 1.1 ğŸ§˜ Focus Mode (ä¸“æ³¨æ¨¡å¼)
*   **Source**: `c8162ff3` (Logic), `35711880` (UI Entry)
*   **Value**: æä¾›æ— å¹²æ‰°çš„æ²‰æµ¸å¼å†™ä½œä½“éªŒï¼Œå¯¹é•¿æ–‡å†™ä½œç”¨æˆ·æå…·å¸å¼•åŠ›ã€‚
*   **Technical Analysis**:
    *   **å®ç°åŸç†**: çº¯ CSS/React çŠ¶æ€æ§åˆ¶ã€‚ä½¿ç”¨ `fixed` å®šä½å°†ç¼–è¾‘å™¨å±‚çº§æå‡ï¼Œè¦†ç›–å…¨å±ã€‚
    *   **äº¤äº’ç»†èŠ‚**: å¿«æ·é”® `Cmd+Shift+F`ï¼Œæ”¯æŒ ESC é€€å‡ºã€‚å…¥å£é›†æˆåœ¨ `InsertMenu`ã€‚
    *   **Integration Plan**:
        *   Port `web/src/components/MemoEditor/index.tsx` ä¸­çš„çŠ¶æ€é€»è¾‘ã€‚
        *   å¼•å…¥ `FOCUS_MODE_STYLES` å¸¸é‡ã€‚
        *   **é£é™©ç‚¹**: éœ€æ£€æŸ¥ Divinesense è‡ªå®šä¹‰çš„ `MemoEditor` å¸ƒå±€æ˜¯å¦ä¸ä¸Šæ¸¸å†²çªï¼Œç‰¹åˆ«æ˜¯ CSS ç±»åã€‚

### 1.2 ğŸ¨ Enhanced Markdown Rendering (Mermaid & LaTeX)
*   **Source**: `fb736c20` (Mermaid), `d9f8bc80` (LaTeX)
*   **Value**: æå¤§æ‰©å±•äº† Memo çš„ä½¿ç”¨åœºæ™¯ï¼ˆæŠ€æœ¯æ–‡æ¡£ã€æ•°å­¦ç¬”è®°ï¼‰ã€‚
*   **Technical Analysis**:
    *   **Deps**: æ–°å¢ `mermaid` (åŠç±»å‹å®šä¹‰), `remark-math`, `rehype-katex`ã€‚
    *   **å®ç°**:
        *   `MermaidBlock.tsx`: ç‹¬ç«‹ç»„ä»¶å¤„ç† Mermaid æ¸²æŸ“ï¼Œæ‡’åŠ è½½ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚
        *   `MemoContent`: æ³¨å…¥ remark/rehype æ’ä»¶ã€‚
    *   **Integration Plan**:
        *   æ›´æ–° `web/package.json` æ·»åŠ ä¾èµ–ã€‚
        *   å¤åˆ¶ `web/src/components/MemoContent/MermaidBlock.tsx`ã€‚

---

## âš™ï¸ Module 2: Backend Architecture (The Plugin System)

### 2.1 ğŸ”Œ New Plugin Architecture
*   **Observation**: ä¸Šæ¸¸æ–°å¢äº† `plugin/` é¡¶å±‚ç›®å½•ï¼Œå°†éæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å‰¥ç¦»ã€‚
*   **Impact**: è¿™æ˜¯ä¸€ä¸ªæ¶æ„è½¬å‘ä¿¡å·ã€‚æœªæ¥æ›´å¤šåŠŸèƒ½ï¼ˆå¦‚ Storage, Auth providersï¼‰å¯èƒ½ä¼šè¿ç§»è‡³æ’ä»¶ã€‚
*   **Strategy**: æˆ‘ä»¬å¿…é¡»è·Ÿè¿›æ­¤ç›®å½•ç»“æ„ï¼Œé¿å…æœªæ¥ cherry-pick å›°éš¾ã€‚

### 2.2 â±ï¸ Scheduler Plugin
*   **Source**: `5828f34a`
*   **Details**: å®ç°äº†åŸºäº Cron çš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚æ”¯æŒä»»åŠ¡æ³¨å†Œã€æ¢å¤ã€æ—¥å¿—ä¸­é—´ä»¶ã€‚
*   **Files**: `plugin/scheduler/*` (2000+ lines).
*   **Integration**: éœ€è¦åœ¨ `server/server.go` ç”Ÿå‘½å‘¨æœŸä¸­åˆå§‹åŒ– Schedulerã€‚

### 2.3 ğŸ“§ Email Plugin
*   **Source**: `b55a0314`
*   **Details**: SMTP å‘ä¿¡æ¨¡å—ï¼Œæ”¯æŒé…ç½®éªŒè¯å’Œå¼‚æ­¥å‘é€ã€‚
*   **Files**: `plugin/email/*`.

---

## ğŸ›¡ï¸ Module 3: Critical Stability Fixes

### 3.1 ğŸ› Private Memos Visibility Bug
*   **Source**: `6db58fae`
*   **Severity**: **High**
*   **Analysis**:
    *   **Root Cause**: åœ¨ Token åˆ·æ–°æœŸé—´ï¼Œå‰ç«¯çŸ­æš‚å¤„äº `!user` çŠ¶æ€ï¼Œå¯¼è‡´ `Home` ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œç§æœ‰ Memo åˆ—è¡¨è¢«æ¸…ç©ºã€‚
    *   **Fix**: ç§»é™¤äº† `enabled={!!user}` çš„å¼ºæ ¡éªŒï¼Œå…è®¸åœ¨ Auth çŠ¶æ€åˆ‡æ¢æ—¶ä¿æŒæ—§æ•°æ®å±•ç¤ºã€‚
    *   **Action**: ç«‹å³åº”ç”¨æ­¤ Patchã€‚

### 3.2 ğŸ” PKCE Optional for OAuth
*   **Source**: `cf0a285e`
*   **Details**: å…è®¸åœ¨ HTTP ç¯å¢ƒä¸‹å›é€€åˆ°æ™®é€š OAuth æµç¨‹ï¼ˆé PKCEï¼‰ã€‚è¿™å¯¹è‡ªæ‰˜ç®¡ç”¨æˆ·ï¼ˆå¾€å¾€æ²¡æœ‰é…ç½® HTTPSï¼‰éå¸¸é‡è¦ã€‚

---

## âœ… Implementation Roadmap

1.  **Backend Core**:
    *   [ ] Sync `plugin/` directory structure (Scheduler & Email).
    *   [ ] Wire up plugins in `server/main.go`.
2.  **Frontend Deps**:
    *   [ ] `pnpm add mermaid remark-math rehype-katex ...`
3.  **Frontend Components**:
    *   [ ] Port `Focus Mode` logic to `MemoEditor`.
    *   [ ] Implement `MermaidBlock` component.
4.  **Verification**:
    *   [ ] Test Cron Scheduler (View logs).
    *   [ ] Verify Focus Mode UI on Mobile/Desktop.
    *   [ ] Verify Private Memo visibility during token refresh (Simulator).

---

> Generated by **Divinesense Agent** | Strategy Mode
