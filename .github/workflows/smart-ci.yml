name: Smart CI

# 智能路径感知 CI - 根据变更路径决定运行哪些测试
# 目标: 减少不必要的测试执行，提升 CI 效率

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - main
  push:
    branches:
      - main

permissions:
  statuses: write

env:
  GO_VERSION: "1.25"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docs: ${{ steps.filter.outputs.docs }}
      proto: ${{ steps.filter.outputs.proto }}
      go_mod: ${{ steps.filter.outputs.go_mod }}
      has_changes: ${{ steps.filter.outputs.any }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: main
          filters: |
            backend:
              - 'go.mod'
              - 'go.sum'
              - '**.go'
            frontend:
              - 'web/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            docs:
              - 'docs/**'
              - '**.md'
              - 'README*'
              - 'CONTRIBUTING*'
              - 'LICENSE*'
            proto:
              - 'proto/**/*.proto'
            go_mod:
              - 'go.mod'
              - 'go.sum'

  # 后端静态检查 (lint)
  backend-static-checks:
    name: Backend Static Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' && needs.changes.outputs.docs != 'true'
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Verify go.mod is tidy
        run: |
          go mod tidy -go=${{ env.GO_VERSION }} 2>&1 | grep -v "^go: downloading" || true
          git diff --exit-code go.mod go.sum

      - name: Cache golangci-lint
        uses: actions/cache@v4
        with:
          path: ~/.cache/golangci-lint
          key: ${{ runner.os }}-golangci-lint-${{ hashFiles('.golangci.yaml') }}
          restore-keys: |
            ${{ runner.os }}-golangci-lint-

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.8.0
          args: --config=.golangci.yaml --timeout=3m --build-tags=noui
          skip-pkg-cache: true
          skip-build-cache: true

  # 后端单元测试
  backend-tests:
    name: Backend Tests (${{ matrix.test-group }})
    runs-on: ubuntu-latest
    needs: [changes, backend-static-checks]
    if: needs.changes.outputs.backend == 'true' && needs.changes.outputs.docs != 'true'
    strategy:
      fail-fast: false
      matrix:
        test-group:
          - store
          - server
          - plugin
          - other
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Cache test results
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-test-${{ matrix.test-group }}-${{ hashFiles('**/go.sum', '**/go.mod', '**/*_test.go') }}
          restore-keys: |
            ${{ runner.os }}-go-test-${{ matrix.test-group }}-

      - name: Run tests - ${{ matrix.test-group }}
        run: |
          case "${{ matrix.test-group }}" in
            store)
              go test -short -timeout=60s -race -coverprofile=coverage.out -covermode=atomic -tags=noui ./store/...
              ;;
            server)
              go test -short -timeout=60s -race -coverprofile=coverage.out -covermode=atomic -tags=noui ./server/...
              ;;
            plugin)
              go test -short -timeout=60s -race -coverprofile=coverage.out -covermode=atomic -tags=noui \
                $(go list ./plugin/... | grep -v "github.com/hrygo/divinesense/plugin/cron$")
              ;;
            other)
              go test -short -timeout=60s -race -coverprofile=coverage.out -covermode=atomic -tags=noui \
                ./cmd/... ./internal/...
              ;;
          esac
        env:
          DRIVER: sqlite

      - name: Upload coverage
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: ${{ matrix.test-group }}
          fail_ci_if_error: false
          verbose: false

  # 前端测试
  frontend-tests:
    name: Frontend (${{ matrix.check }})
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' && needs.changes.outputs.docs != 'true'
    strategy:
      fail-fast: false
      matrix:
        check:
          - lint
          - build
    steps:
      - uses: actions/checkout@v5
      - uses: pnpm/action-setup@v4.1.0
        with:
          version: 9
      - uses: actions/setup-node@v5
        with:
          node-version: "20"
          cache: pnpm
          cache-dependency-path: "web/pnpm-lock.yaml"

      - run: pnpm install --silent --frozen-lockfile
        working-directory: web

      - name: Frontend ${{ matrix.check }}
        run: |
          case "${{ matrix.check }}" in
            lint)
              pnpm lint
              ;;
            build)
              pnpm build
              ;;
          esac
        working-directory: web

  # Proto 检查
  proto-check:
    name: Proto Generation Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.proto == 'true'
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "28.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate and check
        working-directory: proto
        run: |
          buf generate
          if ! git diff --quiet; then
            echo "Generated files differ from committed files"
            git diff
            exit 1
          fi
          echo "Proto generation is up to date"

  # 文档专用状态
  docs-status:
    name: Docs Status
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docs == 'true' && needs.changes.outputs.backend != 'true' && needs.changes.outputs.frontend != 'true'
    steps:
      - name: Set docs-only status
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.pull_request?.head.sha || context.sha;

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: 'success',
              context: 'ci/smart-ci',
              description: 'Documentation only - tests skipped',
              target_url: `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`
            });
