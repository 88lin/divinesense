name: Build Multi-Platform with AI Support

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS Intel (x86_64)
          - os: macos-latest
            goos: darwin
            goarch: amd64
            zig_target: x86_64-macos-none
            artifact_name: divinesense-darwin-amd64

          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            goos: darwin
            goarch: arm64
            zig_target: aarch64-macos-none
            artifact_name: divinesense-darwin-arm64

          # Linux AMD64 (x86_64)
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            zig_target: x86_64-linux-musl
            artifact_name: divinesense-linux-amd64

          # Linux ARM64 (aarch64)
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            zig_target: aarch64-linux-musl
            artifact_name: divinesense-linux-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: go.sum

      - name: Install Zig (for Linux cross-compilation)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Download and install Zig from official releases
          ZIG_VERSION="0.13.0"
          ZIG_ARCH="x86_64-linux"
          ZIG_URL="https://ziglang.org/download/${ZIG_VERSION}/zig-linux-x86_64-${ZIG_VERSION}.tar.xz"

          echo "üì¶ Installing Zig ${ZIG_VERSION}..."
          cd /tmp
          curl -L "${ZIG_URL}" -o zig.tar.xz
          tar -xf zig.tar.xz
          sudo mv "zig-linux-x86_64-${ZIG_VERSION}" /opt/zig
          sudo ln -sf /opt/zig/zig /usr/local/bin/zig

          # Verify installation
          zig version
          echo "‚úì Zig installed successfully"
        shell: bash

      - name: Download sqlite-vec static library
        run: |
          echo "üì¶ Downloading sqlite-vec static library for ${{ matrix.goos }}/${{ matrix.goarch }}..."
          cd store/db/sqlite

          # Download sqlite-vec static library directly
          # This is more reliable than go generate for CI environments
          bash ./download_sqlite_vec.sh

          echo "‚úì Download completed"
          ls -lh .lib/libvec0.a
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}

      - name: Verify static library
        run: |
          echo "üîç Verifying sqlite-vec static library..."
          cd store/db/sqlite

          if [ ! -f ".lib/libvec0.a" ]; then
            echo "‚ùå Static library not found!"
            exit 1
          fi

          # Check file size (should be ~150KB for official builds)
          size=$(wc -c < .lib/libvec0.a | tr -d ' ')
          if [ "$size" -lt 100000 ]; then
            echo "‚ùå Static library too small: $size bytes (corrupted?)"
            exit 1
          fi

          echo "‚úì Static library verified: $size bytes"
        shell: bash

      - name: Download SQLite amalgamation (for Linux cross-compilation)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "üì¶ Downloading SQLite amalgamation..."
          SQLITE_VERSION="3450000"
          SQLITE_AMALGAMATION_URL="https://www.sqlite.org/2024/sqlite-amalgamation-${SQLITE_VERSION}.zip"

          # Download and extract SQLite amalgamation
          curl -sL "${SQLITE_AMALGAMATION_URL}" -o /tmp/sqlite-amalgamation.zip
          unzip -q /tmp/sqlite-amalgamation.zip -d /tmp/

          # Copy to .lib directory alongside libvec0.a
          cp /tmp/sqlite-amalgamation-${SQLITE_VERSION}/sqlite3.h store/db/sqlite/.lib/
          cp /tmp/sqlite-amalgamation-${SQLITE_VERSION}/sqlite3.c store/db/sqlite/.lib/

          echo "‚úì SQLite amalgamation downloaded"
          ls -lh store/db/sqlite/.lib/
        shell: bash

      - name: Build with AI support (sqlite-vec)
        run: |
          echo "üî® Building DivineSense with AI support..."
          set -x

          # Set cross-compilation environment for Linux
          if [ "${{ matrix.goos }}" = "linux" ]; then
            export CC="zig cc -target ${{ matrix.zig_target }} -Istore/db/sqlite/.lib"
            export CXX="zig c++ -target ${{ matrix.zig_target }} -Istore/db/sqlite/.lib"
            export CGO_CFLAGS="-Istore/db/sqlite/.lib"
            export CGO_LDFLAGS="-Lstore/db/sqlite/.lib"
          fi

          # Build with sqlite_vec tag
          CGO_ENABLED=1 \
          GOOS=${{ matrix.goos }} \
          GOARCH=${{ matrix.goarch }} \
          go build -tags sqlite_vec \
            -ldflags "-s -w -X main.Version=${{ github.ref_name }}" \
            -o "${{ matrix.artifact_name }}" \
            ./cmd/divinesense

          # Verify build
          if [ ! -f "${{ matrix.artifact_name }}" ]; then
            echo "‚ùå Build failed: binary not found"
            exit 1
          fi

          ls -lh "${{ matrix.artifact_name }}"

          # Show binary info
          if [ "${{ matrix.goos }}" = "linux" ]; then
            file "${{ matrix.artifact_name }}"
          else
            ls -l "${{ matrix.artifact_name }}"
          fi
        shell: bash

      - name: Test binary (optional)
        if: matrix.goos == 'darwin' && matrix.goarch == 'arm64' && github.event_name == 'push'
        run: |
          echo "üß™ Testing binary..."
          ./${{ matrix.artifact_name }} --version || true
          ./${{ matrix.artifact_name }} --help
          echo "‚úì Binary is functional"

      - name: Create checksums
        run: |
          echo "üìù Creating checksums..."
          if [ "${{ matrix.goos }}" = "darwin" ]; then
            shasum -a 256 "${{ matrix.artifact_name }}" > checksums.txt
          else
            sha256sum "${{ matrix.artifact_name }}" > checksums.txt
          fi
          cat checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}
            checksums.txt
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: |
            divinesense-*
            checksums.txt

      - name: Display artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          ls -lh

      - name: Generate Release Notes
        id: release_notes
        run: |
          echo "üìù Generating release notes..."
          cat > release_notes.md << 'EOF'
          ## DivineSense ${{ github.ref_name }}

          ### üöÄ AI Support Enabled

          This release includes full AI support with sqlite-vec:
          - Vector similarity search with vec0 virtual tables
          - Conversation persistence and episodic memory
          - Multi-agent AI system (MemoParrot, ScheduleParrot, AmazingParrot)

          ### üì¶ Available Platforms

          - **macOS Intel**: divinesense-darwin-amd64
          - **macOS ARM64 (Apple Silicon)**: divinesense-darwin-arm64
          - **Linux AMD64**: divinesense-linux-amd64
          - **Linux ARM64**: divinesense-linux-arm64

          ### üîß Build Details

          - Go version: 1.25
          - sqlite-vec version: v0.1.7-alpha.2
          - Build tags: sqlite_vec
          - CGO enabled for static linking

          ### üìö Documentation

          - [Usage Guide](https://github.com/hrygo/divinesense/blob/main/docs/dev-guides/SQLITE_VEC_USAGE_GUIDE.md)
          - [Integration Details](https://github.com/hrygo/divinesense/blob/main/docs/research/SQLITE_VEC_OFFICIAL_RELEASES.md)

          ---

          **Full Changelog**: https://github.com/hrygo/divinesense/compare/${{ github.event.release.target_name }}...${{ github.ref_name }}
          EOF

          cat release_notes.md

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: DivineSense ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            divinesense-darwin-amd64
            divinesense-darwin-arm64
            divinesense-linux-amd64
            divinesense-linux-arm64
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release URL
        run: |
          echo "üéâ Release created at: ${{ steps.create_release.outputs.html_url }}"
