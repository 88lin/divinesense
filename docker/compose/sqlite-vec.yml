# DivineSense Docker Compose - SQLite + sqlite-vec
# 轻量级部署，无需 PostgreSQL 容器

services:
  divinesense:
    build:
      context: ..
      dockerfile: docker/Dockerfile.sqlite-vec
    container_name: divinesense-sqlite-vec
    restart: unless-stopped
    ports:
      - "5230:5230"
    volumes:
      # SQLite 数据库文件
      - ./data:/var/opt/divinesense
      # 可选：配置文件
      - ./config:/etc/divinesense
    environment:
      # 基础配置
      - DIVINESENSE_MODE=prod
      - DIVINESENSE_PORT=5230

      # 数据库配置（SQLite）
      - DIVINESENSE_DRIVER=sqlite
      - DIVINESENSE_DSN=/var/opt/divinesense/divinesense.db?_loc=auto&_allow_load_extension=1

      # AI 配置（必需）
      - DIVINESENSE_AI_ENABLED=true
      - DIVINESENSE_AI_EMBEDDING_PROVIDER=siliconflow
      - DIVINESENSE_AI_EMBEDDING_MODEL=BAAI/bge-m3
      - DIVINESENSE_AI_RERANK_MODEL=BAAI/bge-reranker-v2-m3
      - DIVINESENSE_AI_LLM_PROVIDER=deepseek
      - DIVINESENSE_AI_LLM_MODEL=deepseek-chat

      # API Keys（从 .env 文件或外部 secret 注入）
      - DIVINESENSE_AI_SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - DIVINESENSE_AI_DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DIVINESENSE_AI_OPENAI_BASE_URL=https://api.siliconflow.cn/v1

      # 时区
      - TZ=Asia/Shanghai

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5230/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  data:
    driver: local
