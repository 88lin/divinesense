# docs-manager 参考文档

> 详细使用示例与高级功能参考

---

## 🔄 状态机详解

### 状态流转图

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   ┌──────┐    ┌──────┐    ┌─────────┐    ┌─────────┐    ┌─────┐│
│   │ IDLE │───▶│ SCAN │───▶│  PLAN   │───▶│ CONFIRM │───▶│EXEC ││
│   └──────┘    └──────┘    └─────────┘    └─────────┘    └─────┘│
│       ▲           │            │              │            │    │
│       │           │            │              │            ▼    │
│       │           ▼            ▼              │       ┌────────┐│
│       │      ┌────────┐   ┌────────┐          │       │ VERIFY ││
│       │      │ ERROR  │   │ DIRECT │          │       └────────┘│
│       │      └────────┘   └────────┘          │            │    │
│       │           │            │              │            ▼    │
│       │           ▼            ▼              ▼       ┌────────┐│
│       └───────────┴────────────┴──────────────┴──────▶│  DONE  ││
│                                                       └────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 状态说明

| 状态        | 入口条件  | 动作             | 出口            |
| :---------- | :-------- | :--------------- | :-------------- |
| **IDLE**    | 初始/完成 | 等待命令         | 收到 `/docs-*`  |
| **SCAN**    | 命令触发  | Glob + Grep 扫描 | 发现完成 / 错误 |
| **PLAN**    | 扫描完成  | 构建影响图       | 有影响 / 无影响 |
| **CONFIRM** | 有影响    | 展示并确认       | 确认 / 拒绝     |
| **EXECUTE** | 确认通过  | git mv + Edit    | 执行完成        |
| **VERIFY**  | 执行完成  | 验证无断链       | 通过 / 失败     |
| **DONE**    | 验证通过  | 输出报告         | → IDLE          |

---

## 🎯 命令示例

### `/docs-check` 执行流程

```
用户: /docs-check

[SCAN]
├─ Glob("docs/**/*.md") → 发现 47 个文档
├─ Grep("\[.*\]\(.*\.md\)") → 发现 123 个 Markdown 引用
├─ Grep("@docs/") → 发现 15 个 @ 引用
└─ Grep("详见|see|参考") → 发现 8 个注释引用

[PLAN]
├─ 验证 146 个引用目标
├─ 发现 3 个断链
└─ 发现 2 个孤立文档

[输出]
📋 文档健康报告 (2026-01-31)

✅ 通过 (144/146 引用有效)

❌ 断链 (3):
  • docs/specs/INDEX.md:45 → phase-1/P1-A003.md (目标不存在)
  • docs/README.md:12 → dev-guides/TESTING.md (目标不存在)
  • CLAUDE.md:82 → @docs/archived/old.md (已归档)

⚠️ 孤立文档 (2):
  • docs/research/draft-experiment.md (无被引用)
  • docs/specs/deprecated-spec.md (无被引用)
```

---

### `/docs-ref` 执行流程

```
用户: /docs-ref ARCHITECTURE.md

[SCAN]
├─ Grep("ARCHITECTURE", "**/*.md") → 12 处匹配
└─ Read(docs/dev-guides/ARCHITECTURE.md) → 分析其引用

[PLAN]
├─ 过滤变量名/误匹配 → 保留 10 处
└─ 构建双向引用图

[输出]
🔗 ARCHITECTURE.md 引用图

┌─ 被引用 (10 处)
│  ├─ CLAUDE.md:82         @docs/dev-guides/ARCHITECTURE.md
│  ├─ README.md:145        [架构](docs/dev-guides/ARCHITECTURE.md)
│  ├─ docs/README.md:7     [ARCHITECTURE](./dev-guides/ARCHITECTURE.md)
│  ├─ docs/specs/INDEX.md  参考 ARCHITECTURE.md
│  └─ ... (6 more)

└─ 引用 (5 个)
   ├─ BACKEND_DB.md
   ├─ FRONTEND.md
   ├─ ../specs/INDEX.md
   ├─ ../research/00-master-roadmap.md
   └─ ../deployment/BINARY_DEPLOYMENT.md

热度: ⭐⭐⭐⭐⭐ (Top 3 被引用文档)
```

---

### `/docs-archive` 执行流程

```
用户: /docs-archive docs/specs/phase-1/

[SCAN]
├─ Glob(docs/specs/phase-1/**/*.md) → 12 个文件
└─ 对每个文件搜索反向引用

[PLAN]
├─ 目标: docs/archived/specs/phase1_20260131/
├─ 受影响引用: 23 处
└─ 生成更新清单

[CONFIRM]
⚠️ 归档影响预览

📦 移动 12 个文件:
  docs/specs/phase-1/ → docs/archived/specs/phase1_20260131/

🔗 需更新 23 处引用:
  ┌────────────────────────────┬─────────────────────────────────┐
  │ 文件                       │ 更新内容                        │
  ├────────────────────────────┼─────────────────────────────────┤
  │ docs/specs/INDEX.md        │ 8 处链接路径                    │
  │ CLAUDE.md                  │ 2 处 @ 引用                     │
  │ docs/README.md             │ 3 处 Markdown 链接              │
  │ ... (10 more files)        │                                 │
  └────────────────────────────┴─────────────────────────────────┘

👉 选择操作:
   [1] 确认执行 (推荐)
   [2] 查看详细变更
   [3] 取消

用户: 1

[EXECUTE]
├─ git mv docs/specs/phase-1/ docs/archived/specs/phase1_20260131/
└─ Edit 更新 23 处引用

[VERIFY]
├─ Grep 验证旧路径无残留
└─ Glob 验证新路径可达

[输出]
✅ 归档完成

📦 已移动: 12 个文件
🔗 已更新: 23 处引用
🔍 验证: 零断链
```

---

## ✅ 元认知自检清单

### 执行前检查

```
┌─────────────────────────────────────────────────────────────┐
│ 📋 执行前自检                                               │
├─────────────────────────────────────────────────────────────┤
│ □ 使用了 ≥3 种引用模式搜索                                  │
│   ├─ [x] Markdown: \[.*\]\(.*\.md\)                        │
│   ├─ [x] @ 语法: @docs/.*\.md                              │
│   └─ [x] 注释: 详见|see|参考|refer                         │
│                                                             │
│ □ 反向引用 100% 发现                                        │
│   └─ [x] 搜索范围: **/*.md (包括根目录)                    │
│                                                             │
│ □ 路径可达性验证                                            │
│   └─ [x] 目标目录存在或可创建                              │
│                                                             │
│ □ 回滚准备                                                  │
│   └─ [x] git status 干净 / 已暂存当前变更                  │
└─────────────────────────────────────────────────────────────┘
```

### 执行后检查

```
┌─────────────────────────────────────────────────────────────┐
│ 📋 执行后验证                                               │
├─────────────────────────────────────────────────────────────┤
│ □ 旧路径无残留引用                                          │
│   └─ Grep(旧路径) → 0 结果                                 │
│                                                             │
│ □ 新路径全部可达                                            │
│   └─ Glob(新路径) → 文件存在                               │
│                                                             │
│ □ 索引文件已更新                                            │
│   └─ README.md / INDEX.md 引用正确                         │
└─────────────────────────────────────────────────────────────┘
```

---

## ⚠️ 错误恢复策略

### 场景 1: 引用更新失败

```
错误: Edit 失败，文件权限问题

恢复:
1. 记录失败文件
2. git checkout -- <failed-files>
3. 报告用户手动处理
4. 状态 → IDLE
```

### 场景 2: 文件移动失败

```
错误: git mv 失败，目标已存在

恢复:
1. 不执行后续更新
2. 保持原状态
3. 建议: 先清理目标目录
4. 状态 → IDLE
```

### 场景 3: 发现新引用格式

```
发现: include::path/to/doc.adoc[] (AsciiDoc)

恢复:
1. 暂停执行
2. 添加新模式到搜索列表
3. 重新 SCAN
4. 继续流程
```

### 场景 4: 验证失败

```
错误: VERIFY 发现残留断链

恢复:
1. 生成断链清单
2. 尝试自动修复
3. 若无法修复:
   - git reset --hard HEAD~1
   - 报告失败原因
4. 状态 → IDLE
```

---

## 🔧 Grep 模式参考

### 常用模式

| 引用类型 | Grep 模式                 | 示例匹配                           |
| :------- | :------------------------ | :--------------------------------- |
| Markdown | `\[.*\]\(.*\.md\)`        | `[文档](path/to/doc.md)`           |
| @ 语法   | `@docs/[^\s]+\.md`        | `@docs/dev-guides/API.md`          |
| 相对路径 | `\.\./[^\s]+\.md`         | `../research/report.md`            |
| 中文注释 | `详见\|参考\|查看.*\.md`  | `详见 docs/API.md`                 |
| 英文注释 | `see\|refer to.*\.md`     | `see docs/API.md`                  |
| URL      | `github\.com.*docs.*\.md` | `https://github.com/.../docs/X.md` |

### 排除模式

```bash
# 排除 node_modules, .git, 归档目录
--glob '!node_modules/**'
--glob '!.git/**'
--glob '!docs/archived/**'  # 根据需要决定是否排除
```

---

## 📊 版本历史

| 版本 | 日期       | 变更                                       |
| :--- | :--------- | :----------------------------------------- |
| v5.1 | 2026-01-31 | 添加命令状态路径映射、大规模操作处理、修复 |
| v5.0 | 2026-01-31 | 添加状态机、元认知自检、错误恢复           |
| v4.0 | 2026-01-30 | 目标导向重构，弃用脚本                     |
| v3.0 | 2026-01    | Python 脚本驱动 (已弃用)                   |

---

> **版本**: v5.1 | **配套**: SKILL.md
