# DivineSense v0.9.2 å‘å¸ƒæ—¥å¿—

**å‘å¸ƒæ—¥æœŸ**: 2026-02-03
**ç‰ˆæœ¬**: 0.9.2

---

## ğŸš€ æ–°åŠŸèƒ½

### CC Runner ä¼šè¯ç»Ÿè®¡ä¸æˆæœ¬è¿½è¸ª

å®Œæ•´çš„ä¼šè¯ç»Ÿè®¡æŒä¹…åŒ–ä¸æˆæœ¬è¿½è¸ªç³»ç»Ÿã€‚

#### æ•°æ®åº“æ¶æ„ (PostgreSQL)

**agent_session_stats** - å®Œæ•´ä¼šè¯è¿½è¸ªè¡¨
- Token ä½¿ç”¨ç»†åˆ† (input/output/cache read/cache write)
- è€—æ—¶æŒ‡æ ‡ (thinking/tool/generation)
- æˆæœ¬è¿½è¸ª (total_cost_usd)
- å·¥å…·è°ƒç”¨å’Œæ–‡ä»¶æ“ä½œè®°å½•
- é”™è¯¯çŠ¶æ€è¿½è¸ª

**user_cost_settings** - é¢„ç®—ç®¡ç†è¡¨
- æ¯æ—¥é¢„ç®—é™é¢
- æ¯ä¼šè¯æˆæœ¬é˜ˆå€¼
- å‘Šè­¦åå¥½ (email/in-app)

**agent_security_audit** - å®‰å…¨å®¡è®¡æ—¥å¿—è¡¨
- é£é™©ç­‰çº§è¿½è¸ª (low/medium/high/critical)
- å‘½ä»¤æ¨¡å¼åŒ¹é…
- æ“ä½œè®°å½•

#### åç«¯ API (5 ä¸ª RPC)

| RPC | æè¿° |
|:-----|:-----|
| `GetSessionStats` | æŒ‰ session_id æŸ¥è¯¢å•ä¸ªä¼šè¯ |
| `ListSessionStats` | åˆ†é¡µåˆ—å‡ºä¼šè¯åˆ—è¡¨ (limit/offset) |
| `GetCostStats` | Nå¤©èšåˆç»Ÿè®¡åŠæ¯æ—¥æ˜ç»† |
| `GetUserCostSettings` | ç”¨æˆ·é¢„ç®—å’Œå‘Šè­¦é…ç½® |
| `SetUserCostSettings`	| æ›´æ–°æˆæœ¬æ§åˆ¶è®¾ç½® |

æ‰€æœ‰å¤„ç†ç¨‹åºåŒ…å«ç”¨æˆ·è®¤è¯å’Œæ‰€æœ‰æƒéªŒè¯ã€‚

#### å‰ç«¯ç»„ä»¶

- **CostTrendChart**: å¯è§†åŒ–æˆæœ¬è¶‹åŠ¿ï¼Œæ¯æ—¥ç»†åˆ†
- **SessionSummaryPanel**: å¢å¼ºæˆæœ¬æ˜¾ç¤ºå’Œç»Ÿè®¡æ•°æ®
- i18n æ”¯æŒæˆæœ¬è¿½è¸ª UI (en/zh-Hans)

#### å¼‚æ­¥æŒä¹…åŒ–

**Persister**: åŸºäºé˜Ÿåˆ—çš„åå°ç»Ÿè®¡æŒä¹…åŒ–
- å¯é…ç½®é˜Ÿåˆ—å¤§å° (é»˜è®¤ 100)
- ä¼˜é›…å…³é—­ï¼Œæ•°æ®ä¸¢å¤±è¿½è¸ª
- æ¯æ¡è®°å½• 5 ç§’ä¿å­˜è¶…æ—¶

---

## ğŸ› é—®é¢˜ä¿®å¤

### å®‰å…¨ä¿®å¤
- SQL æ³¨å…¥ä¿®å¤ï¼šgetDailyCostBreakdown ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- æ‰€æœ‰ QueryContext è¿­ä»£åæ·»åŠ  rows.Err() æ£€æŸ¥
- æ­£ç¡®åŒºåˆ† sql.ErrNoRows ä¸å®é™…é”™è¯¯
- MaxOffset é™åˆ¶ (10000) é˜²æ­¢æ— é™åˆ¶åˆ†é¡µ

### é”™è¯¯å¤„ç†
- Persister å…³é—­æ³„æ¼ï¼šæ·»åŠ  AIService.Close() æ–¹æ³•
- Heartbeat panic å®‰å…¨ï¼šdefer close(heartbeatDone)
- GetMostExpensiveSession æ·»åŠ é”™è¯¯æ—¥å¿—

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

- **parseStringArray**: O(n) æ€§èƒ½ (ä½¿ç”¨ strings.Builder æ›¿ä»£å­—ç¬¦ä¸²æ‹¼æ¥)
- **éƒ¨åˆ†ç´¢å¼•**: æ·»åŠ  `idx_session_stats_user_success` é’ˆå¯¹ is_error=false æŸ¥è¯¢
- **å†—ä½™ç´¢å¼•**: ç§»é™¤ user_cost_settings.user_id ä¸Šçš„å†—ä½™ç´¢å¼• (UNIQUE çº¦æŸå·²æä¾›ç´¢å¼•)

---

## ğŸ—„ï¸ æ•°æ®åº“æ”¹è¿›

- **conversation_id ç±»å‹ä¿®æ­£**: INTEGER (åŒ¹é… ai_conversation.idï¼ŒåŸä¸º BIGINT)
- **çº¦æŸå‘½åæ ‡å‡†åŒ–**: `chk_agent_session_stats_type`

---

## ğŸ“Š æµ‹è¯•

**cc_event_test.go**: 69 ä¸ªç»¼åˆæµ‹è¯•ç”¨ä¾‹
- æ‰€æœ‰ CLI æ¶ˆæ¯ç±»å‹ (11 ç§)
- å†…å®¹å—æå– (ç›´æ¥/åµŒå¥—)
- Result æ¶ˆæ¯ç»Ÿè®¡æå–
- äº‹ä»¶åˆ†å‘è¦†ç›–
- UUID v5 ç¡®å®šæ€§æ˜ å°„
- ä¼šè¯ç»Ÿè®¡æ”¶é›†
- è¾¹ç¼˜æƒ…å†µå¤„ç†
- å¹¶å‘å®‰å…¨

---

## ğŸ“š æ–‡æ¡£

- CC Runner ä¼˜åŒ–è®¡åˆ’è§„æ ¼è¯´æ˜
- æ¶ˆæ¯å¤„ç†æœºåˆ¶è°ƒç ”æŠ¥å‘Š
- æµ‹è¯•è¦†ç›–æ–‡æ¡£
- æ¶æ„è§„æ ¼ v1.3 (cc_runner_async_arch.md)

---

## ğŸ”§ å¼€å‘å·¥ä½œæµ

- **Git Hooks**: æ·»åŠ  pre-commit + pre-push å·¥ä½œæµç”¨äºæœ¬åœ° CI éªŒè¯
  - `pre-commit`: è½»é‡çº§æ£€æŸ¥ (go fmt + go vet + pnpm lint:fix)ï¼Œ~5 ç§’
  - `pre-push`: å®Œæ•´ CI æ£€æŸ¥ (golangci-lint + go test + pnpm build)ï¼Œ~1 åˆ†é’Ÿ

---

## ğŸ“¦ å®‰è£…

```bash
# äºŒè¿›åˆ¶æ¨¡å¼ (Geek Mode æ¨è)
curl -fsSL https://raw.githubusercontent.com/hrygo/divinesense/main/deploy/install.sh | sudo bash -s -- --mode=binary

# Docker æ¨¡å¼
curl -fsSL https://raw.githubusercontent.com/hrygo/divinesense/main/deploy/install.sh | sudo bash
```

---

## ğŸ”„ å‡çº§

ä» v0.9.1 å‡çº§ï¼š

```bash
# äºŒè¿›åˆ¶æ¨¡å¼
/opt/divinesense/deploy-binary.sh upgrade

# Docker æ¨¡å¼
cd /opt/divinesense && ./deploy.sh upgrade
```

---

## âš ï¸ ç ´åæ€§å˜æ›´

æ— ç ´åæ€§å˜æ›´ã€‚

---

## ğŸ™ è‡´è°¢

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
