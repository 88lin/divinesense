# ä¼šè¯åµŒå¥—æ¨¡å‹ - è°ƒç ”æŠ¥å‘Š

> **é—®é¢˜**: DivineSense çš„æ™®é€šæ¨¡å¼ã€æå®¢æ¨¡å¼å’Œè¿›åŒ–æ¨¡å¼å­˜åœ¨ä¼šè¯ä¸Šä¸‹æ–‡å‰²è£‚
> **æ–¹æ¡ˆ**: æ¯ä¼šè¯-å­ä¼šè¯åµŒå¥—æ¨¡å‹ï¼ˆè¿½åŠ å¼è¾“å…¥ + å®Œæ•´ Q+A ä¿å­˜ï¼‰
> **çŠ¶æ€**: âœ… å·²åˆ›å»º Issue [#57](https://github.com/hrygo/divinesense/issues/57)
> **æ—¥æœŸ**: 2026-02-03 (v2.0 åŸºäº commit 567bbe3)

---

## 1. é—®é¢˜æè¿°

### å½“å‰æ¶æ„çš„ä¸‰é‡å‰²è£‚

| ç»´åº¦ | æ™®é€šæ¨¡å¼ | æå®¢æ¨¡å¼ (Geek Mode) | è¿›åŒ–æ¨¡å¼ (Evolution Mode) |
|:-----|:---------|:---------------------|:--------------------------|
| **ä¼šè¯å­˜å‚¨** | `conversation_context` è¡¨ (PostgreSQL) | Claude Code CLI å†…å­˜ (`~/.claude/sessions/`) | Claude Code CLI å†…å­˜ |
| **SessionID æ¥æº** | DivineSense åç«¯ç”Ÿæˆ | UUID v5(ConversationID) æ˜ å°„ | çŸ­ UUID (8 å­—ç¬¦) |
| **å†å²ç®¡ç†** | DivineSense `session.Service` | CC CLI è‡ªåŠ¨ç®¡ç† | CC CLI è‡ªåŠ¨ç®¡ç† |
| **å‰ç«¯æ˜¾ç¤º** | âœ… å®Œæ•´åŒæ­¥ | âš ï¸ ä»…æ˜¾ç¤ºæµå¼è¾“å‡º | âš ï¸ ä»…æ˜¾ç¤ºæµå¼è¾“å‡º |
| **ä¸Šä¸‹æ–‡è¿ç»­æ€§** | âœ… æ•°æ®åº“æŒä¹…åŒ– | âœ… CC å†…éƒ¨æŒä¹…åŒ– | âœ… CC å†…éƒ¨æŒä¹…åŒ– |
| **è·¨æ¨¡å¼å…±äº«** | âŒ ä¸ CC éš”ç¦» | âŒ ä¸æ™®é€šæ¨¡å¼éš”ç¦» | âŒ ä¸å…¶ä»–æ¨¡å¼éš”ç¦» |

### å‰²è£‚çš„å…·ä½“è¡¨ç°

1. **ç”¨æˆ·ä½“éªŒå‰²è£‚**
   - æ™®é€šæ¨¡å¼åˆ‡æ¢åˆ°æå®¢æ¨¡å¼ â†’ ä¸Šä¸‹æ–‡ä¸¢å¤±
   - Geek/Evolution ä¼šè¯å†…å®¹ä¸å‡ºç°åœ¨ DivineSense çš„ `ai_conversation` è¡¨ä¸­
   - å‰ç«¯ä¾§è¾¹æ æ— æ³•æ˜¾ç¤º Geek/Evolution ä¼šè¯å†å²

2. **æ•°æ®æ¨¡å‹å‰²è£‚**
   ```
   DivineSense conversation_context è¡¨:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ session_id  â”‚ user_id â”‚ agent_type   â”‚ context_data (JSON) â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ "ds_xxx"    â”‚ 123     â”‚ "memo"       â”‚ [...messages]      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Claude Code CLI (~/.claude/sessions/):
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ divinesense:conversation:{id} â”‚ [...CC internal messages]  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **ä»£ç†èƒ½åŠ›å‰²è£‚**
   - ç°ç°/æ—¶å·§/æŠ˜è¡· æ— æ³•è®¿é—® Geek/Evolution äº§ç”Ÿçš„ä¸Šä¸‹æ–‡
   - Geek/Evolution æ— æ³•è®¿é—® DivineSense çš„ç¬”è®°/æ—¥ç¨‹æ£€ç´¢ç»“æœ

---

## 2. è§£å†³æ–¹æ¡ˆï¼šä¼šè¯åµŒå¥—æ¨¡å‹

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¯ä¼šè¯ (Normal Mode)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ User: "å¸®æˆ‘åˆ†æè¿™æ®µä»£ç çš„æ€§èƒ½é—®é¢˜"                       â”‚ â”‚
â”‚  â”‚ Assistant: "å¥½çš„ï¼Œåˆ‡æ¢åˆ°æå®¢æ¨¡å¼æ·±å…¥åˆ†æ..."             â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ”„ å­ä¼šè¯å¯åŠ¨ (Geek Mode) - é»‘ç›’æ‰§è¡Œ               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   CC Session ID: divinesense:conversation:{id}    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   ... [åˆ†æã€ä¼˜åŒ–ä»£ç è¿‡ç¨‹] ...                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   äº§å‡º: code_review_report.md                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   äº§å‡º: optimized_solution.go                     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ ğŸ“ å­ä¼šè¯æ€»ç»“ (åµŒå…¥æ¯ä¼šè¯æ¶ˆæ¯æµ)                         â”‚ â”‚
â”‚  â”‚ Assistant: "æå®¢æ¨¡å¼åˆ†æå®Œæˆï¼š                         â”‚ â”‚
â”‚  â”‚   â€¢ å‘ç° 3 ä¸ªæ€§èƒ½ç“¶é¢ˆ                                  â”‚ â”‚
â”‚  â”‚   â€¢ å·²ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ (è§é™„ä»¶)                            â”‚ â”‚
â”‚  â”‚   â€¢ [ä¸‹è½½äº§å‡ºæ–‡ä»¶]                                    â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ User: "æŠŠä¼˜åŒ–åçš„ä»£ç åº”ç”¨åˆ°é¡¹ç›®ä¸­"                     â”‚ â”‚
â”‚  â”‚ Assistant: "å¥½çš„..."                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **è¿½åŠ å¼è¾“å…¥** - å­ä¼šè¯æ”¯æŒå¤š Q ç´¯åŠ  â†’ å• A å“åº”ï¼ˆCC æœ‰ä¼šè¯ç®¡ç†ï¼‰
2. **å®Œæ•´ä¿å­˜** - Q&A å®Œæ•´ä¿å­˜åˆ° `ai_message`ï¼Œä¸ç”Ÿæˆæ‘˜è¦
3. **ä¸é™åˆ¶** - è¿½åŠ çš„ Q æ•°é‡ä¸é™åˆ¶ï¼Œå†å²ä¿ç•™
4. **å¯è¿½æº¯æ€§** - ä¿ç•™ cc_session_idï¼Œå¼€å‘è€…å¯æœ¬åœ°æŸ¥çœ‹è¯¦æƒ…

### æ ¸å¿ƒå·®å¼‚ï¼šè¿½åŠ å¼ vs ç´¯åŠ å¼

| ç»´åº¦ | **LLM æ¨¡å¼ï¼ˆæ™®é€š/ç°ç°/æ—¶å·§ï¼‰** | **CC æ¨¡å¼ï¼ˆæå®¢/è¿›åŒ–ï¼‰** |
|:-----|:---------------------------|:------------------------|
| **ä¼šè¯å­˜å‚¨** | `conversation_context` è¡¨ | `~/.claude/sessions/` æœ¬åœ° |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | æ¯æ¬¡è¯·æ±‚å‘é€å®Œæ•´ messages[] | CLI å†…éƒ¨æŒä¹…åŒ–ï¼Œè¿½åŠ è¾“å…¥ |
| **æ‰§è¡Œæ–¹å¼** | ç´¯åŠ å¼ (cumulative) | **è¿½åŠ å¼** (append) |
| **è¿›ç¨‹æ¨¡å‹** | æ— çŠ¶æ€ | æŒä¹…è¿›ç¨‹ |
| **æŒ‡ä»¤å‘é€** | HTTP è¯·æ±‚ â†’ LLM API | `WriteInput()` â†’ Stdin |

---

## 3. æŠ€æœ¯æ–¹æ¡ˆ

### æ•°æ®æ¨¡å‹

```sql
-- æ–‡ä»¶: store/migration/postgres/V0.82.0__add_subsession_support.sql

-- æ‰©å±• ai_conversation è¡¨æ”¯æŒå­ä¼šè¯
ALTER TABLE ai_conversation
    ADD COLUMN parent_conversation_id INTEGER REFERENCES ai_conversation(id),
    ADD COLUMN session_mode VARCHAR(20) DEFAULT 'normal',  -- 'normal'|'geek'|'evolution'
    ADD COLUMN cc_session_id VARCHAR(64);

CREATE INDEX idx_conversation_parent ON ai_conversation(parent_conversation_id);
CREATE INDEX idx_conversation_mode ON ai_conversation(session_mode);
CREATE INDEX idx_conversation_cc_session ON ai_conversation(cc_session_id);
```

**æ•°æ®å­˜å‚¨ç¤ºä¾‹**ï¼š
```
ai_conversation:
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ parent_id    â”‚ mode        â”‚ cc_session_idâ”‚ title             â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 100 â”‚ NULL         â”‚ 'normal'    â”‚ NULL         â”‚ 'ä¸»ä¼šè¯'         â”‚
â”‚ 101 â”‚ 100          â”‚ 'geek'      â”‚ 'uuid-xxx'   â”‚ 'æå®¢å­ä¼šè¯'     â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ai_message (Q&A å®Œæ•´ä¿å­˜):
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id   â”‚ conversation_idâ”‚ role     â”‚ type         â”‚ content                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1001 â”‚ 101             â”‚ 'user'   â”‚ 'MESSAGE'    â”‚ 'Q1: åˆ†ææ€§èƒ½ç“¶é¢ˆ'      â”‚
â”‚ 1002 â”‚ 101             â”‚ 'user'   â”‚ 'MESSAGE'    â”‚ 'Q2: æ£€æŸ¥å†…å­˜æ³„æ¼'      â”‚
â”‚ 1003 â”‚ 101             â”‚ 'user'   â”‚ 'MESSAGE'    â”‚ 'Q3: ç”Ÿæˆä¼˜åŒ–ä»£ç '      â”‚
â”‚ 1004 â”‚ 101             â”‚'assistant'â”‚ 'MESSAGE'    â”‚ '[å®Œæ•´ CC å“åº”]'       â”‚
â”‚ 1005 â”‚ 101             â”‚ 'user'   â”‚ 'MESSAGE'    â”‚ 'Q4: å†ä¼˜åŒ–ä¸€ä¸‹'        â”‚
â”‚ 1006 â”‚ 101             â”‚'assistant'â”‚ 'MESSAGE'    â”‚ '[ç¬¬äºŒæ³¢å“åº”]'         â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ä¿ç•™**ï¼š
- âŒ CC CLI åŸå§‹ä¼šè¯å†…å®¹ï¼ˆå·²åœ¨æœ¬åœ°æŒä¹…åŒ–ï¼‰
- âŒ thinking/tool_use è¯¦ç»†è¿‡ç¨‹ï¼ˆå¯ä» CC Session æŸ¥çœ‹ï¼‰

**ä¿ç•™**ï¼š
- âœ… å®Œæ•´ Q+Aï¼ˆæ¯æ¡ä½œä¸º `ai_message` ä¿å­˜ï¼‰
- âœ… cc_session_idï¼ˆç”¨äºæœ¬åœ°è¿½æº¯ï¼‰
- âŒ LLM æ‘˜è¦ï¼ˆä¸éœ€è¦ï¼Œå®Œæ•´ Q+A æ›´å¥½ï¼‰

### å‰ç«¯ç±»å‹å®šä¹‰

```typescript
// å­ä¼šè¯å…ƒæ•°æ®
export interface SubsessionMetadata {
  id: string;                 // å­ä¼šè¯ ID (conversation_id)
  mode: 'geek' | 'evolution';
  ccSessionId: string;
  parentConversationId: string;  // æ¯ä¼šè¯ ID
  status: 'active' | 'idle' | 'closed';
  enteredAt: number;
  lastActivityAt: number;

  // è¿½åŠ çš„æŒ‡ä»¤åˆ—è¡¨
  pendingInputs: SubsessionInput[];
}

// å­ä¼šè¯ä¸­çš„å•æ¡è¾“å…¥
export interface SubsessionInput {
  id: string;
  content: string;
  timestamp: number;
  status: 'queued' | 'processing' | 'completed';
}
```

### åç«¯å®ç°ï¼ˆåŸºäºç°æœ‰å¼‚æ­¥æ¶æ„ï¼‰

**å…³é”®å‘ç°**ï¼š`plugin/ai/agent/session_manager.go` å·²å®ç°æŒä¹…ä¼šè¯
- `GetOrCreateSession()` - è·å–/åˆ›å»ºæŒä¹…ä¼šè¯
- `Session.WriteInput()` - çº¿ç¨‹å®‰å…¨çš„ Stdin è¿½åŠ 
- 30 åˆ†é’Ÿç©ºé—²è¶…æ—¶è‡ªåŠ¨æ¸…ç†

**GeekParrot æ”¹é€ **ï¼š

```go
type GeekParrot struct {
    // ... ç°æœ‰å­—æ®µ

    // æ–°å¢ï¼šæŒä¹…ä¼šè¯æ”¯æŒ
    persistentSession *Session
    sessionMutex     sync.RWMutex
    conversationID   int64
}

// EnterSubsession è¿›å…¥å­ä¼šè¯æ¨¡å¼ï¼ˆå¯åŠ¨æŒä¹…ä¼šè¯ï¼‰
func (p *GeekParrot) EnterSubsession(ctx context.Context, cfg CCRunnerConfig) (*Session, error) {
    sess, err := p.runner.StartAsyncSession(ctx, &cfg)
    if err != nil {
        return nil, err
    }

    p.persistentSession = sess
    p.conversationID = cfg.ConversationID

    // å¯åŠ¨æµå¼è¾“å‡ºè¯»å–å¾ªç¯
    go p.streamLoop(sess, cfg.ConversationID)

    return sess, nil
}

// AppendInput è¿½åŠ ç”¨æˆ·è¾“å…¥ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
func (p *GeekParrot) AppendInput(ctx context.Context, input string) error {
    sess := p.persistentSession
    if sess == nil {
        return fmt.Errorf("no active subsession")
    }

    msg := map[string]any{
        "type": "user",
        "message": map[string]any{
            "role": "user",
            "content": []map[string]any{
                {"type": "text", "text": input},
            },
        },
    }

    return sess.WriteInput(msg)  // çº¿ç¨‹å®‰å…¨ï¼Œç›´æ¥å†™å…¥ Stdin
}
```

### äº‹ä»¶æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶æµ: æ¯ä¼šè¯ â†’ å­ä¼šè¯ â†’ æŒç»­äº¤äº’                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ 1. subsession_enter                                                 â”‚
â”‚    { mode: "geek", cc_session_id: "xxx" }                          â”‚
â”‚    â†“ å‰ç«¯æ˜¾ç¤º SubsessionPanel                                       â”‚
â”‚                                                                      â”‚
â”‚ 2. ç”¨æˆ·è¿½åŠ æŒ‡ä»¤ (å¯å¤šæ¬¡)                                            â”‚
â”‚    Q1 â†’ AppendInput() â†’ sess.WriteInput() â†’ CC Stdin               â”‚
â”‚    Q2 â†’ AppendInput() â†’ sess.WriteInput() â†’ CC Stdin               â”‚
â”‚    Q3 â†’ AppendInput() â†’ sess.WriteInput() â†’ CC Stdin               â”‚
â”‚    â†“ å‰ç«¯å®æ—¶æ˜¾ç¤º Q åˆ—è¡¨                                            â”‚
â”‚                                                                      â”‚
â”‚ 3. CC å“åº” (æµå¼)                                                   â”‚
â”‚    thinking â†’ tool_use â†’ answer (ç°æœ‰äº‹ä»¶æµ)                        â”‚
â”‚    â†“ å‰ç«¯å®æ—¶æ˜¾ç¤º CC æ€è€ƒå’Œå“åº”                                     â”‚
â”‚                                                                      â”‚
â”‚ 4. subsession_exit                                                  â”‚
â”‚    ç”¨æˆ·é€€å‡ºæˆ–è¶…æ—¶                                                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‰ç«¯ç»„ä»¶è®¾è®¡

**SubsessionPanel** - å­ä¼šè¯é¢æ¿ï¼š

```tsx
function SubsessionPanel({ subsession, onAppendInput, onExit }) {
  return (
    <div className="border-l-2 border-geek-theme/50">
      {/* å¤´éƒ¨ */}
      <div className="flex items-center justify-between px-4 py-2">
        <span>ğŸ”„ {subsession.mode === 'geek' ? 'æå®¢æ¨¡å¼' : 'è¿›åŒ–æ¨¡å¼'}</span>
        <Button onClick={onExit}>é€€å‡ºå­ä¼šè¯</Button>
      </div>

      {/* å·²è¿½åŠ çš„æŒ‡ä»¤åˆ—è¡¨ */}
      <div className="px-4 py-2 space-y-1">
        {subsession.pendingInputs.map((input, idx) => (
          <div key={input.id}>
            ã€Q{idx + 1}ã€‘{input.content} {formatTime(input.timestamp)}
            {input.status === 'processing' && <span>ğŸ’­ å¤„ç†ä¸­...</span>}
          </div>
        ))}
      </div>

      {/* CC å“åº”åŒºåŸŸï¼ˆæµå¼ï¼‰ */}
      <CcResponseStream ccSessionId={subsession.ccSessionId} />

      {/* è¿½åŠ è¾“å…¥æ¡† */}
      <Input
        placeholder="è¿½åŠ æŒ‡ä»¤... (ç›´æ¥å‘é€ç»™ CC)"
        onKeyPress={(e) => {
          if (e.key === 'Enter') {
            onAppendInput(e.currentTarget.value);
          }
        }}
      />
    </div>
  );
}
```

---

## 4. UI å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ æå®¢æ¨¡å¼                                    [é€€å‡ºå­ä¼šè¯]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã€Q1ã€‘åˆ†æ data_pipeline.go çš„æ€§èƒ½ç“¶é¢ˆ          [10:23:01]       â”‚
â”‚ ã€Q2ã€‘å†æ£€æŸ¥ä¸€ä¸‹å†…å­˜æ³„æ¼é£é™©                     [10:23:15]       â”‚
â”‚ ã€Q3ã€‘ä¼˜åŒ–åçš„ä»£ç ç”Ÿæˆåˆ° optimized_pipeline.go    [10:23:30]      â”‚
â”‚                                                                  â”‚
â”‚ ğŸ’­ CC æ­£åœ¨æ€è€ƒ...                                                â”‚
â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] æ‰§è¡Œ bash: go test -v ...                     â”‚
â”‚                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚                                                                  â”‚
â”‚ ğŸ“ [A1] å®Œæ•´å“åº”å†…å®¹...                                          â”‚
â”‚ â€¢ å‘ç° 3 ä¸ªæ€§èƒ½ç“¶é¢ˆ...                                           â”‚
â”‚ â€¢ [ä¸‹è½½ optimized_pipeline.go]                                  â”‚
â”‚                                                                  â”‚
â”‚ ã€Q4ã€‘å†ä¼˜åŒ–ä¸€ä¸‹                               [10:25:00]       â”‚
â”‚                                                                  â”‚
â”‚ ğŸ’­ CC æ­£åœ¨æ€è€ƒ...                                                â”‚
â”‚                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚                                                                  â”‚
â”‚ ğŸ“ [A2] ç¬¬äºŒæ³¢å“åº”...                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚                                                                  â”‚
â”‚ [è¿½åŠ æŒ‡ä»¤]                                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è¾“å…¥æ¡†...                                      [å‘é€]         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å®ç°é˜¶æ®µ

| é˜¶æ®µ | å†…å®¹ | æ–‡ä»¶ |
|:-----|:-----|:-----|
| **P1** | æ•°æ®åº“è¿ç§» + Store æ¥å£ | `V0.82.0__add_subsession_support.sql`, `store/db/postgres/ai_conversation.go` |
| **P2** | GeekParrot æŒä¹…ä¼šè¯æ”¹é€  | `plugin/ai/agent/geek_parrot.go` |
| **P3** | EvolutionParrot æŒä¹…ä¼šè¯æ”¹é€  | `plugin/ai/agent/evolution_parrot.go` |
| **P4** | åç«¯ Chat Handler æ‰©å±• | `server/router/api/v1/ai/handler.go` |
| **P5** | å‰ç«¯ç±»å‹ + Context | `web/src/types/aichat.ts`, `web/src/contexts/AIChatContext.tsx` |
| **P6** | å‰ç«¯ SubsessionPanel ç»„ä»¶ | `web/src/components/chat/SubsessionPanel.tsx` |
| **P7** | å‰ç«¯æµå¼å“åº”ç»„ä»¶ | `web/src/components/chat/CcResponseStream.tsx` |
| **P8** | é›†æˆæµ‹è¯• + æ–‡æ¡£ | `docs/specs/subsession_model.md` |

---

## 6. å‚è€ƒèµ„æ–™

- **CC Runner å¼‚æ­¥æ¶æ„**: `docs/specs/cc_runner_async_arch.md`
- **SessionManager**: `plugin/ai/agent/session_manager.go`ï¼ˆå·²å®ç°æŒä¹…ä¼šè¯ï¼‰
- **CCRunner**: `plugin/ai/agent/cc_runner.go`ï¼ˆå·²å®ç° UUID v5 æ˜ å°„ï¼‰
- **Proto å®šä¹‰**: `proto/api/v1/ai_service.proto`
- **å‰ç«¯ç±»å‹**: `web/src/types/aichat.ts`

---

## 7. Issue é“¾æ¥

**[#57](https://github.com/hrygo/divinesense/issues/57)** - [feat] ä¼šè¯åµŒå¥—æ¨¡å‹ - æ¯ä¼šè¯ä¸å­ä¼šè¯(Geek/Evolution)çš„ç»Ÿä¸€æ¶æ„

---

*è°ƒç ”å®Œæˆæ—¶é—´: 2026-02-03 (v2.0)*
*è°ƒç ”è€…: Claude (Idea Researcher v3.1)*
