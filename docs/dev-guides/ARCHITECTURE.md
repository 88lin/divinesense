# æ¶æ„æ–‡æ¡£

> **ä¿é²œçŠ¶æ€**: âœ… å·²éªŒè¯ (2026-02-03) | **æœ€åæ£€æŸ¥**: v6.1 (AI Core é‡æ„)

## é¡¹ç›®æ¦‚è¿°

DivineSense (ç¥è¯†) æ˜¯ä¸€æ¬¾éšç§ä¼˜å…ˆã€è½»é‡çº§çš„ç¬”è®°æœåŠ¡ï¼Œé€šè¿‡ AI é©±åŠ¨çš„ã€Œé¹¦é¹‰ã€ä»£ç†å¢å¼ºç”¨æˆ·ä½“éªŒã€‚
- **æ ¸å¿ƒæ¶æ„**ï¼šGo åç«¯ (Echo/Connect RPC) + React å‰ç«¯ (Vite/Tailwind) â€”â€” **å•äºŒè¿›åˆ¶åˆ†å‘**
- **æ•°æ®å­˜å‚¨**ï¼šPostgreSQLï¼ˆç”Ÿäº§ç¯å¢ƒï¼Œå®Œæ•´ AI æ”¯æŒï¼‰ï¼ŒSQLiteï¼ˆä»…å¼€å‘ç¯å¢ƒï¼Œ**æ—  AI**ï¼‰è¯¦è§ [#9](https://github.com/hrygo/divinesense/issues/9)
- **æ ¸å¿ƒç‰¹æ€§**ï¼šå¤šä»£ç† AI ç³»ç»Ÿã€è¯­ä¹‰æœç´¢ã€æ—¥ç¨‹åŠ©ç†ã€è‡ªæ‰˜ç®¡æ— é¥æµ‹
- **ç«¯å£**ï¼šåç«¯ 28081ï¼Œå‰ç«¯ 25173ï¼ŒPostgreSQL 25432ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

## æŠ€æœ¯æ ˆ

| é¢†åŸŸ   | æŠ€æœ¯é€‰å‹                                                                                             |
| :----- | :--------------------------------------------------------------------------------------------------- |
| åç«¯   | Go 1.25, Echo, Connect RPC, pgvector                                                                 |
| å‰ç«¯   | React 18, Vite 7, TypeScript, Tailwind CSS 4, Radix UI, TanStack Query                               |
| æ•°æ®åº“ | PostgreSQL 16+ï¼ˆç”Ÿäº§ï¼‰ï¼ŒSQLiteï¼ˆå¼€å‘ï¼Œ**æ—  AI**ï¼‰[#9](https://github.com/hrygo/divinesense/issues/9) |
| AI     | DeepSeek V3ï¼ˆLLMï¼‰ï¼ŒSiliconFlowï¼ˆEmbeddingã€Rerankerï¼‰                                               |

---

## é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„

```
divinesense/
â”œâ”€â”€ cmd/divinesense/     # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ server/              # HTTP/gRPC æœåŠ¡å™¨ & è·¯ç”±
â”‚   â”œâ”€â”€ router/          # API å¤„ç†å™¨ï¼ˆv1 å®ç°ï¼‰
â”‚   â”œâ”€â”€ queryengine/     # æŸ¥è¯¢è·¯ç”± & æ„å›¾æ£€æµ‹
â”‚   â”œâ”€â”€ runner/          # åå°ä»»åŠ¡è¿è¡Œå™¨
â”‚   â”œâ”€â”€ scheduler/       # æ—¥ç¨‹ç®¡ç†
â”‚   â””â”€â”€ service/         # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ ai/                  # ğŸ”´ AI æ ¸å¿ƒæ¨¡å—ï¼ˆä¸€çº§æ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ agent/           #   Parrot ä»£ç†ï¼ˆMemoParrotã€ScheduleParrotã€AmazingParrotã€GeekParrotã€EvolutionParrotï¼‰
â”‚   â”œâ”€â”€ router/          #   ä¸‰å±‚æ„å›¾è·¯ç”±
â”‚   â”œâ”€â”€ vector/          #   Embedding æœåŠ¡
â”‚   â”œâ”€â”€ memory/          #   æƒ…æ™¯è®°å¿†
â”‚   â”œâ”€â”€ session/         #   å¯¹è¯æŒä¹…åŒ–
â”‚   â”œâ”€â”€ cache/           #   LRU ç¼“å­˜å±‚
â”‚   â”œâ”€â”€ metrics/         #   ä»£ç†æ€§èƒ½è¿½è¸ª
â”‚   â”œâ”€â”€ core/            #   AI åŸºç¡€è®¾æ–½
â”‚   â”‚   â”œâ”€â”€ embedding/   #     åµŒå…¥æœåŠ¡ï¼ˆä» server/ai/ è¿ç§»ï¼‰
â”‚   â”‚   â”œâ”€â”€ retrieval/   #     æ£€ç´¢ç³»ç»Ÿï¼ˆä» server/retrieval/ è¿ç§»ï¼‰
â”‚   â”‚   â”œâ”€â”€ reranker/    #     é‡æ’æœåŠ¡
â”‚   â”‚   â””â”€â”€ llm/         #     LLM å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ rag/             #   RAG é«˜çº§åŠŸèƒ½
â”‚   â”œâ”€â”€ tags/            #   æ ‡ç­¾å»ºè®®
â”‚   â”œâ”€â”€ duplicate/       #   é‡å¤æ£€æµ‹
â”‚   â”œâ”€â”€ habit/           #   ä¹ æƒ¯å­¦ä¹ 
â”‚   â”œâ”€â”€ genui/           #   ç”Ÿæˆå¼ UI
â”‚   â”œâ”€â”€ graph/           #   çŸ¥è¯†å›¾è°±
â”‚   â”œâ”€â”€ prediction/      #   é¢„æµ‹å¼•æ“
â”‚   â”œâ”€â”€ reminder/        #   æé†’ç³»ç»Ÿ
â”‚   â”œâ”€â”€ schedule/        #   æ—¥ç¨‹ AI
â”‚   â”œâ”€â”€ aitime/          #   AI æ—¶é—´è§£æ
â”‚   â”œâ”€â”€ timeout/         #   è¶…æ—¶å¤„ç†
â”‚   â”œâ”€â”€ review/          #   å®¡æŸ¥æœåŠ¡
â”‚   â”œâ”€â”€ context/         #   ä¸Šä¸‹æ–‡æ„å»º
â”‚   â””â”€â”€ config.go        #   AI é…ç½®
â”œâ”€â”€ plugin/              # å…¶ä»–å¯é€‰æ’ä»¶ï¼ˆé AIï¼‰
â”‚   â”œâ”€â”€ scheduler/       # ä»»åŠ¡è°ƒåº¦
â”‚   â”œâ”€â”€ storage/         # å­˜å‚¨é€‚é…å™¨ï¼ˆS3ã€æœ¬åœ°ï¼‰
â”‚   â”œâ”€â”€ idp/             # èº«ä»½æä¾›å•†
â”‚   â”œâ”€â”€ markdown/        # Markdown æ’ä»¶
â”‚   â”œâ”€â”€ ocr/             # OCR æ’ä»¶
â”‚   â””â”€â”€ webhook/         # Webhook æ’ä»¶
â”œâ”€â”€ store/               # æ•°æ®å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ db/              # æ•°æ®åº“å®ç°
â”‚   â”‚   â”œâ”€â”€ postgres/    # PostgreSQL with pgvector
â”‚   â”‚   â””â”€â”€ sqlite/      # SQLiteï¼ˆä»…å¼€å‘ç¯å¢ƒï¼Œæ—  AIï¼‰
â”‚   â””â”€â”€ [interfaces]     # å­˜å‚¨æŠ½è±¡
â”œâ”€â”€ proto/               # Protobuf å®šä¹‰ï¼ˆAPI å¥‘çº¦ï¼‰
â”‚   â”œâ”€â”€ api/v1/          # API æœåŠ¡å®šä¹‰
â”‚   â””â”€â”€ store/           # Store æœåŠ¡å®šä¹‰
â”œâ”€â”€ web/                 # React å‰ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ pages/       # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ layouts/     # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ components/  # UI ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ locales/     # i18n ç¿»è¯‘ï¼ˆenã€zh-Hansã€zh-Hantï¼‰
â”‚   â”‚   â””â”€â”€ hooks/       # React hooks
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ docs/                # æ–‡æ¡£
â”œâ”€â”€ scripts/             # å¼€å‘å’Œæ„å»ºè„šæœ¬
â””â”€â”€ docker/              # Docker é…ç½®
```

### æ ¸å¿ƒç»„ä»¶

1. **å•äºŒè¿›åˆ¶æ„å»º (Single Binary)**ï¼š
   - **å‰ç«¯é›†æˆ**ï¼šä½¿ç”¨ `go:embed` å°† `web/dist` æ‰“åŒ…è¿› Go äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
   - **æ•°æ®åº“è¿ç§»**ï¼šSQL è„šæœ¬åŒæ ·é€šè¿‡ `embed` åµŒå…¥ï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ `store/migrator.go` è¿›è¡Œæ¶æ„å‡çº§ã€‚
   - **ä¼˜åŠ¿**ï¼šåˆ†å‘æ— éœ€ Node.js/Nginxï¼Œç›´æ¥è¿è¡Œå…¨æ ˆæœåŠ¡ã€‚

2. **æœåŠ¡å™¨åˆå§‹åŒ–**ï¼šProfile â†’ DB â†’ Store â†’ Server
   - ä½¿ç”¨ Echo æ¡†æ¶ + Connect RPCï¼ˆgRPC/HTTP è½¬ç ï¼‰
   - é™æ€èµ„æºæœåŠ¡æ”¯æŒ Gzip å‹ç¼©ã€SPA è·¯ç”±å›é€€åŠå¼ºç¼“å­˜ä¼˜åŒ–ã€‚

2. **AI æ ¸å¿ƒæ¨¡å—** (`ai/`)ï¼š
   - LLM æä¾›å•†ï¼šDeepSeekã€OpenAIã€Ollama
   - Embeddingï¼šSiliconFlow (BAAI/bge-m3)ã€OpenAI
   - Rerankerï¼šBAAI/bge-reranker-v2-m3
   - æ‰€æœ‰ AI åŠŸèƒ½å¯é€‰ï¼ˆç”± `DIVINESENSE_AI_ENABLED` æ§åˆ¶ï¼‰
   - åŒ…å«ä» `server/ai/` å’Œ `server/retrieval/` è¿ç§»çš„åµŒå…¥å’Œæ£€ç´¢åŠŸèƒ½

3. **æ’ä»¶ç³»ç»Ÿ** (`plugin/`)ï¼š
   - ä¸å†åŒ…å« AI åŠŸèƒ½ï¼ˆå·²æå‡ä¸ºä¸€çº§æ¨¡å—ï¼‰
   - åŒ…å«ï¼šè°ƒåº¦å™¨ã€å­˜å‚¨é€‚é…å™¨ã€èº«ä»½æä¾›å•†ã€Markdownã€OCRã€Webhook ç­‰

4. **åå°è¿è¡Œå™¨** (`server/runner/`):
   - å¼‚æ­¥ç”Ÿæˆç¬”è®° Embedding
   - AI æ“ä½œä»»åŠ¡é˜Ÿåˆ—
   - AI å¯ç”¨æ—¶è‡ªåŠ¨è¿è¡Œ

5. **å­˜å‚¨å±‚**ï¼š
   - æ¥å£å®šä¹‰åœ¨ `store/`
   - é©±åŠ¨ç‰¹å®šå®ç°åœ¨ `store/db/{postgres,sqlite}/`
   - è¿ç§»ç³»ç»Ÿåœ¨ `store/migration/`

6. **æ™ºèƒ½æŸ¥è¯¢å¼•æ“** (`server/queryengine/`):
   - è‡ªé€‚åº”æ£€ç´¢ï¼ˆBM25 + å‘é‡æœç´¢ + é€‰æ‹©æ€§é‡æ’ï¼‰
   - æ™ºèƒ½æŸ¥è¯¢è·¯ç”±ï¼ˆæ£€æµ‹æ—¥ç¨‹ vs. æœç´¢æŸ¥è¯¢ï¼‰
   - è‡ªç„¶è¯­è¨€æ—¥æœŸè§£æ
   - å¸¦å†²çªæ£€æµ‹çš„æ—¥ç¨‹åŠ©ç†

### API æœåŠ¡

> **ä¿é²œçŠ¶æ€**: âœ… å·²éªŒè¯ (2025-02-02) | **è¦†ç›–èŒƒå›´**: `proto/api/v1/*.proto` | **æœ€åæ£€æŸ¥**: v6.0

| æœåŠ¡ | Proto æ–‡ä»¶ | æè¿° |
|:-----|:-----------|:-----|
| **ActivityService** | `activity_service.proto` | ç”¨æˆ·æ´»åŠ¨è®°å½• |
| **AttachmentService** | `attachment_service.proto` | é™„ä»¶ç®¡ç† |
| **AuthService** | `auth_service.proto` | è®¤è¯æˆæƒ |
| **IdpService** | `idp_service.proto` | èº«ä»½æä¾›å•†é›†æˆ |
| **InstanceService** | `instance_service.proto` | å®ä¾‹é…ç½® |
| **MemoService** | `memo_service.proto` | ç¬”è®° CRUD |
| **ScheduleService** | `schedule_service.proto` | æ—¥ç¨‹ç®¡ç† |
| **ShortcutService** | `shortcut_service.proto` | å¿«æ·æ–¹å¼ |
| **UserService** | `user_service.proto` | ç”¨æˆ·ç®¡ç† |
| **Common** | `common.proto` | é€šç”¨ç±»å‹å®šä¹‰ |
| **AIService** | `ai_service.proto` | AI èŠå¤©ã€åµŒå…¥ã€æ£€ç´¢ |

---

## ğŸ”’ Git Hooks å·¥ä½œæµ

DivineSense ä½¿ç”¨ **pre-commit + pre-push** hooks ç¡®ä¿ä»£ç è´¨é‡ï¼š

| Hook | æ£€æŸ¥å†…å®¹ | é€Ÿåº¦ | è§¦å‘æ—¶æœº |
|:-----|:---------|:-----|:---------|
| **pre-commit** | `go fmt` + `go vet` + `pnpm lint:fix` | ~5ç§’ | æ¯æ¬¡ `git commit` |
| **pre-push** | `golangci-lint` + `go test` + `pnpm build` | ~1åˆ†é’Ÿ | æ¯æ¬¡ `git push` |

### å®‰è£…ä¸ä½¿ç”¨

```bash
# å®‰è£… hooks
make install-hooks

# æœ¬åœ° CI æ£€æŸ¥ï¼ˆä¸ GitHub Actions ä¸€è‡´ï¼‰
make ci-check
make ci-backend
make ci-frontend

# è·³è¿‡æ£€æŸ¥
git commit --no-verify -m "WIP"
git push --no-verify
```

> **è¯¦ç»†è§„èŒƒ**ï¼šå‚è§ [Git å·¥ä½œæµ](../../.claude/rules/git-workflow.md)

---

## Parrot ä»£ç†æ¶æ„

### ä»£ç†ç±»å‹ (`ai/agent/`)

|  AgentType  | é¹¦é¹‰åç§° | æ–‡ä»¶                    | ä¸­æ–‡å | æè¿°                             |
| :---------: | :------- | :---------------------- | :----- | :------------------------------- |
|   `MEMO`    | ç°ç°     | `memo_parrot.go`        | ç°ç°   | ç¬”è®°æœç´¢å’Œæ£€ç´¢ä¸“å®¶               |
| `SCHEDULE`  | æ—¶å·§     | `schedule_parrot_v2.go` | æ—¶å·§   | æ—¥ç¨‹åˆ›å»ºå’Œç®¡ç†                   |
|  `AMAZING`  | æŠ˜è¡·     | `amazing_parrot.go`     | æŠ˜è¡·   | ç»¼åˆåŠ©ç†ï¼ˆç¬”è®° + æ—¥ç¨‹ï¼‰          |
|   `GEEK`    | æå®¢     | `geek_parrot.go`        | æå®¢   | Claude Code CLI é€šä¿¡å±‚ï¼ˆé›¶ LLMï¼‰ |
| `EVOLUTION` | è¿›åŒ–     | `evolution_parrot.go`   | è¿›åŒ–   | è‡ªæˆ‘è¿›åŒ–èƒ½åŠ›ï¼ˆæºä»£ç ä¿®æ”¹ï¼‰       |

### ä»£ç†è·¯ç”±å™¨

**ä½ç½®**ï¼š`ai/agent/chat_router.go`

ChatRouter å®ç°**ä¸‰å±‚**æ„å›¾åˆ†ç±»ç³»ç»Ÿï¼š

```
ç”¨æˆ·è¾“å…¥ â†’ EvolutionMode? â”€Yesâ†’ EvolutionParrotï¼ˆè‡ªæˆ‘è¿›åŒ–ï¼‰
                  â”‚
                  No
                  â†“
           GeekMode? â”€Yesâ†’ GeekParrotï¼ˆClaude Code CLIï¼‰
                  â”‚
                  No
                  â†“
           ChatRouter.Route()
                  â†“
           routerService? â”€Yesâ†’ ä¸‰å±‚è·¯ç”±
                  â”‚          (è§„åˆ™ + å†å² + LLM)
                  â”‚
                  Noï¼ˆå‘åå…¼å®¹ï¼‰
                  â†“
           routeByRules()     â† å¿«é€Ÿè·¯å¾„ï¼ˆ0msï¼‰
                  â†“
         åŒ¹é…æˆåŠŸ? â”€Yesâ†’ è¿”å›ï¼ˆç½®ä¿¡åº¦ â‰¥0.80ï¼‰
                  â”‚
                  No
                  â†“
           routeByLLM()       â† æ…¢é€Ÿè·¯å¾„ï¼ˆ~400msï¼‰
                  â†“
         Qwen2.5-7B-Instruct
         ï¼ˆä¸¥æ ¼ JSON Schemaï¼‰
                  â†“
           è·¯ç”±ç»“æœ
```

**EvolutionMode æœ€é«˜ä¼˜å…ˆçº§è·¯ç”±**ï¼š
- å½“ `EvolutionMode=true` æ—¶ï¼Œ**ç»•è¿‡æ‰€æœ‰è·¯ç”±**ï¼Œç›´æ¥åˆ›å»º EvolutionParrot
- **å·¥ä½œç›®å½•**: DivineSense æºä»£ç æ ¹ç›®å½•
- **äº§å‡ºç‰©**: å¼ºåˆ¶ GitHub PRï¼Œéœ€äººå·¥ Review ååˆå¹¶
- **å®‰å…¨ç­‰çº§**: é«˜ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ + ç¯å¢ƒå˜é‡å¯ç”¨ + PR å®¡æ ¸ï¼‰
- ä»…é™ç®¡ç†å‘˜ä½¿ç”¨
- å®ç°ï¼š`server/router/api/v1/ai/handler.go` ä¸­çš„ `handleEvolutionMode()`

**GeekMode ä¼˜å…ˆè·¯ç”±**ï¼š
- å½“ `GeekMode=true` æ—¶ï¼ˆä¸” EvolutionMode=falseï¼‰ï¼Œ**ç»•è¿‡æ‰€æœ‰è·¯ç”±**ï¼Œç›´æ¥åˆ›å»º GeekParrot
- **å·¥ä½œç›®å½•**: `~/.divinesense/claude/user_{id}`ï¼ˆç”¨æˆ·æ²™ç®±ï¼‰
- **äº§å‡ºç‰©**: ç”¨æˆ·å¯æµè§ˆ/ä¸‹è½½çš„ä»£ç äº§ç‰©
- **å®‰å…¨ç­‰çº§**: ä¸­ï¼ˆæ²™ç®±éš”ç¦»ï¼‰
- æ‰€æœ‰ç”¨æˆ·å¯ç”¨
- å®ç°ï¼š`server/router/api/v1/ai/handler.go` ä¸­çš„ `handleGeekMode()`

**ä¸‰å±‚è·¯ç”±**ï¼ˆå½“ `router.Service` å·²é…ç½®æ—¶ï¼‰ï¼š
1. **è§„åˆ™åŒ¹é…**ï¼ˆ0msï¼‰ï¼šå¸¸è§æ¨¡å¼çš„å…³é”®è¯åŒ¹é…
2. **å†å²æ„ŸçŸ¥**ï¼ˆ~10msï¼‰ï¼šå¯¹è¯ä¸Šä¸‹æ–‡åŒ¹é…
3. **LLM é™çº§**ï¼ˆ~400msï¼‰ï¼šæ¨¡ç³Šè¾“å…¥çš„è¯­ä¹‰ç†è§£

**è§„åˆ™åŒ¹é…**ï¼š
- æ—¥ç¨‹å…³é”®è¯ï¼š`æ—¥ç¨‹`ã€`schedule`ã€`ä¼šè®®`ã€`meeting`ã€`æé†’`ã€`remind`ã€æ—¶é—´è¯ï¼ˆ`ä»Šå¤©`ã€`æ˜å¤©`ã€`å‘¨X`ã€`ç‚¹`ã€`åˆ†`ï¼‰
- ç¬”è®°å…³é”®è¯ï¼š`ç¬”è®°`ã€`memo`ã€`note`ã€`æœç´¢`ã€`search`ã€`æŸ¥æ‰¾`ã€`find`ã€`å†™è¿‡`ã€`å…³äº`
- Amazing å…³é”®è¯ï¼š`ç»¼åˆ`ã€`æ€»ç»“`ã€`summary`ã€`æœ¬å‘¨å·¥ä½œ`ã€`å‘¨æŠ¥`

**LLM é™çº§**ï¼š
- æ¨¡å‹ï¼š`Qwen/Qwen2.5-7B-Instruct`ï¼ˆé€šè¿‡ SiliconFlowï¼‰
- æœ€å¤§ tokenï¼š30ï¼ˆæœ€å°åŒ–å“åº”ï¼‰
- ä¸¥æ ¼ JSON Schemaï¼š`{"route": "memo|schedule|amazing", "confidence": 0.0-1.0}`

### ä»£ç†å·¥å…·

**ä½ç½®**ï¼š`ai/agent/tools/`

| å·¥å…·              | æ–‡ä»¶             | æè¿°                    |
| :---------------- | :--------------- | :---------------------- |
| `memo_search`     | `memo_search.go` | è¯­ä¹‰ç¬”è®°æœç´¢ + RRF èåˆ |
| `schedule_add`    | `scheduler.go`   | åˆ›å»ºæ–°æ—¥ç¨‹              |
| `schedule_query`  | `scheduler.go`   | æŸ¥è¯¢ç°æœ‰æ—¥ç¨‹            |
| `schedule_update` | `scheduler.go`   | æ›´æ–°ç°æœ‰æ—¥ç¨‹            |
| `find_free_time`  | `scheduler.go`   | æŸ¥æ‰¾ç©ºé—²æ—¶é—´æ®µ          |

### æ—¥ç¨‹ä»£ç† V2

**ä½ç½®**ï¼š`ai/agent/scheduler_v2.go`

å®ç°åŸç”Ÿå·¥å…·è°ƒç”¨å¾ªç¯ï¼ˆç°ä»£ LLM ä¸éœ€è¦ ReActï¼‰ï¼š

**ç‰¹æ€§**ï¼š
- å¸¦ç»“æ„åŒ–å‚æ•°çš„ç›´æ¥å‡½æ•°è°ƒç”¨
- é»˜è®¤ 1 å°æ—¶æŒç»­æ—¶é—´
- è‡ªåŠ¨å†²çªæ£€æµ‹
- æ—¶åŒºæ„ŸçŸ¥æ—¥ç¨‹å®‰æ’

---

## CC Runner å¼‚æ­¥æ¶æ„ (Geek Mode æ ¸å¿ƒ)

**è§„æ ¼æ–‡æ¡£**ï¼š[CC Runner å¼‚æ­¥æ¶æ„è¯´æ˜ä¹¦](../specs/cc_runner_async_arch.md) (v1.2)

**æ¦‚è¿°**ï¼šGeek Mode ä»ä¸€æ¬¡æ€§æ‰§è¡Œï¼ˆOne-shotï¼‰å‡çº§ä¸º**å…¨åŒå·¥æŒä¹…åŒ–**ï¼ˆFull-Duplex Persistentï¼‰æ¶æ„ã€‚

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  EventBadge  â”‚  â”‚ ToolCallCard â”‚  â”‚  SessionSummaryPanel â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                  â”‚
â”‚                        WebSocket (SSE)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend (Go)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Session Mgr â”‚â—„â”€â”¤   Streamer  â”‚â—„â”€â”¤  DangerDetector      â”‚  â”‚
â”‚  â”‚  (30min)    â”‚  â”‚ (Bidirect)  â”‚  â”‚  (rm -rf, format)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Claude Code CLI (OS Process)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  --session-id <UUID> --output-format stream-json          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚    CLI      â”‚  â”‚  In-Memory   â”‚  â”‚  Skills & MCP    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Engine    â”‚â—„â”€â”¤   Context    â”‚  â”‚    Registry      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

**ä½ç½®**ï¼š`ai/agent/cc_runner/`

| ç»„ä»¶ | æ–‡ä»¶ | æè¿° |
|:-----|:-----|:-----|
| **SessionManager** | `session_manager.go` | ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆ30min ç©ºé—²è¶…æ—¶ï¼‰ |
| **Streamer** | `streamer.go` | åŒå‘æµå¼è½¬æ¢ï¼ˆHTTP â‡„ CLI JSON Streamï¼‰ |
| **DangerDetector** | `danger_detector.go` | å±é™©å‘½ä»¤æ£€æµ‹ï¼ˆrm -rf, mkfs, etc.ï¼‰ |
| **SessionStats** | `session_stats.go` | å®æ—¶æŒ‡æ ‡æ”¶é›†ï¼ˆthinking, tokens, toolsï¼‰ |

### ä¼šè¯æ˜ å°„æ¨¡å‹

```
å‰ç«¯ ConversationID (æ•°æ®åº“ ID)
         â”‚
         â–¼ UUID v5 å®šå‘å“ˆå¸Œ
         â”‚
    SessionID (UUID)
         â”‚
         â–¼
Claude Code CLI Process
```

- **ç¡®å®šæ€§æ˜ å°„**ï¼š`UUID v5(Namespace, "divinesense:conversation:{ID}")`
- **çŠ¶æ€æ¢å¤**ï¼šCLI è‡ªåŠ¨ä» `~/.claude/sessions/` æ¢å¤ä¸Šä¸‹æ–‡
- **ç‰©ç†éš”ç¦»**ï¼šæ¯ä¸ªä¼šè¯ç‹¬ç«‹ OS è¿›ç¨‹ï¼Œäº’ä¸å¹²æ‰°

### äº¤äº’åè®®

**Client â†’ Server (WebSocket Events)**:

| Event | Payload | æè¿° |
|:-----|:--------|:-----|
| `session.start` | `{config}` | å¯åŠ¨æ–°ä¼šè¯ |
| `input.send` | `{text}` | å‘é€ç”¨æˆ·è¾“å…¥ |
| `session.stop` | `{}` | å¼ºåˆ¶åœæ­¢ |

**Server â†’ Client (Stream Events)**:

| Event | Meta | æè¿° |
|:-----|:-----|:-----|
| `thinking` | â€” | æ€è€ƒè¿‡ç¨‹ï¼ˆå¢é‡ï¼‰ |
| `tool_use` | `{name, input, id}` | å·¥å…·è°ƒç”¨ |
| `tool_result` | `{is_error}` | å·¥å…·ç»“æœ |
| `answer` | â€” | æœ€ç»ˆå›ç­”ï¼ˆå¢é‡ï¼‰ |
| `error` | â€” | ç³»ç»Ÿçº§é”™è¯¯ |

### å®‰å…¨ä¸é£æ§

- **Permission Bypass**: ä½¿ç”¨ `--permission-mode bypassPermissions`
- **å‰ç«¯ç¡®è®¤**: å¯¹å…³é”®æ“ä½œï¼ˆå¦‚ `rm -rf`ï¼‰è¿›è¡Œ Regex æ‹¦æˆª
- **Git æ¢å¤**: å¼ºåˆ¶åœ¨ Git ä»“åº“å†…è¿è¡Œï¼Œç¡®ä¿å¯å›æ»š
- **è¶…æ—¶ä¿æŠ¤**: 30 åˆ†é’Ÿç©ºé—²è‡ªåŠ¨ Kill

### API ç«¯ç‚¹

| RPC | æ–¹æ³• | æè¿° |
|:-----|:-----|:-----|
| `ChatService` | `StreamChat` | æµå¼èŠå¤©ï¼ˆSSEï¼‰ |
| `ChatService` | `StopChat` | åœæ­¢ä¼šè¯ï¼ˆæ‰€æœ‰æƒéªŒè¯ï¼‰ |

---

## AI æœåŠ¡ (`ai/`)

### æœåŠ¡æ¦‚è§ˆ

| æœåŠ¡    | åŒ…         | æè¿°                            |
| :------ | :--------- | :------------------------------ |
| Memory  | `memory/`  | æƒ…æ™¯è®°å¿† & ç”¨æˆ·åå¥½             |
| Session | `session/` | å¯¹è¯æŒä¹…åŒ–ï¼ˆ30 å¤©ä¿ç•™ï¼‰         |
| Router  | `router/`  | ä¸‰å±‚æ„å›¾åˆ†ç±» & è·¯ç”±             |
| Cache   | `cache/`   | å¸¦ TTL çš„ LRU ç¼“å­˜ï¼ˆæŸ¥è¯¢ç»“æœï¼‰  |
| Metrics | `metrics/` | ä»£ç† & å·¥å…·æ€§èƒ½è¿½è¸ªï¼ˆA/B æµ‹è¯•ï¼‰ |
| Vector  | `vector/`  | å¤šæä¾›å•† Embedding æœåŠ¡         |

### ä¼šè¯æœåŠ¡ (`ai/session/`)

ä¸º AI ä»£ç†æä¾›å¯¹è¯æŒä¹…åŒ–ï¼š

**ç»„ä»¶**ï¼š
- `store.go`ï¼šPostgreSQL æŒä¹…åŒ– + ç›´å†™ç¼“å­˜ï¼ˆ30min TTLï¼‰
- `recovery.go`ï¼šä¼šè¯æ¢å¤å·¥ä½œæµ + æ»‘åŠ¨çª—å£ï¼ˆæœ€å¤š 20 æ¡æ¶ˆæ¯ï¼‰
- `cleanup.go`ï¼šè¿‡æœŸä¼šè¯æ¸…ç†åå°ä»»åŠ¡ï¼ˆé»˜è®¤ï¼š30 å¤©ï¼‰

**æ•°æ®åº“**ï¼š`conversation_context` è¡¨ï¼ˆJSONB å­˜å‚¨ï¼‰

### ä¸Šä¸‹æ–‡æ„å»ºå™¨ (`ai/context/`)

ç»„è£… LLM ä¸Šä¸‹æ–‡ï¼Œæ™ºèƒ½åˆ†é… token é¢„ç®—ï¼š

```
Token é¢„ç®—åˆ†é…ï¼ˆå¸¦æ£€ç´¢ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ System Prompt      â”‚ 500 tokensï¼ˆå›ºå®šï¼‰ â”‚
â”‚ User Preferences   â”‚ 10%                â”‚
â”‚ Short-term Memory  â”‚ 40%                â”‚
â”‚ Long-term Memory   â”‚ 15%                â”‚
â”‚ Retrieval Results  â”‚ 45%                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ£€ç´¢ç³»ç»Ÿ (`ai/core/retrieval/`)

### AdaptiveRetriever

æ··åˆ BM25 + å‘é‡æœç´¢ + æ™ºèƒ½èåˆï¼š

| ç­–ç•¥             | æè¿°                            |
| :--------------- | :------------------------------ |
| `BM25Only`       | ä»…å…³é”®è¯æœç´¢ï¼ˆå¿«ï¼Œä½è´¨é‡ï¼‰      |
| `SemanticOnly`   | ä»…å‘é‡æœç´¢ï¼ˆæ…¢ï¼Œè¯­ä¹‰ï¼‰          |
| `HybridStandard` | BM25 + å‘é‡ + RRF èåˆï¼ˆå¹³è¡¡ï¼‰  |
| `FullPipeline`   | æ··åˆ + é‡æ’å™¨ï¼ˆæœ€é«˜è´¨é‡ï¼Œæœ€æ…¢ï¼‰ |

### RRF èåˆ

ç”¨äºåˆå¹¶ BM25 å’Œå‘é‡ç»“æœçš„å€’æ•°æ’åèåˆï¼š
```
score = Î£ weight_i / (60 + rank_i)
```

### é‡æ’å™¨

BAAI/bge-reranker-v2-m3 ç”¨äºç»“æœç²¾ç‚¼ï¼ˆå¯é€šè¿‡ç­–ç•¥é…ç½®ï¼‰ã€‚

---

## å‰ç«¯æ¶æ„ (`web/src/`)

### é¡µé¢ç»„ä»¶

| è·¯å¾„           | ç»„ä»¶              | å¸ƒå±€           | ç”¨é€”                     |
| :------------- | :---------------- | :------------- | :----------------------- |
| `/`            | `Home.tsx`        | MainLayout     | ä¸»æ—¶é—´çº¿ + ç¬”è®°ç¼–è¾‘å™¨    |
| `/explore`     | `Explore.tsx`     | MainLayout     | æœç´¢å’Œæ¢ç´¢å†…å®¹           |
| `/archived`    | `Archived.tsx`    | MainLayout     | å·²å½’æ¡£ç¬”è®°               |
| `/chat`        | `AIChat.tsx`      | AIChatLayout   | AI èŠå¤©ç•Œé¢ + è‡ªåŠ¨è·¯ç”±   |
| `/schedule`    | `Schedule.tsx`    | ScheduleLayout | æ—¥å†è§†å›¾ï¼ˆFullCalendarï¼‰ |
| `/review`      | `Review.tsx`      | MainLayout     | æ¯æ—¥å›é¡¾                 |
| `/setting`     | `Setting.tsx`     | MainLayout     | ç”¨æˆ·è®¾ç½®                 |
| `/u/:username` | `UserProfile.tsx` | MainLayout     | å…¬å¼€ç”¨æˆ·èµ„æ–™             |

### å¸ƒå±€å±‚çº§

```
RootLayoutï¼ˆå…¨å±€å¯¼èˆª + è®¤è¯ï¼‰
    â”‚
    â”œâ”€â”€ MainLayoutï¼ˆå¯æŠ˜å ä¾§è¾¹æ ï¼šMemoExplorerï¼‰
    â”‚   â””â”€â”€ /, /explore, /archived, /u/:username
    â”‚
    â”œâ”€â”€ AIChatLayoutï¼ˆå›ºå®šä¾§è¾¹æ ï¼šAIChatSidebarï¼‰
    â”‚   â””â”€â”€ /chat
    â”‚
    â””â”€â”€ ScheduleLayoutï¼ˆå›ºå®šä¾§è¾¹æ ï¼šScheduleCalendarï¼‰
        â””â”€â”€ /schedule
```

### é™æ€èµ„æºä¼˜åŒ– (Static Asset Optimization)

ä¸ºäº†åœ¨å•äºŒè¿›åˆ¶åˆ†å‘ä¸­ä¿æŒæè‡´çš„ Web æ€§èƒ½ï¼Œ`FrontendService` å®ç°äº†ä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼š

| ç­–ç•¥                 | å®ç°ç»†èŠ‚                                 | ç›®æ ‡                                      |
| :------------------- | :--------------------------------------- | :---------------------------------------- |
| **Gzip å‹ç¼©**        | `middleware.Gzip(Level: 5)`              | å‡å°‘äºŒè¿›åˆ¶åµŒå…¥äº§ç‰©çš„ä¼ è¾“å¤§å°ï¼ˆçº¦ 70%ï¼‰    |
| **å¼ºç¼“å­˜ (Vite)**    | `/assets/*` åŒ¹é… `immutable, max-age=1y` | é’ˆå¯¹ Vite å“ˆå¸Œèµ„æºå®ç°â€œé›¶è¯·æ±‚â€é‡å¤è®¿é—®    |
| **å…¥å£é˜²ç¼“å­˜**       | `index.html` å¼ºåˆ¶ `no-cache, no-store`   | ç¡®ä¿ç‰ˆæœ¬è¿­ä»£åç”¨æˆ·ç«‹åˆ»è·å–æœ€æ–° JS å¼•ç”¨    |
| **Geek å·¥ä½œåŒº Host** | `/file/geek/:userID/*` å®æ—¶ Host         | æå®¢æ¨¡å¼äº§ç”Ÿçš„ç½‘é¡µ/äº§ç‰©å¯åœ¨æµè§ˆå™¨å®æ—¶é¢„è§ˆ |
| **å®‰å…¨åŠ å›º**         | `X-Content-Type-Options: nosniff`        | å¢å¼ºé’ˆå¯¹åµŒå…¥å¼é™æ€èµ„æºçš„å®‰å…¨é˜²å¾¡          |

---

## æ•°æ®æµ

### AI èŠå¤©æµç¨‹

```
å‰ç«¯ï¼ˆAIChat.tsxï¼‰
    â”‚ï¼ˆWebSocket / SSEï¼‰
    â†“
åç«¯ï¼ˆai_service_chat.goï¼‰
    â”‚
    â†“ GeekMode?
    â”‚   Yes â†’ GeekParrotï¼ˆClaude Code CLIï¼Œé›¶ LLMï¼‰
    â”‚   No  â†“ ChatRouter.Route()
    â”‚       â†’ è§„åˆ™åŒ¹é…ï¼ˆ0msï¼‰
    â”‚       â†’ å†å²æ„ŸçŸ¥ï¼ˆ~10msï¼‰
    â”‚       â†’ LLM é™çº§ï¼ˆ~400msï¼‰
    â†“
ä»£ç†æ‰§è¡Œ
    â”‚   â†’ GeekParrotï¼ˆClaude Code CLIï¼‰
    â”‚   â†’ MemoParrotï¼ˆmemo_search å·¥å…·ï¼‰
    â”‚   â†’ ScheduleParrotV2ï¼ˆscheduler å·¥å…·ï¼‰
    â”‚   â†’ AmazingParrotï¼ˆå¹¶å‘å·¥å…·ï¼‰
    â†“
å“åº”æµå¼ä¼ è¾“
    â”‚   â†’ äº‹ä»¶ç±»å‹ï¼šthinkingã€tool_useã€tool_resultã€answer
    â†“
å‰ç«¯ UI æ›´æ–°
```

---

## AI æ•°æ®åº“æ¶æ„ï¼ˆPostgreSQLï¼‰

### æ ¸å¿ƒè¡¨

| è¡¨å                   | ç”¨é€”                                      |
| :--------------------- | :---------------------------------------- |
| `memo_embedding`       | å‘é‡åµŒå…¥ï¼ˆ1024 ç»´ï¼‰ç”¨äºè¯­ä¹‰æœç´¢           |
| `conversation_context` | ä¼šè¯æŒä¹…åŒ–ï¼ˆ30 å¤©ä¿ç•™ï¼‰                   |
| `episodic_memory`      | é•¿æœŸç”¨æˆ·è®°å¿†å’Œå­¦ä¹                         |
| `user_preferences`     | ç”¨æˆ·æ²Ÿé€šåå¥½                              |
| `agent_metrics`        | A/B æµ‹è¯•æŒ‡æ ‡ï¼ˆprompt ç‰ˆæœ¬ã€å»¶è¿Ÿã€æˆåŠŸç‡ï¼‰ |

---

## ç¯å¢ƒé…ç½®

### å…³é”®å˜é‡

```bash
# æ•°æ®åº“
DIVINESENSE_DRIVER=postgres
DIVINESENSE_DSN=postgres://divinesense:divinesense@localhost:25432/divinesense?sslmode=disable

# AI
DIVINESENSE_AI_ENABLED=true
DIVINESENSE_AI_EMBEDDING_PROVIDER=siliconflow
DIVINESENSE_AI_EMBEDDING_MODEL=BAAI/bge-m3
DIVINESENSE_AI_RERANK_MODEL=BAAI/bge-reranker-v2-m3
DIVINESENSE_AI_LLM_PROVIDER=deepseek
DIVINESENSE_AI_LLM_MODEL=deepseek-chat
DIVINESENSE_AI_DEEPSEEK_API_KEY=your_key
DIVINESENSE_AI_SILICONFLOW_API_KEY=your_key
DIVINESENSE_AI_OPENAI_BASE_URL=https://api.siliconflow.cn/v1
```
