# æ¶æ„æ–‡æ¡£

> **ä¿é²œçŠ¶æ€**: âœ… å·²æ›´æ–° (2026-02-10) | **æœ€åæ£€æŸ¥**: v0.94.0 (æ™ºèƒ½è·¯ç”± + æ€§èƒ½ä¼˜åŒ–)

## é¡¹ç›®æ¦‚è¿°

DivineSense (ç¥è¯†) æ˜¯ä¸€æ¬¾éšç§ä¼˜å…ˆã€è½»é‡çº§çš„ç¬”è®°æœåŠ¡ï¼Œé€šè¿‡ AI é©±åŠ¨çš„ã€Œé¹¦é¹‰ã€ä»£ç†å¢å¼ºç”¨æˆ·ä½“éªŒã€‚
- **æ ¸å¿ƒæ¶æ„**ï¼šGo åç«¯ (Echo/Connect RPC) + React å‰ç«¯ (Vite/Tailwind) â€”â€” **å•äºŒè¿›åˆ¶åˆ†å‘**
- **æ•°æ®å­˜å‚¨**ï¼šPostgreSQLï¼ˆç”Ÿäº§ç¯å¢ƒï¼Œå®Œæ•´ AI æ”¯æŒï¼‰ï¼ŒSQLiteï¼ˆä»…å¼€å‘ç¯å¢ƒï¼Œ**æ—  AI**ï¼‰è¯¦è§ [#9](https://github.com/hrygo/divinesense/issues/9)
- **æ ¸å¿ƒç‰¹æ€§**ï¼šå¤šä»£ç† AI ç³»ç»Ÿã€è¯­ä¹‰æœç´¢ã€æ—¥ç¨‹åŠ©ç†ã€è‡ªæ‰˜ç®¡æ— é¥æµ‹
- **ç«¯å£**ï¼šåç«¯ 28081ï¼Œå‰ç«¯ 25173ï¼ŒPostgreSQL 25432ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

## æŠ€æœ¯æ ˆ

| é¢†åŸŸ   | æŠ€æœ¯é€‰å‹                                                                                             |
| :----- | :--------------------------------------------------------------------------------------------------- |
| åç«¯   | Go 1.25, Echo, Connect RPC, pgvector                                                                 |
| å‰ç«¯   | React 18, Vite 7, TypeScript, Tailwind CSS 4, Radix UI, TanStack Query                               |
| æ•°æ®åº“ | PostgreSQL 16+ï¼ˆç”Ÿäº§ï¼‰ï¼ŒSQLiteï¼ˆå¼€å‘ï¼Œ**æ—  AI**ï¼‰[#9](https://github.com/hrygo/divinesense/issues/9) |
| AI     | **DeepSeek**ï¼ˆå¯¹è¯ LLMï¼‰ï¼Œ**SiliconFlow**ï¼ˆEmbeddingã€æ„å›¾åˆ†ç±»ã€Rerankerï¼‰                              |

---

## é¡¹ç›®æ¶æ„

### ç›®å½•ç»“æ„

```
divinesense/
â”œâ”€â”€ cmd/divinesense/     # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ internal/             # å†…éƒ¨å·¥å…·åº“
â”‚   â”œâ”€â”€ base/            # åŸºç¡€ç»„ä»¶
â”‚   â”œâ”€â”€ profile/         # é…ç½®æ–‡ä»¶å¤„ç†
â”‚   â”œâ”€â”€ util/            # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ version/         # ç‰ˆæœ¬ä¿¡æ¯
â”œâ”€â”€ server/              # HTTP/gRPC æœåŠ¡å™¨ & è·¯ç”±
â”‚   â”œâ”€â”€ auth/            # è®¤è¯æˆæƒ
â”‚   â”œâ”€â”€ internal/        # å†…éƒ¨æœåŠ¡
â”‚   â”œâ”€â”€ middleware/      # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ queryengine/     # æŸ¥è¯¢è·¯ç”± & æ„å›¾æ£€æµ‹
â”‚   â”œâ”€â”€ router/          # API å¤„ç†å™¨ï¼ˆv1 å®ç°ï¼‰
â”‚   â”œâ”€â”€ runner/          # åå°ä»»åŠ¡è¿è¡Œå™¨
â”‚   â”œâ”€â”€ scheduler/       # æ—¥ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ service/         # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ stats/           # ç»Ÿè®¡æœåŠ¡
â”‚   â””â”€â”€ timezone/        # æ—¶åŒºå¤„ç†
â”œâ”€â”€ ai/                  # ğŸ”´ AI æ ¸å¿ƒæ¨¡å—ï¼ˆä¸€çº§æ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ agent/           #   Parrot ä»£ç†ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ cc_runner/  #     CC Runner å¼‚æ­¥æ¶æ„ï¼ˆGeek Mode æ ¸å¿ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ tools/      #     ä»£ç†å·¥å…·å®ç°
â”‚   â”‚   â”œâ”€â”€ universal/  #     UniversalParrot é…ç½®é©±åŠ¨ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ registry/   #     æ³¨å†Œè¡¨ç³»ç»Ÿï¼ˆå·¥å…·/æç¤ºè¯åŠ¨æ€å‘ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ cache.go    #     ä¼šè¯ç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ chat_router.go #   èŠå¤©è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ context.go  #     ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ evolution_parrot.go # è¿›åŒ–æ¨¡å¼ï¼ˆä»£ç å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ geek_parrot.go     # æå®¢æ¨¡å¼ï¼ˆä»£ç å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ session_manager.go # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ aitime/         #   AI æ—¶é—´è§£æ
â”‚   â”œâ”€â”€ cache/           #   LRU ç¼“å­˜å±‚
â”‚   â”œâ”€â”€ context/         #   ä¸Šä¸‹æ–‡æ„å»º
â”‚   â”œâ”€â”€ core/            #   AI åŸºç¡€è®¾æ–½
â”‚   â”‚   â”œâ”€â”€ embedding/  #     åµŒå…¥æœåŠ¡ï¼ˆä» server/ai/ è¿ç§»ï¼‰
â”‚   â”‚   â”œâ”€â”€ retrieval/  #     æ£€ç´¢ç³»ç»Ÿï¼ˆä» server/retrieval/ è¿ç§»ï¼‰
â”‚   â”‚   â”œâ”€â”€ reranker/   #     é‡æ’æœåŠ¡
â”‚   â”‚   â””â”€â”€ llm/        #     LLM å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ duplicate/       #   é‡å¤æ£€æµ‹
â”‚   â”œâ”€â”€ filter/         #   è¿‡æ»¤å™¨ç³»ç»Ÿï¼ˆæ•æ„Ÿä¿¡æ¯è¿‡æ»¤ï¼Œ<1ms å“åº”ï¼‰
â”‚   â”œâ”€â”€ genui/          #   ç”Ÿæˆå¼ UI
â”‚   â”œâ”€â”€ graph/          #   çŸ¥è¯†å›¾è°±
â”‚   â”œâ”€â”€ habit/          #   ä¹ æƒ¯å­¦ä¹ 
â”‚   â”œâ”€â”€ memory/         #   æƒ…æ™¯è®°å¿†
â”‚   â”œâ”€â”€ metrics/        #   ä»£ç†æ€§èƒ½è¿½è¸ª
â”‚   â”œâ”€â”€ prediction/     #   é¢„æµ‹å¼•æ“
â”‚   â”œâ”€â”€ preload/        #   é¢„åŠ è½½ç³»ç»Ÿï¼ˆé¢„æµ‹æ€§ç¼“å­˜ä¼˜åŒ–ï¼‰
â”‚   â”œâ”€â”€ rag/            #   RAG é«˜çº§åŠŸèƒ½
â”‚   â”œâ”€â”€ reminder/       #   æé†’ç³»ç»Ÿ
â”‚   â”œâ”€â”€ review/         #   å®¡æŸ¥æœåŠ¡
â”‚   â”œâ”€â”€ router/         #   å››å±‚æ„å›¾è·¯ç”±ï¼ˆå«æ™ºèƒ½è·¯ç”±åé¦ˆï¼‰
â”‚   â”œâ”€â”€ schedule/       #   æ—¥ç¨‹ AI
â”‚   â”œâ”€â”€ session/        #   å¯¹è¯æŒä¹…åŒ–
â”‚   â”œâ”€â”€ stats/          #   ç»Ÿè®¡æœåŠ¡ï¼ˆå‘Šè­¦æŒä¹…åŒ–ï¼‰
â”‚   â”œâ”€â”€ tags/           #   æ ‡ç­¾å»ºè®®
â”‚   â”œâ”€â”€ timeout/        #   è¶…æ—¶å¤„ç†
â”‚   â”œâ”€â”€ tracing/        #   é“¾è·¯è¿½è¸ªï¼ˆåˆ†å¸ƒå¼è¿½è¸ªï¼‰
â”‚   â””â”€â”€ config.go       #   AI é…ç½®
â”œâ”€â”€ plugin/              # å…¶ä»–å¯é€‰æ’ä»¶ï¼ˆé AIï¼‰
â”‚   â”œâ”€â”€ chat_apps/      # èŠå¤©åº”ç”¨æ¥å…¥ï¼ˆTelegram/é’‰é’‰/WhatsAppï¼‰
â”‚   â”œâ”€â”€ cron/           # å®šæ—¶ä»»åŠ¡
â”‚   â”œâ”€â”€ email/          # é‚®ä»¶æœåŠ¡
â”‚   â”œâ”€â”€ filter/         # è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ httpgetter/     # HTTP è·å–å™¨
â”‚   â”œâ”€â”€ idp/            # èº«ä»½æä¾›å•†
â”‚   â”œâ”€â”€ markdown/       # Markdown æ’ä»¶
â”‚   â”œâ”€â”€ ocr/            # OCR æ’ä»¶
â”‚   â”œâ”€â”€ scheduler/      # ä»»åŠ¡è°ƒåº¦
â”‚   â”œâ”€â”€ storage/        # å­˜å‚¨é€‚é…å™¨ï¼ˆS3ã€æœ¬åœ°ï¼‰
â”‚   â”œâ”€â”€ textextract/    # æ–‡æœ¬æå–
â”‚   â”œâ”€â”€ webhook/        # Webhook æ’ä»¶
â”‚   â””â”€â”€ ...
â”œâ”€â”€ store/               # æ•°æ®å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ cache/          # ç¼“å­˜å­˜å‚¨
â”‚   â”œâ”€â”€ db/             # æ•°æ®åº“å®ç°
â”‚   â”œâ”€â”€ migration/      # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ seed/           # ç§å­æ•°æ®
â”œâ”€â”€ proto/               # Protobuf å®šä¹‰ï¼ˆAPI å¥‘çº¦ï¼‰
â”‚   â”œâ”€â”€ api/v1/         # API æœåŠ¡å®šä¹‰
â”‚   â”œâ”€â”€ store/          # Store æœåŠ¡å®šä¹‰
â”‚   â””â”€â”€ third_party/    # ç¬¬ä¸‰æ–¹ä¾èµ–
â”œâ”€â”€ web/                 # React å‰ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ pages/      # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ layouts/    # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ components/ # UI ç»„ä»¶ï¼ˆ49+ AI èŠå¤©ç»„ä»¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ locales/    # i18n ç¿»è¯‘ï¼ˆenã€zh-Hansï¼‰
â”‚   â”‚   â””â”€â”€ hooks/      # React hooks
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ docs/                # æ–‡æ¡£
â”œâ”€â”€ scripts/             # å¼€å‘å’Œæ„å»ºè„šæœ¬
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ parrots/        # é¹¦é¹‰ä»£ç†é…ç½®ï¼ˆYAMLï¼‰
â””â”€â”€ docker/              # Docker é…ç½®
```

### æ ¸å¿ƒç»„ä»¶

1. **å•äºŒè¿›åˆ¶æ„å»º (Single Binary)**ï¼š
   - **å‰ç«¯é›†æˆ**ï¼šä½¿ç”¨ `go:embed` å°† `web/dist` æ‰“åŒ…è¿› Go äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
   - **æ•°æ®åº“è¿ç§»**ï¼šSQL è„šæœ¬åŒæ ·é€šè¿‡ `embed` åµŒå…¥ï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ `store/migrator.go` è¿›è¡Œæ¶æ„å‡çº§ã€‚
   - **ä¼˜åŠ¿**ï¼šåˆ†å‘æ— éœ€ Node.js/Nginxï¼Œç›´æ¥è¿è¡Œå…¨æ ˆæœåŠ¡ã€‚

2. **æœåŠ¡å™¨åˆå§‹åŒ–**ï¼šProfile â†’ DB â†’ Store â†’ Server
   - ä½¿ç”¨ Echo æ¡†æ¶ + Connect RPCï¼ˆgRPC/HTTP è½¬ç ï¼‰
   - é™æ€èµ„æºæœåŠ¡æ”¯æŒ Gzip å‹ç¼©ã€SPA è·¯ç”±å›é€€åŠå¼ºç¼“å­˜ä¼˜åŒ–ã€‚

2. **AI æ ¸å¿ƒæ¨¡å—** (`ai/`)ï¼š
   - **å¯¹è¯ LLM**ï¼šDeepSeek (`deepseek-chat`)
   - **Embedding**ï¼šSiliconFlow (`BAAI/bge-m3`, 1024 ç»´)
   - **æ„å›¾åˆ†ç±»**ï¼šSiliconFlow (`Qwen/Qwen2.5-7B-Instruct`)
   - **Reranker**ï¼šSiliconFlow (`BAAI/bge-reranker-v2-m3`)
   - æ‰€æœ‰ AI åŠŸèƒ½å¯é€‰ï¼ˆç”± `DIVINESENSE_AI_ENABLED` æ§åˆ¶ï¼‰
   - åŒ…å«ä» `server/ai/` å’Œ `server/retrieval/` è¿ç§»çš„åµŒå…¥å’Œæ£€ç´¢åŠŸèƒ½

3. **æ’ä»¶ç³»ç»Ÿ** (`plugin/`)ï¼š
   - ä¸å†åŒ…å« AI åŠŸèƒ½ï¼ˆå·²æå‡ä¸ºä¸€çº§æ¨¡å—ï¼‰
   - åŒ…å«ï¼šè°ƒåº¦å™¨ã€å­˜å‚¨é€‚é…å™¨ã€èº«ä»½æä¾›å•†ã€Markdownã€OCRã€Webhookã€èŠå¤©åº”ç”¨æ¥å…¥ï¼ˆChat Appsï¼‰ç­‰

### èŠå¤©åº”ç”¨é›†æˆ (Chat Apps)

> **ä¿é²œçŠ¶æ€**: âœ… å·²éªŒè¯ (2026-02-03) | **æœ€åæ£€æŸ¥**: v0.91.0

**æ¶æ„æ¦‚è§ˆ**ï¼šå°† DivineSense AI è¿æ¥åˆ° Telegramã€WhatsAppã€é’‰é’‰ç­‰èŠå¤©å¹³å°ï¼Œå®ç°å¤šæ¸ é“æ™ºèƒ½åŠ©æ‰‹æœåŠ¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chat Apps Gateway                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Telegram   â”‚  â”‚   WhatsApp   â”‚  â”‚         DingTalk             â”‚ â”‚
â”‚  â”‚   Channel    â”‚  â”‚   Bridge     â”‚  â”‚         Channel              â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ BotToken     â”‚  â”‚ Baileys      â”‚  â”‚ HMAC-SHA256 + Timestamp      â”‚ â”‚
â”‚  â”‚ Webhook      â”‚  â”‚ HTTP API     â”‚  â”‚ Webhook                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                       â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ChatChannel Router  â”‚
                  â”‚  (user verification) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  AI Agent Router     â”‚
                  â”‚  (AUTO: memo/schedule)â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Parrot Agents      â”‚
                  â”‚  (ç°ç°/æ—¶å·§/æŠ˜è¡·)     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®å½•ç»“æ„**ï¼š
```
plugin/chat_apps/
â”œâ”€â”€ channels/
â”‚   â”œâ”€â”€ base.go                    # ChatChannel æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ router.go                  # é€šé“è·¯ç”±å™¨ï¼ˆç”¨æˆ·éªŒè¯ï¼‰
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â”œâ”€â”€ telegram.go            # Telegram Bot å®ç°
â”‚   â”‚   â””â”€â”€ webhook.go             # Webhook å¤„ç†
â”‚   â”œâ”€â”€ whatsapp/
â”‚   â”‚   â””â”€â”€ bridge.go              # Baileys æ¡¥æ¥å®¢æˆ·ç«¯
â”‚   â””â”€â”€ dingtalk/
â”‚       â”œâ”€â”€ dingtalk.go            # é’‰é’‰æœºå™¨äººå®ç°
â”‚       â””â”€â”€ crypto.go              # ç­¾åéªŒè¯
â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ db.go                      # æ•°æ®åº“æ“ä½œ
â”‚   â””â”€â”€ crypto.go                  # Token åŠ å¯†ï¼ˆAES-256-GCMï¼‰
â”œâ”€â”€ metrics/
â”‚   â””â”€â”€ metrics.go                 # Webhook æŒ‡æ ‡æ”¶é›†
â””â”€â”€ types.go                       # é€šç”¨ç±»å‹å®šä¹‰
```

**å®‰å…¨æœºåˆ¶**ï¼š
- Token åŠ å¯†ï¼šAES-256-GCMï¼Œ32 å­—èŠ‚å¯†é’¥
- è¾“å…¥éªŒè¯ï¼šå¹³å°ç™½åå• + é•¿åº¦é™åˆ¶
- Webhook ç­¾åï¼šHMAC-SHA256 + æ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿçª—å£ï¼Œé˜²é‡æ”¾ï¼‰
- å¹¶å‘å®‰å…¨ï¼šå•ä¸€ Mutex é˜²æ­¢ Token ç¼“å­˜ç«æ€

**æ•°æ®åº“è¡¨**ï¼š`chat_app_credential`

| å­—æ®µ | ç±»å‹ | æè¿° |
|:-----|:-----|:-----|
| `id` | SERIAL | ä¸»é”® |
| `user_id` | INTEGER | æ‰€å±ç”¨æˆ·ï¼ˆå¤–é”®ï¼‰ |
| `platform` | TEXT | å¹³å°åç§°ï¼ˆtelegram/whatsapp/dingtalkï¼‰ |
| `platform_user_id` | TEXT | å¹³å°ç”¨æˆ· ID |
| `access_token` | TEXT | åŠ å¯†å­˜å‚¨çš„è®¿é—®ä»¤ç‰Œ |
| `app_secret` | TEXT | åŠ å¯†å­˜å‚¨çš„åº”ç”¨å¯†é’¥ï¼ˆé’‰é’‰ï¼‰ |
| `webhook_url` | TEXT | Webhook URL |
| `enabled` | BOOLEAN | å¯ç”¨çŠ¶æ€ |

**è¯¦ç»†æ–‡æ¡£**ï¼š
- [ç”¨æˆ·æŒ‡å—](../user-guides/CHAT_APPS.md)
- [å¼€å‘è€…æŒ‡å—](../guides/CHAT_APPS.md)
- [æŠ€æœ¯è§„æ ¼](../specs/chat-apps-integration.md)

4. **åå°è¿è¡Œå™¨** (`server/runner/`):
   - å¼‚æ­¥ç”Ÿæˆç¬”è®° Embedding
   - AI æ“ä½œä»»åŠ¡é˜Ÿåˆ—
   - AI å¯ç”¨æ—¶è‡ªåŠ¨è¿è¡Œ

5. **å­˜å‚¨å±‚**ï¼š
   - æ¥å£å®šä¹‰åœ¨ `store/`
   - é©±åŠ¨ç‰¹å®šå®ç°åœ¨ `store/db/{postgres,sqlite}/`
   - è¿ç§»ç³»ç»Ÿåœ¨ `store/migration/`

6. **æ™ºèƒ½æŸ¥è¯¢å¼•æ“** (`server/queryengine/`):
   - è‡ªé€‚åº”æ£€ç´¢ï¼ˆBM25 + å‘é‡æœç´¢ + é€‰æ‹©æ€§é‡æ’ï¼‰
   - æ™ºèƒ½æŸ¥è¯¢è·¯ç”±ï¼ˆæ£€æµ‹æ—¥ç¨‹ vs. æœç´¢æŸ¥è¯¢ï¼‰
   - è‡ªç„¶è¯­è¨€æ—¥æœŸè§£æ
   - å¸¦å†²çªæ£€æµ‹çš„æ—¥ç¨‹åŠ©ç†

### API æœåŠ¡

> **ä¿é²œçŠ¶æ€**: âœ… å·²éªŒè¯ (2026-02-03) | **è¦†ç›–èŒƒå›´**: `proto/api/v1/*.proto` | **æœ€åæ£€æŸ¥**: v0.91.0

| æœåŠ¡ | Proto æ–‡ä»¶ | æè¿° |
|:-----|:-----------|:-----|
| **ActivityService** | `activity_service.proto` | ç”¨æˆ·æ´»åŠ¨è®°å½• |
| **AttachmentService** | `attachment_service.proto` | é™„ä»¶ç®¡ç† |
| **AuthService** | `auth_service.proto` | è®¤è¯æˆæƒ |
| **AIService** | `ai_service.proto` | AI èŠå¤©ã€åµŒå…¥ã€æ£€ç´¢ |
| â””â”€â”€ *Block Model* | `ai_block.proto` | Unified Block Model æ”¯æŒ |
| â””â”€â”€ *Stats* | `ai_stats.proto` | AI ç»Ÿè®¡ä¸å‘Šè­¦ |
| **ChatAppService** | `chat_app_service.proto` | èŠå¤©åº”ç”¨æ¥å…¥ï¼ˆTelegram/é’‰é’‰/WhatsAppï¼‰ |
| **IdpService** | `idp_service.proto` | èº«ä»½æä¾›å•†é›†æˆ |
| **InstanceService** | `instance_service.proto` | å®ä¾‹é…ç½® |
| **MemoService** | `memo_service.proto` | ç¬”è®° CRUD |
| **ScheduleService** | `schedule_service.proto` | æ—¥ç¨‹ç®¡ç† |
| **ShortcutService** | `shortcut_service.proto` | å¿«æ·æ–¹å¼ |
| **UserService** | `user_service.proto` | ç”¨æˆ·ç®¡ç† |
| **Common** | `common.proto` | é€šç”¨ç±»å‹å®šä¹‰ |

---

## ğŸ”’ Git Hooks å·¥ä½œæµ

> **ä¿é²œçŠ¶æ€**: âœ… 2026-02-07 | **æ™ºèƒ½æ£€æŸ¥ç­–ç•¥**

DivineSense ä½¿ç”¨ **æ™ºèƒ½ pre-commit + pre-push** hooksï¼Œæ ¹æ®ä¿®æ”¹å†…å®¹è‡ªåŠ¨é€‰æ‹©æ£€æŸ¥é¡¹ï¼š

### æ£€æŸ¥ç­–ç•¥çŸ©é˜µ

| ä¿®æ”¹ç±»å‹ | pre-commit (~2-10s) | pre-push (~10-60s) |
|:---------|:---------------------|:-------------------|
| **ä»…åç«¯** | `go fmt` + `go vet` | `go mod tidy` + `golangci-lint` + `go test` |
| **ä»…å‰ç«¯** | `pnpm lint:fix` | `pnpm lint` + `pnpm build` |
| **ä»…æ–‡æ¡£** | è·³è¿‡ | è·³è¿‡ |
| **æ··åˆ** | æŒ‰éœ€æ£€æŸ¥ | æŒ‰éœ€æ£€æŸ¥ |

### æ–‡ä»¶åˆ†ç±»è§„åˆ™

| åˆ†ç±» | åŒ¹é…æ¨¡å¼ |
|:-----|:---------|
| åç«¯ | `*.go`, `go.mod`, `go.sum` |
| å‰ç«¯ | `web/**`, `server/router/frontend/**` |
| æ–‡æ¡£ | `docs/**`, `*.md` (ä¸åŒ¹é…ä¸Šè¿°) |
| Proto | `proto/**` |

### å®‰è£…ä¸ä½¿ç”¨

```bash
# å®‰è£… hooks
make install-hooks

# æœ¬åœ° CI æ£€æŸ¥ï¼ˆå®Œæ•´æ£€æŸ¥ï¼Œä¸åˆ†ç±»ï¼‰
make ci-check
make ci-backend
make ci-frontend

# è·³è¿‡æ£€æŸ¥
git commit --no-verify -m "WIP"
git push --no-verify
```

### ç¤ºä¾‹è¾“å‡º

```
ğŸ” Pre-commit checks...

ğŸ“¦ Backend changes detected:
  â†’ go.mod/go.sum tidy check...
    âœ“ go.mod/go.sum tidy
  â†’ go fmt...
    âœ“ go fmt
  â†’ go vet...
    âœ“ go vet

ğŸ¨ Frontend changes detected:
  â†’ pnpm lint:fix...
    âœ“ pnpm lint:fix

âœ… Pre-commit checks passed!
```

> **è¯¦ç»†è§„èŒƒ**ï¼šå‚è§ [Git å·¥ä½œæµ](../../.claude/rules/git-workflow.md)

---

## Parrot ä»£ç†æ¶æ„

### ä»£ç†ç±»å‹ (`ai/agent/`)

|  AgentType  | é¹¦é¹‰åç§° | é…ç½®/æ–‡ä»¶              | ä¸­æ–‡å | æè¿°                             |
| :---------: | :------- | :--------------------- | :----- | :------------------------------- |
|   `AUTO`    | â€”        | â€”                      | â€”      | è·¯ç”±æ ‡è®°ï¼ˆéé¹¦é¹‰ï¼‰ï¼Œç”±åç«¯ä¸‰å±‚è·¯ç”±å†³å®šä½¿ç”¨å“ªåªé¹¦é¹‰ |
|   `MEMO`    | ç°ç°     | `config/parrots/memo.yaml` | ç°ç°   | ç¬”è®°æœç´¢å’Œæ£€ç´¢ä¸“å®¶               |
| `SCHEDULE`  | æ—¶å·§     | `config/parrots/schedule.yaml` | æ—¶å·§ | æ—¥ç¨‹åˆ›å»ºå’Œç®¡ç†                   |
|  `AMAZING`  | æŠ˜è¡·     | `config/parrots/amazing.yaml` | æŠ˜è¡· | ç»¼åˆåŠ©ç†ï¼ˆç¬”è®° + æ—¥ç¨‹ï¼‰          |
|   `GEEK`    | æå®¢     | `geek_parrot.go`       | æå®¢   | Claude Code CLI é€šä¿¡å±‚ï¼ˆé›¶ LLMï¼‰ |
| `EVOLUTION` | è¿›åŒ–     | `evolution_parrot.go`  | è¿›åŒ–   | è‡ªæˆ‘è¿›åŒ–èƒ½åŠ›ï¼ˆæºä»£ç ä¿®æ”¹ï¼‰       |

**è¯´æ˜**ï¼š
- **é¹¦é¹‰å…±äº”åª**ï¼šMEMOã€SCHEDULEã€AMAZINGï¼ˆé…ç½®é©±åŠ¨ï¼‰ã€GEEKã€EVOLUTIONï¼ˆä»£ç å®ç°ï¼‰
- **AUTO ä¸æ˜¯é¹¦é¹‰**ï¼šå®ƒæ˜¯å‰ç«¯å‘é€ç»™åç«¯çš„ç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤º"è¯·åç«¯è·¯ç”±ç³»ç»Ÿå†³å®šä½¿ç”¨å“ªåªé¹¦é¹‰"
- å½“ `AgentType == AUTO` æ—¶ï¼Œåç«¯è§¦å‘äº”å±‚è·¯ç”±ï¼ˆç¼“å­˜ â†’ è§„åˆ™ â†’ å†å² â†’ æƒé‡ â†’ LLMï¼‰

### UniversalParrot æ¶æ„

> **å®ç°çŠ¶æ€**: âœ… å®Œæˆ (v0.93.0) | **ä½ç½®**: `ai/agent/universal/`

**æ¦‚è¿°**ï¼šUniversalParrot æ˜¯é…ç½®é©±åŠ¨çš„é€šç”¨ä»£ç†ç³»ç»Ÿï¼Œä¸‰åªæ ¸å¿ƒé¹¦é¹‰ï¼ˆMEMOã€SCHEDULEã€AMAZINGï¼‰é€šè¿‡ YAML é…ç½®æ–‡ä»¶å®šä¹‰ï¼Œæ— éœ€ç¼–å†™ä»£ç ã€‚

**é…ç½®ç›®å½•**ï¼š`config/parrots/`

| é…ç½®æ–‡ä»¶ | ä»£ç†åç§° | æ‰§è¡Œç­–ç•¥ |
|:--------|:--------|:---------|
| `memo.yaml` | MemoParrot | ReAct å¾ªç¯ï¼ˆ`react`ï¼‰ |
| `schedule.yaml` | ScheduleParrot | åŸç”Ÿå·¥å…·è°ƒç”¨ï¼ˆ`direct`ï¼‰ |
| `amazing.yaml` | AmazingParrot | ä¸¤é˜¶æ®µè§„åˆ’ + å¹¶å‘æ‰§è¡Œï¼ˆ`planning`ï¼‰ |

**æ ¸å¿ƒç»„ä»¶**ï¼š

| ç»„ä»¶ | æ–‡ä»¶ | æè¿° |
|:-----|:-----|:-----|
| **UniversalParrot** | `universal_parrot.go` | é…ç½®é©±åŠ¨çš„é€šç”¨ä»£ç†å®ç° |
| **ParrotFactory** | `parrot_factory.go` | ä»é…ç½®åˆ›å»ºä»£ç†çš„å·¥å‚ |
| **ParrotConfig** | `parrot_config.go` | é…ç½®åŠ è½½å’ŒéªŒè¯ |
| **ExecutionStrategy** | `*_executor.go` | æ‰§è¡Œç­–ç•¥æ¥å£ï¼ˆDirect/ReAct/Planningï¼‰ |
| **ToolRegistry** | `registry/tool_registry.go` | å·¥å…·æ³¨å†Œè¡¨ï¼ˆåŠ¨æ€å·¥å…·å‘ç°ï¼‰ |
| **PromptRegistry** | `registry/prompt_registry.go` | æç¤ºè¯æ³¨å†Œè¡¨ï¼ˆç‰ˆæœ¬ç®¡ç†ï¼‰ |

**æ‰§è¡Œç­–ç•¥**ï¼š

| ç­–ç•¥ | æ–‡ä»¶ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|:-----|:-----|:-----|:---------|
| **DirectExecutor** | `direct_executor.go` | åŸç”Ÿ LLM å·¥å…·è°ƒç”¨ | ç®€å•å·¥å…·è°ƒç”¨ |
| **ReActExecutor** | `react_executor.go` | æ€è€ƒ-è¡ŒåŠ¨å¾ªç¯ | å¤æ‚å¤šæ­¥ä»»åŠ¡ |
| **PlanningExecutor** | `planning_executor.go` | ä¸¤é˜¶æ®µè§„åˆ’ + å¹¶å‘ | å¤šå·¥å…·åä½œ |

### ä»£ç†è·¯ç”±å™¨

**ä½ç½®**ï¼š`ai/agent/chat_router.go` + `ai/router/service.go`

ChatRouter å®ç°**äº”å±‚**æ„å›¾åˆ†ç±»ç³»ç»Ÿï¼ˆå«æ™ºèƒ½è·¯ç”±åé¦ˆï¼‰ï¼š

```
ç”¨æˆ·è¾“å…¥ â†’ EvolutionMode? â”€Yesâ†’ EvolutionParrotï¼ˆè‡ªæˆ‘è¿›åŒ–ï¼‰
                  â”‚
                  No
                  â†“
           GeekMode? â”€Yesâ†’ GeekParrotï¼ˆClaude Code CLIï¼‰
                  â”‚
                  No
                  â†“
           AgentType == AUTO?
                  â”‚
           Yes â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€ Noï¼ˆç›´æ¥ä½¿ç”¨æŒ‡å®šçš„é¹¦é¹‰ï¼‰
                  â†“
           ChatRouter.Route()
                  â†“
           router.Service.ClassifyIntent()
                  â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Layer 0: Cache (LRU, 0ms)          â”‚  â†’ Hit? è¿”å›ç¼“å­˜ç»“æœ
    â”‚  Layer 1: RuleMatcher (0ms)        â”‚  â†’ Match? è¿”å›
    â”‚  Layer 2: HistoryMatcher (~10ms)   â”‚  â†’ Match? è¿”å›
    â”‚  Layer 3: WeightMatcher (åŠ¨æ€æƒé‡) â”‚  â†’ ä¸ªæ€§åŒ–è·¯ç”±
    â”‚  Layer 4: LLM Classifier (~400ms)   â”‚  â†’ è¿”å› JSON {intent, confidence}
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
           è·¯ç”±ç»“æœï¼ˆMEMO/SCHEDULE/AMAZINGï¼‰
                  â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ åé¦ˆæ”¶é›† (å¯é€‰)   â”‚ â†’ router_feedback è¡¨
           â”‚ ä¼˜åŒ–è·¯ç”±æƒé‡      â”‚ â†’ router_weight è¡¨
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Layer 0: Cache (LRU)**
- å®¹é‡ï¼š500 æ¡
- TTLï¼šè§„åˆ™åŒ¹é…ç»“æœ 5 åˆ†é’Ÿï¼ŒLLM ç»“æœ 30 åˆ†é’Ÿ
- å»¶è¿Ÿï¼š~0ms

**Layer 1: RuleMatcher (å…³é”®è¯åŒ¹é…)**
- æ—¶é—´è¯æƒé‡ï¼š2ï¼ˆä»Šå¤©ã€æ˜å¤©ã€åå¤©ã€ä¸‹å‘¨ã€æœ¬å‘¨ã€ä¸Šåˆã€ä¸‹åˆã€æ™šä¸Šã€ç‚¹ï¼‰
- æ ¸å¿ƒå…³é”®è¯æƒé‡ï¼š2ï¼ˆæ—¥ç¨‹ã€å®‰æ’ã€ä¼šè®®ã€æé†’ã€é¢„çº¦ã€å¼€ä¼šï¼‰
- å¿«é€Ÿè·¯å¾„ï¼šæ—¶é—´è¯ + æŸ¥è¯¢è¯ â†’ `schedule_query` (å¦‚ï¼š"æ˜å¤©æœ‰ä»€ä¹ˆäº‹æƒ…è¦åš")
- å»¶è¿Ÿï¼š~0ms

**Layer 2: HistoryMatcher (å¯¹è¯å†å²)**
- åŸºäºç”¨æˆ·å†å²å¯¹è¯çš„å‘é‡ç›¸ä¼¼åº¦åŒ¹é…
- å­˜å‚¨è¡¨ï¼š`conversation_context`
- å»¶è¿Ÿï¼š~10ms

**Layer 3: WeightMatcherï¼ˆä¸ªæ€§åŒ–è·¯ç”±ï¼‰**
- åŸºäºç”¨æˆ·å†å²è·¯ç”±åé¦ˆè°ƒæ•´å…³é”®è¯æƒé‡
- å­˜å‚¨è¡¨ï¼š`router_weight`
- å»¶è¿Ÿï¼š~5ms
- æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å…³é”®è¯ä¼˜å…ˆçº§

**Layer 4: LLM Classifier**
- Provider: SiliconFlow
- Model: `Qwen/Qwen2.5-7B-Instruct`
- Token: 50, Temperature: 0
- è¾“å‡ºæ ¼å¼ï¼šJSON Schema `{intent, confidence}`
- å»¶è¿Ÿï¼š~400ms

**æ™ºèƒ½è·¯ç”±åé¦ˆï¼ˆv0.94.0 æ–°å¢ï¼‰**ï¼š
- æ”¶é›†ç”¨æˆ·å¯¹è·¯ç”±ç»“æœçš„åé¦ˆ
- å­˜å‚¨è¡¨ï¼š`router_feedback`ï¼ˆpredicted_intent, actual_intent, confidenceï¼‰
- ç”¨äºä¼˜åŒ–å…³é”®è¯æƒé‡å’Œ LLM åˆ†ç±»å™¨
- æ”¯æŒ A/B æµ‹è¯•ä¸åŒè·¯ç”±ç­–ç•¥

**EvolutionMode æœ€é«˜ä¼˜å…ˆçº§è·¯ç”±**ï¼š
- å½“ `EvolutionMode=true` æ—¶ï¼Œ**ç»•è¿‡æ‰€æœ‰è·¯ç”±**ï¼Œç›´æ¥åˆ›å»º EvolutionParrot
- **å·¥ä½œç›®å½•**: DivineSense æºä»£ç æ ¹ç›®å½•
- **äº§å‡ºç‰©**: å¼ºåˆ¶ GitHub PRï¼Œéœ€äººå·¥ Review ååˆå¹¶
- **å®‰å…¨ç­‰çº§**: é«˜ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ + ç¯å¢ƒå˜é‡å¯ç”¨ + PR å®¡æ ¸ï¼‰
- ä»…é™ç®¡ç†å‘˜ä½¿ç”¨
- å®ç°ï¼š`server/router/api/v1/ai/handler.go` ä¸­çš„ `handleEvolutionMode()`

**GeekMode ä¼˜å…ˆè·¯ç”±**ï¼š
- å½“ `GeekMode=true` æ—¶ï¼ˆä¸” EvolutionMode=falseï¼‰ï¼Œ**ç»•è¿‡æ‰€æœ‰è·¯ç”±**ï¼Œç›´æ¥åˆ›å»º GeekParrot
- **å·¥ä½œç›®å½•**: `~/.divinesense/claude/user_{id}`ï¼ˆç”¨æˆ·æ²™ç®±ï¼‰
- **äº§å‡ºç‰©**: ç”¨æˆ·å¯æµè§ˆ/ä¸‹è½½çš„ä»£ç äº§ç‰©
- **å®‰å…¨ç­‰çº§**: ä¸­ï¼ˆæ²™ç®±éš”ç¦»ï¼‰
- æ‰€æœ‰ç”¨æˆ·å¯ç”¨
- å®ç°ï¼š`server/router/api/v1/ai/handler.go` ä¸­çš„ `handleGeekMode()`

### AI æ¨¡å‹ç­–ç•¥æ€»è§ˆ

| åŠŸèƒ½ | æä¾›å•† | æ¨¡å‹ | ç”¨é€” |
|:-----|:-------|:-----|:-----|
| **å¯¹è¯ LLM** | DeepSeek | `deepseek-chat` | ä¸»å¯¹è¯ç”Ÿæˆ |
| **å‘é‡ Embedding** | SiliconFlow | `BAAI/bge-m3` | è¯­ä¹‰æœç´¢ï¼ˆ1024ç»´ï¼‰ |
| **æ„å›¾åˆ†ç±»** | SiliconFlow | `Qwen/Qwen2.5-7B-Instruct` | è·¯ç”±æ„å›¾åˆ†ç±» |
| **é‡æ’ Rerank** | SiliconFlow | `BAAI/bge-reranker-v2-m3` | æ£€ç´¢ç»“æœç²¾ç‚¼ |

**ç­–ç•¥è¯´æ˜**ï¼š
- **æ„å›¾åˆ†ç±»ç‹¬ç«‹æ¨¡å‹**ï¼šä½¿ç”¨è½»é‡çº§ Qwen2.5-7B-Instructï¼ˆè€Œéä¸»å¯¹è¯ LLMï¼‰ï¼Œå®ç°å¿«é€Ÿã€ä½æˆæœ¬çš„åˆ†ç±»
- **æˆæœ¬ä¼˜åŒ–**ï¼šæ„å›¾åˆ†ç±» Token é™åˆ¶ä¸º 50ï¼ŒTemperature 0ï¼ˆç¡®å®šæ€§è¾“å‡ºï¼‰
- **è¾“å‡ºæ ¼å¼**ï¼šJSON Schema `{intent, confidence}` ç¡®ä¿ç»“æ„åŒ–å“åº”

### DeepSeek ä¸Šä¸‹æ–‡ç¼“å­˜

> **ä¿é²œçŠ¶æ€**: âœ… å·²éªŒè¯ (2026-02-07)

DeepSeek API æä¾›è‡ªåŠ¨ä¸Šä¸‹æ–‡ç¼“å­˜ï¼ˆPrompt Cachingï¼‰ï¼Œé™ä½å¤šè½®å¯¹è¯æˆæœ¬ã€‚

**ç¼“å­˜æœºåˆ¶**ï¼š
- **ç¼“å­˜ç²’åº¦**ï¼š64 token å—
- **å·¥ä½œåŸç†**ï¼šç›¸åŒä¼šè¯å‰ç¼€çš„åç»­è¯·æ±‚è‡ªåŠ¨å‘½ä¸­ç¼“å­˜
- **å‘½ä¸­è¯†åˆ«**ï¼šAPI å“åº”è¿”å› `prompt_cache_hit_tokens` å­—æ®µ

**æ•°æ®æµ**ï¼š
```
DeepSeek API Response
    â†“ prompt_cache_hit_tokens
go-openai åº“æ˜ å°„
    â†“ PromptTokensDetails.CachedTokens
ai/llm.go:206
    â†“ CacheReadTokens: resp.Usage.PromptTokensDetails.CachedTokens
LLMCallStats.CacheReadTokens
    â†“ SessionStats.CacheReadTokens
æ•°æ®åº“ ai_block.token_usage.cache_read_tokens
```

**æˆæœ¬ä¼˜åŒ–æ•ˆæœ**ï¼š
| è½®æ¬¡ | Prompt Tokens | Cache Hit | ç¼“å­˜ç‡ |
|:-----|:--------------|:---------|:-------|
| ç¬¬1è½® | ~5000 | 0 | 0% (å†·å¯åŠ¨) |
| ç¬¬2è½® | ~6000 | ~5000 | ~83% |
| ç¬¬3è½® | ~8000 | ~5760 | ~72% |

**æœ€ä½³å®è·µ**ï¼š
- ä¿æŒç³»ç»Ÿæç¤ºè¯ç¨³å®šï¼Œæå‡ç¼“å­˜å‘½ä¸­ç‡
- é¿å…é¢‘ç¹ä¿®æ”¹ä¼šè¯å‰ç¼€
- ç›‘æ§ `cache_write_tokens` ä¸ `cache_read_tokens` æ¯”ä¾‹

### ä»£ç†å·¥å…·

**ä½ç½®**ï¼š`ai/agent/tools/`

| å·¥å…·              | æ–‡ä»¶             | æè¿°                    |
| :---------------- | :--------------- | :---------------------- |
| `memo_search`     | `memo_search.go` | è¯­ä¹‰ç¬”è®°æœç´¢ + RRF èåˆ |
| `schedule_add`    | `scheduler.go`   | åˆ›å»ºæ–°æ—¥ç¨‹              |
| `schedule_query`  | `scheduler.go`   | æŸ¥è¯¢ç°æœ‰æ—¥ç¨‹            |
| `schedule_update` | `scheduler.go`   | æ›´æ–°ç°æœ‰æ—¥ç¨‹            |
| `find_free_time`  | `scheduler.go`   | æŸ¥æ‰¾ç©ºé—²æ—¶é—´æ®µ          |

### æµå¼å·¥å…·è°ƒç”¨

> **å®ç°çŠ¶æ€**: âœ… å®Œæˆ (v0.93.0)

**æ¦‚è¿°**ï¼šæ‰€æœ‰æ‰§è¡Œç­–ç•¥æ”¯æŒæµå¼äº‹ä»¶å›è°ƒï¼Œå‰ç«¯å¯å®æ—¶æ˜¾ç¤ºå·¥å…·æ‰§è¡Œè¿›åº¦ã€‚

**äº‹ä»¶ç±»å‹**ï¼š

| äº‹ä»¶ | æè¿° | å…ƒæ•°æ® |
|:-----|:-----|:-------|
| `thinking` | æ€è€ƒä¸­ | tokens, duration |
| `tool_use` | å·¥å…·è°ƒç”¨ | toolName, input, toolId |
| `tool_result` | å·¥å…·ç»“æœ | toolName, status, error |
| `phase_change` | é˜¶æ®µåˆ‡æ¢ | currentStep, totalSteps |
| `answer` | æœ€ç»ˆå›ç­” | â€” |

**å‰ç«¯ç»„ä»¶**ï¼š
- `EventBadge` - äº‹ä»¶ç±»å‹å¾½ç« 
- `CompactToolCall` - è½»é‡çº§å·¥å…·è°ƒç”¨å¡ç‰‡
- `UnifiedMessageBlock` - ç»Ÿä¸€æ¶ˆæ¯å—ï¼ˆé›†æˆå·¥å…·å±•ç¤ºï¼‰

---

## CC Runner å¼‚æ­¥æ¶æ„ (Geek Mode æ ¸å¿ƒ)

**è§„æ ¼æ–‡æ¡£**ï¼š[CC Runner å¼‚æ­¥æ¶æ„è¯´æ˜ä¹¦](../specs/cc_runner_async_arch.md) (v1.2)

**æ¦‚è¿°**ï¼šGeek Mode ä»ä¸€æ¬¡æ€§æ‰§è¡Œï¼ˆOne-shotï¼‰å‡çº§ä¸º**å…¨åŒå·¥æŒä¹…åŒ–**ï¼ˆFull-Duplex Persistentï¼‰æ¶æ„ã€‚

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (React)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  EventBadge  â”‚  â”‚ ToolCallCard â”‚  â”‚  SessionSummaryPanel â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                  â”‚
â”‚                        WebSocket (SSE)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Backend (Go)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Session Mgr â”‚â—„â”€â”¤   Streamer  â”‚â—„â”€â”¤  DangerDetector      â”‚  â”‚
â”‚  â”‚  (30min)    â”‚  â”‚ (Bidirect)  â”‚  â”‚  (rm -rf, format)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Claude Code CLI (OS Process)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  --session-id <UUID> --output-format stream-json          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚    CLI      â”‚  â”‚  In-Memory   â”‚  â”‚  Skills & MCP    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚   Engine    â”‚â—„â”€â”¤   Context    â”‚  â”‚    Registry      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

**ä½ç½®**ï¼š`ai/agent/cc_runner/`

| ç»„ä»¶ | æ–‡ä»¶ | æè¿° |
|:-----|:-----|:-----|
| **SessionManager** | `session_manager.go` | ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆ30min ç©ºé—²è¶…æ—¶ï¼‰ |
| **Streamer** | `streamer.go` | åŒå‘æµå¼è½¬æ¢ï¼ˆHTTP â‡„ CLI JSON Streamï¼‰ |
| **DangerDetector** | `danger_detector.go` | å±é™©å‘½ä»¤æ£€æµ‹ï¼ˆrm -rf, mkfs, etc.ï¼‰ |
| **SessionStats** | `session_stats.go` | å®æ—¶æŒ‡æ ‡æ”¶é›†ï¼ˆthinking, tokens, toolsï¼‰ |

### ä¼šè¯æ˜ å°„æ¨¡å‹

```
å‰ç«¯ ConversationID (æ•°æ®åº“ ID)
         â”‚
         â–¼ UUID v5 å®šå‘å“ˆå¸Œ
         â”‚
    SessionID (UUID)
         â”‚
         â–¼
Claude Code CLI Process
```

- **ç¡®å®šæ€§æ˜ å°„**ï¼š`UUID v5(Namespace, "divinesense:conversation:{ID}")`
- **çŠ¶æ€æ¢å¤**ï¼šCLI è‡ªåŠ¨ä» `~/.claude/sessions/` æ¢å¤ä¸Šä¸‹æ–‡
- **ç‰©ç†éš”ç¦»**ï¼šæ¯ä¸ªä¼šè¯ç‹¬ç«‹ OS è¿›ç¨‹ï¼Œäº’ä¸å¹²æ‰°

### äº¤äº’åè®®

**Client â†’ Server (WebSocket Events)**:

| Event | Payload | æè¿° |
|:-----|:--------|:-----|
| `session.start` | `{config}` | å¯åŠ¨æ–°ä¼šè¯ |
| `input.send` | `{text}` | å‘é€ç”¨æˆ·è¾“å…¥ |
| `session.stop` | `{}` | å¼ºåˆ¶åœæ­¢ |

**Server â†’ Client (Stream Events)**:

| Event | Meta | æè¿° |
|:-----|:-----|:-----|
| `thinking` | â€” | æ€è€ƒè¿‡ç¨‹ï¼ˆå¢é‡ï¼‰ |
| `tool_use` | `{name, input, id}` | å·¥å…·è°ƒç”¨ |
| `tool_result` | `{is_error}` | å·¥å…·ç»“æœ |
| `answer` | â€” | æœ€ç»ˆå›ç­”ï¼ˆå¢é‡ï¼‰ |
| `error` | â€” | ç³»ç»Ÿçº§é”™è¯¯ |

### å®‰å…¨ä¸é£æ§

- **Permission Bypass**: ä½¿ç”¨ `--permission-mode bypassPermissions`
- **å‰ç«¯ç¡®è®¤**: å¯¹å…³é”®æ“ä½œï¼ˆå¦‚ `rm -rf`ï¼‰è¿›è¡Œ Regex æ‹¦æˆª
- **Git æ¢å¤**: å¼ºåˆ¶åœ¨ Git ä»“åº“å†…è¿è¡Œï¼Œç¡®ä¿å¯å›æ»š
- **è¶…æ—¶ä¿æŠ¤**: 30 åˆ†é’Ÿç©ºé—²è‡ªåŠ¨ Kill

### API ç«¯ç‚¹

| RPC | æ–¹æ³• | æè¿° |
|:-----|:-----|:-----|
| `ChatService` | `StreamChat` | æµå¼èŠå¤©ï¼ˆSSEï¼‰ |
| `ChatService` | `StopChat` | åœæ­¢ä¼šè¯ï¼ˆæ‰€æœ‰æƒéªŒè¯ï¼‰ |

---

## AI æœåŠ¡ (`ai/`)

### æœåŠ¡æ¦‚è§ˆ

| æœåŠ¡    | åŒ…         | æè¿°                            |
| :------ | :--------- | :------------------------------ |
| Memory  | `memory/`  | æƒ…æ™¯è®°å¿† & ç”¨æˆ·åå¥½             |
| Session | `session/` | å¯¹è¯æŒä¹…åŒ–ï¼ˆ30 å¤©ä¿ç•™ï¼‰         |
| Router  | `router/`  | å››å±‚æ„å›¾åˆ†ç±» & æ™ºèƒ½è·¯ç”±åé¦ˆ     |
| Cache   | `cache/`   | å¸¦ TTL çš„ LRU ç¼“å­˜ï¼ˆæŸ¥è¯¢ç»“æœï¼‰  |
| Metrics | `metrics/` | ä»£ç† & å·¥å…·æ€§èƒ½è¿½è¸ªï¼ˆA/B æµ‹è¯•ï¼‰ |
| Stats   | `stats/`   | ç»Ÿè®¡æœåŠ¡ï¼ˆå‘Šè­¦æŒä¹…åŒ–ï¼‰          |
| Vector  | `vector/`  | å¤šæä¾›å•† Embedding æœåŠ¡         |
| Filter  | `filter/`  | æ•æ„Ÿä¿¡æ¯è¿‡æ»¤å™¨ï¼ˆ<1ms å“åº”ï¼‰     |
| Preload | `preload/` | é¢„æµ‹æ€§ç¼“å­˜é¢„åŠ è½½                |
| Tracing | `tracing/` | åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª                  |

### æ–°å¢ AI æ¨¡å— (v0.94.0)

| æ¨¡å— | åŠŸèƒ½ | æ€§èƒ½æŒ‡æ ‡ |
|:-----|:-----|:---------|
| **ai/filter/** | æ•æ„Ÿä¿¡æ¯è¿‡æ»¤ï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯ã€é‚®ç®±ã€é“¶è¡Œå¡ã€IPï¼‰ | <1ms å“åº”æ—¶é—´ |
| **ai/preload/** | åŸºäºç”¨æˆ·è¡Œä¸ºæ¨¡å¼çš„æ™ºèƒ½é¢„åŠ è½½ | å‘½ä¸­ç‡ >60% |
| **ai/stats/** | å‘Šè­¦æŒä¹…åŒ–ã€æŒ‡æ ‡å­˜å‚¨ | å®æ—¶èšåˆ |
| **ai/tracing/** | åˆ†å¸ƒå¼è¿½è¸ªï¼ˆOpenTelemetry å…¼å®¹ï¼‰ | <5% å¼€é”€ |
| **ai/agent/registry/** | åŠ¨æ€å·¥å…·å‘ç°ã€æ‰§è¡Œç­–ç•¥æ³¨å†Œ | çƒ­åŠ è½½ |

### ä¼šè¯æœåŠ¡ (`ai/session/`)

ä¸º AI ä»£ç†æä¾›å¯¹è¯æŒä¹…åŒ–ï¼š

**ç»„ä»¶**ï¼š
- `store.go`ï¼šPostgreSQL æŒä¹…åŒ– + ç›´å†™ç¼“å­˜ï¼ˆ30min TTLï¼‰
- `recovery.go`ï¼šä¼šè¯æ¢å¤å·¥ä½œæµ + æ»‘åŠ¨çª—å£ï¼ˆæœ€å¤š 20 æ¡æ¶ˆæ¯ï¼‰
- `cleanup.go`ï¼šè¿‡æœŸä¼šè¯æ¸…ç†åå°ä»»åŠ¡ï¼ˆé»˜è®¤ï¼š30 å¤©ï¼‰

**æ•°æ®åº“**ï¼š`conversation_context` è¡¨ï¼ˆJSONB å­˜å‚¨ï¼‰

### ä¸Šä¸‹æ–‡æ„å»ºå™¨ (`ai/context/`)

ç»„è£… LLM ä¸Šä¸‹æ–‡ï¼Œæ™ºèƒ½åˆ†é… token é¢„ç®—ï¼š

```
Token é¢„ç®—åˆ†é…ï¼ˆå¸¦æ£€ç´¢ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ System Prompt      â”‚ 500 tokensï¼ˆå›ºå®šï¼‰ â”‚
â”‚ User Preferences   â”‚ 10%                â”‚
â”‚ Short-term Memory  â”‚ 40%                â”‚
â”‚ Long-term Memory   â”‚ 15%                â”‚
â”‚ Retrieval Results  â”‚ 45%                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ£€ç´¢ç³»ç»Ÿ (`ai/core/retrieval/`)

### AdaptiveRetriever

æ··åˆ BM25 + å‘é‡æœç´¢ + æ™ºèƒ½èåˆï¼š

| ç­–ç•¥             | æè¿°                            |
| :--------------- | :------------------------------ |
| `BM25Only`       | ä»…å…³é”®è¯æœç´¢ï¼ˆå¿«ï¼Œä½è´¨é‡ï¼‰      |
| `SemanticOnly`   | ä»…å‘é‡æœç´¢ï¼ˆæ…¢ï¼Œè¯­ä¹‰ï¼‰          |
| `HybridStandard` | BM25 + å‘é‡ + RRF èåˆï¼ˆå¹³è¡¡ï¼‰  |
| `FullPipeline`   | æ··åˆ + é‡æ’å™¨ï¼ˆæœ€é«˜è´¨é‡ï¼Œæœ€æ…¢ï¼‰ |

### RRF èåˆ

ç”¨äºåˆå¹¶ BM25 å’Œå‘é‡ç»“æœçš„å€’æ•°æ’åèåˆï¼š
```
score = Î£ weight_i / (60 + rank_i)
```

### é‡æ’å™¨

BAAI/bge-reranker-v2-m3 ç”¨äºç»“æœç²¾ç‚¼ï¼ˆå¯é€šè¿‡ç­–ç•¥é…ç½®ï¼‰ã€‚

---

## å‰ç«¯æ¶æ„ (`web/src/`)

### é¡µé¢ç»„ä»¶

| è·¯å¾„           | ç»„ä»¶              | å¸ƒå±€           | ç”¨é€”                     |
| :------------- | :---------------- | :------------- | :----------------------- |
| `/`            | é‡å®šå‘åˆ° `/chat`   | RootLayout     | é»˜è®¤å…¥å£                 |
| `/auth/*`      | è®¤è¯é¡µé¢ç»„        | RootLayout     | ç™»å½•/æ³¨å†Œ/OAuth å›è°ƒ     |
| `/home`        | `Home.tsx`        | MemoLayout     | ä¸»æ—¶é—´çº¿ + ç¬”è®°ç¼–è¾‘å™¨    |
| `/explore`     | `Explore.tsx`     | MemoLayout     | æœç´¢å’Œæ¢ç´¢å†…å®¹           |
| `/archived`    | `Archived.tsx`    | MemoLayout     | å·²å½’æ¡£ç¬”è®°               |
| `/chat`        | `AIChat.tsx`      | AIChatLayout   | AI èŠå¤©ç•Œé¢ + è‡ªåŠ¨è·¯ç”±   |
| `/schedule`    | `Schedule.tsx`    | ScheduleLayout | æ—¥å†è§†å›¾ï¼ˆFullCalendarï¼‰ |
| `/knowledge-graph` | `KnowledgeGraph.tsx` | GeneralLayout | çŸ¥è¯†å›¾è°±å¯è§†åŒ–          |
| `/inbox`       | `Inboxes.tsx`     | GeneralLayout  | æ”¶ä»¶ç®±                   |
| `/attachments` | `Attachments.tsx` | GeneralLayout  | é™„ä»¶ç®¡ç†                 |
| `/review`      | `Review.tsx`      | MemoLayout     | æ¯æ—¥å›é¡¾                 |
| `/setting`     | `Setting.tsx`     | GeneralLayout  | ç”¨æˆ·è®¾ç½®                 |
| `/u/:username` | `UserProfile.tsx` | MemoLayout     | å…¬å¼€ç”¨æˆ·èµ„æ–™             |
| `/memos/:uid`  | `MemoDetail.tsx`  | GeneralLayout  | ç¬”è®°è¯¦æƒ…é¡µ               |

### å¸ƒå±€å±‚çº§

```
RootLayoutï¼ˆå…¨å±€å¯¼èˆª + è®¤è¯ï¼‰
    â”‚
    â”œâ”€â”€ MemoLayoutï¼ˆå¯æŠ˜å ä¾§è¾¹æ ï¼šMemoExplorerï¼‰
    â”‚   â””â”€â”€ /home, /explore, /archived, /u/:username, /review
    â”‚
    â”œâ”€â”€ AIChatLayoutï¼ˆå›ºå®šä¾§è¾¹æ ï¼šAIChatSidebarï¼Œå¤šæ¨¡å¼ä¸»é¢˜ï¼‰
    â”‚   â””â”€â”€ /chat
    â”‚
    â”œâ”€â”€ ScheduleLayoutï¼ˆå›ºå®šä¾§è¾¹æ ï¼šScheduleCalendarï¼‰
    â”‚   â””â”€â”€ /schedule
    â”‚
    â””â”€â”€ GeneralLayoutï¼ˆæ— ä¾§è¾¹æ ï¼Œå…¨å®½å†…å®¹ï¼‰
        â””â”€â”€ /knowledge-graph, /inbox, /attachments, /setting, /memos/:uid
```

### æ ¸å¿ƒ Hooks

| Hook | å¤§å° | æè¿° |
|:-----|:-----|:-----|
| `useAIQueries` | 41KB | AI æŸ¥è¯¢ç®¡ç† |
| `useBlockQueries` | 21KB | Block æ¨¡å‹æ”¯æŒ |
| `useScheduleQueries` | 20KB | æ—¥ç¨‹æŸ¥è¯¢ |
| `useParrotChat` | 8KB | é¹¦é¹‰èŠå¤© |
| `useBranchTree` | 5KB | åˆ†æ”¯æ ‘ç®¡ç† |
| `useIntentPrediction` | - | æ„å›¾é¢„æµ‹ |

### é™æ€èµ„æºä¼˜åŒ– (Static Asset Optimization)

ä¸ºäº†åœ¨å•äºŒè¿›åˆ¶åˆ†å‘ä¸­ä¿æŒæè‡´çš„ Web æ€§èƒ½ï¼Œ`FrontendService` å®ç°äº†ä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼š

| ç­–ç•¥                 | å®ç°ç»†èŠ‚                                 | ç›®æ ‡                                      |
| :------------------- | :--------------------------------------- | :---------------------------------------- |
| **Gzip å‹ç¼©**        | `middleware.Gzip(Level: 5)`              | å‡å°‘äºŒè¿›åˆ¶åµŒå…¥äº§ç‰©çš„ä¼ è¾“å¤§å°ï¼ˆçº¦ 70%ï¼‰    |
| **å¼ºç¼“å­˜ (Vite)**    | `/assets/*` åŒ¹é… `immutable, max-age=1y` | é’ˆå¯¹ Vite å“ˆå¸Œèµ„æºå®ç°â€œé›¶è¯·æ±‚â€é‡å¤è®¿é—®    |
| **å…¥å£é˜²ç¼“å­˜**       | `index.html` å¼ºåˆ¶ `no-cache, no-store`   | ç¡®ä¿ç‰ˆæœ¬è¿­ä»£åç”¨æˆ·ç«‹åˆ»è·å–æœ€æ–° JS å¼•ç”¨    |
| **Geek å·¥ä½œåŒº Host** | `/file/geek/:userID/*` å®æ—¶ Host         | æå®¢æ¨¡å¼äº§ç”Ÿçš„ç½‘é¡µ/äº§ç‰©å¯åœ¨æµè§ˆå™¨å®æ—¶é¢„è§ˆ |
| **å®‰å…¨åŠ å›º**         | `X-Content-Type-Options: nosniff`        | å¢å¼ºé’ˆå¯¹åµŒå…¥å¼é™æ€èµ„æºçš„å®‰å…¨é˜²å¾¡          |

---

## æ•°æ®æµ

### AI èŠå¤©æµç¨‹

```
å‰ç«¯ï¼ˆAIChat.tsxï¼‰
    â”‚ï¼ˆWebSocket / SSEï¼‰
    â†“
åç«¯ï¼ˆai_service_chat.goï¼‰
    â”‚
    â†“ GeekMode?
    â”‚   Yes â†’ GeekParrotï¼ˆClaude Code CLIï¼Œé›¶ LLMï¼‰
    â”‚   No  â†“ ChatRouter.Route()
    â”‚       â†’ è§„åˆ™åŒ¹é…ï¼ˆ0msï¼‰
    â”‚       â†’ å†å²æ„ŸçŸ¥ï¼ˆ~10msï¼‰
    â”‚       â†’ LLM é™çº§ï¼ˆ~400msï¼‰
    â†“
ä»£ç†æ‰§è¡Œ
    â”‚   â†’ GeekParrotï¼ˆClaude Code CLIï¼‰
    â”‚   â†’ MemoParrotï¼ˆmemo_search å·¥å…·ï¼‰
    â”‚   â†’ ScheduleParrotV2ï¼ˆscheduler å·¥å…·ï¼‰
    â”‚   â†’ AmazingParrotï¼ˆå¹¶å‘å·¥å…·ï¼‰
    â†“
å“åº”æµå¼ä¼ è¾“
    â”‚   â†’ äº‹ä»¶ç±»å‹ï¼šthinkingã€tool_useã€tool_resultã€answer
    â†“
å‰ç«¯ UI æ›´æ–°
```

---

## Unified Block Model (ç»Ÿä¸€å—æ¨¡å‹)

> **å®ç°çŠ¶æ€**: âœ… å®Œæˆ (Issue #71) | **ç‰ˆæœ¬**: v0.93.0

**æ¦‚è¿°**ï¼šUnified Block Model æ˜¯ä¸€ç§æ–°çš„ AI èŠå¤©å¯¹è¯æŒä¹…åŒ–æ–¹æ¡ˆï¼Œæ›¿ä»£åŸæœ‰çš„ ChatItem[] ç»“æ„ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

**Block (å—)**ï¼šä¸€ä¸ªèŠå¤©è½®æ¬¡çš„å®Œæ•´æ•°æ®å•å…ƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AIBlock                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id, uid, conversation_id, round_number               â”‚
â”‚  mode: normal | geek | evolution                        â”‚
â”‚  user_inputs[]       // ç”¨æˆ·è¾“å…¥ï¼ˆæ”¯æŒå¤šè½®è¡¥å……ï¼‰       â”‚
â”‚  assistant_content   // AI å›å¤å†…å®¹                    â”‚
â”‚  event_stream[]      // æµå¼äº‹ä»¶ï¼ˆthinking/tool_useï¼‰  â”‚
â”‚  session_stats       // ä¼šè¯ç»Ÿè®¡ï¼ˆtokens/costï¼‰         â”‚
â”‚  status: pending | streaming | completed | error       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Frontend (React)                        â”‚
â”‚  ChatMessages â”€â”€â–¶ AIBlock[] â”€â”€â–¶ UnifiedMessageBlock    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ gRPC Stream
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Backend (Go)                             â”‚
â”‚  Chat Handler â”€â”€â–¶ BlockManager â”€â”€â–¶ Store.AIBlock       â”‚
â”‚                      â”‚                                 â”‚
â”‚                      â”œâ”€ CreateBlockForChat()           â”‚
â”‚                      â”œâ”€ AppendEvent() (async)         â”‚
â”‚                      â”œâ”€ CompleteBlock()               â”‚
â”‚                      â””â”€ MarkBlockError()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL (ai_block è¡¨)                   â”‚
â”‚  - id, uid, conversation_id, round_number              â”‚
â”‚  - mode (normal/geek/evolution)                         â”‚
â”‚  - user_inputs[], event_stream[], session_stats         â”‚
â”‚  - status (pending/streaming/completed/error)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ä½ç½® | æè¿° |
|:-----|:-----|:-----|
| **BlockManager** | `server/router/api/v1/ai/block_manager.go` | Block ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| **ChatMessages** | `web/src/components/AIChat/ChatMessages.tsx` | å‰ç«¯ Block æ¸²æŸ“ |
| **AIChatContext** | `web/src/contexts/AIChatContext.tsx` | Block çŠ¶æ€ç®¡ç† |
| **Block Queries** | `web/src/hooks/useBlockQueries.ts` | React Query é›†æˆ |

### æ•°æ®åº“è¡¨ï¼š`ai_block`

| å­—æ®µ | ç±»å‹ | æè¿° |
|:-----|:-----|:-----|
| `id` | BIGINT | ä¸»é”® |
| `uid` | VARCHAR(64) | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `conversation_id` | INTEGER | æ‰€å±ä¼šè¯ï¼ˆå¤–é”®ï¼‰ |
| `round_number` | INTEGER | è½®æ¬¡å·ï¼ˆä¼šè¯å†…è‡ªå¢ï¼‰ |
| `mode` | TEXT | æ¨¡å¼ï¼šnormal/geek/evolution |
| `user_inputs` | JSONB | ç”¨æˆ·è¾“å…¥æ•°ç»„ |
| `assistant_content` | TEXT | AI å›å¤å†…å®¹ |
| `event_stream` | JSONB | æµå¼äº‹ä»¶æ•°ç»„ |
| `session_stats` | JSONB | ä¼šè¯ç»Ÿè®¡ä¿¡æ¯ |
| `cc_session_id` | VARCHAR(64) | CC Runner ä¼šè¯ ID |
| `status` | TEXT | çŠ¶æ€ï¼špending/streaming/completed/error |
| `metadata` | JSONB | å…ƒæ•°æ® |
| `created_ts` | BIGINT | åˆ›å»ºæ—¶é—´æˆ³ |
| `updated_ts` | BIGINT | æ›´æ–°æ—¶é—´æˆ³ |

**ç´¢å¼•**ï¼š
- `idx_ai_block_conversation`ï¼š`(conversation_id, round_number)`
- `idx_ai_block_status`ï¼š`(status)`
- `idx_ai_block_cc_session`ï¼š`(cc_session_id)`

**è§¦å‘å™¨**ï¼š
- `ai_block_round_number_trigger`ï¼šè‡ªåŠ¨è®¾ç½® `round_number`

### Block çŠ¶æ€æµè½¬

```
pending â”€â”€â–¶ streaming â”€â”€â–¶ completed
    â”‚             â”‚
    â”‚             â””â”€â”€â–¶ error
    â””â”€â”€â–¶ error
```

### BlockMode æ˜ å°„

| BlockMode | ParrotAgentType | ç”¨é€” |
|:----------|:----------------|:-----|
| `normal` | `AUTO` | æ™®é€šæ¨¡å¼ï¼Œç”±åç«¯ä¸‰å±‚è·¯ç”±å†³å®šä½¿ç”¨å“ªåªé¹¦é¹‰ï¼ˆMEMO/SCHEDULE/AMAZINGï¼‰ |
| `geek` | `GEEK` | æå®¢æ¨¡å¼ï¼ŒClaude Code CLI ä»£ç æ‰§è¡Œ |
| `evolution` | `EVOLUTION` | è¿›åŒ–æ¨¡å¼ï¼Œç³»ç»Ÿè‡ªæˆ‘è¿›åŒ– |

### API ç«¯ç‚¹

| RPC | æ–¹æ³• | æè¿° |
|:-----|:-----|:-----|
| `AIService` | `ListBlocks` | åˆ—å‡ºä¼šè¯çš„æ‰€æœ‰ Blocks |
| `AIService` | `GetBlock` | è·å–å•ä¸ª Block è¯¦æƒ… |
| `AIService` | `CreateBlock` | åˆ›å»ºæ–° Block |
| `AIService` | `UpdateBlock` | æ›´æ–° Block |
| `AIService` | `DeleteBlock` | åˆ é™¤ Block |
| `AIService` | `AppendEvent` | è¿½åŠ äº‹ä»¶åˆ°æµ |
| `AIService` | `AppendUserInput` | è¿½åŠ ç”¨æˆ·è¾“å…¥ |

**è¯¦ç»†è§„æ ¼**ï¼š[Unified Block Model è§„æ ¼](../specs/unified-block-model.md)

**ç•Œé¢è®¾è®¡**ï¼š[AI Chat ç•Œé¢æ¶æ„](AI_CHAT_INTERFACE.md) - åŒ…å«å®Œæ•´çš„ UI å¸ƒå±€ã€ç»„ä»¶å±‚çº§å’Œäº¤äº’è®¾è®¡

---

## AI æ•°æ®åº“æ¶æ„ï¼ˆPostgreSQLï¼‰

### æ ¸å¿ƒè¡¨

| è¡¨å                   | ç”¨é€”                                      | ç‰ˆæœ¬    |
| :--------------------- | :---------------------------------------- | :------ |
| `ai_block`            | **ç»Ÿä¸€å—æ¨¡å‹**ï¼šAI èŠå¤©å¯¹è¯æŒä¹…åŒ– (#71)     | v0.93.0 |
| `ai_conversation`     | AI å¯¹è¯ä¼šè¯                              | v0.93.0 |
| `memo_embedding`       | å‘é‡åµŒå…¥ï¼ˆ1024 ç»´ï¼‰ç”¨äºè¯­ä¹‰æœç´¢           | v0.93.0 |
| `conversation_context` | ä¼šè¯æŒä¹…åŒ–ï¼ˆå¤šæ¸ é“æ”¯æŒï¼‰                  | v0.93.0 |
| `episodic_memory`      | é•¿æœŸç”¨æˆ·è®°å¿†å’Œå­¦ä¹                         | -       |
| `user_preferences`     | ç”¨æˆ·æ²Ÿé€šåå¥½                              | -       |

### å¢å¼ºåŠŸèƒ½è¡¨

| è¡¨å                   | ç”¨é€”                                      | ç‰ˆæœ¬    |
| :--------------------- | :---------------------------------------- | :------ |
| `agent_session_stats`  | ä¼šè¯ç»Ÿè®¡ï¼ˆæˆæœ¬è¿½è¸ªï¼‰                       | v0.93.0 |
| `user_cost_settings`   | ç”¨æˆ·æˆæœ¬é¢„ç®—è®¾ç½®                          | v0.93.0 |
| `agent_security_audit` | å®‰å…¨å®¡è®¡ï¼ˆé«˜é£é™©æ“ä½œè®°å½•ï¼‰                 | v0.93.0 |

### æ™ºèƒ½è·¯ç”±è¡¨ï¼ˆv0.94.0 æ–°å¢ï¼‰

| è¡¨å                   | ç”¨é€”                                      | åŠŸèƒ½     |
| :--------------------- | :---------------------------------------- | :------- |
| `router_feedback`      | è·¯ç”±åé¦ˆæ”¶é›†                              | æ„å›¾åˆ†ç±»ä¼˜åŒ– |
| `router_weight`        | åŠ¨æ€æƒé‡å­˜å‚¨                              | ä¸ªæ€§åŒ–è·¯ç”± |

---

## ç¯å¢ƒé…ç½®

### å…³é”®å˜é‡

```bash
# æ•°æ®åº“
DIVINESENSE_DRIVER=postgres
DIVINESENSE_DSN=postgres://divinesense:divinesense@localhost:25432/divinesense?sslmode=disable

# AI å¼€å…³
DIVINESENSE_AI_ENABLED=true

# å¯¹è¯ LLM (DeepSeek)
DIVINESENSE_AI_LLM_PROVIDER=deepseek
DIVINESENSE_AI_LLM_MODEL=deepseek-chat
DIVINESENSE_AI_DEEPSEEK_API_KEY=your_key

# å‘é‡ Embedding (SiliconFlow)
DIVINESENSE_AI_EMBEDDING_PROVIDER=siliconflow
DIVINESENSE_AI_EMBEDDING_MODEL=BAAI/bge-m3
DIVINESENSE_AI_SILICONFLOW_API_KEY=your_key
DIVINESENSE_AI_OPENAI_BASE_URL=https://api.siliconflow.cn/v1

# æ„å›¾åˆ†ç±» (SiliconFlow + Qwen)
DIVINESENSE_AI_SILICONFLOW_API_KEY=your_key
DIVINESENSE_AI_OPENAI_BASE_URL=https://api.siliconflow.cn/v1

# é‡æ’ Reranker (SiliconFlow)
DIVINESENSE_AI_RERANK_MODEL=BAAI/bge-reranker-v2-m3
DIVINESENSE_AI_SILICONFLOW_API_KEY=your_key
DIVINESENSE_AI_OPENAI_BASE_URL=https://api.siliconflow.cn/v1
```
