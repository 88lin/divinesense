# Agent 工作范式

> DivineSense AI Agent 开发的工作流程和工具选择指南
> **保鲜状态**: ✅ 2026-02-18 | **架构**: UniversalParrot 配置驱动

---

## 架构概述

```
┌─────────────────────────────────────────────────────────────────┐
│                     DivineSense Agent 架构                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ChatRouter (两层路由: Cache → Rule)                     │  │
│  │  - L0: Cache (LRU)                                      │  │
│  │  - L1: Rule Matcher (配置驱动)                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                           │                                    │
│                           ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Orchestrator (LLM 驱动任务分解)                         │  │
│  │  - Decomposer: 任务分解                                   │  │
│  │  - Executor: DAG 调度执行                                  │  │
│  │  - Aggregator: 结果聚合                                   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                           │                                    │
│                           ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  UniversalParrot (配置驱动 Agent 引擎)                    │  │
│  │  - memo.yaml: 笔记搜索                                     │  │
│  │  - schedule.yaml: 日程管理                                 │  │
│  │  - general.yaml: 通用任务                                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 思考协议

```
任务 → 分析 → 方案 → 执行 → 验证
         ↑         ↓
         └── 修订 ──┘
```

### 何时显式思考
- 架构变更
- 陌生 API
- 需用户确认的方案

### 何时直接执行
- 单文件修改
- 明确 lint 错误

---

## 工具选择

| 任务           | 工具            | 说明                          |
| :------------- | :-------------- | :---------------------------- |
| 理解代码库结构 | `Task(Explore)` | 只读模式，快速分析             |
| 实现方案设计   | `Task(Plan)`    | 不修改代码，只写计划           |
| 查找具体文件   | `Glob`          | 按名称模式查找文件             |
| 搜索代码内容   | `Grep`          | 搜索代码中的关键词             |
| 读取文件       | `Read`          | 读取文件内容                   |
| 编辑文件       | `Edit`          | 修改现有文件（优先于 Write）   |
| 代码审查       | `Task(code-reviewer)` | 快速代码审查             |
| 前端界面       | `Skill(frontend-design)` | 高质量前端界面生成    |

**核心原则**：专用工具 > 通用工具，并行调用独立工具

---

## 并行代理策略

### 启动条件（满足任一）
- 2+ 个无依赖关系的子任务
- 子任务涉及不同代码区域
- 任务预计 > 10 分钟

### 不适用场景
- 强依赖任务
- 单文件修改
- 频繁交互

---

## 通用工具模式

### 探索模式
```bash
# 快速探索代码库
Task(Explore, "分析 AI 模块的架构和组件")
```

### 规划模式
```bash
# 设计实现方案
Task(Plan, "设计 Reflexion 执行器的实现方案")
```

### 并行执行
```bash
# 同时执行多个独立任务
Task(Explore, "任务1") &
Task(Explore, "任务2") &
Task(Explore, "任务3")
```

---

*文档路径：docs/dev-guides/AGENT_WORKFLOW.md*
