# DivineSense 聊天应用接入用户指南

> **零门槛入门** — 将 DivineSense AI 连接到您常用的聊天应用，随时随地享受智能助手服务。

---

## 目录

1. [功能介绍](#功能介绍)
2. [支持的平台](#支持的平台)
3. [快速开始](#快速开始)
4. [Telegram 配置指南](#telegram-配置指南)
5. [WhatsApp 配置指南](#whatsapp-配置指南)
6. [钉钉配置指南](#钉钉配置指南)
7. [使用方法](#使用方法)
8. [常见问题](#常见问题)
9. [故障排查](#故障排查)

---

## 功能介绍

**DivineSense 聊天应用接入** 功能允许您将 AI 助手连接到日常使用的聊天应用中。配置完成后，您可以直接在 Telegram、WhatsApp 或钉钉中与 DivineSense AI 对话，无需打开网页或特殊应用。

### 核心功能

- **双向对话** — 在聊天应用中直接发送消息，AI 回复会自动推送回来
- **多平台支持** — 同时支持 Telegram、WhatsApp、钉钉
- **媒体处理** — 支持发送和接收图片、文件等媒体内容
- **安全加密** — 所有访问令牌使用 AES-256-GCM 加密存储
- **即时生效** — 启用/禁用开关，随时控制消息接收
- **智能路由** — 自动选择合适的 AI 代理处理您的请求

### 使用场景

| 场景 | 描述 | 推荐平台 |
|:-----|:-----|:---------|
| **移动办公** | 出门在外，用手机通过 Telegram 快速查询笔记或日程 | Telegram |
| **团队协作** | 在钉钉群中直接询问 AI 问题，提高团队效率 | 钉钉 |
| **海外沟通** | 通过 WhatsApp 与海外客户沟通时，AI 实时辅助 | WhatsApp |
| **个人助理** | 随时随地让 AI 帮您记录灵感、提醒事项 | 任意 |

---

## 支持的平台

| 平台 | 类型 | 推荐场景 | 特点 |
|:-----|:-----|:---------|:-----|
| **Telegram** | Bot API | 个人用户、海外用户 | 稳定、功能丰富、支持长消息、流式响应 |
| **WhatsApp** | Baileys 桥接 | 海外用户、个人联系 | 使用广泛、无需额外应用、支持媒体 |
| **钉钉** | 企业机器人 | 国内企业用户 | 与工作流集成、支持群聊、HMAC 签名验证 |

---

## 快速开始

### 前置条件检查

在开始配置之前，请确认：

- [ ] 您已经有 DivineSense 账号并可以登录
- [ ] 您的 DivineSense 服务器可以从外网访问（或已配置内网穿透）
- [ ] 您有聊天平台的基本操作权限

### 配置流程概览

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  1. 选择平台    │ -> │  2. 获取凭证    │ -> │  3. 配置系统    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                                        v
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  5. 开始对话！   │ <- │  4. 测试连接    │ <- │  4. 绑定账号    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## Telegram 配置指南

Telegram 是最推荐的入门平台，配置简单，功能稳定。

### 第一步：创建 Telegram Bot

1. **打开 Telegram**，在搜索框中输入 `@BotFather`

2. **点击开始对话**，发送 `/newbot` 命令

3. **按照提示操作**：
   ```
   BotFather: 好的，请给您的机器人起个名字
   您: 我的AI助手

   BotFather: 很好！现在请给机器人一个用户名（必须以 bot 结尾）
   您: MyDivineSenseBot
   ```

4. **保存 Bot Token**

   BotFather 会返回一个类似这样的 Token：
   ```
   1234567890:ABCDefGhIJKlMnOPqrSTUvwxYZ-1234567890
   ```

   ⚠️ **请妥善保管此 Token**，不要泄露给他人！

### 第二步：获取您的 Telegram User ID

1. **搜索并打开** `@userinfobot`

2. **点击** `Start` 按钮

3. **机器人会返回您的 User ID**，例如：
   ```
   Id: 123456789
   ```

4. **记下这个数字**，后面配置时会用到

### 第三步：在 DivineSense 中配置

1. **登录 DivineSense**，进入 **设置** 页面

2. **点击左侧菜单** 中的 **「聊天应用」**

3. **点击右上角** 「添加账号」按钮

4. **填写表单**：

   | 字段 | 填写内容 | 示例 |
   |:-----|:---------|:-----|
   | 平台 | 选择 `Telegram` | — |
   | 平台用户 ID | 您的 Telegram User ID | `123456789` |
   | 访问令牌 | Bot Token（从 BotFather 获取） | `1234567890:ABCDef...` |

5. **点击** 「确认」完成配置

### 第四步：设置 Webhook（推荐）

1. **在 DivineSense 设置页面**，找到刚添加的 Telegram 账号

2. **复制显示的 Webhook URL**，格式类似：
   ```
   https://your-domain.com/api/v1/chat_apps/webhook?platform=telegram
   ```

3. **回到 Telegram**，打开 `@BotFather` 对话

4. **发送命令**：
   ```
   /setwebhook
   ```

5. **选择您的机器人**

6. **粘贴 Webhook URL** 并发送

7. **成功提示**：
   ```
   Webhook was set!
   ```

### 第五步：测试连接

1. **打开 Telegram**，找到您创建的机器人

2. **点击** `Start` 按钮或发送 `/start`

3. **发送任意消息**，例如：
   ```
   你好
   ```

4. **如果配置正确**，DivineSense AI 会回复您！

---

## WhatsApp 配置指南

WhatsApp 使用 Baileys 桥接服务，需要在服务器上运行一个 Node.js 程序。

### 架构说明

```
┌─────────────┐     HTTP      ┌─────────────────┐     Webhook     ┌──────────────┐
│  WhatsApp   │ ◄────────────► │  Baileys Bridge │ ◄──────────────► │ DivineSense  │
│   (手机)     │                │  (Node.js 服务) │                  │   (后端)     │
└─────────────┘                └─────────────────┘                  └──────────────┘
                                       │
                                       │ QR 码配对
                                       ▼
                                扫描连接设备
```

### 第一步：启动 Baileys 桥接服务

**开发环境**：

```bash
cd plugin/chat_apps/channels/whatsapp/bridge
npm install
npm start
```

**生产环境**（使用 PM2）：

```bash
cd /opt/divinesense/plugin/chat_apps/channels/whatsapp/bridge
npm install
pm2 start src/index.js --name baileys-bridge
pm2 save
```

### 第二步：获取 QR 码

启动后，终端会显示：

```
==================================================
  QR Code - Scan with WhatsApp
  Settings → Linked Devices → Link a Device
==================================================

█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀██
█ ▄▄▄▄▄ ▄▄ ▄▄▄▄▄▄▄ ▄▄▄▄▄▄▄ ▄▄ ▄▄▄▄▄ ▄▄▄▄▄▄▄ ▄▄▄██
█ █   █ █ █ █       █       █ █ █   █ █     █   ███
█ █▄▄▄█ █ █ █▄▄▄▄▄▄▄█ █▄▄▄▄▄▄▄█ █ █   █ █▄▄▄▄▄█   ███
█     █ █       █       █       █ █   █       █   ███
█ ▄▄▄▄▄ █ █▄▄▄▄▄▄▄█ █▄▄▄▄▄▄▄█ █▄▄▄█ █▄▄▄▄▄█ █▄▄▄██
█                                                   █
█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀██

Or visit: http://localhost:3001/info
```

### 第三步：扫码绑定

1. **打开 WhatsApp** 手机应用

2. **进入设置**：
   - **Android**: ⋮ 菜单 → 设置
   - **iOS**: 设置 ⚙️

3. **点击**「已连接的设备」或「链接设备」

4. **点击**「链接设备」或「关联设备」

5. **扫描终端中显示的 QR 码**

6. **扫描成功后**，终端显示：
   ```
   ==================================================
     ✅ WhatsApp connection opened successfully!
   ==================================================
   ```

### 第四步：在 DivineSense 中配置

1. **登录 DivineSense**，进入 **设置 → 聊天应用**

2. **点击** 「添加账号」

3. **填写表单**：

   | 字段 | 填写内容 |
   |:-----|:---------|
   | 平台 | 选择 `WhatsApp` |
   | Bridge URL | 桥接服务地址（如 `http://localhost:3001`） |
   | 平台用户 ID | 留空（系统自动获取） |

4. **点击** 「确认」

### 第五步：测试连接

1. **给任意联系人**（包括您自己）发送消息到已连接的 WhatsApp 号码

2. **DivineSense AI 会自动回复**

---

## 钉钉配置指南

钉钉机器人适合国内企业用户，可以集成到钉钉群聊中。

### 第一步：创建钉钉应用

1. **登录** [钉钉开放平台](https://open.dingtalk.com/)

2. **进入**「应用开发」→「企业内部开发」→「机器人」

3. **点击**「创建应用」，填写基本信息：
   - 应用名称：`DivineSense AI`
   - 应用描述：`智能助手服务`

4. **创建完成后**，在「应用凭证」页面获取：
   - **AppKey**（也叫 ClientId）
   - **AppSecret**（也叫 ClientSecret）

### 第二步：配置消息接收

1. **在应用开发页面**，进入「消息推送」

2. **配置**消息推送地址：
   ```
   https://your-domain.com/api/v1/chat_apps/webhook?platform=dingtalk
   ```

3. **保存** 并记录 AppKey 和 AppSecret

### 第三步：添加机器人到群聊

1. **在钉钉群聊**中，点击右上角 `...` →「智能群助手」

2. **点击**「添加机器人」→「自定义」

3. **搜索并选择**您创建的应用

4. **完成添加**

### 第四步：在 DivineSense 中配置

1. **登录 DivineSense**，进入 **设置 → 聊天应用**

2. **点击** 「添加账号」

3. **填写表单**：

   | 字段 | 填写内容 | 示例 |
   |:-----|:---------|:-----|
   | 平台 | 选择 `钉钉` | — |
   | 平台用户 ID | 您的钉钉工号或 Union ID | `manager1234` |
   | 访问令牌 | AppKey | `dingxxxxx` |
   | 应用密钥 | AppSecret | `SEC...` |

4. **点击** 「确认」

### 第五步：测试连接

1. **在钉钉群中** @机器人
2. **发送消息**，例如：
   ```
   @DivineSenseAI 你好
   ```
3. **机器人会回复**

---

## 使用方法

### 基础对话

配置完成后，您可以在聊天应用中直接发送消息：

```
你: 你今天有什么安排？
AI: 让我查询一下...（查询日程）
```

### 支持的功能

| 功能类型 | 示例命令 | 说明 |
|:---------|:---------|:-----|
| **笔记查询** | `搜索关于 Python 的笔记` | 语义搜索笔记 |
| **日程查询** | `今天有什么会议？` | 查询日程安排 |
| **日程创建** | `明天下午3点提醒我开会` | 创建新日程 |
| **综合查询** | `总结这周的工作` | 组合查询 |

### AI 代理介绍

DivineSense 会根据您的问题自动选择最合适的 AI 代理：

| 代理 | 名称 | 擅长领域 | 触发关键词 |
|:-----|:-----|:---------|:-----------|
| **MEMO** | 灰灰 | 笔记搜索、知识查询 | 笔记、搜索、查找、写过、关于 |
| **SCHEDULE** | 时巧 | 日程管理、时间提醒 | 日程、会议、提醒、今天、明天、周X |
| **AMAZING** | 折衷 | 复杂任务、多数据源查询 | 综合、总结、本周工作、周报 |

---

## 常见问题

### Q1: 为什么收不到 AI 的回复？

**可能原因和解决方案**：

| 原因 | 解决方案 |
|:-----|:---------|
| Webhook 未设置 | 参考各平台的「设置 Webhook」步骤 |
| 凭证被禁用 | 在设置中检查账号状态，确保「已启用」 |
| 网络问题 | 检查服务器网络连接和防火墙设置 |
| Bot Token 错误 | 重新验证 Token 是否正确 |

### Q2: Telegram 提示 "Bot was blocked by the user"

**解决方法**：

1. 打开与机器人的对话
2. 点击 `Start` 或发送 `/start`
3. 如果还不行，点击 `Stop` 后重新 `Start`

### Q3: WhatsApp 二维码过期怎么办？

**解决方法**：

1. 删除 `baileys_auth_info.json` 文件
2. 重启桥接服务：`pm2 restart baileys-bridge`
3. 重新扫描新的 QR 码

### Q4: 钉钉机器人只返回配置信息，不回复我的消息？

**解决方法**：

1. 检查群机器人设置，确保已正确添加到群聊
2. 确认使用 @机器人的方式发送消息
3. 检查 DivineSense 服务器能接收外网请求

### Q5: 如何同时使用多个平台？

**答**：完全可以！您可以为同一个 DivineSense 账号配置多个平台的凭证。AI 会根据消息来源平台进行回复。

### Q6: AI 响应速度慢怎么办？

**可能原因**：
- 网络延迟
- AI 服务负载较高
- 查询数据量大

**解决方法**：
- 尝试更简洁的查询语句
- 避免高峰时段使用
- 联系管理员检查服务器状态

---

## 故障排查

### 检查清单

使用以下清单快速诊断问题：

```
□ DivineSense 服务运行正常
□ 聊天应用账号已启用
□ Webhook URL 正确配置
□ 网络连接正常
□ Token/密钥 未过期
□ 防火墙允许外部访问
□ 桥接服务（WhatsApp）正在运行
```

### 获取调试信息

#### Telegram

1. **向 BotFather 发送** `/getwebhook`
2. **查看 webhook 状态**和最近错误
3. **检查 webhook URL** 是否正确

#### WhatsApp

1. **查看桥接服务日志**：
   ```bash
   pm2 logs baileys-bridge
   ```

2. **检查连接状态**：
   ```bash
   curl http://localhost:3001/health
   ```

3. **查看 QR 码**：
   ```bash
   curl http://localhost:3001/info
   ```

#### 钉钉

1. **在钉钉开放平台**查看消息推送日志
2. **检查应用凭证**是否正确
3. **验证服务器时间**与钉钉服务器同步

### 常见错误码

| 错误 | 含义 | 解决方案 |
|:-----|:-----|:---------|
| `401 Unauthorized` | Token 无效或过期 | 重新获取 Token |
| `403 Forbidden` | 用户被禁用或 Bot 被封禁 | 检查账号状态 |
| `404 Not Found` | API 端点不存在 | 检查 URL 配置 |
| `500 Internal Server Error` | 服务器错误 | 查看服务器日志 |
| `502 Bad Gateway` | 桥接服务不可用 | 重启桥接服务 |

### 联系支持

如果以上方法都无法解决问题：

1. 访问 [GitHub Issues](https://github.com/hrygo/divinesense/issues)
2. 查看是否有相同问题
3. 提交新问题时，请提供：
   - 平台类型（Telegram/WhatsApp/钉钉）
   - 错误信息截图
   - 服务器日志片段
   - 操作步骤描述

---

## 安全建议

1. **定期更换 Token** — 建议每 3-6 个月更换一次
2. **使用强密钥** — 确保 `DIVINESENSE_CHAT_APPS_SECRET_KEY` 已设置
3. **限制访问** — Webhook URL 不要泄露给无关人员
4. **监控日志** — 定期检查异常访问记录
5. **备份凭证** — 定期备份 `baileys_auth_info.json` 文件

---

**最后更新**: 2026-02-03
**相关文档**: [技术规格](../archived/specs/20260207_archive/chat-apps-integration.md) | [系统架构](../dev-guides/ARCHITECTURE.md)
