# DivineSense Memo Search 混合检索终版架构

> 基于混合检索最佳实践 (RRF + Rerank + 质量评估) 设计
> 版本: v1.0 | 更新日期: 2026-02-16

## 1. 架构概述

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DivineSense Memo Search 混合检索架构                    │
│                           (Hybrid Search Pipeline)                          │
└─────────────────────────────────────────────────────────────────────────────┘

                                    用户查询
                                     "Go 语言 Golang 编程"
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          入口: MemoSearchTool                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 解析输入 JSON                                                     │   │
│  │  • 设置默认值 (Limit=10, MinScore=0.5)                              │   │
│  │  • 意图分类 → 策略选择                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      第一阶段: 意图分类 (0ms, 零资源)                         │
└─────────────────────────────────────────────────────────────────────────────┘
         │                              │                              │
         ▼                              ▼                              ▼
   ┌───────────┐                 ┌───────────┐                 ┌───────────┐
   │ IntentList│                 │IntentFilter│                │IntentSemantic│
   │ (列表意图)│                 │ (过滤意图) │                 │ (语义意图)  │
   │近期笔记   │                 │2026年1月  │                 │Go 编程    │
   └─────┬─────┘                 └─────┬─────┘                 └─────┬─────┘
         │                               │                               │
         └───────────────────────────────┼───────────────────────────────┘
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    第二阶段: 并行检索 (Parallel Retrieval)                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                         │
                    ┌────────────────────┴────────────────────┐
                    │                                         │
                    ▼                                         ▼
         ┌──────────────────┐                  ┌──────────────────┐
         │   向量检索通道    │                  │   BM25 检索通道   │
         │  (Dense Search)  │                  │  (Sparse Search) │
         └────────┬─────────┘                  └────────┬─────────┘
                  │                                    │
                  ▼                                    ▼
    ┌─────────────────────┐               ┌─────────────────────┐
    │ embeddingService    │               │   store.BM25Search  │
    │      .Embed()        │               │                     │
    └──────────┬──────────┘               └──────────┬──────────┘
               │                                        │
               ▼                                        ▼
    ┌─────────────────────┐               ┌─────────────────────┐
    │ store.VectorSearch()│               │  FTS5 bm25() 或    │
    │  Top 20 (可配置)    │               │  LIKE 模糊匹配     │
    │  + 时间过滤 (90天)  │               │  Top 20 (可配置)   │
    └──────────┬──────────┘               └──────────┬──────────┘
               │                                        │
               │  ┌─────────────────────────────────────┘
               │  │
               ▼  ▼
    ┌─────────────────────┐
    │  分数归一化         │
    │  (Normalization)   │
    │                     │
    │  向量: 0-1 (原声)  │
    │  BM25: Min-Max     │
    │    → [0, 1]        │
    └──────────┬──────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    第三阶段: RRF 融合 (Reciprocal Rank Fusion)              │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │                     RRF 融合公式                                      │
    │                                                                     │
    │         RRF(d) = Σ 1/(k + rank_i(d))                               │
    │                                                                     │
    │    • k = 60 (标准值)                                               │
    │    • rank_i(d): 文档在第 i 个检索结果中的排名                       │
    │    • 支持并行多路: 向量 + BM25 + 过滤列表                           │
    │                                                                     │
    │    动态权重策略:                                                    │
    │    ┌─────────────────────────────────────────────────────────┐      │
    │    │ 质量等级        │  semanticWeight  │ 说明              │      │
    │    ├─────────────────┼──────────────────┼───────────────────┤      │
    │    │ High (≥0.90)   │      0.8         │ 信任语义结果       │      │
    │    │ Medium(≥0.70)  │      0.5         │ 平衡权重          │      │
    │    │ Low   (<0.70)  │      0.3         │ 偏向 BM25         │      │
    │    └─────────────────┴──────────────────┴───────────────────┘      │
    └─────────────────────────────────────────────────────────────────────┘

               │
               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    第四阶段: 质量评估 (Quality Check)                       │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │                    evaluateQuality(results)                          │
    │                                                                     │
    │    输入: RRF 融合后的结果列表 (Top 20)                              │
    │                                                                     │
    │    判断逻辑:                                                        │
    │    ┌─────────────────────────────────────────────────────────┐      │
    │    │                                                         │      │
    │    │  if topScore ≥ 0.90 OR gap ≥ 0.20                     │      │
    │    │       → HighQuality                                     │      │
    │    │  else if topScore ≥ 0.70                               │      │
    │    │       → MediumQuality                                   │      │
    │    │  else                                                  │      │
    │    │       → LowQuality                                     │      │
    │    │                                                         │      │
    │    └─────────────────────────────────────────────────────────┘      │
    │                                                                     │
    │    输出: QualityLevel + 动态 semanticWeight                        │
    └─────────────────────────────────────────────────────────────────────┘

               │
    ┌──────────┼──────────┐
    │          │          │
    ▼          ▼          ▼
 High      Medium       Low
    │          │          │
    │          │          └─────────────────────┐
    │          │                                │
    │          ▼                                ▼
    │    ┌──────────────┐              ┌──────────────────┐
    │    │ 扩展候选集   │              │ 扩展候选集       │
    │    │ Top 20→50   │              │ Top 20→100      │
    │    └──────────────┘              └──────────────────┘
    │          │                                │
    └──────────┴────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    第五阶段: Rerank 重排序 (必选)                           │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │                    shouldRerank()                                    │
    │                                                                     │
    │    触发条件:                                                        │
    │    • Reranker 已配置且启用                                         │
    │    • 结果数量 ≥ 3                                                  │
    │    • 质量 ≠ High (High 质量可跳过，节省开销)                       │
    │                                                                     │
    │    不触发:                                                         │
    │    • Reranker 未配置                                               │
    │    • 结果数量 < 3                                                  │
    │    • 已是高质量 (topScore ≥ 0.90)                                 │
    └─────────────────────────────────────────────────────────────────────┘

               │
               ▼
    ┌────────────────────────────────┐
    │    rerankerService.Rerank()    │
    │                                │
    │    • 输入: Query + Documents   │
    │    • 模型: Cross-Encoder      │
    │    • 输出: 重排序后的分数     │
    │                                │
    └───────────────┬────────────────┘
                    │
                    ▼
    ┌────────────────────────────────┐
    │    按 Rerank 分数重排序        │
    │    + 分数语义: "相关" (1.0)   │
    │                                │
    │    当 topScore < 0.70 时:     │
    │    • 隐藏不可靠的原始分数     │
    │    • 显示 "相关" 而非 55%    │
    └───────────────┬────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    第六阶段: 后处理 (Post-Processing)                        │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │                                                                     │
    │  1. 分数语义化                                                       │
    │     ┌─────────────────────────────────────────────────────────┐    │
    │     │  topScore ≥ 0.70  → 显示百分比: "85%"                  │    │
    │     │  topScore < 0.70  → 显示 "相关"                        │    │
    │     └─────────────────────────────────────────────────────────┘    │
    │                                                                     │
    │  2. 截断结果                                                        │
    │     • 返回 Top K (默认 10)                                        │
    │                                                                     │
    │  3. 格式化为 Markdown 表格                                          │
    │     | # | 标题 | 相关度 | 摘要 |                                   │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘

               │
               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              返回结果                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  Markdown 表格 → JSON → LLM → 用户                                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 核心组件设计

### 2.1 并行检索器 (Parallel Retriever)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ParallelRetriever                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  func (r *ParallelRetriever) Retrieve(ctx, query, userID)      │
│      │                                                           │
│      ├───► go vectorSearch(ctx, query, userID) ──► Ch1         │
│      │                                                           │
│      └───► go bm25Search(ctx, query, userID)  ──► Ch2         │
│                                                               │
│      wait Ch1, Ch2                                            │
│                                                               │
│      ├───► normalizeScores() ◄── 关键: 归一化                  │
│      │                                                           │
│      └───► rrfFusion(vectorResults, bm25Results, weight)      │
│                                                               │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 质量评估器 (Quality Evaluator)

```
┌─────────────────────────────────────────────────────────────────┐
│                    QualityEvaluator                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  type QualityLevel: High | Medium | Low                        │
│                                                                 │
│  func (e *Evaluator) Evaluate(results []*SearchResult)          │
│      │                                                           │
│      ├───► 计算 topScore (最高分数)                              │
│      ├───► 计算 scoreGap (最高-最低分数差)                      │
│      │                                                           │
│      └───► 返回 QualityLevel + semanticWeight                  │
│                                                               │
│  决策矩阵:                                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 条件                          │ 质量  │ semanticWeight  │   │
│  ├────────────────────────────────┼───────┼─────────────────┤   │
│  │ topScore ≥ 0.90 OR gap ≥ 0.20 │ High  │      0.8       │   │
│  │ topScore ≥ 0.70               │Medium │      0.5       │   │
│  │ topScore < 0.70               │ Low   │      0.3       │   │
│  └────────────────────────────────┴───────┴─────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 分数管理器 (Score Manager)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ScoreManager                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  func (m *ScoreManager) Normalize(results []*SearchResult)      │
│      │                                                           │
│      ├───► 向量分数: 直接使用 (已是 0-1 范围)                   │
│      │                                                           │
│      └───► BM25 分数: Min-Max 归一化                          │
│              │                                                   │
│              ├───► 原始分数: [min, max]                         │
│              ├───► 归一化: (score - min) / (max - min)         │
│              └───► 结果: [0, 1] 范围                           │
│                                                               │
│  func (m *ScoreManager) ToDisplay(score float32) string        │
│      │                                                           │
│      ├───► score ≥ 0.70 → fmt.Sprintf("%.0f%%", score*100)   │
│      │                                                           │
│      └───► score < 0.70 → "相关"                               │
│                                                               │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 最佳实践对照表

| 最佳实践 | 当前实现 | 终版设计 | 优先级 |
|---------|---------|---------|-------|
| 并行检索 | 部分并行 | 完全并行 (goroutine) | P0 |
| 分数归一化 | ❌ 无 | Min-Max → [0,1] | P0 |
| RRF 融合 | 固定权重 | 动态权重 (根据质量) | P0 |
| 质量评估 | ✅ 已有 | 扩展决策矩阵 | P1 |
| Rerank | 可选 | 必选 (非 High 时) | P0 |
| 候选集扩展 | Top 10 | 动态扩展 (20-100) | P1 |
| 分数语义化 | ❌ 显示原始值 | "相关" / 百分比 | P1 |
| FTS5 中文分词 | ❌ 无 | unicode61 | P0 |

## 4. 配置项

```yaml
# config/parrots/memo.yaml (新增)
retrieval:
  # 并行检索配置
  parallel:
    enabled: true
    vector_limit: 20
    bm25_limit: 20

  # RRF 融合配置
  rrf:
    k: 60  # 标准值
    dynamic_weight: true  # 动态权重

  # 质量评估配置
  quality:
    high_threshold: 0.90
    medium_threshold: 0.70
    expand_on_low: true
    low_candidate_limit: 100

  # Rerank 配置
  rerank:
    enabled: true
    min_results: 3
    skip_on_high_quality: true

  # 分数显示配置
  display:
    show_percentage: true
    low_quality_display: "相关"  # 低于阈值时显示
```

## 5. 改进路线图

```
Phase 1 (P0 - 阻塞问题)
├── [ ] FTS5 中文分词器配置 (unicode61)
├── [ ] 分数归一化 (Min-Max)
└── [ ] Rerank 必选 (非 High 时)

Phase 2 (P1 - 质量提升)
├── [ ] 动态语义权重
├── [ ] 候选集动态扩展
├── [ ] 分数语义化显示
└── [ ] 并行检索优化

Phase 3 (P2 - 高级特性) ✅
├── [x] 多路 RRF (向量 + BM25 + 过滤)
├── [x] 自适应候选集大小
└── [x] 质量自适应策略
```

## 6. 预期收益

| 指标 | 当前 | 终版 | 提升 |
|-----|------|------|------|
| 中文查询成功率 | ~50% (fallback) | ~95% | +45% |
| 排序质量 (NDCG) | 中等 | 高 | +20% |
| 分数可解释性 | ❌ | ✅ | 清晰 |
| 延迟 (P99) | <2s | <2s | 持平 |

---

*文档版本: v1.0 | 基于混合检索最佳实践设计 | 2026-02-16*
