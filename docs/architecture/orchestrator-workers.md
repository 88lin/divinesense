# Orchestrator-Workers æ¶æ„

> DivineSense å¤šä»£ç†åä½œæ¶æ„

---

## 1. æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  ç”¨æˆ·è¾“å…¥                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FastRouter (å¿«é€Ÿè·¯ç”±)                               â”‚
â”‚                                                                                 â”‚
â”‚   Cache â†’ Rule â†’ Confidence                                                     â”‚
â”‚                                                                                 â”‚
â”‚   è¾“å‡º: ç›´æ¥è·¯ç”± / Orchestrator ç¼–æ’                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚                   â”‚
                    â–¼                   â–¼                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Memo Expert â”‚     â”‚Sched Expert â”‚     â”‚Orchestrator â”‚
            â”‚   (ç›´æ¥)    â”‚     â”‚   (ç›´æ¥)    â”‚     â”‚   (ç¼–æ’)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                   â”‚                   â”‚
                   â”‚                   â”‚                   â–¼
                   â”‚                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                   â”‚    â”‚         Orchestrator            â”‚
                   â”‚                   â”‚    â”‚                                 â”‚
                   â”‚                   â”‚    â”‚  Decomposer â†’ Executor â†’ Agg    â”‚
                   â”‚                   â”‚    â”‚        â”‚         â”‚              â”‚
                   â”‚                   â”‚    â”‚        â–¼         â–¼              â”‚
                   â”‚                   â”‚    â”‚  TaskPlan   HandoffHandler      â”‚
                   â”‚                   â”‚    â”‚                    â”‚            â”‚
                   â”‚                   â”‚    â”‚                    â–¼            â”‚
                   â”‚                   â”‚    â”‚              CapabilityMap      â”‚
                   â”‚                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                   â”‚                         â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   Expert Pool   â”‚
                            â”‚                 â”‚
                            â”‚  Memo | Sched   â”‚
                            â”‚  (é…ç½®é©±åŠ¨)     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Final Response â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒç»„ä»¶

### 2.1 FastRouter

å¿«é€Ÿæ„å›¾è¯†åˆ«ä¸è·¯ç”±ã€‚

| ç»„ä»¶       | åŠŸèƒ½                | å»¶è¿Ÿ |
| :--------- | :------------------ | :--- |
| Cache      | ç¼“å­˜è·¯ç”±å†³ç­–        | ~0ms |
| Rule       | è§„åˆ™åŒ¹é… + å†å²åˆ†æ | ~0ms |
| Confidence | ç½®ä¿¡åº¦è¯„ä¼°          | -    |

**è·¯ç”±å†³ç­–**ï¼š

| ç½®ä¿¡åº¦ | è¾“å‡º                   |
| :----- | :--------------------- |
| â‰¥ 0.8  | ç›´æ¥è·¯ç”±åˆ°ä¸“å®¶         |
| < 0.8  | äº¤ç»™ Orchestrator ç¼–æ’ |

### 2.2 Orchestrator

ä»»åŠ¡ç¼–æ’æ ¸å¿ƒï¼ŒåŒ…å«å››ä¸ªå­ç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Orchestrator                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Decomposer â”‚â”€â”€â†’â”‚  Executor  â”‚â”€â”€â†’â”‚ Aggregator â”‚          â”‚
â”‚  â”‚ ä»»åŠ¡åˆ†è§£   â”‚   â”‚ ä»»åŠ¡æ‰§è¡Œ   â”‚   â”‚ ç»“æœèšåˆ   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â–¼                                   â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                  â”‚  Handoff   â”‚                             â”‚
â”‚                  â”‚  Handler   â”‚                             â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                        â”‚                                    â”‚
â”‚                        â–¼                                    â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                 â”‚CapabilityMapâ”‚                             â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Decomposerï¼ˆä»»åŠ¡åˆ†è§£å™¨ï¼‰

```yaml
é…ç½®: config/orchestrator/decomposer.yaml

æµç¨‹:
  1. ç†è§£æ„å›¾
  2. åŒ¹é…ä¸“å®¶
  3. ä»»åŠ¡åˆ†è§£
  4. ä¾èµ–åˆ†æ

è¾“å‡º: TaskPlan
```

#### Executorï¼ˆä»»åŠ¡æ‰§è¡Œå™¨ï¼‰

```go
MaxConcurrency: 3           // æœ€å¤§å¹¶è¡Œæ•°
Strategy: goroutine + semaphore

Events:
  - plan        // ä»»åŠ¡è®¡åˆ’
  - task_start  // ä»»åŠ¡å¼€å§‹
  - task_end    // ä»»åŠ¡ç»“æŸ
  - handoff     // ä»»åŠ¡è½¬äº¤
```

#### Aggregatorï¼ˆç»“æœèšåˆå™¨ï¼‰

```yaml
é…ç½®: config/orchestrator/aggregator.yaml

è§¦å‘: plan.aggregate == true && tasks > 1

ç­–ç•¥:
  - Primary: LLM èåˆ
  - Fallback: ç®€å•æ‹¼æ¥
```

#### HandoffHandlerï¼ˆä»»åŠ¡è½¬äº¤å¤„ç†å™¨ï¼‰

å¤„ç†ç²˜æ€§è·¯ç”±åœºæ™¯ä¸‹ä¸“å®¶èƒ½åŠ›ä¸è¶³çš„æƒ…å†µã€‚

**æ ¸å¿ƒæ´å¯Ÿ**ï¼š

```
"èƒ½åš"æœ‰é™å¯æšä¸¾ â†’ ä¸“å®¶å£°æ˜ capabilities
"ä¸èƒ½åš"æ— é™ä¸å¯ç©·å°½ â†’ ä¸“å®¶ä¸å£°æ˜ï¼Œè¿è¡Œæ—¶æŠ¥å‘Š
```

**æµç¨‹**ï¼š

```
ä¸“å®¶æ‰§è¡Œ â†’ å‘ç°è¶…å‡ºèƒ½åŠ› â†’ æŠ¥å‘Š MissingCapability
                              â†“
                    Orchestrator æŸ¥è¯¢ CapabilityMap
                              â†“
                    Handoff to ç›®æ ‡ä¸“å®¶ â†’ è¿”å›ç»“æœ
```

### 2.3 CapabilityMap

è¿è¡Œæ—¶æ„å»ºçš„èƒ½åŠ›åˆ°ä¸“å®¶æ˜ å°„ã€‚

```go
// ä» config/parrots/*.yaml çš„ capabilities èšåˆ
{
    "æœç´¢ç¬”è®°å†…å®¹":   ["memo"],
    "æŒ‰æ—¶é—´æµè§ˆç¬”è®°": ["memo"],
    "åˆ›å»ºæ—¥ç¨‹":       ["schedule"],
    "æŸ¥è¯¢æ—¥ç¨‹å®‰æ’":   ["schedule"],
}
```

### 2.4 Expert Pool

é…ç½®é©±åŠ¨çš„ä¸“å®¶æ± ã€‚

| Expert    | ç¬¦å· | èƒ½åŠ›                                         |
| :-------- | :--- | :------------------------------------------- |
| Memo      | ğŸ“    | æœç´¢ç¬”è®°ã€æµè§ˆç¬”è®°                           |
| Schedule  | ğŸ“…    | åˆ›å»º/æŸ¥è¯¢/ä¿®æ”¹æ—¥ç¨‹                           |
| Geek      | ğŸ’»    | **CCRunner v2.0**: Hot-Multiplexing ä»£ç æ‰§è¡Œ |
| Evolution | ğŸ§¬    | **CCRunner v2.0**: è‡ªæˆ‘è¿›åŒ–ä¸ä»£ç ä¿®æ”¹        |

**ä¸“å®¶é…ç½®åŸåˆ™**ï¼š

| å£°æ˜                       | ä¸å£°æ˜                                 |
| :------------------------- | :------------------------------------- |
| `capabilities`ï¼ˆèƒ½åšä»€ä¹ˆï¼‰ | `limitations`ï¼ˆä¸èƒ½åšä»€ä¹ˆ - æ— æ³•ç©·å°½ï¼‰ |
|                            | `handoff_triggers`ï¼ˆæ¶‰åŠ"ä¸èƒ½"ï¼‰       |

---

## 3. æ•°æ®æµ

### 3.1 æ­£å¸¸æµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
FastRouter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                     â”‚
    â”œâ”€[é«˜ç½®ä¿¡åº¦]â†’ ç›´æ¥è·¯ç”± â†’ Expert â†’ å“åº”  â”‚
    â”‚                                     â”‚
    â””â”€[ä½ç½®ä¿¡åº¦]                          â”‚
              â”‚                           â”‚
              â–¼                           â”‚
        Decomposer                        â”‚
              â”‚                           â”‚
              â–¼                           â”‚
         TaskPlan                         â”‚
              â”‚                           â”‚
              â–¼                           â”‚
          Executor                        â”‚
              â”‚                           â”‚
              â–¼                           â”‚
        Expert Pool                       â”‚
              â”‚                           â”‚
              â–¼                           â”‚
         Aggregator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
          å“åº”
```

### 3.2 Handoff æµç¨‹

**åœºæ™¯**ï¼šç²˜æ€§è·¯ç”±åçš„ä¸Šä¸‹æ–‡åˆ‡æ¢

```
å¯¹è¯è½®æ¬¡ 1:
ç”¨æˆ·: "å¸®æˆ‘æ‰¾ä¸€ä¸‹ PostgreSQL ä¼˜åŒ–çš„ç¬”è®°"
    â”‚
    â–¼
FastRouter â†’ Orchestrator â†’ Memo Expert â†’ æˆåŠŸ

å¯¹è¯è½®æ¬¡ 2ï¼ˆç²˜æ€§è·¯ç”±ï¼‰:
ç”¨æˆ·: "æ‰¾åˆ°äº†ï¼Œé¡ºä¾¿å¸®æˆ‘å®‰æ’ä¸ªä¼šè®¨è®ºä¸€ä¸‹"
    â”‚
    â–¼
Memo Expertï¼ˆç²˜æ€§è·¯ç”±ä¿æŒä¸Šä¸‹æ–‡ï¼‰
    â”‚
    â””â†’ "å®‰æ’ä¼šè®®" è¶…å‡ºèƒ½åŠ›
              â”‚
              â–¼
       æŠ¥å‘Š MissingCapability: "åˆ›å»ºæ—¥ç¨‹"
              â”‚
              â–¼
       HandoffHandler
              â”‚
              â”œâ†’ CapabilityMap: "åˆ›å»ºæ—¥ç¨‹" â†’ [schedule]
              â”‚
              â””â†’ Handoff to Schedule Expert
                        â”‚
                        â–¼
                 Schedule Expert â†’ æˆåŠŸ â†’ å“åº”
```

---

## 4. é…ç½®ç»“æ„

```
config/
â”œâ”€â”€ orchestrator/
â”‚   â”œâ”€â”€ decomposer.yaml     # ä»»åŠ¡åˆ†è§£æç¤ºè¯
â”‚   â””â”€â”€ aggregator.yaml     # ç»“æœèšåˆæç¤ºè¯
â”‚
â””â”€â”€ parrots/
    â”œâ”€â”€ memo.yaml           # Memo Expert é…ç½®
    â””â”€â”€ schedule.yaml       # Schedule Expert é…ç½®
```

### ä¸“å®¶é…ç½®ç¤ºä¾‹

```yaml
# config/parrots/memo.yaml
name: memo
display_name: Memo Parrot
emoji: "ğŸ“"

strategy: react
max_iterations: 10
tools:
  - memo_search

system_prompt: |
  ä½ æ˜¯ç¬”è®°æœç´¢ä¸“å®¶...

# ä¸“å®¶åªå£°æ˜èƒ½åŠ›ï¼Œä¸å£°æ˜"ä¸èƒ½"
self_description:
  name: memo
  title: "ç¬”è®°æœç´¢ä¸“å®¶"
  capabilities:
    - "æœç´¢ç¬”è®°å†…å®¹"
    - "æŒ‰æ—¶é—´æµè§ˆç¬”è®°"
    - "æŸ¥æ‰¾ç‰¹å®šè¯é¢˜çš„è®°å½•"
```

---

## 5. è®¾è®¡å†³ç­–

### 5.1 ä¸¤çº§è·¯ç”±

| å±‚çº§ | ç»„ä»¶         | å»¶è¿Ÿ   | åœºæ™¯               |
| :--- | :----------- | :----- | :----------------- |
| L1   | FastRouter   | ~0ms   | ç®€å•æ„å›¾ã€é«˜ç½®ä¿¡åº¦ |
| L2   | Orchestrator | ~400ms | å¤æ‚æ„å›¾ã€å¤šæ„å›¾   |

### 5.2 ä¸“å®¶é›¶è€¦åˆ

```
ä¸“å®¶è§†è§’:
  - æˆ‘èƒ½åšä»€ä¹ˆ â†’ å£°æ˜ capabilities
  - æˆ‘ä¸èƒ½åšä»€ä¹ˆ â†’ ä¸éœ€è¦çŸ¥é“
  - è°èƒ½åšæˆ‘ä¸èƒ½çš„ â†’ ä¸éœ€è¦çŸ¥é“

Orchestrator è§†è§’:
  - è°èƒ½åšä»€ä¹ˆ â†’ CapabilityMap
  - ä¸“å®¶æŠ¥å‘Š"ç¼ºå¤±èƒ½åŠ›" â†’ æŸ¥è¯¢ â†’ Handoff
```

### 5.3 é™çº§æœºåˆ¶

| åœºæ™¯         | é™çº§ç­–ç•¥                |
| :----------- | :---------------------- |
| LLM åˆ†è§£å¤±è´¥ | Fallback Planï¼ˆå•ä¸“å®¶ï¼‰ |
| LLM èšåˆå¤±è´¥ | ç®€å•æ‹¼æ¥                |
| ä¸“å®¶ä¸å¯ç”¨   | è¿”å›ç©ºè®¡åˆ’              |
| æ— åŒ¹é…èƒ½åŠ›   | ç›´æ¥å›å¤ç”¨æˆ·            |

---

## 6. æ‰©å±•æ€§

### æ–°å¢ä¸“å®¶

```
1. åˆ›å»º config/parrots/new_expert.yaml
2. å£°æ˜ capabilities
3. å®Œæˆ

æ— éœ€ä¿®æ”¹:
  - å…¶ä»–ä¸“å®¶é…ç½®
  - Orchestrator ä»£ç 
  - CapabilityMap æ„å»º
```

---

## 7. æ–‡ä»¶ç´¢å¼•

| ç»„ä»¶            | æ–‡ä»¶                                        |
| :-------------- | :------------------------------------------ |
| Orchestrator    | `ai/agents/orchestrator/orchestrator.go`    |
| Decomposer      | `ai/agents/orchestrator/decomposer.go`      |
| Executor        | `ai/agents/orchestrator/executor.go`        |
| Aggregator      | `ai/agents/orchestrator/aggregator.go`      |
| HandoffHandler  | `ai/agents/orchestrator/handoff.go`         |
| CapabilityMap   | `ai/agents/orchestrator/capability_map.go`  |
| ExpertRegistry  | `ai/agents/orchestrator/expert_registry.go` |
| UniversalParrot | `ai/agents/universal/universal_parrot.go`   |

---

## 8. å®¡æŸ¥ä¸å®æ–½çŠ¶æ€

> **å®¡æŸ¥æ—¥æœŸ**: 2026-02-14
> **å®ç°å®Œæˆåº¦**: ~70%

### 8.1 ç»„ä»¶å®ç°çŠ¶æ€

| çŠ¶æ€ | ç»„ä»¶               | æ–‡ä»¶ä½ç½®                                    | è¯´æ˜                                  |
| :--- | :----------------- | :------------------------------------------ | :------------------------------------ |
| âœ…    | FastRouter         | `ai/routing/service.go:84-135`              | Cache â†’ Rule ä¸¤å±‚è·¯ç”±ï¼Œç½®ä¿¡åº¦é˜ˆå€¼ 0.8 |
| âœ…    | Decomposer         | `ai/agents/orchestrator/decomposer.go`      | LLM åˆ†è§£ + fallback æœºåˆ¶              |
| âœ…    | Executor           | `ai/agents/orchestrator/executor.go`        | å¹¶å‘æ§åˆ¶ã€äº‹ä»¶å›è°ƒå®Œæ•´                |
| âœ…    | Aggregator         | `ai/agents/orchestrator/aggregator.go`      | æ”¯æŒå¤šè¯­è¨€ã€é™çº§æ‹¼æ¥                  |
| âœ…    | ExpertRegistry     | `ai/agents/orchestrator/expert_registry.go` | é€šè¿‡ ParrotFactory å®ç°               |
| âœ…    | UniversalParrot    | `ai/agents/universal/universal_parrot.go`   | æ”¯æŒå¤šç§æ‰§è¡Œç­–ç•¥                      |
| âœ…    | **CCRunner v2.0**  | `ai/agents/runner/runner.go`                | **Hot-Multiplexing** + PGID çº§å›æ”¶    |
| âŒ    | **HandoffHandler** | æ–‡ä»¶ä¸å­˜åœ¨                                  | ç²˜æ€§è·¯ç”± Handoff æœºåˆ¶å®Œå…¨ç¼ºå¤±         |
| âŒ    | **CapabilityMap**  | æ–‡ä»¶ä¸å­˜åœ¨                                  | èƒ½åŠ›æ˜ å°„æœªå®ç°                        |
| âš ï¸    | DAG ä¾èµ–æ‰§è¡Œ       | `Task.Dependencies` æœªä½¿ç”¨                  | å­—æ®µå­˜åœ¨ä½†æ‰§è¡Œé€»è¾‘æœªå®ç°              |

### 8.2 é£é™©æ¸…å•

| ä¼˜å…ˆçº§ | é£é™©               | ä¸¥é‡åº¦ | ç¼“è§£æªæ–½                                    |
| :----- | :----------------- | :----- | :------------------------------------------ |
| **P0** | Handoff æœºåˆ¶æœªå®ç° | High   | å®ç° MissingCapability æ£€æµ‹ + CapabilityMap |
| **P0** | CapabilityMap ç¼ºå¤± | High   | ä»ä¸“å®¶é…ç½®èšåˆæ„å»º                          |
| **P1** | ä»»åŠ¡ä¾èµ–æœªå®ç°     | Medium | executor.go æ·»åŠ ä¾èµ–æ‹“æ‰‘æ’åº                |
| **P1** | å•ä»»åŠ¡æ— è¶…æ—¶       | Medium | æ·»åŠ  per-task context timeout               |
| **P2** | é˜ˆå€¼ 0.8 ç¡¬ç¼–ç     | Low    | é…ç½®åŒ–åˆ° `config/routing.yaml`              |

### 8.3 æ ¸å¿ƒæ¥å£å®šä¹‰ï¼ˆå¾…å®ç°ï¼‰

```go
// HandoffHandler - ä»»åŠ¡è½¬äº¤å¤„ç†å™¨
type HandoffHandler interface {
    HandleHandoff(ctx context.Context, request *HandoffRequest) (*HandoffResult, error)
    CanHandoff(ctx context.Context, capability string) (bool, []string)
}

// CapabilityMap - èƒ½åŠ›åˆ°ä¸“å®¶æ˜ å°„
type CapabilityMap interface {
    Query(capability string) []string
    Refresh(ctx context.Context) error
    RegisterExpert(expert *ExpertCapability) error
}

// MissingCapability - ä¸“å®¶èƒ½åŠ›ä¸è¶³æŠ¥å‘Š
type MissingCapability struct {
    Capability     string `json:"capability"`
    Reason         string `json:"reason"`
    SuggestedAgent string `json:"suggested_agent,omitempty"`
}
```

### 8.4 å®æ–½è·¯å¾„

```
Phase 1 (æ ¸å¿ƒ)
â”œâ”€â”€ capability_map.go     # ä» config/parrots/*.yaml èšåˆ capabilities
â”œâ”€â”€ handoff.go            # å®ç° HandoffHandler æ¥å£
â””â”€â”€ MissingCapability é›†æˆ # ä¿®æ”¹ UniversalParrot æ”¯æŒèƒ½åŠ›è¾¹ç•ŒæŠ¥å‘Š

Phase 2 (å¢å¼º)
â”œâ”€â”€ DAG ä¾èµ–æ‰§è¡Œ          # æ‹“æ‰‘æ’åºæ‰§è¡Œ
â””â”€â”€ Per-task è¶…æ—¶         # é˜²æ­¢å•ä»»åŠ¡é˜»å¡

Phase 3 (ä¼˜åŒ–)
â”œâ”€â”€ é˜ˆå€¼é…ç½®åŒ–            # config/routing.yaml
â”œâ”€â”€ Prometheus metrics    # è·¯ç”±å»¶è¿Ÿã€Handoff æ¬¡æ•°
â””â”€â”€ OpenTelemetry è¿½è¸ª    # åˆ†å¸ƒå¼è¿½è¸ª
```

### 8.5 éªŒæ”¶æ ‡å‡†

| é˜¶æ®µ    | éªŒæ”¶é¡¹                                                  |
| :------ | :------------------------------------------------------ |
| Phase 1 | ç²˜æ€§è·¯ç”±åœºæ™¯ä¸‹ä¸“å®¶æŠ¥å‘Š MissingCapability å¯è§¦å‘ Handoff |
| Phase 1 | Handoff åä»»åŠ¡æ­£ç¡®è½¬äº¤åˆ°ç›®æ ‡ä¸“å®¶                        |
| Phase 2 | æœ‰ä¾èµ–çš„ä»»åŠ¡ä¸²è¡Œï¼Œæ— ä¾èµ–å¹¶è¡Œ                            |
| Phase 2 | å•ä¸ªä»»åŠ¡è¶…æ—¶ä¸é˜»å¡æ•´ä½“è®¡åˆ’                              |
| Phase 3 | ç½®ä¿¡åº¦é˜ˆå€¼å¯é…ç½®                                        |
| Phase 3 | Prometheus metrics è¦†ç›–å…³é”®æŒ‡æ ‡                         |

### 8.6 æ¶æ„ä¼˜ç‚¹

1. **SOLID åŸåˆ™éµå¾ª**ï¼šExpertRegistry æ¥å£è§£è€¦ï¼ŒDIP ä¾èµ–æ³¨å…¥
2. **é…ç½®é©±åŠ¨**ï¼šä¸“å®¶é€šè¿‡ YAML é…ç½®ï¼Œæ‰©å±•æ€§å¥½
3. **é™çº§å®Œå¤‡**ï¼šDecomposer/Aggregator å‡æœ‰ fallback
4. **å¹¶å‘å®‰å…¨**ï¼šæ­£ç¡®ä½¿ç”¨ sync åŸè¯­ï¼Œcontext ä¼ æ’­æ­£ç¡®
5. **é€æ˜æ€§**ï¼šEventCallback æœºåˆ¶æ”¯æŒå‰ç«¯å®æ—¶å±•ç¤º

---

*æ›´æ–°æ—¥æœŸ: 2026-02-20*
