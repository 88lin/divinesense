# E2E 用户测试手册

> **测试范围**: MemoParrot (灰灰) + ScheduleParrot (时巧)
> **系统版本**: 基于 2026-02-15 架构
> **测试级别**: L2 真实 E2E（需要真实数据库和 LLM）

---

## 测试前准备

### 1. 环境检查

```bash
# 确认服务运行中
make status

# 确认 PostgreSQL 可用
docker exec -it divinesense-postgres-dev psql -U divinesense -c "SELECT 1"

# 确认 LLM 配置（可选，用于 L2 测试）
cat .env | grep -E "LLM_|ZHIYUAN_"
```

### 2. 开启 L2 测试模式

```bash
# 必须在 CI 环境变量未设置的情况下
export ENABLE_MANUAL_E2E=true
export CI=  # 确保 CI 未设置
```

---

## 测试用例

### 第一部分：MemoParrot (灰灰) 测试

#### TC-MEMO-001: 关键词搜索

**测试目标**: 验证笔记搜索专家能正确执行关键词搜索

**操作步骤**:
1. 打开 AI Chat 界面
2. 选择或创建一个对话
3. 输入: `查找关于 Go 语言的笔记`
4. 观察返回结果

**预期结果**:
- 返回包含 "Go" 关键词的笔记
- 显示相关度分数
- 响应时间 < 3s

**验证点**:
- [ ] 结果包含 Go 相关笔记
- [ ] 笔记内容正确显示
- [ ] 可以点击跳转到笔记详情

---

#### TC-MEMO-002: 语义向量搜索

**测试目标**: 验证语义搜索能力

**前置条件**: 已有至少 5 条包含 "编程" 标签的笔记

**操作步骤**:
1. 输入: `我之前记录的编程学习资料`
2. 观察返回结果

**预期结果**:
- 返回语义相关的结果（即使不包含 "编程" 关键词）
- 结果按相关度排序

**验证点**:
- [ ] 返回与 "编程学习" 语义相关的笔记
- [ ] 不包含关键词但相关内容也被召回

---

#### TC-MEMO-003: 时间过滤搜索

**测试目标**: 验证时间过滤器

**操作步骤**:
1. 输入: `查看今天的笔记`
2. 输入: `查看上周的笔记`
3. 输入: `查看最近7天的笔记`

**预期结果**:
| 输入 | 预期时间范围 |
|------|-------------|
| 今天 | 今日 00:00 ~ 现在 |
| 昨天 | 昨日 00:00 ~ 24:00 |
| 本周 | 本周周一 ~ 现在 |
| 上周 | 上周周一 ~ 周日 |
| 最近7天 | 7天前 ~ 现在 |

**验证点**:
- [ ] "今天的笔记" 只返回今天创建的笔记
- [ ] "上周的笔记" 正确返回上周的笔记
- [ ] 跨日期边界查询正确

---

#### TC-MEMO-004: 标签过滤搜索

**测试目标**: 验证标签过滤功能

**前置条件**: 已有带标签的笔记

**操作步骤**:
1. 输入: `查看 #work 标签的笔记`
2. 输入: `查看关于 Python 且带 #学习 标签的笔记`

**预期结果**:
- 返回指定标签的笔记
- 支持组合条件查询

**验证点**:
- [ ] 单标签过滤正确
- [ ] 多条件组合查询正确

---

#### TC-MEMO-005: 无结果处理

**测试目标**: 验证无搜索结果时的友好提示

**操作步骤**:
1. 输入: `查找一个不存在的关键词 xyzabc123`

**预期结果**:
- 返回友好的无结果提示
- 建议用户尝试其他搜索词

**验证点**:
- [ ] 不返回空结果
- [ ] 有友好的提示信息

---

### 第二部分：ScheduleParrot (时巧) 测试

#### TC-SCHEDULE-001: 创建日程（简单）

**测试目标**: 验证日程创建功能

**操作步骤**:
1. 输入: `下周五下午三点安排团队会议`
2. 观察解析结果
3. 确认创建

**预期结果**:
- 正确解析相对时间 "下周五下午三点"
- 显示创建确认
- 日程成功保存到数据库

**验证点**:
- [ ] 时间解析正确（下周五 15:00）
- [ ] 返回创建成功的日程信息
- [ ] 数据库中可查询到该日程

---

#### TC-SCHEDULE-002: 创建日程（含冲突检测）

**测试目标**: 验证日程冲突检测

**前置条件**: 已存在 14:00-16:00 的会议

**操作步骤**:
1. 输入: `今天下午三点安排项目评审`
2. 观察冲突提示

**预期结果**:
- 检测到与现有日程冲突
- 显示冲突详情（冲突的日程标题和时间）
- 提供解决方案建议

**验证点**:
- [ ] 正确检测时间冲突
- [ ] 显示冲突的日程信息
- [ ] 建议调整时间或继续创建

---

#### TC-SCHEDULE-003: 查询今日日程

**测试目标**: 验证日程查询功能

**前置条件**: 已有今日日程

**操作步骤**:
1. 输入: `今天有什么安排？`
2. 输入: `查看今天的日程`

**预期结果**:
- 返回今日所有日程
- 按时间排序
- 显示日程标题、时间、地点

**验证点**:
- [ ] 返回今日所有日程
- [ ] 时间排序正确
- [ ] 信息完整（标题、时间、地点）

---

#### TC-SCHEDULE-004: 查询本周日程

**测试目标**: 验证周期查询

**操作步骤**:
1. 输入: `这周有什么安排？`
2. 输入: `查看下周一的日程`

**预期结果**:
- 返回本周/下周所有日程
- 按日期分组显示

**验证点**:
- [ ] 正确返回本周/下周日程
- [ ] 按日期正确分组
- [ ] 不包含非本周日程

---

#### TC-SCHEDULE-005: 修改日程

**测试目标**: 验证日程更新功能

**前置条件**: 已有待修改的日程

**操作步骤**:
1. 输入: `把团队会议改到下周三下午四点`
2. 观察修改结果

**预期结果**:
- 正确识别要修改的日程
- 更新时间
- 返回更新后的日程信息

**验证点**:
- [ ] 正确识别目标日程
- [ ] 时间更新正确
- [ ] 数据库中已更新

---

#### TC-SCHEDULE-006: 删除日程

**测试目标**: 验证日程删除功能

**前置条件**: 已有待删除的日程

**操作步骤**:
1. 输入: `删除今天下午三点的项目评审`
2. 确认删除

**预期结果**:
- 删除指定的日程
- 返回删除确认

**验证点**:
- [ ] 指定日程被删除
- [ ] 数据库中已删除

---

#### TC-SCHEDULE-007: 查找空闲时间

**测试目标**: 验证空闲时间查找功能

**操作步骤**:
1. 输入: `查看明天有什么空闲时间`
2. 输入: `帮我找一下这周下午2点到5点之间的空档`

**预期结果**:
- 返回指定日期/时间段的空闲时间
- 显示可用时间段

**验证点**:
- [ ] 正确识别已有日程
- [ ] 返回正确的空闲时间段

---

#### TC-SCHEDULE-008: 相对时间解析

**测试目标**: 验证各种相对时间表达

**测试用例**:
| 输入 | 预期解析结果 |
|------|-------------|
| 明天上午9点 | 明天 09:00 |
| 后天下午2点 | 明天下午 14:00 |
| 下周一上午10点 | 下周一 10:00 |
| 这周五下班前 | 本周五 18:00 |
| 3天后 | 3天后 00:00 |
| 2周后的周三 | 2周后的周三 00:00 |

**验证点**:
- [ ] 所有相对时间正确解析
- [ ] 中文和英文都支持

---

### 第三部分：多 Agent 协作测试

#### TC-ORCH-001: 简单任务路由

**测试目标**: 验证单任务正确路由

**操作步骤**:
1. 输入: `搜索我记录的 Go 学习笔记`

**预期结果**:
- 识别为 memo 任务
- 路由到 MemoParrot
- 返回搜索结果

**验证点**:
- [ ] 正确识别任务类型
- [ ] 路由到正确的 Agent
- [ ] 返回正确的结果

---

#### TC-ORCH-002: 复杂任务分解

**测试目标**: 验证多任务分解和 DAG 调度

**操作步骤**:
1. 输入: `搜索上次项目会议的纪要，并帮我安排下周的跟进会议`

**预期结果**:
- 分解为 2 个任务：
  1. 搜索会议纪要 (memo)
  2. 创建日程 (schedule)
- DAG 依赖：先搜索，后创建日程
- 按依赖顺序执行

**验证点**:
- [ ] 任务正确分解为 2 个
- [ ] 依赖关系正确
- [ ] 结果聚合展示

---

#### TC-ORCH-003: 并行任务执行

**测试目标**: 验证无依赖任务并行执行

**操作步骤**:
1. 输入: `帮我搜索 Go 笔记，同时看看这周有什么日程`

**预期结果**:
- 分解为 2 个独立任务
- 并行执行
- 结果同时展示

**验证点**:
- [ ] 识别为可并行任务
- [ ] 两个任务同时执行
- [ ] 结果聚合展示

---

#### TC-ORCH-004: 自动转交 (Handoff)

**测试目标**: 验证任务失败时自动转交

**场景**:
1. 当前 Agent 无法处理
2. 自动转交给其他 Agent

**操作步骤**:
1. 输入: `帮我安排明天的会议`（在 Memo 对话中）

**预期结果**:
- 检测到需要 schedule 能力
- 自动转交给 ScheduleParrot
- 成功创建日程

**验证点**:
- [ ] 识别需要转交的场景
- [ ] 成功转交到目标 Agent
- [ ] 任务完成

---

### 第四部分：交互体验测试

#### TC-INTERACT-001: 多轮澄清

**测试目标**: 验证必填信息缺失时的追问能力

**操作步骤**:
1. 输入: `帮我安排个会`
2. 观察澄清问题

**预期结果**:
- 不直接创建日程
- 返回澄清问题: "请问会议的主题是什么？计划在什么时间开始？"
- 保持会话状态

**验证点**:
- [ ] 不创建不完整的日程
- [ ] 返回有意义的澄清问题
- [ ] 会话上下文保持

---

#### TC-INTERACT-002: 流式响应

**测试目标**: 验证 Thinking 过程和最终结果的流式传输

**操作步骤**:
1. 输入一个复杂查询
2. 观察响应过程

**预期结果**:
- 收到流式输出
- 事件序列:
  1. `thinking_start`: "正在分析用户意图..."
  2. `tool_call`: "正在搜索笔记..."
  3. `thinking_end`
  4. `content`: 最终结果

**验证点**:
- [ ] 流式输出可见
- [ ] Thinking 过程可见
- [ ] 工具调用状态可见

---

#### TC-INTERACT-003: 错误处理

**测试目标**: 验证错误情况的友好提示

**操作步骤**:
1. 输入一个无效请求
2. 观察错误处理

**预期结果**:
- 返回友好的错误提示
- 不泄露内部错误详情
- 建议用户如何操作

**验证点**:
- [ ] 错误信息友好
- [ ] 不暴露内部细节
- [ ] 提供解决建议

---

## 测试数据准备

### 创建测试笔记

```sql
-- 在 PostgreSQL 中创建测试笔记
INSERT INTO memo (uid, creator_id, content, visibility, row_status, created_ts, updated_ts)
VALUES
  ('test_memo_001', 1, 'Go 语言学习笔记：今天学习了 Go 的并发编程，包括 goroutine 和 channel 的使用。', 'PRIVATE', 'N', EXTRACT(EPOCH FROM NOW()), EXTRACT(EPOCH FROM NOW())),
  ('test_memo_002', 1, 'Python 入门指南：变量、数据类型、条件语句和循环的基础用法。', 'PRIVATE', 'N', EXTRACT(EPOCH FROM NOW()), EXTRACT(EPOCH FROM NOW())),
  ('test_memo_003', 1, '会议纪要：Q1 规划会议，讨论了产品路线图和技术债务。', 'PRIVATE', 'N', EXTRACT(EPOCH FROM NOW()), EXTRACT(EPOCH FROM NOW()));
```

### 创建测试日程

```sql
-- 创建测试日程
INSERT INTO schedule (uid, creator_id, title, start_ts, end_ts, all_day, timezone, row_status, created_ts, updated_ts)
VALUES
  ('test_sched_001', 1, '团队周会', EXTRACT(EPOCH FROM NOW()) + 86400, EXTRACT(EPOCH FROM NOW()) + 86400 + 3600, false, 'Asia/Shanghai', 'N', EXTRACT(EPOCH FROM NOW()), EXTRACT(EPOCH FROM NOW()));
```

---

## 测试检查清单

### 每日冒烟测试

- [ ] TC-MEMO-001: 关键词搜索
- [ ] TC-SCHEDULE-001: 创建日程
- [ ] TC-SCHEDULE-003: 查询今日日程

### 完整回归测试

- [ ] 所有 MemoParrot 测试用例
- [ ] 所有 ScheduleParrot 测试用例
- [ ] 多 Agent 协作测试
- [ ] 交互体验测试

---

## 常见问题排查

### 问题 1: 日程创建失败

**可能原因**:
- 时间解析失败
- 数据库连接问题

**排查步骤**:
1. 检查输入的时间表达是否支持
2. 检查数据库连接
3. 查看服务端日志

### 问题 2: 搜索无结果

**可能原因**:
- 索引未构建
- 关键词不匹配

**排查步骤**:
1. 确认笔记已创建
2. 检查 pgvector 扩展是否安装
3. 尝试语义搜索

### 问题 3: Agent 转交失败

**可能原因**:
- 目标 Agent 不可用
- Handoff 深度超限

**排查步骤**:
1. 检查专家配置
2. 查看 Handoff 日志

---

## 测试报告模板

```markdown
## 测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: XXX
**测试环境**: dev/staging

### 测试结果

| 用例 | 状态 | 备注 |
|------|------|------|
| TC-MEMO-001 | PASS/FAIL | 备注 |
| ... | ... | ... |

### 问题记录

| 问题 | 严重程度 | 状态 |
|------|---------|------|
| 问题描述 | P0/P1/P2/P3 | Open/Resolved |
```

---

## 参考资料

- 测试用例文档: `docs/testing/e2e-ai-agent-test-cases.md`
- 专家配置:
  - `config/parrots/memo.yaml`
  - `config/parrots/schedule.yaml`
- Agent 实现:
  - `ai/agents/tools/memo_search.go`
  - `ai/agents/tools/schedule/tools.go`
