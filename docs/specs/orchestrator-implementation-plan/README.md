# Orchestrator 实施计划规范文档 (修订版)

> **版本**: v1.1.0 | **日期**: 2026-02-15 | **状态**: 需要更新

## ⚠️ 重要修订说明

**上次审计遗漏**：Handoff 机制和 CapabilityMap 已在代码库中完整实现！

| 组件 | 文件位置 | 状态 | 测试覆盖 |
|:-----|:---------|:-----|:---------|
| Handoff Handler | `ai/agents/orchestrator/handoff.go` | ✅ 已实现 | ✅ handoff_test.go |
| CapabilityMap | `ai/agents/orchestrator/capability_map.go` | ✅ 已实现 | ✅ capability_map_test.go |
| ExpertRegistry | `ai/agents/orchestrator/expert_registry.go` | ✅ 已实现 | - |

---

## 概述

本文档是 Orchestrator 架构升级与实施方案的结构化规范输出。将原实施计划拆分为原子化的 SPEC 文档，便于独立实现、审查和追踪。

## 目标

整合 DAG 调度能力、上下文感知与工程韧性，构建支持复杂任务编排的智能 Agent 架构。

**核心目标**:
1. **DAG 调度**: 基于 Kahn 算法实现动态任务分发，支持最大化并行
2. **上下文注入**: 实现任务间数据流转，支持 `{{task.result}}` 动态替换
3. **工程韧性**: 引入 Retry、Exponential Backoff 和 Cascade Skip 机制
4. **Agent 增强**: 优化 Schedule/Memo Agent 的交互协议与鲁棒性

---

## 实施路线图

| 阶段 | 内容 | 周期 |
|:-----|:-----|:-----|
| 阶段一 | Agent 增强与清理 (Schedule/Memo Agent 提示词优化) | Sprint 1 |
| 阶段二 | Orchestrator 核心重构 (DAG & Executor) | Sprint 2-3 |
| 阶段三 | 测试与验收 | Sprint 4 |

---

## 原子 Spec 索引

### 阶段一：快速赢面 (Agent 增强)

| SPEC | 标题 | 优先级 | 状态 |
|:-----|:-----|:-------|:-----|
| SPEC-005 | Schedule Agent 增强 | P0 | 待实现 |
| SPEC-006 | Memo Agent 增强 | P0 | 待实现 |
| SPEC-007 | 可观测性与日志 | P1 | **缺失 - 需新建** |
| SPEC-008 | 废弃代码清理 | P1 | ✅ 已确认无废弃代码 |

### 阶段二：Orchestrator 核心重构

| SPEC | 标题 | 优先级 | 状态 |
|:-----|:-----|:-------|:-----|
| SPEC-001 | DAG 调度核心 (Kahn 算法) | P0 | 设计中 |
| SPEC-002 | 变量替换与上下文注入 | P0 | 设计中 |
| SPEC-003 | 韧性设计 (Retry/Backoff) | P0 | 设计中 |
| SPEC-004 | 结构感知聚合 | P1 | 设计中 |
| SPEC-009 | Executor 升级 (集成 DAG) | P0 | 设计中 |
| SPEC-010 | 手动验收测试用例 | P1 | **缺失 - 需新建** |

### 阶段三：已实现 (无需覆盖)

| SPEC | 标题 | 优先级 | 状态 |
|:-----|:-----|:-------|:-----|
| - | Handoff 机制 | P0 | ✅ 已实现 |
| - | CapabilityMap | P0 | ✅ 已实现 |

---

## 与当前系统实现的差距

### 已实现 ✅
- [x] Handoff Handler (`ai/agents/orchestrator/handoff.go`)
- [x] CapabilityMap (`ai/agents/orchestrator/capability_map.go`)
- [x] ExpertRegistry (`ai/agents/orchestrator/expert_registry.go`)
- [x] Decomposer 支持生成含 `dependencies` 字段的任务计划
- [x] TaskPlan 数据结构定义

### 待实现 (MVP) ⚠️
- [ ] DAG 调度引擎 (Kahn 算法)
- [ ] 上下文注入 (`{{task.result}}` 语法)
- [ ] Retry 机制与 Exponential Backoff
- [ ] Cascade Skip (级联跳过)
- [ ] 结构感知聚合
- [ ] 可观测性 (trace_id 日志)
- [ ] 手动验收测试用例

---

## 依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                      已实现 (无需实现)                          │
│  ┌─────────────────┐    ┌──────────────────┐                  │
│  │   Handoff       │    │  CapabilityMap   │                  │
│  │   Handler       │    │                  │                  │
│  └────────┬────────┘    └────────┬─────────┘                  │
└───────────┼──────────────────────┼─────────────────────────────┘
            │                      │
            ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    阶段一：快速赢面                             │
│  ┌────────────┐ ┌───────────┐ ┌────────────┐ ┌────────────┐│
│  │ SPEC-005   │ │ SPEC-006   │ │ SPEC-007    │ │ SPEC-008   ││
│  │ Schedule   │ │ Memo       │ │ 可观测性    │ │ 清理      ││
│  │ Agent      │ │ Agent      │ │ 日志       │ │            ││
│  └─────┬──────┘ └───────────┘ └─────────────┘ └────────────┘│
└────────┼──────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│              阶段二：Orchestrator 核心重构                      │
│  ┌────────────┐ ┌───────────┐ ┌────────────┐ ┌────────────┐ │
│  │ SPEC-001   │ │ SPEC-002   │ │ SPEC-003    │ │ SPEC-004   │ │
│  │ DAG 调度   │ │ 上下文注入  │ │ 韧性设计    │ │ 聚合      │ │
│  └─────┬──────┘ └─────┬──────┘ └─────────────┘ └────────────┘ │
│        │               │                                        │
│        └───────┬───────┘                                        │
│                ▼                                                │
│  ┌─────────────────────┐                                        │
│  │ SPEC-009 Executor  │                                        │
│  │ 升级                │                                        │
│  └─────────────────────┘                                        │
└─────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│              阶段三：测试与验收                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ SPEC-010 手动验收测试用例                                   ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 快速开始

1. ~~阅读 SPEC-007 了解 Handoff 机制~~ → 已实现，无需阅读
2. 阅读 SPEC-001 了解 DAG 调度核心设计
3. 按照依赖顺序实现各 SPEC
4. 运行单元测试验证 (`make test-ai`)

---

## 文档更新日志

| 日期 | 版本 | 变更 |
|:-----|:-----|:-----|
| 2026-02-15 | v1.0.0 | 初始版本，从实施计划拆分 |
| 2026-02-15 | v1.1.0 | 修订：标注 Handoff/CapabilityMap 已实现，补充缺失 SPEC |
