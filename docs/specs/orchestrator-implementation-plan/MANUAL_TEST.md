# Orchestrator 手动验收测试用例

> **关联 Issue**: #213 | **状态**: 待执行

## 测试环境

| 配置 | 值 |
|:-----|:---|
| 数据库 | PostgreSQL (divinesense-postgres-dev) |
| 前端端口 | 25173 |
| 后端端口 | 28081 |
| Trace ID | 可从日志中获取 |

## 测试场景

### 场景 1: 线性任务依赖

**目的**: 验证 DAG 按依赖顺序串行执行

**步骤**:
1. 发送请求触发多步骤任务（例：先搜索笔记，再总结）
2. 观察日志确认任务执行顺序
3. 验证最终聚合结果包含所有步骤输出

**预期结果**:
- `t1` 完成后再执行 `t2`
- 最终响应包含两个任务的结果

---

### 场景 2: 钻石依赖并行

**目的**: 验证 DAG 最大化并行执行

**步骤**:
1. 发送请求触发钻石依赖结构（A → B,C → D）
2. 观察日志确认 B 和 C 并行执行
3. 验证 D 在 B,C 都完成后执行

**预期结果**:
- B 和 C 同时运行（时间戳接近）
- D 等待 B,C 都完成后才开始

---

### 场景 3: 上下文注入

**目的**: 验证 `{{task_id.result}}` 变量替换

**步骤**:
1. 发送请求包含依赖引用（例：搜索笔记 A，基于结果再搜索 B）
2. 检查第二个任务的输入是否包含第一个任务的结果

**预期结果**:
- Task B 的输入中 `{{task_a.result}}` 被替换为 Task A 的实际输出

---

### 场景 4: 重试与 Exponential Backoff

**目的**: 验证任务失败后的重试机制

**步骤**:
1. 构造一个会失败的任务（例：搜索不存在的笔记）
2. 观察日志中的重试日志
3. 确认 Exponential Backoff（1s, 2s, 4s）

**预期结果**:
- 日志显示 `retrying... attempt=1/3`
- 重试间隔递增

---

### 场景 5: 级联跳过

**目的**: 验证上游失败后下游任务被跳过

**步骤**:
1. 构造依赖链：A → B → C
2. 使 A 失败
3. 观察 B,C 的状态

**预期结果**:
- A 失败
- B 状态变为 `skipped`（原因：上游失败）
- C 状态变为 `skipped`（原因：上游失败）

---

### 场景 6: 循环依赖检测

**目的**: 验证 DAG 能检测循环依赖并报错

**步骤**:
1. 构造循环依赖：A → B → C → A
2. 执行任务计划
3. 观察错误信息

**预期结果**:
- 返回错误：`cycle detected or deadlock`

---

## 执行清单

- [ ] 场景 1: 线性任务依赖
- [ ] 场景 2: 钻石依赖并行
- [ ] 场景 3: 上下文注入
- [ ] 场景 4: 重试与 Backoff
- [ ] 场景 5: 级联跳过
- [ ] 场景 6: 循环依赖检测
