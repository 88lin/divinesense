# Unified Block Model - å®æ–½è§„æ ¼ç´¢å¼•

> **çŠ¶æ€**: ğŸ”„ å¼€å‘ä¸­ | **æ€»æŠ•å…¥**: 21 äººå¤© | **å…³è” Issue**: [#71](https://github.com/hrygo/divinesense/issues/71)

---

## æ¦‚è¿°

Unified Block Model å°†å¯¹è¯å›åˆ (Block) ä½œä¸ºä¸€ç­‰å…¬æ°‘çš„æŒä¹…åŒ–å•å…ƒï¼Œç»Ÿä¸€å¤„ç† Normal/Geek/Evolution ä¸‰ç§æ¨¡å¼çš„æ•°æ®å­˜å‚¨ã€‚

**æ ¸å¿ƒç›®æ ‡**:
- ç»Ÿä¸€æ•°æ®æ¨¡å‹ï¼šæ¶ˆé™¤æ™®é€šæ¨¡å¼å’Œ CC æ¨¡å¼çš„æ•°æ®ç»“æ„å·®å¼‚
- å®Œæ•´æŒä¹…åŒ–ï¼šä¿å­˜å®Œæ•´çš„äº‹ä»¶æµ (thinking/tool_use/answer)
- è¿½åŠ å¼è¾“å…¥ï¼šæ”¯æŒåœ¨ AI å›å¤å‰è¿½åŠ ç”¨æˆ·è¾“å…¥
- æ¨¡å¼ç‹¬ç«‹ï¼šæ¯ä¸ª Block è®°å½•åˆ›å»ºæ—¶çš„ modeï¼Œäº’ä¸å½±å“

---

## Phase è§„æ ¼æ–‡æ¡£

| Phase | æ ‡é¢˜                                                   | æŠ•å…¥  | ä¾èµ–      | çŠ¶æ€ |
| :---- | :----------------------------------------------------- | :---- | :-------- | :--- |
| **1** | [æ•°æ®åº“ & åç«¯ Store](./unified-block-model-phase1.md) | 5äººå¤© | -         | ğŸ”²    |
| **2** | [Proto & API](./unified-block-model-phase2.md)         | 3äººå¤© | -         | ğŸ”²    |
| **3** | [å‰ç«¯ç±»å‹å®šä¹‰](./unified-block-model-phase3.md)        | 2äººå¤© | Phase 2   | ğŸ”²    |
| **4** | [å‰ç«¯ç»„ä»¶æ”¹é€ ](./unified-block-model-phase4.md)        | 4äººå¤© | Phase 3   | ğŸ”²    |
| **5** | [Chat Handler é›†æˆ](./unified-block-model-phase5.md)   | 4äººå¤© | Phase 2   | ğŸ”²    |
| **6** | [é›†æˆæµ‹è¯•](./unified-block-model-phase6.md)            | 3äººå¤© | Phase 1-5 | ğŸ”²    |

---

## ä¾èµ–å…³ç³»å›¾

```
Phase 1 (æ•°æ®åº“ & Store)
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚                 â”‚
    â–¼                 â–¼                 â–¼
Phase 2           Phase 3          Phase 5
(Proto & API)     (å‰ç«¯ç±»å‹)      (Chat Handler)
    â”‚                 â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
              â”‚                         â”‚
              â–¼                         â”‚
          Phase 4                       â”‚
      (å‰ç«¯ç»„ä»¶æ”¹é€ )                     â”‚
              â”‚                         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                   Phase 6
                  (é›†æˆæµ‹è¯•)
```

---

## æ•°æ®æ¨¡å‹é€Ÿè§ˆ

### ai_block è¡¨ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ai_block (æ–°å¢)                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id BIGSERIAL PK                                                â”‚
â”‚  conversation_id INTEGER FK â†’ ai_conversation                   â”‚
â”‚  round_number INTEGER (0-based)                                 â”‚
â”‚  block_type TEXT ('message' | 'context_separator')              â”‚
â”‚  mode TEXT ('normal' | 'geek' | 'evolution')                    â”‚
â”‚  user_inputs JSONB [{content, timestamp}]                       â”‚
â”‚  assistant_content TEXT                                         â”‚
â”‚  assistant_timestamp BIGINT                                     â”‚
â”‚  event_stream JSONB [{type, content, timestamp, meta}]          â”‚
â”‚  session_stats JSONB (CC æ¨¡å¼ç»Ÿè®¡)                               â”‚
â”‚  cc_session_id TEXT (UUID v5 æ˜ å°„)                              â”‚
â”‚  status TEXT ('pending' | 'streaming' | 'completed' | 'error')  â”‚
â”‚  metadata JSONB                                                 â”‚
â”‚  created_ts BIGINT                                              â”‚
â”‚  updated_ts BIGINT                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Block çŠ¶æ€æµè½¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pending â”‚ â†’ â”‚Streaming â”‚ â†’ â”‚Completedâ”‚ â†’ â”‚  Error   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚               â”‚               â”‚
    â–¼              â–¼               â–¼               â–¼
ç”¨æˆ·è¾“å…¥      äº‹ä»¶æµå¼å†™å…¥      ä¼šè¯ç»Ÿè®¡å†™å…¥     é”™è¯¯å¤„ç†
åˆ›å»ºBlock    event_stream      session_stats    metadata
```

---

## éªŒæ”¶æ ‡å‡†æ±‡æ€»

| ç±»åˆ«         | éªŒæ”¶æ¡ä»¶                                    |
| :----------- | :------------------------------------------ |
| **æ•°æ®åº“**   | `ai_block` è¡¨åˆ›å»ºï¼Œç´¢å¼•ç”Ÿæ•ˆï¼Œè§¦å‘å™¨å·¥ä½œæ­£å¸¸ |
| **åç«¯ API** | BlockService CRUD å®Œæ•´ï¼Œæµå¼æ›´æ–°æ­£å¸¸        |
| **å‰ç«¯**     | å¯æ¸²æŸ“ä¸‰ç§æ¨¡å¼ Blockï¼Œè¿½åŠ è¾“å…¥æ­£å¸¸å·¥ä½œ      |
| **é›†æˆ**     | ç«¯åˆ°ç«¯æµç¨‹é€šè¿‡ï¼Œå‘åå…¼å®¹                    |

---

## å‚è€ƒèµ„æ–™

- [ä¸»è§„æ ¼æ–‡æ¡£](./unified-block-model.md)
- [è°ƒç ”æŠ¥å‘Š](../../archived/research/20260207_archive/unified-block-model-research.md)
- [Issue #69: Warp Block UI](https://github.com/hrygo/divinesense/issues/69)
- [CC Runner å¼‚æ­¥æ¶æ„](../../archived/specs/20260207_archive/cc_runner_async_arch.md)

---

*æ›´æ–°æ—¶é—´: 2026-02-04*
