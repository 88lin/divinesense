# Block Design Specs - è§„æ ¼ç´¢å¼•

> **æœ€åæ›´æ–°**: 2026-02-10 | **çŠ¶æ€**: âœ… UBM å·²å®ç° (v0.97.0) | æ‰©å±•åŠŸèƒ½å¾…å¼€å‘

## æ¦‚è¿°

æœ¬ç›®å½•åŒ…å« DivineSense AI èŠå¤©ç³»ç»Ÿçš„ Block Design è§„æ ¼ï¼Œæ¶µç›– Unified Block Model åŠå…¶æ‰©å±•åŠŸèƒ½çš„å®Œæ•´æŠ€æœ¯è§„èŒƒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DivineSense AI èŠå¤©ç³»ç»Ÿæ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Unified Block Model (UBM) - æ ¸å¿ƒæ•°æ®æ¨¡å‹                        â”‚   â”‚
â”‚  â”‚  - ai_block è¡¨ï¼šç»Ÿä¸€å­˜å‚¨å¯¹è¯å›åˆ                                 â”‚   â”‚
â”‚  â”‚  - æ”¯æŒ Normal/Geek/Evolution ä¸‰ç§æ¨¡å¼                            â”‚   â”‚
â”‚  â”‚  - å®Œæ•´äº‹ä»¶æµæŒä¹…åŒ– (thinking/tool_use/answer)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ‰©å±•åŠŸèƒ½                                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ LLM Stats Collection (P1-A006) - æ™®é€š Token ç»Ÿè®¡           â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Tree Conversation Branching - å¯¹è¯åˆ†æ”¯/ç¼–è¾‘é‡ç”Ÿæˆ           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–‡æ¡£å¯¼èˆª

### 1. æ ¸å¿ƒè§„æ ¼ (Core Specs)

| æ–‡æ¡£ | æè¿° | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|:-----|:-----|:-----|:-------|
| [unified-block-model.md](./unified-block-model.md) | UBM ä¸»è§„æ ¼æ–‡æ¡£ - å®Œæ•´æ¶æ„è®¾è®¡ | âœ… å·²å®ç° (v0.93.0) | P0 |
| [archived/unified-block-model-index.md](./archived/unified-block-model-index.md) | UBM Phase å®æ–½ç´¢å¼• (å·²å½’æ¡£) | âœ… å·²å®ç° | P0 |

### 2. Phase è§„æ ¼ (Implementation Phases)

| Phase | æ–‡æ¡£ | æŠ•å…¥ | çŠ¶æ€ | ä¾èµ– |
|:------|:-----|:-----|:-----|:-----|
| **Phase 1** | [archived/unified-block-model-phase1.md](./archived/unified-block-model-phase1.md) | 5äººå¤© | âœ… å·²å®ç° | - |
| **Phase 2** | [archived/unified-block-model-phase2.md](./archived/unified-block-model-phase2.md) | 3äººå¤© | âœ… å·²å®ç° | - |
| **Phase 3** | [archived/unified-block-model-phase3.md](./archived/unified-block-model-phase3.md) | 2äººå¤© | âœ… å·²å®ç° | Phase 2 |
| **Phase 4** | [archived/unified-block-model-phase4.md](./archived/unified-block-model-phase4.md) | 4äººå¤© | âœ… å·²å®ç° | Phase 3 |
| **Phase 5** | [archived/unified-block-model-phase5.md](./archived/unified-block-model-phase5.md) | 4äººå¤© | âœ… å·²å®ç° | Phase 2 |
| **Phase 6** | [archived/unified-block-model-phase6.md](./archived/unified-block-model-phase6.md) | 3äººå¤© | âœ… å·²å®ç° | Phase 1-5 |

**æ€»è®¡**: 21 äººå¤© | **çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ (v0.93.0) | è¯¦æƒ…å·²å½’æ¡£è‡³ `archived/`

### 3. æ”¹è¿›ä¸ä¿®å¤ (Improvements & Fixes)

| æ–‡æ¡£ | æè¿° | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|:-----|:-----|:-----|:-------|
| [unified-block-model_improvement.md](./unified-block-model_improvement.md) | UBM æ”¹è¿›å»ºè®® - Bug ä¿®å¤å’Œæ ‡å‡†ç»Ÿä¸€ | ğŸ”² å¾…å¼€å‘ | **P0** |

**å…³é”®ä¿®å¤**:
- æ—¶é—´æˆ³å•ä½ç»Ÿä¸€ (ç§’ â†’ æ¯«ç§’)
- ä¹è§‚æ›´æ–°é€»è¾‘ä¿®å¤
- ä¸ºæ ‘çŠ¶åˆ†æ”¯é¢„ç•™ `parent_block_id`

### 4. æ‰©å±•åŠŸèƒ½ (Extended Features)

| æ–‡æ¡£ | æè¿° | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|:-----|:-----|:-----|:-------|
| [P1-A006-llm-stats-collection.md](./P1-A006-llm-stats-collection.md) | LLM å±‚ç»Ÿè®¡æ”¶é›† - æ™®é€š Token ç»Ÿè®¡ | ğŸ”² å¾…å¼€å‘ | P1 |
| [tree-conversation-branching.md](./tree-conversation-branching.md) | æ ‘çŠ¶ä¼šè¯åˆ†æ”¯ - ç¼–è¾‘é‡ç”ŸæˆåŠŸèƒ½ | ğŸ”² å¾…å¼€å‘ | P1 |
<<<<<<< HEAD
| [ai-block-fields-extension.md](./ai-block-fields-extension.md) | ai_block å­—æ®µæ‰©å±• - Token/æˆæœ¬/åé¦ˆ/è½¯åˆ é™¤ | ğŸ“ å·²æè®® | P1 |
=======
>>>>>>> 98db96e2 (feat(ai): implement Unified Block Model (Issue #71) (#78))

### 5. å®¡è®¡ä¸åè°ƒ (Audit & Coordination)

| æ–‡æ¡£ | æè¿° | çŠ¶æ€ |
|:-----|:-----|:-----|
| [joint-audit-report.md](./joint-audit-report.md) | ä¸‰æ–¹è§„æ ¼è”åˆå®¡è®¡æŠ¥å‘Š | âœ… å·²å®Œæˆ |

---

## å®æ–½çŠ¶æ€æ€»ç»“

| æ¨¡å— | çŠ¶æ€ | ç‰ˆæœ¬ |
|:-----|:-----|:-----|
| **Unified Block Model (Phase 1-6)** | âœ… å·²å®ç° | v0.93.0 |
| **UBM æ”¹è¿›å»ºè®® (P0)** | ğŸ”² å¾…å¼€å‘ | - |
| **LLM ç»Ÿè®¡æ”¶é›† (P1-A006)** | ğŸ”² å¾…å¼€å‘ | - |
| **æ ‘çŠ¶ä¼šè¯åˆ†æ”¯** | ğŸ”² å¾…å¼€å‘ | - |

## æ¨èåç»­å®æ–½è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… å·²å®Œæˆ: Unified Block Model (Phase 1-6) - v0.93.0                   â”‚
â”‚     â”œâ”€ Phase 1: æ•°æ®åº“ & åç«¯ Store                                    â”‚
â”‚     â”œâ”€ Phase 2: Proto & API                                            â”‚
â”‚     â”œâ”€ Phase 3: å‰ç«¯ç±»å‹å®šä¹‰                                           â”‚
â”‚     â”œâ”€ Phase 4: å‰ç«¯ç»„ä»¶æ”¹é€                                            â”‚
â”‚     â”œâ”€ Phase 5: Chat Handler é›†æˆ                                      â”‚
â”‚     â””â”€ Phase 6: é›†æˆæµ‹è¯•                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”² ä¸‹ä¸€æ­¥: åœ°åŸºä¿®å¤ (Foundation) - P0                                  â”‚
â”‚  â””â”€ unified-block-model_improvement.md                                 â”‚
â”‚     â”œâ”€ ä¿®å¤æ—¶é—´æˆ³ Bug (ç»Ÿä¸€ä¸ºæ¯«ç§’)                                     â”‚
â”‚     â”œâ”€ ä¼˜åŒ–å‰ç«¯ä¹è§‚æ›´æ–°é€»è¾‘                                           â”‚
â”‚     â””â”€ ä¸ºåç»­åŠŸèƒ½æä¾›ç¨³å®šã€æ ‡å‡†ä¸€è‡´çš„æ•°æ®åº•åº§                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”² åç»­: æ ¸å¿ƒé‡æ„ (Core Refactor) - P1                                â”‚
â”‚  â””â”€ P1-A006-llm-stats-collection.md                                    â”‚
â”‚     â”œâ”€ é‡æ„ LLMService æ¥å£ (Stateless)                               â”‚
â”‚     â”œâ”€ å®ç° Token/Duration ç»Ÿè®¡æµ                                      â”‚
â”‚     â””â”€ ç¡®ç«‹æ–°çš„åç«¯æœåŠ¡æ¥å£æ ‡å‡†                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”² æœ€ç»ˆ: åŠŸèƒ½æ‰©å±• (Feature Expansion) - P1                            â”‚
â”‚  â””â”€ tree-conversation-branching.md                                     â”‚
â”‚     â”œâ”€ å®æ–½ parent_block_id å’Œ branch_path Schema å˜æ›´                â”‚
â”‚     â”œâ”€ åŸºäºæ–°ç‰ˆ LLMService å®ç° ForkBlock                              â”‚
â”‚     â””â”€ å¯¹è¯åŠŸèƒ½ä»çº¿æ€§å‡çº§ä¸ºæ ‘çŠ¶                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¾èµ–å…³ç³»å›¾

```
           âœ… Unified Block Model (Phase 1-6) - å·²å®ç°
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚             â”‚             â”‚
            â–¼             â–¼             â–¼
    ğŸ”² P1-A006     ğŸ”² tree-conversation   ğŸ”² UBM Improvement
    (LLM ç»Ÿè®¡)     (æ ‘çŠ¶åˆ†æ”¯)           (Bug ä¿®å¤)
            â”‚             â”‚             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    å®Œæ•´ Block è®¾è®¡
```

---

## æ•°æ®æ¨¡å‹é€ŸæŸ¥

### ai_block è¡¨ç»“æ„

| å­—æ®µ | ç±»å‹ | æè¿° |
|:-----|:-----|:-----|
| `id` | BIGSERIAL | ä¸»é”® |
| `conversation_id` | INTEGER | æ‰€å±ä¼šè¯ |
| `round_number` | INTEGER | ä¼šè¯å†…è½®æ¬¡ (0-based) |
| `block_type` | TEXT | 'message' | 'context_separator' |
| `mode` | TEXT | 'normal' | 'geek' | 'evolution' |
| `user_inputs` | JSONB | ç”¨æˆ·è¾“å…¥æ•°ç»„ [{content, timestamp}] |
| `assistant_content` | TEXT | AI å›å¤å†…å®¹ |
| `event_stream` | JSONB | äº‹ä»¶æµæ•°ç»„ [{type, content, timestamp, meta}] |
| `session_stats` | JSONB | ä¼šè¯ç»Ÿè®¡ (CC æ¨¡å¼) |
| `cc_session_id` | TEXT | CC ä¼šè¯ UUID v5 æ˜ å°„ |
| `status` | TEXT | 'pending' | 'streaming' | 'completed' | 'error' |
| `metadata` | JSONB | å…ƒæ•°æ® |
| `created_ts` | BIGINT | åˆ›å»ºæ—¶é—´æˆ³ |
| `updated_ts` | BIGINT | æ›´æ–°æ—¶é—´æˆ³ |

### æ‰©å±•å­—æ®µ (Tree Branching)

| å­—æ®µ | ç±»å‹ | æè¿° |
|:-----|:-----|:-----|
| `parent_block_id` | BIGINT | çˆ¶ Block ID (æ”¯æŒæ ‘çŠ¶åˆ†æ”¯) |
| `branch_path` | TEXT | åˆ†æ”¯è·¯å¾„ (å¦‚ "0/1/2") |

<<<<<<< HEAD
### æ‰©å±•å­—æ®µ (Fields Extension - P1)

| å­—æ®µ | ç±»å‹ | æè¿° |
|:-----|:-----|:-----|
| `token_usage` | JSONB | Token ä½¿ç”¨æ˜ç»† (prompt/completion/cache) |
| `cost_estimate` | BIGINT | æˆæœ¬ä¼°ç®—ï¼ˆæ¯«å˜ï¼Œ1/1000 ç¾åˆ†ï¼‰ |
| `model_version` | TEXT | LLM æ¨¡å‹ç‰ˆæœ¬ (å¦‚ deepseek/deepseek-chat) |
| `user_feedback` | INTEGER | ç”¨æˆ·è¯„åˆ† (1-5, NULL è¡¨ç¤ºæœªè¯„åˆ†) |
| `error_message` | TEXT | é”™è¯¯è¯¦æƒ…ï¼ˆå½“ status=error æ—¶å¡«å……ï¼‰ |
| `regeneration_count` | INTEGER | é‡æ–°ç”Ÿæˆæ¬¡æ•° |
| `archived_at` | BIGINT | è½¯åˆ é™¤æ—¶é—´æˆ³ï¼ˆNULL è¡¨ç¤ºæ­£å¸¸ï¼‰ |

=======
>>>>>>> 98db96e2 (feat(ai): implement Unified Block Model (Issue #71) (#78))
---

## ç‰ˆæœ¬å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ |
|:-----|:-----|:---------|
| 2026-02-05 | v1.0 | åˆ›å»ºè§„æ ¼ç´¢å¼•ï¼Œæ•´ç†æ–‡æ¡£ç»“æ„ |

---

*ç»´æŠ¤è€…*: DivineSense å¼€å‘å›¢é˜Ÿ
*åé¦ˆæ¸ é“*: [GitHub Issues](https://github.com/hrygo/divinesense/issues)
