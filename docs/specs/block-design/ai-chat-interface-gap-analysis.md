# AI Chat ç•Œé¢æ¶æ„ - å·®è·åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

> **åˆ›å»ºæ—¥æœŸ**: 2026-02-06
> **ç‰ˆæœ¬**: v1.0
> **å…³è”**: [AI Chat Interface Architecture](../../dev-guides/frontend/ai-chat.md) | [Unified Block Model](./unified-block-model.md)

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£åŸºäºå¯¹ DivineSense AI Chat ç•Œé¢çš„æ·±åº¦ä»£ç å®¡æŸ¥ï¼Œè¯†åˆ«è®¾è®¡æ–‡æ¡£ä¸å®é™…å®ç°ä¹‹é—´çš„å·®è·ï¼Œå¹¶æä¾› AI Native åŸåˆ™ä¸‹çš„äº§å“è®¾è®¡æ–¹æ¡ˆå’Œå®æ–½è®¡åˆ’ã€‚

**æ ¸å¿ƒå‘ç°**ï¼š
1. åç«¯ Unified Block Model å·²å®Œæ•´å®ç°å¹¶æŒä¹…åŒ–æ•°æ®
2. å‰ç«¯ç»„ä»¶éƒ¨åˆ†å®ç°ï¼Œä½†å­˜åœ¨æ•°æ®æµæ–­è£‚
3. æ–‡æ¡£ä¸å®ç°å­˜åœ¨å¤šå¤„ä¸ä¸€è‡´
4. UI å±‚çº§å’Œå…ƒç´ åˆ†é…éœ€è¦é‡æ–°å¹³è¡¡

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å½“å‰å®ç°çŠ¶æ€                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å±‚çº§              â”‚ ç»„ä»¶                  â”‚ çŠ¶æ€  â”‚ å¤‡æ³¨       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯æ•°æ®æ¨¡å‹     â”‚ ai_block è¡¨          â”‚ âœ…    â”‚ å®Œæ•´å®ç°   â”‚
â”‚                   â”‚ event_stream (JSONB)  â”‚ âœ…    â”‚ æŒä¹…åŒ–     â”‚
â”‚                   â”‚ session_stats (JSONB) â”‚ âœ…    â”‚ æŒä¹…åŒ–     â”‚
â”‚                   â”‚ token_usage (JSONB)   â”‚ âœ…    â”‚ æŒä¹…åŒ–     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯æœåŠ¡å±‚      â”‚ BlockManager          â”‚ âœ…    â”‚ Create/     â”‚
â”‚                   â”‚                       â”‚       â”‚ Update/     â”‚
â”‚                   â”‚                       â”‚       â”‚ AppendEvent â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯ API        â”‚ ListBlocks/GetBlock   â”‚ âœ…    â”‚ gRPC       â”‚
â”‚                   â”‚ CreateBlock           â”‚ âœ…    â”‚            â”‚
â”‚                   â”‚ UpdateBlock           â”‚ âœ…    â”‚            â”‚
â”‚                   â”‚ AppendEvent           â”‚ âœ…    â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯æ•°æ®å±‚      â”‚ useBlockQueries        â”‚ âœ…    â”‚ React Query â”‚
â”‚                   â”‚ useBlocksWithFallback  â”‚ âœ…    â”‚ Fallback    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯é¡µé¢å±‚      â”‚ AIChat.tsx             â”‚ âœ…    â”‚ ä¸»å…¥å£     â”‚
â”‚                   â”‚ ChatMessages.tsx       â”‚ âœ…    â”‚ æ¶ˆæ¯åˆ—è¡¨   â”‚
â”‚                   â”‚ ChatInput.tsx          â”‚ âœ…    â”‚ è¾“å…¥åŒºåŸŸ   â”‚
â”‚                   â”‚ ChatHeader.tsx         â”‚ âœ…    â”‚ çŠ¶æ€å¤´éƒ¨   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ç»„ä»¶å±‚      â”‚ UnifiedMessageBlock    â”‚ âš ï¸    â”‚ éƒ¨åˆ†å®ç°   â”‚
â”‚                   â”‚   - BlockHeader        â”‚ âš ï¸    â”‚ ç¼ºå¤±å…ƒç´    â”‚
â”‚                   â”‚   - BlockBody          â”‚ âœ…    â”‚ å®Œæ•´       â”‚
â”‚                   â”‚   - BlockFooter        â”‚ âš ï¸    â”‚ ç¼ºå¤±æ“ä½œ   â”‚
â”‚                   â”‚ BranchIndicator        â”‚ âš ï¸    â”‚ éƒ¨åˆ†é›†æˆ   â”‚
â”‚                   â”‚ ExpandedSessionSummary â”‚ âœ…    â”‚ Geek/Evo   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµåˆ†æ

```
ç”¨æˆ·è¾“å…¥ â†’ ChatInput.tsx
    â”‚
    â–¼
AIChat.tsx (handleSend)
    â”‚
    â”œâ”€â”€â–º åˆ›å»º/é€‰æ‹©ä¼šè¯
    â”‚
    â”œâ”€â”€â–º æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° Context
    â”‚
    â””â”€â”€â–º chatHook.stream()
            â”‚
            â”œâ”€â”€ onThinking â†’ updateMessage() â”€â”€â”€â–º âŒ ä»…å­˜å‚¨åœ¨å†…å­˜ Context
            â”œâ”€â”€ onToolUse   â†’ updateMessage() â”€â”€â”€â–º âŒ ä»…å­˜å‚¨åœ¨å†…å­˜ Context
            â”œâ”€â”€ onToolResult â†’ updateMessage() â”€â”€â”€â–º âŒ ä»…å­˜å‚¨åœ¨å†…å­˜ Context
            â”œâ”€â”€ onContent   â†’ updateMessage() â”€â”€â”€â–º âŒ ä»…å­˜å‚¨åœ¨å†…å­˜ Context
            â””â”€â”€ onDone      â†’ refetchBlocks() â”€â”€â”€â–º âœ… ä»æ•°æ®åº“è·å–å®Œæ•´ Block
                                                            â”‚
                                                            â–¼
                                                    ChatMessages.tsx
                                                    convertAIBlocksToMessageBlocks()
                                                            â”‚
                                                            â–¼
                                                    extractToolCalls(eventStream) â”€â”€â–º âœ… ä»æŒä¹…åŒ–æ•°æ®æå–
                                                    extractThinkingSteps(eventStream)
                                                            â”‚
                                                            â–¼
                                                    UnifiedMessageBlock
                                                    æ˜¾ç¤ºå®Œæ•´å†…å®¹
```

**å…³é”®å‘ç°**ï¼š
- æµå¼æœŸé—´ï¼šæ•°æ®ä»…å­˜å‚¨åœ¨å†…å­˜ Contextï¼ˆåˆ·æ–°åä¸¢å¤±ï¼‰
- å®Œæˆåï¼š`refetchBlocks()` ä»æ•°æ®åº“è·å–å®Œæ•´ Block
- `event_stream` æŒä¹…åŒ–å®Œæ•´ï¼Œä½†å‰ç«¯ä¸»è¦ä¾èµ–å†…å­˜ Context æ¸²æŸ“

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 2. å·®è·æ¸…å•

### 2.1 æ–‡æ¡£ä¸å®ç°ä¸ä¸€è‡´

| #    | æ–‡æ¡£æè¿°                     | å®é™…å®ç°                                                | å½±å“     | ä¼˜å…ˆçº§ |
| :--- | :--------------------------- | :------------------------------------------------------ | :------- | :----- |
| 1    | Mode Switcher åœ¨ HEADER åŒºåŸŸ | Mode Switcher åœ¨ INPUT AREA (ChatInput)                 | æ–‡æ¡£è¯¯å¯¼ | P3     |
| 2    | Header æ˜¾ç¤º Session Info     | æ— æ­¤ç»„ä»¶                                                | ç¼ºå¤±åŠŸèƒ½ | P2     |
| 3    | Header æ˜¾ç¤ºå½“å‰ Modeï¼ˆå†—ä½™ï¼‰ | æ— æ­¤å†—ä½™è®¾è®¡                                            | è®¾è®¡ä¼˜åŒ– | P3     |
| 4    | Block Header å®Œæ•´å®ç°        | éƒ¨åˆ†å®ç°ï¼ˆè§ä¸‹è¡¨ï¼‰                                      | åŠŸèƒ½ç¼ºå¤± | P1     |
| 5    | Tool Calls åˆ·æ–°åæ¶ˆå¤±        | å®é™…å·²æŒä¹…åŒ–ï¼ˆconvertAIBlocksToMessageBlocks æ­£ç¡®æå–ï¼‰ | å·²ä¿®å¤   | -      |
| 6    | "Session Summary"            | åº”ä¸º "Block Summary"                                    | å‘½åæ··æ·† | P2     |

### 2.2 Block Header å®ç°å·®è·

| å…ƒç´                | è®¾è®¡è¦æ±‚              | å½“å‰å®ç°                                 | ç¼ºå¤±åŸå›                             | ä¼˜å…ˆçº§ |
| :----------------- | :-------------------- | :--------------------------------------- | :---------------------------------- | :----- |
| ğŸŒ¿ Branch Indicator | æ˜¾ç¤ºåˆ†æ”¯è·¯å¾„ï¼ˆ0/1/2ï¼‰ | BranchIndicator ç»„ä»¶å­˜åœ¨ä½†æœªæ˜¾ç¤ºå®Œæ•´æ•°æ® | æ•°æ®æœªä» Block è¯»å–                 | P1     |
| ğŸ¤– Parrot Routing   | AUTO â†’ MemoParrot     | æ— æ­¤æ˜¾ç¤º                                 | éœ€è¦è·¯ç”±å†³ç­–è®°å½•                    | P2     |
| â± Duration         | æ˜¾ç¤ºå¤„ç†æ—¶é—´ï¼ˆ2.3sï¼‰  | æ—                                        | sessionStats æœªåœ¨ Block Header æ˜¾ç¤º | P1     |
| ğŸ’° Cost             | æ˜¾ç¤ºæˆæœ¬ï¼ˆ$0.0087ï¼‰   | ä»… Geek/Evolution æ¨¡å¼                   | Normal æ¨¡å¼æ— æˆæœ¬ä¼°ç®—               | P1     |
| ğŸ”„ Regenerate       | é‡æ–°ç”ŸæˆæŒ‰é’®          | æœ‰                                       | -                                   | -      |
| ğŸ“‹ Copy             | å¤åˆ¶æŒ‰é’®              | æœ‰                                       | -                                   | -      |
| âœï¸ Edit             | ç¼–è¾‘ç”¨æˆ·è¾“å…¥æŒ‰é’®      | **æ— **                                   | æœªå®ç°                              | P0     |
| ğŸ—‘ï¸ Delete           | åˆ é™¤ Block æŒ‰é’®       | æœ‰ï¼ˆä»…æœ€æ–°ï¼‰                             | -                                   | -      |

### 2.3 æ•°æ®æŒä¹…åŒ–å·®è·

| æ•°æ®              | åç«¯å­˜å‚¨                        | å‰ç«¯è¯»å–                 | å‰ç«¯æ˜¾ç¤º               | çŠ¶æ€ |
| :---------------- | :------------------------------ | :----------------------- | :--------------------- | :--- |
| user_inputs       | âœ… user_inputs JSONB             | âœ… Block.userInputs       | âœ… UserInputsSection    | å®Œæˆ |
| assistant_content | âœ… assistant_content             | âœ… Block.assistantContent | âœ… AnswerSection        | å®Œæˆ |
| event_stream      | âœ… event_stream JSONB            | âœ… Block.eventStream      | âœ… ToolCallsSection     | å®Œæˆ |
| thinking_steps    | âœ… event_stream (type: thinking) | âœ… extractThinkingSteps() | âœ… ThinkingSection      | å®Œæˆ |
| token_usage       | âœ… token_usage JSONB             | âœ… Block.tokenUsage       | âŒ æœªæ˜¾ç¤º               | ç¼ºå¤± |
| session_stats     | âœ… session_stats JSONB           | âœ… Block.sessionStats     | âš ï¸ ä»… Geek/Evolution    | éƒ¨åˆ† |
| cost_estimate     | âŒ æ— ç‹¬ç«‹å­—æ®µ                    | âŒ æ—                      | âš ï¸ ä» sessionStats è®¡ç®— | ç¼ºå¤± |

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 3. AI Native äº§å“è®¾è®¡

### 3.1 è®¾è®¡åŸåˆ™

1. **æ•°æ®å•ä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰**
   - Block æ˜¯å”¯ä¸€çœŸç›¸æº
   - æ‰€æœ‰ UI å…ƒç´ ä» Block æ•°æ®æ´¾ç”Ÿ
   - æµå¼æœŸé—´ä¹è§‚æ›´æ–°ï¼Œå®Œæˆåä»æ•°æ®åº“åˆ·æ–°

2. **æ¸è¿›å¼æŠ«éœ²ï¼ˆProgressive Disclosureï¼‰**
   - é»˜è®¤æŠ˜å å†å² Block
   - æœ€æ–° Block é»˜è®¤å±•å¼€
   - è¯¦ç»†ç»Ÿè®¡é»˜è®¤éšè—ï¼Œç‚¹å‡»å±•å¼€

3. **ç§»åŠ¨ä¼˜å…ˆï¼ˆMobile Firstï¼‰**
   - å“åº”å¼è®¾è®¡ï¼Œç§»åŠ¨ç«¯ä¼˜å…ˆ
   - è§¦æ‘¸å‹å¥½çš„äº¤äº’
   - å…³é”®æ“ä½œå§‹ç»ˆå¯è§

4. **çŠ¶æ€å¯è§†åŒ–ï¼ˆState Visualizationï¼‰**
   - æ¸…æ™°çš„çŠ¶æ€æŒ‡ç¤ºï¼ˆthinkingã€toolsã€answerï¼‰
   - é”™è¯¯çŠ¶æ€çªå‡ºæ˜¾ç¤º
   - è¿›åº¦å®æ—¶åé¦ˆ

### 3.2 ç•Œé¢å±‚çº§é‡æ–°è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI Chat ç•Œé¢æ¶æ„ v2.0                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  OPTIONAL: Session Bar (ä¼šè¯æ±‡æ€»æ  - å¯æŠ˜å )              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚  â”‚ Session: #123 â”‚ Cost: $0.23 â”‚ Tokens: 15K â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ChatHeader (çŠ¶æ€å¤´éƒ¨ - æ¡Œé¢ç«¯æ˜¾ç¤º)                       â”‚   â”‚
â”‚  â”‚  ğŸ¤– Assistant Name  â”‚  ğŸ’¬ Thinking...                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ChatMessages (æ¶ˆæ¯åŒºåŸŸ)                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  UnifiedMessageBlock #1 (æŠ˜å çŠ¶æ€)                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  [ğŸ‘¤ ç”¨æˆ·æ¶ˆæ¯é¢„è§ˆ...] [14:30] [â–¼]                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  UnifiedMessageBlock #2 (å±•å¼€çŠ¶æ€)                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Block Header                              â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  [ğŸ‘¤] æœç´¢ Neo4j å›¾æ•°æ®åº“                      â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ ğŸŒ¿ 0/1 â”‚ ğŸ¤– AUTO â”‚ â± 2.3s â”‚ ğŸ’° $0.0087 â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  [â–¼]                                             â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Block Body (å¯æŠ˜å )                         â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€ User Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ ğŸ‘¤ "æœç´¢ Neo4j å›¾æ•°æ®åº“"               â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€ Thinking Process (å¯æŠ˜å ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ ğŸ§  åˆ†æç”¨æˆ·æŸ¥è¯¢...                  â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€ Tool Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ ğŸ”§ memo_search                         â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚    Query: "Neo4j å›¾æ•°æ®åº“"            â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚    Results: 3 blocks                  â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€ AI Answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ âš¡ æ‰¾åˆ° 3 æ¡ç›¸å…³ç¬”è®°...             â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€ Block Summary (å¯æŠ˜å ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â”‚ ğŸ“Š LLM Stats: 1,279 tokens, $0.0087 â”‚  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Block Footer (æ“ä½œæ )                      â”‚   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  [â–¼ æŠ˜å ] [ğŸ”„ é‡æ–°ç”Ÿæˆ] [âœï¸ ç¼–è¾‘] [ğŸ“‹ å¤åˆ¶] [ğŸ—‘ï¸] â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ChatInput (è¾“å…¥åŒºåŸŸ)                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  [âŒ˜N] [âœ‚ï¸K] [ğŸ—‘ï¸L] â”€â”€â”€â”€â”€â”€â”€â”€ âŒ¨ï¸ Enter å‘é€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  [â—‹ Normal â—‹ Geek â—‹ Evolution] â”‚ [ğŸ”½ Modeâ–¼]  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ è¾“å…¥æ¶ˆæ¯...                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                      [â¤ Send]           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ç»„ä»¶èŒè´£é‡æ–°åˆ†é…

#### 3.3.1 BlockHeaderï¼ˆç´§å‡‘å‹ï¼‰

**èŒè´£**ï¼šå¿«é€Ÿè¯†åˆ« Block å†…å®¹å’ŒçŠ¶æ€

| å…ƒç´                                 | ç§»åŠ¨ç«¯ | æ¡Œé¢ç«¯ | å®ç°ä¼˜å…ˆçº§ |
| :---------------------------------- | :----- | :----- | :--------- |
| ç”¨æˆ·å¤´åƒ + æ¶ˆæ¯é¢„è§ˆ                 | âœ…      | âœ…      | P0         |
| æ—¶é—´æˆ³                              | âœ…      | âœ…      | P0         |
| æŠ˜å /å±•å¼€æŒ‰é’®                       | âœ…      | âœ…      | P0         |
| çŠ¶æ€å¾½ç« ï¼ˆthinking/errorï¼‰          | âœ…      | âœ…      | P0         |
| åˆ†æ”¯æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœ‰åˆ†æ”¯ï¼‰              | âš ï¸ å›¾æ ‡ | âœ… å®Œæ•´ | P1         |
| **ç§»é™¤**ï¼šParrot åç§°               | -      | -      | -          |
| **ç§»é™¤**ï¼šSession ç»Ÿè®¡ï¼ˆç§»åˆ° Bodyï¼‰ | -      | -      | -          |

#### 3.3.2 BlockBodyï¼ˆä¸»ä½“ï¼‰

**èŒè´£**ï¼šå±•ç¤ºè¯¦ç»†å†…å®¹

| å­ç»„ä»¶                  | æè¿°                 | å®ç°çŠ¶æ€  | ä¼˜å…ˆçº§ |
| :---------------------- | :------------------- | :-------- | :----- |
| UserInputsSection       | ç”¨æˆ·è¾“å…¥ï¼ˆæ”¯æŒå¤šä¸ªï¼‰ | âœ…         | P0     |
| ThinkingSection         | æ€è€ƒè¿‡ç¨‹ï¼ˆå¯æŠ˜å ï¼‰   | âœ…         | P0     |
| ToolCallsSection        | å·¥å…·è°ƒç”¨åˆ—è¡¨         | âœ…         | P0     |
| AnswerSection           | AI å›å¤å†…å®¹          | âœ…         | P0     |
| **BlockSummarySection** | Token/Cost/æ—¶é—´ç»Ÿè®¡  | âš ï¸ ä»… Geek | P1     |

#### 3.3.3 BlockFooterï¼ˆæ“ä½œæ ï¼‰

**èŒè´£**ï¼šæä¾›æ“ä½œå…¥å£

| æ“ä½œ      | ç§»åŠ¨ç«¯ | æ¡Œé¢ç«¯    | å®ç°çŠ¶æ€ | ä¼˜å…ˆçº§ |
| :-------- | :----- | :-------- | :------- | :----- |
| æŠ˜å /å±•å¼€ | æ–‡å­—   | å›¾æ ‡+æ–‡å­— | âœ…        | P0     |
| é‡æ–°ç”Ÿæˆ  | ğŸ”„ å›¾æ ‡ | å›¾æ ‡+æ–‡å­— | âœ…        | P0     |
| å¤åˆ¶      | ğŸ“‹ å›¾æ ‡ | å›¾æ ‡+æ–‡å­— | âœ…        | P0     |
| **ç¼–è¾‘**  | âŒ      | âŒ         | âŒ        | **P0** |
| åˆ é™¤      | âŒ      | âŒ         | âš ï¸ ä»…æœ€æ–° | P1     |
| **Fork**  | âŒ      | âŒ         | âŒ        | P2     |

### 3.4 æ–°å¢ç»„ä»¶è®¾è®¡

#### 3.4.1 SessionBarï¼ˆä¼šè¯æ±‡æ€»æ ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¬ Session: #12345  â”‚  ğŸ’° $0.0234  â”‚  ğŸª™ 15.2K tokens  â”‚  â± 2m  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§**ï¼š
- å¯æŠ˜å ï¼ˆç‚¹å‡»æŠ˜å /å±•å¼€ï¼‰
- å®æ—¶æ›´æ–°ï¼ˆæµå¼å®Œæˆååˆ·æ–°ï¼‰
- ç§»åŠ¨ç«¯éšè—æˆ–ç®€åŒ–æ˜¾ç¤º

**æ•°æ®æ¥æº**ï¼šèšåˆå½“å‰ä¼šè¯æ‰€æœ‰ Blocks
- æ€»æˆæœ¬ = Î£ block.cost_estimate
- æ€» Token = Î£ block.token_usage.total_tokens
- æ€»æ—¶é—´ = Î£ (æœ€åæ›´æ–° - æœ€å…ˆåˆ›å»º)

#### 3.4.2 BlockEditDialogï¼ˆç¼–è¾‘å¯¹è¯æ¡†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœï¸ ç¼–è¾‘ç”¨æˆ·è¾“å…¥                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åŸå§‹æ¶ˆæ¯:                                             â”‚   â”‚
â”‚  â”‚  "æœç´¢ Neo4j å›¾æ•°æ®åº“ç¬”è®°"                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç¼–è¾‘åçš„æ¶ˆæ¯:                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ æœç´¢ Neo4j å›¾æ•°æ®åº“å’Œ Cypher æŸ¥è¯¢ç›¸å…³çš„ç¬”è®°     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸ æ³¨æ„ï¼šç¼–è¾‘ç”¨æˆ·è¾“å…¥å°†åˆ›å»ºæ–°çš„åˆ†æ”¯ï¼ŒåŸ Block ä¿æŒä¸å˜ã€‚      â”‚
â”‚                                                                  â”‚
â”‚  [å–æ¶ˆ]  [åˆ›å»ºåˆ†æ”¯å¹¶é‡æ–°ç”Ÿæˆ]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 4. ä¿®å¤æ–¹æ¡ˆä¸å®æ–½è®¡åˆ’

### 4.1 P0 ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

#### 4.1.1 å®ç° Block ç¼–è¾‘åŠŸèƒ½

**ç›®æ ‡**ï¼šå…è®¸ç”¨æˆ·ç¼–è¾‘å·²å‘é€çš„ç”¨æˆ·è¾“å…¥ï¼Œåˆ›å»ºæ–°åˆ†æ”¯å¹¶é‡æ–°ç”Ÿæˆ

**API**ï¼š
- ForkBlockï¼šå·²å­˜åœ¨ (`proto/api/v1/ai_service.proto`)
- éœ€è¦å‰ç«¯å®ç° `ForkBlock` è°ƒç”¨

**å‰ç«¯å®ç°**ï¼š
```typescript
// æ–°å¢ç»„ä»¶: BlockEditDialog.tsx
interface BlockEditDialogProps {
  blockId: number;
  originalContent: string;
  onConfirm: (newContent: string) => void;
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»º `BlockEditDialog` ç»„ä»¶
2. æ·»åŠ  `âœï¸ Edit` æŒ‰é’®åˆ° BlockFooter
3. å®ç° `handleEdit` å‡½æ•°ï¼Œè°ƒç”¨ `forkBlock` API
4. æ›´æ–° Block åè‡ªåŠ¨è§¦å‘ç”Ÿæˆ

**æ–‡ä»¶**ï¼š
- `web/src/components/AIChat/BlockEditDialog.tsx` (æ–°å»º)
- `web/src/components/AIChat/UnifiedMessageBlock.tsx` (ä¿®æ”¹)
- `web/src/hooks/useBlockQueries.ts` (æ·»åŠ  useForkBlock)

#### 4.1.2 ä¿®å¤æˆæœ¬å’Œ Token ç»Ÿè®¡æ˜¾ç¤º

**é—®é¢˜**ï¼šNormal æ¨¡å¼ä¸‹æ— æˆæœ¬å’Œ Token æ˜¾ç¤º

**åŸå› åˆ†æ**ï¼š
- åç«¯ä»…åœ¨ Geek/Evolution æ¨¡å¼æ”¶é›† `sessionStats`
- Normal æ¨¡å¼æœªè°ƒç”¨ `UpdateBlockStatus`ï¼Œå¯¼è‡´ `session_stats` ä¸ºç©º

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. åç«¯ï¼šNormal æ¨¡å¼ä¹Ÿæ”¶é›†åŸºç¡€ Token ç»Ÿè®¡
2. å‰ç«¯ï¼šä» `token_usage` å­—æ®µè¯»å–å¹¶æ˜¾ç¤º

**åç«¯ä¿®æ”¹**ï¼š`server/router/api/v1/ai/handler.go`
```go
// åœ¨æµå¼å®Œæˆåï¼Œä¸ºæ‰€æœ‰æ¨¡å¼æ”¶é›†åŸºç¡€ç»Ÿè®¡
func (h *Handler) finalizeBlock(ctx context.Context, blockID int64, content string, stats *SessionStats) {
    // ç¡®ä¿ token_usage å§‹ç»ˆæœ‰å€¼
    if stats != nil && stats.TotalTokens > 0 {
        // è½¬æ¢ä¸º TokenUsage
        tokenUsage := &store.TokenUsage{
            PromptTokens:     int32(stats.InputTokens),
            CompletionTokens: int32(stats.OutputTokens),
            TotalTokens:      int32(stats.TotalTokens),
            CacheReadTokens:  int32(stats.CacheReadTokens),
            CacheWriteTokens: int32(stats.CacheWriteTokens),
        }
        // æ›´æ–° Block
        h.blockManager.CompleteBlock(ctx, blockID, content, stats)
    }
}
```

**å‰ç«¯ä¿®æ”¹**ï¼š`UnifiedMessageBlock.tsx` - BlockHeader
```tsx
// æ˜¾ç¤ºæˆæœ¬å’Œ Tokenï¼ˆæ‰€æœ‰æ¨¡å¼ï¼‰
{block.tokenUsage && (
  <div className="flex items-center gap-2 text-xs">
    {block.tokenUsage.totalTokens > 0 && (
      <span title="Total Tokens">
        ğŸª™ {(block.tokenUsage.totalTokens / 1000).toFixed(1)}k
      </span>
    )}
  </div>
)}
```

### 4.2 P1 ä¼˜å…ˆçº§ï¼ˆé‡è¦åŠŸèƒ½ï¼‰

#### 4.2.1 å®Œå–„ BlockHeader ä¿¡æ¯æ˜¾ç¤º

**ç›®æ ‡**ï¼šæ˜¾ç¤ºåˆ†æ”¯è·¯å¾„ã€æŒç»­æ—¶é—´ã€æˆæœ¬

**å®æ–½æ­¥éª¤**ï¼š
1. ä» `Block.branchPath` è§£æåˆ†æ”¯è·¯å¾„æ˜¾ç¤º
2. è®¡ç®—æŒç»­æ—¶é—´ï¼š`updated_ts - created_ts`
3. è®¡ç®—æˆæœ¬ï¼š`cost_estimate / 100000`ï¼ˆä» milli-cents è½¬ç¾å…ƒï¼‰

**ä»£ç ä½ç½®**ï¼š`UnifiedMessageBlock.tsx` - BlockHeader

```tsx
// åˆ†æ”¯è·¯å¾„æ˜¾ç¤º
{block.branchPath && (
  <span className="flex items-center gap-1 text-xs" title="Branch path">
    ğŸŒ¿ {block.branchPath}
  </span>
)}

// æŒç»­æ—¶é—´æ˜¾ç¤º
{block.assistantTimestamp && block.createdTs && (
  <span className="flex items-center gap-1 text-xs" title="Duration">
    â± {((block.assistantTimestamp - block.createdTs) / 1000).toFixed(1)}s
  </span>
)}

// æˆæœ¬æ˜¾ç¤º
{block.costEstimate && block.costEstimate > 0 && (
  <span className="flex items-center gap-1 text-xs text-green-600" title="Cost">
    ğŸ’° ${(block.costEstimate / 100000).toFixed(4)}
  </span>
)}
```

#### 4.2.2 å®ç° SessionBarï¼ˆä¼šè¯æ±‡æ€»æ ï¼‰

**ç›®æ ‡**ï¼šåœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºä¼šè¯çº§æ±‡æ€»ç»Ÿè®¡

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»º `SessionBar` ç»„ä»¶
2. èšåˆå½“å‰ä¼šè¯æ‰€æœ‰ Blocks çš„ç»Ÿè®¡
3. æ·»åŠ æŠ˜å /å±•å¼€åŠŸèƒ½

**æ–‡ä»¶**ï¼š
- `web/src/components/AIChat/SessionBar.tsx` (æ–°å»º)

**ä»£ç ä½ç½®**ï¼š`AIChat.tsx` - æ’å…¥åœ¨ ChatHeader å’Œ ChatMessages ä¹‹é—´

#### 4.2.3 ä¿®å¤ BranchIndicator æ˜¾ç¤º

**é—®é¢˜**ï¼šBranchIndicator ç»„ä»¶å­˜åœ¨ä½†æœªå®Œæ•´æ˜¾ç¤ºåˆ†æ”¯ä¿¡æ¯

**ä¿®å¤**ï¼š
1. ç¡®ä¿ `branches` prop æ­£ç¡®ä¼ é€’
2. ä» Block æ•°æ®æ„å»ºåˆ†æ”¯æ ‘
3. å®ç°åˆ†æ”¯é€‰æ‹©å¯¹è¯æ¡†

**æ–‡ä»¶**ï¼š
- `web/src/components/AIChat/BranchIndicator.tsx` (ä¿®æ”¹)
- `web/src/components/AIChat/BranchSelectorDialog.tsx` (æ–°å»º)

### 4.3 P2 ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–æ”¹è¿›ï¼‰

#### 4.3.1 æ–‡æ¡£æ›´æ–°

**ç›®æ ‡**ï¼šä¿®æ­£æ–‡æ¡£ä¸­çš„ ASCII å›¾ï¼Œä¸å®é™…å®ç°ä¸€è‡´

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `docs/dev-guides/frontend/ai-chat.md`

**ä¿®æ”¹å†…å®¹**ï¼š
1. Mode Switcher ä½ç½®ï¼šä» HEADER ç§»åˆ° INPUT AREA
2. ç§»é™¤ä¸å­˜åœ¨çš„ Session Infoï¼ˆæˆ–æ ‡æ³¨ä¸ºå¾…å®ç°ï¼‰
3. æ›´æ–° Block Header ç»„ä»¶å›¾
4. ä¿®æ­£ "Session Summary" â†’ "Block Summary"

#### 4.3.2 ç§»åŠ¨ç«¯ä¼˜åŒ–

**ç›®æ ‡**ï¼šç¡®ä¿æ‰€æœ‰åŠŸèƒ½åœ¨ç§»åŠ¨ç«¯å¯ç”¨

**ä¼˜åŒ–ç‚¹**ï¼š
1. Block Footerï¼šéšè—æ–‡å­—ï¼Œä»…æ˜¾ç¤ºå›¾æ ‡
2. BlockSummarySectionï¼šé»˜è®¤æŠ˜å 
3. SessionBarï¼šé»˜è®¤éšè—æˆ–ç®€åŒ–æ˜¾ç¤º

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 5. å®æ–½è®¡åˆ’

### 5.1 Phase 1ï¼šæ ¸å¿ƒåŠŸèƒ½ä¿®å¤ï¼ˆ1-2 å‘¨ï¼‰

| ä»»åŠ¡                  | æ–‡ä»¶                                | å·¥ä½œé‡ | ä¾èµ–          |
| :-------------------- | :---------------------------------- | :----- | :------------ |
| å®ç° Block ç¼–è¾‘       | BlockEditDialog.tsx                 | 2d     | ForkBlock API |
| ä¿®å¤ Token/Cost æ˜¾ç¤º  | handler.go, UnifiedMessageBlock.tsx | 2d     | åç«¯ç»Ÿè®¡      |
| å®Œå–„ BlockHeader ä¿¡æ¯ | UnifiedMessageBlock.tsx             | 1d     | -             |
| æ›´æ–°æ–‡æ¡£              | AI_CHAT_INTERFACE.md                | 1d     | -             |

### 5.2 Phase 2ï¼šä¼šè¯çº§åŠŸèƒ½ï¼ˆ1 å‘¨ï¼‰

| ä»»åŠ¡            | æ–‡ä»¶           | å·¥ä½œé‡ | ä¾èµ– |
| :-------------- | :------------- | :----- | :--- |
| å®ç° SessionBar | SessionBar.tsx | 2d     | -    |
| èšåˆä¼šè¯ç»Ÿè®¡    | AIChat.tsx     | 1d     | -    |
| æ·»åŠ æŠ˜å åŠŸèƒ½    | SessionBar.tsx | 1d     | -    |

### 5.3 Phase 3ï¼šåˆ†æ”¯åŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰

| ä»»åŠ¡                 | æ–‡ä»¶                     | å·¥ä½œé‡ | ä¾èµ–             |
| :------------------- | :----------------------- | :----- | :--------------- |
| ä¿®å¤ BranchIndicator | BranchIndicator.tsx      | 1d     | -                |
| å®ç°åˆ†æ”¯é€‰æ‹©å¯¹è¯æ¡†   | BranchSelectorDialog.tsx | 2d     | -                |
| é›†æˆåˆ†æ”¯åˆ‡æ¢é€»è¾‘     | AIChat.tsx               | 2d     | SwitchBranch API |

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 6. æ•°æ®ç»“æ„è¡¥å……

### 6.1 æˆæœ¬è®¡ç®—å­—æ®µ

**ç°çŠ¶**ï¼š`cost_estimate` å­—æ®µå·²å­˜åœ¨ä½†æœªå¡«å……

**ä¿®å¤æ–¹æ¡ˆ**ï¼šåœ¨ `UpdateBlockStatus` æ—¶è®¡ç®—æˆæœ¬

```go
// åç«¯ï¼šserver/router/api/v1/ai/handler.go
func calculateCostEstimate(stats *SessionStats) int64 {
    if stats == nil || stats.TotalTokens == 0 {
        return 0
    }

    // Z.AI GLM å®šä»·
    // Input: Â¥0.50/M tokens (500 tokens / Â¥1M) = 0.05 milli-cents/token
    // Output: Â¥0.50/M tokens (500 tokens / Â¥1M) = 0.05 milli-cents/token
    inputCost := stats.InputTokens * 0.14
    outputCost := stats.OutputTokens * 0.28

    return int64(inputCost + outputCost)
}
```

### 6.2 æŒç»­æ—¶é—´è®¡ç®—

**ç°çŠ¶**ï¼š`created_ts` å’Œ `updated_ts` å·²å­˜åœ¨

**å‰ç«¯è®¡ç®—**ï¼š
```typescript
const duration = block.assistantTimestamp - block.created_ts;
const durationSeconds = duration / 1000;
const display = durationSeconds < 60
  ? `${durationSeconds.toFixed(1)}s`
  : `${(durationSeconds / 60).toFixed(1)}m`;
```

### 6.3 TokenUsage æ˜¾ç¤º

**ç°çŠ¶**ï¼š`token_usage` JSONB å­—æ®µå·²å­˜åœ¨ä½†å‰ç«¯æœªä½¿ç”¨

**ä¿®å¤**ï¼šåœ¨ BlockHeader ä¸­è¯»å–å¹¶æ˜¾ç¤º

```typescript
interface TokenUsage {
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
  cacheReadTokens: number;
  cacheWriteTokens: number;
}

// åœ¨ UnifiedMessageBlock.tsx - BlockHeader
{block.tokenUsage && block.tokenUsage.totalTokens > 0 && (
  <Tooltip content={`${block.tokenUsage.promptTokens} input + ${block.tokenUsage.completionTokens} output`}>
    <span className="flex items-center gap-1 text-xs">
      ğŸª™ {(block.tokenUsage.totalTokens / 1000).toFixed(1)}k
      {block.tokenUsage.cacheReadTokens > 0 && (
        <span className="text-green-500" title="Cache read">
          +{block.tokenUsage.cacheReadTokens}
        </span>
      )}
    </span>
  </Tooltip>
)}
```

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## 7. æ€»ç»“

### 7.1 å…³é”®å‘ç°

1. **åç«¯å®ç°å®Œæ•´**ï¼šUnified Block Model çš„åç«¯å®ç°æ˜¯å®Œæ•´çš„ï¼Œæ•°æ®å·²æ­£ç¡®æŒä¹…åŒ–
2. **å‰ç«¯éƒ¨åˆ†ç¼ºå¤±**ï¼šBlock Header çš„éƒ¨åˆ†å…ƒç´ æœªå®ç°ï¼Œç‰¹åˆ«æ˜¯ç¼–è¾‘åŠŸèƒ½
3. **æ•°æ®æµæ­£ç¡®**ï¼š`event_stream` â†’ `extractToolCalls()` æ•°æ®æµæ˜¯æ­£ç¡®çš„
4. **æ–‡æ¡£è¿‡æ—¶**ï¼šæ–‡æ¡£ä¸­çš„ ASCII å›¾ä¸å®é™…å®ç°ä¸ä¸€è‡´

### 7.2 ä¼˜å…ˆçº§å»ºè®®

1. **P0 - å¿…é¡»ä¿®å¤**ï¼š
   - å®ç° Block ç¼–è¾‘åŠŸèƒ½
   - ä¿®å¤ Token/Cost ç»Ÿè®¡æ˜¾ç¤º

2. **P1 - é‡è¦åŠŸèƒ½**ï¼š
   - å®Œå–„ BlockHeader ä¿¡æ¯æ˜¾ç¤º
   - å®ç° SessionBar
   - ä¿®å¤ BranchIndicator

3. **P2 - ä¼˜åŒ–æ”¹è¿›**ï¼š
   - æ–‡æ¡£æ›´æ–°
   - ç§»åŠ¨ç«¯ä¼˜åŒ–

### 7.3 é•¿æœŸè§„åˆ’

1. **åˆ†æ”¯ç®¡ç†**ï¼šå®Œæ•´çš„å¯¹è¯æ ‘å¯è§†åŒ–
2. **æœç´¢è¿‡æ»¤**ï¼šæŒ‰åˆ†æ”¯ã€æŒ‰æ—¶é—´ã€æŒ‰ Token ä½¿ç”¨é‡ç­›é€‰
3. **å¯¼å‡ºåŠŸèƒ½**ï¼šå¯¼å‡ºä¼šè¯ä¸º Markdown/JSON
4. **æˆæœ¬æ§åˆ¶**ï¼šä¼šè¯é¢„ç®—å‘Šè­¦

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„                                             | ç”¨é€”               | ä¿®æ”¹ä¼˜å…ˆçº§ |
| :--------------------------------------------------- | :----------------- | :--------- |
| `docs/dev-guides/frontend/ai-chat.md`                | ç•Œé¢æ¶æ„æ–‡æ¡£       | P2         |
| `web/src/pages/AIChat.tsx`                           | AI Chat ä¸»é¡µé¢     | P1         |
| `web/src/components/AIChat/UnifiedMessageBlock.tsx`  | Block ç»„ä»¶         | P0         |
| `web/src/components/AIChat/ChatHeader.tsx`           | èŠå¤©å¤´éƒ¨           | P3         |
| `web/src/components/AIChat/ChatInput.tsx`            | è¾“å…¥åŒºåŸŸ           | P3         |
| `web/src/components/AIChat/BlockEditDialog.tsx`      | ç¼–è¾‘å¯¹è¯æ¡†ï¼ˆæ–°å»ºï¼‰ | P0         |
| `web/src/components/AIChat/SessionBar.tsx`           | ä¼šè¯æ±‡æ€»æ ï¼ˆæ–°å»ºï¼‰ | P1         |
| `web/src/components/AIChat/BranchSelectorDialog.tsx` | åˆ†æ”¯é€‰æ‹©å™¨ï¼ˆæ–°å»ºï¼‰ | P2         |
| `server/router/api/v1/ai/handler.go`                 | èŠå¤©å¤„ç†å™¨         | P0         |
| `server/router/api/v1/ai/block_manager.go`           | Block ç®¡ç†å™¨       | P0         |

### B. API ä¾èµ–æ¸…å•

| API                 | çŠ¶æ€ | è¯´æ˜            |
| :------------------ | :--- | :-------------- |
| `ListBlocks`        | âœ…    | è·å–ä¼šè¯ Blocks |
| `GetBlock`          | âœ…    | è·å–å•ä¸ª Block  |
| `CreateBlock`       | âœ…    | åˆ›å»ºæ–° Block    |
| `UpdateBlock`       | âœ…    | æ›´æ–° Block      |
| `DeleteBlock`       | âœ…    | åˆ é™¤ Block      |
| `AppendEvent`       | âœ…    | è¿½åŠ äº‹ä»¶        |
| `AppendUserInput`   | âœ…    | è¿½åŠ ç”¨æˆ·è¾“å…¥    |
| `ForkBlock`         | âœ…    | åˆ›å»ºåˆ†æ”¯        |
| `ListBlockBranches` | âœ…    | åˆ—å‡ºåˆ†æ”¯        |
| `SwitchBranch`      | âœ…    | åˆ‡æ¢åˆ†æ”¯        |
| `DeleteBranch`      | âœ…    | åˆ é™¤åˆ†æ”¯        |

### C. æµ‹è¯•æ¸…å•

- [ ] Block ç¼–è¾‘åŠŸèƒ½ï¼šç¼–è¾‘ç”¨æˆ·è¾“å…¥ â†’ åˆ›å»ºæ–°åˆ†æ”¯ â†’ é‡æ–°ç”Ÿæˆ
- [ ] Token/Cost æ˜¾ç¤ºï¼šæ‰€æœ‰æ¨¡å¼ä¸‹æ­£ç¡®æ˜¾ç¤º
- [ ] BlockHeader ä¿¡æ¯ï¼šåˆ†æ”¯è·¯å¾„ã€æŒç»­æ—¶é—´ã€æˆæœ¬
- [ ] SessionBarï¼šä¼šè¯ç»Ÿè®¡èšåˆå’ŒæŠ˜å 
- [ ] BranchIndicatorï¼šåˆ†æ”¯é€‰æ‹©å’Œåˆ‡æ¢
- [ ] ç§»åŠ¨ç«¯ï¼šæ‰€æœ‰åŠŸèƒ½åœ¨ç§»åŠ¨ç«¯å¯ç”¨

---

## 8. P0 ä»»åŠ¡å®æ–½è®°å½•

### 8.1 å·²å®Œæˆ (2026-02-06)

#### P0-A001: Block ç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/BlockEditDialog.tsx`

**å®ç°å†…å®¹**:
1. åˆ›å»º BlockEditDialog ç»„ä»¶ï¼ŒåŒ…å«ï¼š
   - åŸå§‹æ¶ˆæ¯æ˜¾ç¤º
   - ç¼–è¾‘åŒºåŸŸï¼ˆTextareaï¼‰
   - è­¦å‘Šä¿¡æ¯ï¼ˆç¼–è¾‘å°†åˆ›å»ºæ–°åˆ†æ”¯ï¼‰
   - ç¡®è®¤/å–æ¶ˆæŒ‰é’®
   - useBlockEditDialog Hook ç®¡ç†å¯¹è¯æ¡†çŠ¶æ€

2. æ›´æ–° `UnifiedMessageBlock.tsx`:
   - æ·»åŠ  `onEdit` prop åˆ° UnifiedMessageBlockProps
   - æ·»åŠ  `blockId` prop åˆ° UnifiedMessageBlockProps
   - åœ¨ BlockFooter ä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®ï¼ˆPencil å›¾æ ‡ï¼‰
   - ç¼–è¾‘æŒ‰é’®åœ¨æµå¼è¾“å‡ºæ—¶ç¦ç”¨ï¼ˆ`isStreaming` çŠ¶æ€ï¼‰

3. æ›´æ–°å›½é™…åŒ– (en.json + zh-Hans.json):
   - `ai.unified_block.edit`: "Edit"
   - `ai.unified_block.edit_title`: "Edit User Input"
   - `ai.unified_block.edit_description`: "Edit your message to create a new branch and regenerate"
   - `ai.unified_block.original_message`: "Original Message"
   - `ai.unified_block.edited_message`: "Edited Message"
   - `ai.unified_block.edit_warning`: "Note: Editing will create a new branch..."
   - `ai.unified_block.cancel`: "Cancel"
   - `ai.unified_block.create_branch`: "Create Branch & Regenerate"
   - `ai.unified_block.branch_created`: "Branch created successfully"
   - `ai.unified_block.duration`: "Duration"
   - `ai.unified_block.cost`: "Cost"
   - `ai.unified_block.tokens`: "Tokens"
   - `ai.unified_block.branch_path`: "Branch"

**å¾…é›†æˆ**: ChatMessages.tsx ä¸­é›†æˆ BlockEditDialog å¹¶å¤„ç†ç¼–è¾‘ç¡®è®¤é€»è¾‘

#### P0-A006: Normal æ¨¡å¼ Token/Cost æ˜¾ç¤ºä¿®å¤ âœ…

**æ–‡ä»¶**: `web/src/components/AIChat/UnifiedMessageBlock.tsx`

**ä¿®æ”¹å‰**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary || (parrotId !== "GEEK" && parrotId !== "EVOLUTION")) return null;
  // ...
}, [blockSummary, parrotId]);
```

**ä¿®æ”¹å**:
```typescript
const geekSummary = useMemo(() => {
  if (!blockSummary) return null;  // ç§»é™¤ parrotId æ£€æŸ¥ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º
  // ...
}, [blockSummary]);  // ç§»é™¤ parrotId ä¾èµ–
```

**æ•ˆæœ**: NORMALã€GEEKã€EVOLUTION æ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤º Token/Cost ç»Ÿè®¡

#### P0-A007: ForkBlock API Hook âœ…

**æ–‡ä»¶**: `web/src/hooks/useBlockQueries.ts`

**æ–°å¢å†…å®¹**:
```typescript
export function useForkBlock() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ blockId, reason }: { blockId: bigint; reason?: string }) => {
      const response = await aiServiceClient.forkBlock({ id: blockId, reason });
      return response;
    },
    onSuccess: (newBlock, variables) => {
      // Add the new forked block to cache
      const conversationId = Number(newBlock.conversationId);
      queryClient.setQueryData(blockKeys.detail(Number(newBlock.id)), newBlock);

      // Invalidate the block list to show the new branch
      queryClient.invalidateQueries({
        queryKey: blockKeys.list(conversationId),
      });
    },
  });
}
```

### 8.2 å¾…é›†æˆ

1. **ChatMessages.tsx é›†æˆ**:
   - å¯¼å…¥ BlockEditDialog å’Œ useBlockEditDialog
   - ä¼ é€’ onEdit å›è°ƒåˆ° UnifiedMessageBlock
   - å¤„ç†ç¼–è¾‘ç¡®è®¤åè°ƒç”¨ useForkBlock

2. **BranchIndicator å®Œå–„** (P1):
   - æ˜¾ç¤ºå½“å‰åˆ†æ”¯è·¯å¾„ï¼ˆå¦‚ `A.1`ã€`B.2.3`ï¼‰
   - ç‚¹å‡»å±•å¼€åˆ†æ”¯é€‰æ‹©å™¨

3. **SessionBar å®ç°** (P1):
   - æ–°å»ºç»„ä»¶èšåˆä¼šè¯ç»Ÿè®¡
   - æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢é¡¶éƒ¨æˆ–ä¾§è¾¹

---

**æ–‡æ¡£ç»“æŸ**
